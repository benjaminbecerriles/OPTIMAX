{% extends 'base.html' %}

{% block title %}Cambiar Precios - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Dise√±o Apple - Consistente con dashboard_inventario.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales - TEXTO OSCURECIDO */
    --text-color: #1d1d1f;
    --text-secondary: #515154; /* Oscurecido de #86868b a #515154 */
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    
    /* Colores de estado */
    --green: #2ecc71;
    --orange: #f39c12;
    --red: #e74c3c;
  }
  
  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }
  
  /* Contenedor principal */
  .apple-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Tipograf√≠a */
  h1 {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: 24px;
    max-width: 600px;
  }
  
  /* Barra de b√∫squeda - MEJORADA */
  .search-container {
    position: relative;
    margin-bottom: 30px;
    border-radius: 12px;
    background-color: var(--light-background);
    padding: 16px 20px; /* Reducido de 24px a 16px/20px */
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  
  .search-input-group {
    display: flex;
    align-items: center;
    background-color: white;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--separator);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  
  .search-input-group:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
  }
  
  .search-input {
    flex-grow: 1;
    padding: 14px 16px;
    font-family: var(--font-apple);
    font-size: 16px;
    border: none;
    outline: none;
    background: transparent;
    color: var(--text-color); /* Texto m√°s oscuro */
  }
  
  .search-input::placeholder {
    color: #707074; /* Placeholder oscurecido */
    font-weight: 400;
  }
  
  .search-icon-group {
    display: flex;
    align-items: center;
    padding-right: 16px;
    gap: 12px;
  }
  
  .search-icon {
    width: 20px;
    height: 20px;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  
  .search-icon:hover {
    transform: scale(1.1);
  }
  
  /* Categor√≠as */
  .category-section {
    margin-bottom: 30px; /* Reducido de 36px a 30px */
  }
  
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px; /* Reducido de 16px a 14px */
  }
  
  .category-title {
    font-size: 20px; /* Reducido de 22px a 20px */
    font-weight: 600; /* Aumentado de 500 a 600 */
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
  }
  
  .category-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px; /* Reducido de 28px a 24px */
    height: 24px; /* Reducido de 28px a 24px */
    border-radius: 50%;
    background-color: #eeeeee; /* Cambiado de var(--light-background) a #eeeeee */
    color: #505050; /* Color m√°s oscuro */
    font-size: 13px; /* Reducido de 14px a 13px */
    font-weight: 600; /* Aumentado de 500 a 600 */
  }
  
  .category-color-dot {
    width: 12px; /* Reducido de 14px a 12px */
    height: 12px; /* Reducido de 14px a 12px */
    border-radius: 50%;
  }
  
  /* Slider de productos - REDISE√ëO COMPLETO con ALTURA FIJA */
  .product-slider-container {
    position: relative;
    padding: 0 30px; /* Reducido de 40px a 30px */
  }
  
  .product-slider {
    display: flex;
    gap: 14px; /* Reducido de 16px a 14px */
    overflow-x: hidden;
    scroll-behavior: smooth;
    padding: 4px 0 12px 0; /* Reducido */
    margin-bottom: 4px; /* Reducido de 8px a 4px */
  }
  
  .product-card {
    flex: 0 0 180px; /* Reducido de 200px a 180px */
    height: 310px; /* ALTURA FIJA para todas las tarjetas */
    border-radius: 10px; /* Reducido de 12px a 10px */
    overflow: hidden;
    background-color: white;
    border: 1px solid #e0e0e0; /* Cambiado de var(--separator) a un color m√°s visible */
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Sombra muy sutil a√±adida */
    display: flex;
    flex-direction: column; /* Para control del dise√±o interno */
  }
  
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08); /* Sombra menos intensa */
  }
  
  .product-image-container {
    height: 120px; /* Reducido de 150px a 120px */
    min-height: 120px; /* Asegurar altura m√≠nima */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f8f8f8; /* Un poco m√°s claro que var(--light-background) */
  }
  
  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .product-details {
    padding: 12px; /* Reducido de 16px a 12px */
    flex-grow: 1; /* Toma el espacio restante */
    display: flex;
    flex-direction: column; /* Organiza el contenido verticalmente */
  }
  
  /* NUEVO: Dise√±o mejorado para nombre y marca */
  .product-info-container {
    display: flex;
    flex-direction: column;
    height: 60px; /* Altura fija para nombre+marca */
    margin-bottom: 6px;
    overflow: hidden;
    position: relative; /* Para posicionamiento absoluto de la marca */
  }
  
  .product-name {
    font-size: 14px;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Limitar a 2 l√≠neas siempre */
    -webkit-box-orient: vertical;
    line-height: 1.35; /* Ajustado para optimizar espacio */
    color: var(--text-color);
    height: 38px; /* Altura fija para 2 l√≠neas */
    margin-bottom: 0; /* Sin margen inferior */
  }
  
  .product-brand {
    font-size: 12px;
    color: #606060; /* Color m√°s oscuro que var(--text-secondary) */
    position: absolute; /* Posicionamiento absoluto para ubicaci√≥n fija */
    bottom: 0; /* Siempre en la parte inferior */
    left: 0; /* Alineado a la izquierda */
    right: 0; /* Extender a todo el ancho */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2; /* Ajuste de l√≠nea para marca */
  }
  
  /* Contenedor de precio con altura fija */
  .product-price-container {
    height: 24px; /* Altura fija para precio */
    margin-top: auto; /* Empuja hacia abajo, despu√©s del espacio flexible */
    margin-bottom: 8px; /* Espacio antes del input */
  }
  
  .current-price {
    font-size: 17px; /* Reducido de 18px a 17px */
    font-weight: 600;
    color: var(--accent);
  }
  
  /* Contenedor de input con altura fija */
  .price-input-container {
    height: 70px; /* Altura fija para input+bot√≥n */
  }
  
  .price-input-group {
    display: flex;
    align-items: center;
    height: 36px; /* Altura fija para el input */
    border: 1px solid #d1d1d6; /* Color m√°s visible que var(--separator) */
    border-radius: 6px;
    overflow: hidden;
    background-color: white;
    transition: border-color 0.2s ease;
    margin-bottom: 8px; /* Espacio consistente antes del bot√≥n */
  }
  
  .price-input-group:focus-within {
    border-color: var(--accent);
  }
  
  .currency-symbol {
    padding: 0 8px;
    font-weight: 500;
    color: #505050; /* Texto oscurecido */
  }
  
  .price-input {
    flex-grow: 1;
    height: 100%;
    padding: 0;
    border: none;
    outline: none;
    font-size: 14px;
    width: 100%;
    text-align: left;
    color: var(--text-color); /* Texto m√°s oscuro */
  }
  
  .save-price-btn {
    width: 100%;
    height: 36px; /* Altura fija para el bot√≥n */
    background-color: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px; /* Reducido de 14px a 13px */
    font-weight: 600; /* Aumentado de 500 a 600 */
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .save-price-btn:hover {
    background-color: var(--accent-hover);
  }
  
  /* Botones de navegaci√≥n del slider - MEJORADOS */
  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px; /* Reducido de 36px a 30px */
    height: 30px; /* Reducido de 36px a 30px */
    border-radius: 50%;
    background-color: white;
    border: 1px solid #d1d1d6; /* Color m√°s visible que var(--separator) */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    z-index: 10;
    transition: background-color 0.2s ease;
  }
  
  .slider-arrow:hover {
    background-color: #f0f0f2; /* Un poco m√°s oscuro que var(--light-background) */
  }
  
  .slider-arrow-left {
    left: 0;
  }
  
  .slider-arrow-right {
    right: 0;
  }
  
  .slider-arrow svg {
    width: 16px; /* Reducido de 20px a 16px */
    height: 16px; /* Reducido de 20px a 16px */
    fill: none;
    stroke: var(--text-color);
    stroke-width: 2;
  }
  
  /* Estado vac√≠o */
  .empty-state {
    padding: 50px 0; /* Reducido de 64px a 50px */
    text-align: center;
    background-color: var(--light-background);
    border-radius: 12px;
    margin-bottom: 36px;
  }
  
  .empty-icon {
    font-size: 32px; /* Reducido de 36px a 32px */
    color: var(--text-secondary);
    margin-bottom: 14px; /* Reducido de 16px a 14px */
  }
  
  .empty-message {
    font-size: 16px; /* Reducido de 17px a 16px */
    color: var(--text-secondary);
    margin-bottom: 14px; /* Reducido de 16px a 14px */
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Toast notificaciones - MEJORADAS */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }
  
  .toast {
    background-color: #333;
    color: white;
    padding: 14px 20px; /* Reducido de 16px 24px a 14px 20px */
    border-radius: 8px;
    margin-top: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 10px; /* Reducido de 12px a 10px */
    animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
    max-width: 350px; /* Reducido de 400px a 350px */
    font-weight: 500;
  }
  
  .toast.success {
    background-color: var(--green);
  }
  
  .toast.error {
    background-color: var(--red);
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
  
  /* Modal de scanner */
  #modalEscaneoCamara {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.85);
    z-index: 100;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .product-slider {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 16px; /* Reducido de 24px a 16px */
    }
    
    .product-card {
      flex: 0 0 70%; /* Reducido de 80% a 70% */
      scroll-snap-align: start;
    }
    
    .product-slider-container {
      padding: 0;
    }
    
    .slider-arrow {
      display: none;
    }
    
    h1 {
      font-size: 26px; /* Reducido de 28px a 26px */
    }
    
    .page-description {
      font-size: 15px; /* Reducido de 16px a 15px */
    }
  }
  
  @media (max-width: 480px) {
    .product-card {
      flex: 0 0 85%; /* Reducido de 90% a 85% */
    }
  }
  
  /* Animaciones */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .animated-fade {
    animation: fadeIn 0.3s ease-out;
  }
  
  .no-scroll {
    overflow: hidden;
  }
</style>

<div class="apple-container animated-fade">
  <h1>Cambiar precios</h1>
  <p class="page-description">Actualiza los precios de tus productos de forma r√°pida y sencilla. Explora por categor√≠as o busca un producto espec√≠fico.</p>
  
  <!-- Barra de b√∫squeda -->
  <div class="search-container">
    <div class="search-input-group">
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nombre, marca o c√≥digo de barras..." autocomplete="off">
      <div class="search-icon-group">
        <!-- Icono Lector F√≠sico -->
        <img src="{{ url_for('static', filename='img/3.png') }}" alt="Escanear con Lector" class="search-icon" id="scanIcon">
        <!-- Icono C√°mara QuaggaJS -->
        <img src="{{ url_for('static', filename='img/4.png') }}" alt="Escanear con C√°mara" class="search-icon" id="cameraIcon">
      </div>
    </div>
  </div>
  
  <!-- Contenedor para categor√≠as y productos -->
  <div id="categoriesContainer">
    {% if categorias and categorias|length > 0 %}
      {# Ordenar categor√≠as por cantidad de productos (mayor a menor) #}
      {% set categorias_ordenadas = [] %}
      {% for categoria in categorias %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        {% if productos_categoria|length > 0 %}
          {% set _ = categorias_ordenadas.append({'nombre': categoria.nombre, 'color': categoria.color, 'count': productos_categoria|length}) %}
        {% endif %}
      {% endfor %}
      {% set categorias_ordenadas = categorias_ordenadas|sort(attribute='count', reverse=true) %}
      
      {% for categoria in categorias_ordenadas %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        <div class="category-section" data-category="{{ categoria.nombre|lower }}">
          <div class="category-header">
            <h2 class="category-title">
              <span class="category-color-dot" style="background-color: {{ categoria.color }}"></span>
              {{ categoria.nombre|title }}
              <span class="category-badge">{{ categoria.count }}</span>
            </h2>
          </div>
          
          <div class="product-slider-container">
            <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('{{ categoria.nombre|lower }}', 'left')">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            
            <div class="product-slider" id="slider-{{ categoria.nombre|lower }}">
              {% for producto in productos_categoria %}
                <div class="product-card" data-product-id="{{ producto.id }}" data-product-name="{{ producto.nombre|lower }}" data-product-barcode="{{ producto.codigo_barras_externo|lower if producto.codigo_barras_externo else '' }}">
                  <div class="product-image-container">
                    {% if producto.foto %}
                      <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" class="product-image" alt="{{ producto.nombre }}">
                    {% else %}
                      <div class="product-image" style="display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-box" style="color: var(--text-secondary);"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="product-details">
                    <div class="product-info-container">
                      <div class="product-name">{{ producto.nombre }}</div>
                      {% if producto.marca %}
                        <div class="product-brand">{{ producto.marca }}</div>
                      {% else %}
                        <div class="product-brand" style="opacity: 0;">-</div>
                      {% endif %}
                    </div>
                    <div class="product-price-container">
                      <div class="current-price">${{ '{:.2f}'.format(producto.precio_venta) }}</div>
                    </div>
                    <div class="price-input-container">
                      <div class="price-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="text" class="price-input" value="{{ '{:.2f}'.format(producto.precio_venta) }}" 
                              data-original-price="{{ producto.precio_venta }}"
                              oninput="formatPriceInput(this)">
                      </div>
                      <button class="save-price-btn" onclick="updatePrice({{ producto.id }}, this)">Guardar</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('{{ categoria.nombre|lower }}', 'right')">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <!-- Estado vac√≠o -->
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-tag"></i>
        </div>
        <p class="empty-message">No hay productos en tu inventario</p>
        <a href="{{ url_for('nuevo_producto') }}" class="button-link" style="display: inline-block; padding: 10px 20px; background-color: var(--accent); color: white; text-decoration: none; border-radius: 6px; margin-top: 16px;">
          Agregar producto
        </a>
      </div>
    {% endif %}
  </div>
  
  <!-- Contenedor de notificaciones toast -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // ----------------------------------------------------
  // FUNCI√ìN PARA FORMATEAR PRECIOS CON COMAS DE MILES - SIMPLIFICADA
  // ----------------------------------------------------
  function formatPrice(price) {
    // Convertir a n√∫mero si es string
    if (typeof price === 'string') {
      price = price.replace(/,/g, '');
      price = parseFloat(price);
    }
    
    // Si no es un n√∫mero v√°lido, retornar un valor por defecto
    if (isNaN(price)) {
      return '0.00';
    }
    
    // Formatear con comas y siempre 2 decimales
    return price.toLocaleString('es-MX', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }
  
  // Formatear todos los precios actuales al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    // Formatear todos los precios actuales
    document.querySelectorAll('.current-price').forEach(function(element) {
      // Obtener el precio actual (eliminando el "$" del inicio)
      const priceText = element.textContent.replace('$', '').trim();
      const price = parseFloat(priceText);
      
      if (!isNaN(price)) {
        // Formatear y mostrar con el s√≠mbolo "$"
        element.textContent = '$' + formatPrice(price);
      }
    });
    
    // Formatear todos los inputs de precios
    document.querySelectorAll('.price-input').forEach(function(input) {
      const price = parseFloat(input.value);
      if (!isNaN(price)) {
        input.value = formatPrice(price);
      }
    });
  });
  
  // ----------------------------------------------------
  // Funciones para el slider de productos
  // ----------------------------------------------------
  function scrollSlider(categoryId, direction) {
    const slider = document.getElementById(`slider-${categoryId}`);
    if (!slider) return;
    
    const cardWidth = slider.querySelector('.product-card').offsetWidth + 14; // 14px es el gap
    const scrollAmount = cardWidth * 3; // Scroll de 3 productos a la vez
    
    if (direction === 'left') {
      slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
      slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
  }
  
  // ----------------------------------------------------
  // Formateo de entrada de precios SIMPLIFICADO
  // ----------------------------------------------------
  function formatPriceInput(input) {
    // 1. Detectar y manejar si est√° completamente vac√≠o
    if (input.value === '') {
      return; // Permitir que est√© vac√≠o
    }
    
    // 2. Eliminar cualquier caracter que no sea n√∫mero, punto o coma
    const cleanedValue = input.value.replace(/[^\d.,]/g, '');
    
    // 3. Si despu√©s de limpiar est√° vac√≠o, dejar el campo vac√≠o
    if (cleanedValue === '') {
      input.value = '';
      return;
    }
    
    // 4. Eliminar todas las comas para trabajar solo con el valor num√©rico
    const rawValue = cleanedValue.replace(/,/g, '');
    
    // 5. Manejar puntos decimales (asegurar solo uno)
    const parts = rawValue.split('.');
    let formattedValue;
    
    if (parts.length === 1) {
      // Sin punto decimal - formatear toda la parte entera
      const wholeNumber = parseInt(parts[0]);
      if (!isNaN(wholeNumber)) {
        formattedValue = wholeNumber.toLocaleString('es-MX');
      } else {
        input.value = '';
        return;
      }
    } else {
      // Con punto decimal
      const wholeNumber = parseInt(parts[0]);
      let decimal = parts.slice(1).join(''); // Por si hay m√∫ltiples puntos
      
      // Limitar decimales a 2
      decimal = decimal.substr(0, 2);
      
      if (!isNaN(wholeNumber)) {
        // Formatear con comas la parte entera
        formattedValue = wholeNumber.toLocaleString('es-MX');
        
        // A√±adir los decimales si existen
        if (decimal) {
          formattedValue += '.' + decimal;
        } else if (input.value.endsWith('.')) {
          // Si termina con punto, mantenerlo
          formattedValue += '.';
        }
      } else {
        // Si la parte entera no es un n√∫mero, manejar solo decimales
        formattedValue = '0';
        if (decimal) {
          formattedValue += '.' + decimal;
        } else if (input.value.endsWith('.')) {
          formattedValue += '.';
        }
      }
    }
    
    // 6. Actualizar el valor con el formato correcto
    input.value = formattedValue;
  }
  
  // ----------------------------------------------------
  // Actualizar precio con AJAX
  // ----------------------------------------------------
  function updatePrice(productId, button) {
    const card = button.closest('.product-card');
    const inputContainer = button.closest('.price-input-container');
    const input = inputContainer.querySelector('.price-input');
    const currentPriceElement = card.querySelector('.current-price');
    
    // Obtener el valor sin comas para procesarlo
    const rawValue = input.value.replace(/,/g, '');
    
    // Convertir a n√∫mero
    const newPrice = parseFloat(rawValue);
    
    // Validar que el precio sea mayor que cero
    if (isNaN(newPrice) || newPrice <= 0) {
      showToast('El precio debe ser mayor que cero', 'error');
      return;
    }
    
    // Desactivar bot√≥n durante la actualizaci√≥n
    button.disabled = true;
    button.textContent = 'Guardando...';
    
    // Enviar actualizaci√≥n al servidor
    fetch(`/api/update_price/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ price: newPrice })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Error al actualizar el precio');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Actualizar la interfaz con el precio formateado con comas
        const formattedPrice = newPrice.toLocaleString('es-MX', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        currentPriceElement.textContent = `$${formattedPrice}`;
        input.dataset.originalPrice = newPrice;
        
        // Mostrar notificaci√≥n de √©xito
        showToast('Precio actualizado correctamente', 'success');
        
        // Efecto visual de √©xito
        card.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
        card.style.boxShadow = '0 0 0 3px rgba(46, 204, 113, 0.3)';
        setTimeout(() => {
          card.style.boxShadow = '';
        }, 1500);
      } else {
        throw new Error(data.message || 'Error al actualizar el precio');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast(error.message, 'error');
    })
    .finally(() => {
      // Restaurar bot√≥n
      button.disabled = false;
      button.textContent = 'Guardar';
    });
  }
  
  // ----------------------------------------------------
  // Sistema de notificaciones toast
  // ----------------------------------------------------
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    // Crear elemento toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    // Agregar al contenedor
    toastContainer.appendChild(toast);
    
    // Remover despu√©s de la animaci√≥n
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
  
  // ----------------------------------------------------
  // FUNCIONES DE B√öSQUEDA Y MANEJO DE C√ìDIGOS ESCANEADOS
  // ----------------------------------------------------
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const categorySections = document.querySelectorAll('.category-section');
    
    // ==========================================
    // FUNCI√ìN DE B√öSQUEDA PRINCIPAL - SIMPLIFICADA
    // ==========================================
    window.performSearch = function performSearch(searchTermParam) {
      // Permitir proporcionar el t√©rmino de b√∫squeda como par√°metro o usar el valor del input
      const searchTerm = (searchTermParam !== undefined) 
        ? searchTermParam.toString().toLowerCase().trim() 
        : searchInput.value.toLowerCase().trim();
      
      console.log(">> EJECUTANDO B√öSQUEDA:", searchTerm);
      
      let resultsCount = 0;
      
      // Si no hay t√©rmino de b√∫squeda, mostrar todo
      if (!searchTerm) {
        categorySections.forEach(section => {
          section.style.display = 'block';
          const products = section.querySelectorAll('.product-card');
          products.forEach(product => {
            product.style.display = 'block';
          });
        });
        
        const emptySearch = document.getElementById('emptySearchResults');
        if (emptySearch) {
          emptySearch.style.display = 'none';
        }
        return;
      }
      
      // Filtrar productos por b√∫squeda
      categorySections.forEach(section => {
        const products = section.querySelectorAll('.product-card');
        let hasVisibleProducts = false;
        
        products.forEach(product => {
          const productName = product.dataset.productName || '';
          const productBarcode = product.dataset.productBarcode || '';
          const productBrand = product.querySelector('.product-brand')?.textContent?.toLowerCase() || '';
          
          // Coincidencia exacta para c√≥digos de barras
          const exactBarcodeMatch = productBarcode === searchTerm;
          
          // Coincidencia parcial para nombre y marca
          const partialNameMatch = productName.includes(searchTerm);
          const partialBrandMatch = productBrand.includes(searchTerm);
          
          // Dar prioridad a coincidencia exacta de c√≥digo de barras
          const matches = exactBarcodeMatch || partialNameMatch || partialBrandMatch;
          
          product.style.display = matches ? 'block' : 'none';
          
          if (matches) {
            hasVisibleProducts = true;
            resultsCount++;
            
            if (exactBarcodeMatch) {
              // Resaltar el producto con c√≥digo de barras exacto
              product.style.order = "-1"; // Mover al principio
              product.style.boxShadow = "0 0 0 2px #e52e2e";
              setTimeout(() => {
                product.style.boxShadow = "";
              }, 3000);
            }
          }
        });
        
        section.style.display = hasVisibleProducts ? 'block' : 'none';
      });
      
      // Mensaje sin resultados
      showEmptyOrResults(resultsCount, searchTerm);
      
      console.log(`>> B√öSQUEDA COMPLETADA: ${resultsCount} productos encontrados`);
      return resultsCount;
    };
    
    // Funci√≥n auxiliar para mensaje vac√≠o
    function showEmptyOrResults(count, term) {
      let emptySearch = document.getElementById('emptySearchResults');
      
      if (count === 0) {
        if (!emptySearch) {
          emptySearch = document.createElement('div');
          emptySearch.id = 'emptySearchResults';
          emptySearch.className = 'empty-state';
          emptySearch.innerHTML = `
            <div class="empty-icon">
              <i class="fas fa-search"></i>
            </div>
            <p class="empty-message">No se encontraron productos que coincidan con "<strong>${term}</strong>"</p>
          `;
          
          const categoriesContainer = document.getElementById('categoriesContainer');
          categoriesContainer.prepend(emptySearch);
        } else {
          const message = emptySearch.querySelector('.empty-message');
          message.innerHTML = `No se encontraron productos que coincidan con "<strong>${term}</strong>"`;
          emptySearch.style.display = 'block';
        }
      } else if (emptySearch) {
        emptySearch.style.display = 'none';
      }
    }
    
    // ==========================================
    // HANDLER PRINCIPAL UNIFICADO PARA ESC√ÅNER
    // ==========================================
    window.handleScannedCode = function(code) {
      // Alertar del c√≥digo escaneado
      console.log("üîç C√ìDIGO ESCANEADO:", code);
      
      // Actualizar directamente el input
      if (searchInput) {
        searchInput.value = code;
        
        // Disparar eventos para que otros controladores lo detecten
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      }
      
      // Ejecutar b√∫squeda inmediatamente
      const found = window.performSearch(code);
      
      // Notificar el resultado
      if (found > 0) {
        showToast(`Encontrado ${found} producto(s) para: ${code}`, 'success');
      } else {
        showToast(`No se encontr√≥ ning√∫n producto para el c√≥digo: ${code}`, 'error');
      }
      
      // Log para fines de diagn√≥stico
      console.log("üîç B√∫squeda completada para el c√≥digo:", code);
      return found;
    };
    
    // Establecer funci√≥n para lector f√≠sico
    window.onScannedBarcode = function(code) {
      return window.handleScannedCode(code);
    };
    
    // Registro para eventos de input
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        window.performSearch();
      });
      
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          window.performSearch();
        }
      });
    }
    
    // Inicializar esc√°ner f√≠sico si existe la funci√≥n
    if (typeof window.initBarcodeScanner === 'function' && document.getElementById('scanIcon')) {
      window.initBarcodeScanner('#scanIcon', '#searchInput');
      console.log("‚öôÔ∏è Esc√°ner f√≠sico inicializado");
    }
    
    // TRUCO ADICIONAL: monitor para cambios en searchInput desde cualquier fuente
    if (searchInput) {
      let lastKnownValue = searchInput.value;
      
      // Verificar cada 100ms si hay cambios en el valor
      setInterval(function() {
        const currentValue = searchInput.value;
        if (currentValue !== lastKnownValue && currentValue.trim() !== '') {
          console.log("‚ö†Ô∏è Se detect√≥ cambio en searchInput:", currentValue);
          lastKnownValue = currentValue;
          window.performSearch(currentValue);
        }
      }, 100);
    }
  });
</script>

<!-- SOLUCI√ìN PARA EL ESC√ÅNER DE C√ÅMARA EN CAMBIAR-PRECIOS -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. Aseguramos que Quagga est√© disponible
    if (typeof Quagga === "undefined") {
      console.error("Error: Quagga no est√° disponible. Verifica la carga de la biblioteca.");
      return;
    }
    
    console.log("‚úì Inyectando funcionalidad de esc√°ner QuaggaJS para cambiar-precios");
    
    // 2. Configurar el bot√≥n de c√°mara
    const cameraBtn = document.getElementById("cameraIcon");
    if (cameraBtn) {
      // Asignar nuestro handler
      cameraBtn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        iniciarEscaneoQuaggaCambiarPrecios();
        return false;
      };
      console.log("‚úì Bot√≥n de c√°mara configurado correctamente");
    } else {
      console.error("‚ö†Ô∏è No se encontr√≥ el bot√≥n de c√°mara (#cameraIcon)");
    }

    // NUEVA IMPLEMENTACI√ìN INDEPENDIENTE DEL ESC√ÅNER QUAGGA
    window.iniciarEscaneoQuaggaCambiarPrecios = function() {
      console.log("‚ñ∂Ô∏è Iniciando el esc√°ner de c√≥digos de barras personalizado para cambiar-precios");
      
      // Verificar si el modal existe, si no, crearlo
      let modalEscaneo = document.getElementById("modalEscaneoCambioPrecio");
      if (!modalEscaneo) {
        modalEscaneo = document.createElement("div");
        modalEscaneo.id = "modalEscaneoCambioPrecio";
        modalEscaneo.style.display = "none";
        modalEscaneo.style.position = "fixed";
        modalEscaneo.style.top = "0";
        modalEscaneo.style.left = "0";
        modalEscaneo.style.width = "100%";
        modalEscaneo.style.height = "100%";
        modalEscaneo.style.backgroundColor = "rgba(0,0,0,0.9)";
        modalEscaneo.style.zIndex = "9999";
        
        // Crear contenido del modal
        modalEscaneo.innerHTML = `
          <div style="position:relative; width:100%; height:100%;">
            <button style="position:absolute; top:20px; right:20px; background-color:#e52e2e; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; cursor:pointer; z-index:10000" onclick="cerrarEscanerCambioPrecio()">√ó</button>
            <h2 style="color:white; text-align:center; margin-top:20px">Escanear c√≥digo de barras</h2>
            <div id="videoContainerCambioPrecio" style="width:90%; max-width:640px; margin:0 auto; background:#000;"></div>
          </div>
        `;
        
        document.body.appendChild(modalEscaneo);
      }
      
      // Mostrar el modal
      modalEscaneo.style.display = "block";
      
      // Obtener el contenedor de video
      const videoContainer = document.getElementById("videoContainerCambioPrecio");
      if (!videoContainer) {
        console.error("Error: No se encuentra el contenedor de video");
        return;
      }
      
      // Limpiar el contenedor
      videoContainer.innerHTML = "";
      
      // Inicializar Quagga
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: videoContainer,
          constraints: {
            width: { min: 640 },
            height: { min: 480 },
            facingMode: "environment",
            aspectRatio: { min: 1, max: 2 }
          }
        },
        locator: {
          patchSize: "medium",
          halfSample: true
        },
        numOfWorkers: 2,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "upc_reader",
            "upc_e_reader"
          ]
        }
      }, function(err) {
        if (err) {
          console.error("Error inicializando Quagga:", err);
          videoContainer.innerHTML = `
            <div style="color:white; padding:20px; text-align:center">
              <p>Error accediendo a la c√°mara: ${err.message || "desconocido"}</p>
              <p>Por favor, verifica los permisos de c√°mara y recarga la p√°gina.</p>
            </div>
          `;
          return;
        }
        
        console.log("‚úì Quagga iniciado correctamente");
        
        // M√âTODO AVANZADO: Desconectar todos los handlers anteriores e instalar el nuestro personalizado
        try {
          // Soluci√≥n radical: reemplazar completamente el m√©todo onDetected
          const originalOnDetected = Quagga.onDetected;
          Quagga.onDetected = function(callback) {
            // Guardar el callback
            window._currentQuaggaCallback = callback;
            // Llamar a la implementaci√≥n original
            return originalOnDetected.call(Quagga, callback);
          };
          
          Quagga.offDetected = function() {
            window._currentQuaggaCallback = null;
            // Simular desactivaci√≥n del detector
            return Quagga;
          };
        } catch (e) {
          console.error("Error al sobreescribir Quagga.onDetected:", e);
        }
        
        // Nuestro handler personalizado para esta p√°gina espec√≠fica
        Quagga.onDetected(function(result) {
          if (!result || !result.codeResult) return;
          
          const codigo = result.codeResult.code;
          console.log("üîç C√ìDIGO DETECTADO en cambiar-precios:", codigo);
          
          // Detener Quagga y cerrar el modal
          Quagga.stop();
          modalEscaneo.style.display = "none";
          
          // IMPORTANTE: Obtener el campo de b√∫squeda
          const searchInput = document.getElementById("searchInput");
          if (searchInput) {
            // Establecer el valor y forzar el evento input
            searchInput.value = codigo;
            
            // Disparar eventos para activar la b√∫squeda - REDUNDANCIA M√ÅXIMA
            // 1. Evento input nativo
            const inputEvent = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(inputEvent);
            
            // 2. Evento change
            const changeEvent = new Event('change', { bubbles: true });
            searchInput.dispatchEvent(changeEvent);
            
            // 3. Evento keydown con Enter para simular presionar Enter
            const enterEvent = new KeyboardEvent('keydown', {
              key: 'Enter',
              code: 'Enter',
              keyCode: 13,
              which: 13,
              bubbles: true
            });
            searchInput.dispatchEvent(enterEvent);
            
            // 4. Llamada directa a la funci√≥n de b√∫squeda global
            if (typeof window.performSearch === 'function') {
              window.performSearch(codigo);
            }
            
            // 5. Llamada al handler globalizado para escaner
            if (typeof window.handleScannedCode === 'function') {
              window.handleScannedCode(codigo);
            }
            
            // 6. Llamada al handler del lector f√≠sico para compatibilidad
            if (typeof window.onScannedBarcode === 'function') {
              window.onScannedBarcode(codigo);
            }
          } else {
            console.error("Error: No se encontr√≥ el campo de b√∫squeda #searchInput");
          }
        });
        
        // Iniciar Quagga
        Quagga.start();
      });
    };

    // Funci√≥n para cerrar el esc√°ner
    window.cerrarEscanerCambioPrecio = function() {
      console.log("‚èπÔ∏è Cerrando esc√°ner");
      
      // Detener Quagga
      if (window.Quagga) {
        try {
          Quagga.stop();
        } catch (e) {
          console.error("Error al detener Quagga:", e);
        }
      }
      
      // Ocultar modal
      const modal = document.getElementById("modalEscaneoCambioPrecio");
      if (modal) {
        modal.style.display = "none";
      }
    };
    
    console.log("üéâ Configuraci√≥n de esc√°ner para cambiar-precios completada");
  });
</script>
{% endblock %}