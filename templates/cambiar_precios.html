{% extends 'base.html' %}

{% block title %}Cambiar Precios - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Consistente con dashboard_inventario.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales - TEXTO OSCURECIDO */
    --text-color: #1d1d1f;
    --text-secondary: #515154; /* Oscurecido de #86868b a #515154 */
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    --save-btn-color: #ff6b6b; /* Color rojo claro para botones de guardar */
    --save-btn-hover: #ff5252; /* Color hover para botones de guardar */
    --blue: #1a237e; /* Azul para el botón volver */
    
    /* Colores de estado */
    --green: #2ecc71;
    --orange: #f39c12;
    --red: #e74c3c;
  }
  
  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }
  
  /* Contenedor principal */
  .apple-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Encabezado de página - MODIFICADO PARA ALINEACIÓN PERFECTA */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px; /* Ajuste para alinear con la primera línea del título */
    align-items: center;
  }
  
  /* Botón volver estilo ajuste_stock.html */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px; /* Altura fija para todos los botones */
    white-space: nowrap; /* Evita que el texto se rompa */
  }
  
  .btn-action i, 
  .btn-action span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1;
  }
  
  /* Botón Volver estilo historial de movimientos */
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }
  
  /* Barra de búsqueda - MEJORADA para coincidir con ajuste_stock.html */
  .search-container {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 150px; /* TRIPLICADO de 50px a 150px para mucha más separación */
    position: relative;
    align-items: center;
  }
  
  .search-box {
    flex: 1;
    position: relative;
  }
  
  .search-box i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-600);
    font-size: 1.1rem;
    z-index: 5;
    pointer-events: none;
  }
  
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 1rem;
    height: 48px;
    transition: all 0.2s ease;
    font-weight: 400;
    background-color: var(--light-background);
  }
  
  .search-input input:focus {
    background-color: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  .search-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .icon-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light-background);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
  }
  
  .icon-btn:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .icon-btn.scan-active {
    background-color: rgba(229, 46, 46, 0.1);
    border-color: var(--accent);
    animation: blink 1s infinite;
  }
  
  /* Estilos para el corazón exactamente como en productos.html */
  .heart-icon {
    font-size: 24px;
    cursor: pointer;
    display: inline-block;
    transition: transform 0.2s ease, color 0.2s ease;
  }
  
  .heart-icon:hover {
    transform: scale(1.1);
  }
  
  .heart-icon.active {
    color: var(--red);
  }
  
  .heart-icon:not(.active) {
    color: var(--gray-500);
  }
  
  /* Contenedor para el checkbox de favoritos */
  .form-heart-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    background-color: var(--light-background);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 0 16px;
    height: 48px;
    transition: all 0.2s ease;
    user-select: none;
  }
  
  .form-heart-container:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .form-heart-container.active {
    background-color: rgba(231, 76, 60, 0.1);
    border-color: var(--red);
  }
  
  .form-heart-check-input {
    display: none;
  }
  
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
  }
  
  /* Categorías - MEJORADO: Más separación y borde de categoría */
  .category-section {
    margin-bottom: 70px; /* Aumentado a 70px para mucha más separación entre categorías */
    border: 1px solid #eaeaea;
    border-radius: 12px;
    padding: 25px; /* Aumentado a 25px */
    box-shadow: 0 3px 10px rgba(0,0,0,0.05); /* Sombra más pronunciada */
    background-color: #fafafa;
  }
  
  /* Eliminar selector para primera categoría ya que aumentamos el margen de search-container */
  
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px; /* Aumentado de 14px a 16px */
    padding-bottom: 10px; /* Nuevo: padding inferior */
    border-bottom: 1px solid #f0f0f0; /* Nuevo: separador */
  }
  
  .category-title {
    font-size: 22px; /* Aumentado de 20px a 22px */
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
  }
  
  .category-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px; /* Aumentado de 24px a 26px */
    height: 26px; /* Aumentado de 24px a 26px */
    border-radius: 50%;
    background-color: #eeeeee;
    color: #505050;
    font-size: 13px;
    font-weight: 600;
  }
  
  .category-color-dot {
    width: 16px; /* Aumentado de 12px a 16px */
    height: 16px; /* Aumentado de 12px a 16px */
    border-radius: 50%;
    /* El color se aplica dinámicamente con category_color */
  }
  
  /* Slider de productos - REDISEÑO COMPLETO con TARJETAS MÁS GRANDES */
  .product-slider-container {
    position: relative;
    padding: 0 70px;
    margin: 0 -10px; /* Margen negativo para compensar el padding */
  }
  
  .product-slider {
    display: flex;
    gap: 16px; /* Aumentado de 14px a 16px */
    overflow-x: hidden;
    scroll-behavior: smooth;
    padding: 4px 0 12px 0;
    margin-bottom: 4px;
  }
  
  .product-card {
    flex: 0 0 220px;
    height: 440px; /* AUMENTADO DRÁSTICAMENTE a 440px para asegurar que quepa todo */
    border-radius: 12px;
    overflow: hidden;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    position: relative; /* Añadido para mejor control de elementos internos */
  }
  
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }
  
  .product-image-container {
    height: 140px; /* Reducido a 140px para dar más espacio a otros elementos */
    min-height: 140px; 
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f8f8f8;
    padding: 5px;
  }
  
  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .product-details {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 300px; /* Altura fija para evitar problemas de cálculo */
  }
  
  /* MEJORADO: Diseño mejorado para nombre y marca */
  .product-info-container {
    display: flex;
    flex-direction: column;
    height: 78px; /* Aumentado a 78px para dar más espacio */
    margin-bottom: 10px; /* Aumentado a 10px */
    overflow: hidden;
    position: relative;
  }
  
  .product-name {
    font-size: 16px; /* Aumentado a 16px */
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4; /* Aumentado a 1.4 */
    color: var(--text-color);
    height: 46px; /* Aumentado a 46px */
    margin-bottom: 0;
  }
  
  .product-brand {
    font-size: 13px; /* Aumentado de 12px a 13px */
    color: #606060;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  
  /* Contenedor de precio con altura fija */
  .product-price-container {
    height: 32px;
    margin-top: 10px; /* Valor fijo en lugar de auto */
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 6px;
  }
  
  .current-price {
    font-size: 18px; /* Aumentado de 17px a 18px */
    font-weight: 600;
    color: var(--accent);
  }
  
  .price-unit {
    font-size: 13px; /* Aumentado de 12px a 13px */
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  /* Contenedor de input con altura fija */
  .price-input-container {
    height: 100px; /* Aumentado a 100px */
    margin-top: 5px;
    display: flex; /* Añadido */
    flex-direction: column; /* Añadido */
  }
  
  /* Asegurar visibilidad completa */
  .price-input-container button {
    display: block !important; /* Forzar visualización */
    visibility: visible !important; /* Forzar visibilidad */
  }
  
  .price-input-group {
    display: flex;
    align-items: center;
    height: 42px;
    border: 1px solid #d1d1d6;
    border-radius: 6px;
    overflow: hidden;
    background-color: white;
    transition: border-color 0.2s ease;
    margin-bottom: 15px; /* Aumentado a 15px */
    width: 100%; /* Asegurar ancho completo */
  }
  
  .price-input-group:focus-within {
    border-color: var(--accent);
  }
  
  .currency-symbol {
    padding: 0 10px; /* Aumentado de 8px a 10px */
    font-weight: 500;
    color: #505050;
  }
  
  .price-input {
    flex-grow: 1;
    height: 100%;
    padding: 0;
    border: none;
    outline: none;
    font-size: 15px; /* Aumentado de 14px a 15px */
    width: 100%;
    text-align: left;
    color: var(--text-color);
  }
  
  /* Botón de guardar en rojo claro */
  .save-price-btn {
    width: 100%;
    height: 42px;
    background-color: var(--save-btn-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
    box-shadow: 0 2px 4px rgba(255, 107, 107, 0.2);
    display: block !important; /* Forzar visualización */
    opacity: 1 !important; /* Asegurar visibilidad */
    position: relative; /* Mejor control */
    z-index: 10; /* Elevar sobre otros elementos */
  }
  
  .save-price-btn:hover {
    background-color: var(--save-btn-hover);
    transform: translateY(-1px);
  }
  
  /* Botones de navegación del slider */
  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--accent);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(229, 46, 46, 0.3);
    z-index: 10;
    transition: all 0.2s ease;
  }
  
  .slider-arrow:hover {
    background-color: var(--accent-hover);
    transform: translateY(-50%) scale(1.1);
  }
  
  .slider-arrow-left {
    left: 20px;
  }
  
  .slider-arrow-right {
    right: 20px;
  }
  
  .slider-arrow svg {
    width: 18px;
    height: 18px;
    fill: none;
    stroke: white;
    stroke-width: 2.5;
  }
  
  /* Estado vacío - MEJORADO con botón de restablecer */
  .empty-state {
    padding: 50px 0;
    text-align: center;
    background-color: var(--light-background);
    border-radius: 12px;
    margin-bottom: 36px;
  }
  
  .empty-icon {
    font-size: 32px;
    color: var(--text-secondary);
    margin-bottom: 14px;
  }
  
  .empty-message {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 20px; /* Aumentado para dar espacio al botón */
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* NUEVO: Botón de restablecer */
  .btn-reset {
    display: inline-block;
    background-color: white;
    color: var(--text-color);
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    padding: 12px 28px; /* Aumentado tamaño del botón */
    font-size: 15px; /* Aumentado tamaño de fuente */
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08); /* Sombra más visible */
    text-decoration: none;
    margin-top: 5px; /* Espacio superior adicional */
  }
  
  .btn-reset:hover {
    background-color: #f5f5f7;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transform: translateY(-1px);
  }
  
  /* Toast notificaciones */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }
  
  .toast {
    background-color: #333;
    color: white;
    padding: 14px 20px;
    border-radius: 8px;
    margin-top: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
    max-width: 350px;
    font-weight: 500;
  }
  
  .toast.success {
    background-color: var(--green);
  }
  
  .toast.error {
    background-color: var(--red);
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
  
  /* Modal de scanner */
  #modalEscaneoCamara {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.85);
    z-index: 100;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .product-slider {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 16px;
    }
    
    .product-card {
      flex: 0 0 70%;
      scroll-snap-align: start;
      height: 470px; /* Aumentado para móviles */
    }
    
    .product-slider-container {
      padding: 0;
    }
    
    .slider-arrow {
      display: none;
    }
    
    h1 {
      font-size: 26px;
    }
    
    .page-description {
      font-size: 15px;
    }
  }
  
  @media (max-width: 480px) {
    .product-card {
      flex: 0 0 85%;
    }
  }
  
  /* Animaciones */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .animated-fade {
    animation: fadeIn 0.3s ease-out;
  }
  
  .no-scroll {
    overflow: hidden;
  }
</style>

<div class="apple-container animated-fade">
  <!-- NUEVA ESTRUCTURA DE ENCABEZADO -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Cambiar precios</h1>
      <p class="page-description">Actualiza los precios de tus productos de forma rápida y sencilla</p>
    </div>
    <div class="header-actions">
      <!-- Botón Volver con clase btn-action y btn-volver -->
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>
  
  <!-- Barra de búsqueda adaptada al estilo de ajuste_stock.html -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar por nombre, marca o código de barras...">
    </div>
    <div class="search-actions">
      <!-- Filtro solo favoritos -->
      <div class="form-heart-container" id="favoritosContainer">
        <input class="form-heart-check-input" type="checkbox" id="favoritosCheck">
        <span class="heart-icon" id="heartIcon">&#9825;</span>
        <span style="font-size: 0.95rem; font-weight: 500;">Solo favoritos</span>
      </div>
      <!-- Botón de escaneo con pistola de código de barras -->
      <button class="icon-btn" id="scanIcon" title="Escanear con pistola">
        <img src="{{ url_for('static', filename='img/3.png') }}" alt="Escanear con Lector" style="width: 24px; height: 24px;">
      </button>
      <!-- Botón de escaneo con cámara -->
      <button class="icon-btn" id="cameraIcon" title="Escanear con cámara" onclick="iniciarEscaneoQuagga()">
        <img src="{{ url_for('static', filename='img/4.png') }}" alt="Escanear con Cámara" style="width: 24px; height: 24px;">
      </button>
    </div>
  </div>
  
  <!-- Contenedor para categorías y productos -->
  <div id="categoriesContainer">
    {% if categorias and categorias|length > 0 %}
      {# Ordenar categorías por cantidad de productos (mayor a menor) #}
      {% set categorias_ordenadas = [] %}
      {% for categoria in categorias %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        {% if productos_categoria|length > 0 %}
          {% set _ = categorias_ordenadas.append({'nombre': categoria.nombre, 'color': categoria.color, 'count': productos_categoria|length}) %}
        {% endif %}
      {% endfor %}
      {% set categorias_ordenadas = categorias_ordenadas|sort(attribute='count', reverse=true) %}
      
      {% for categoria in categorias_ordenadas %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        <div class="category-section" data-category="{{ categoria.nombre|lower }}">
          <div class="category-header">
            <h2 class="category-title">
              <span class="category-color-dot" style="background-color: {% if categoria.nombre == 'medicamentos de mostrador (otc)' %}#FF6347{% else %}{{ categoria.color }}{% endif %}"></span>
              {{ categoria.nombre|title }}
              <span class="category-badge">{{ categoria.count }}</span>
            </h2>
          </div>
          
          <div class="product-slider-container">
            <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('{{ categoria.nombre|lower }}', 'left')">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            
            <div class="product-slider" id="slider-{{ categoria.nombre|lower }}">
              {% for producto in productos_categoria %}
                <div class="product-card" data-product-id="{{ producto.id }}" data-product-name="{{ producto.nombre|lower }}" data-product-barcode="{{ producto.codigo_barras_externo|lower if producto.codigo_barras_externo else '' }}" data-favorito="{{ producto.es_favorito }}">
                  <div class="product-image-container">
                    {% if producto.foto %}
                      <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" class="product-image" alt="{{ producto.nombre }}">
                    {% else %}
                      <div class="product-image" style="display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-box" style="color: var(--text-secondary);"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="product-details">
                    <div class="product-info-container">
                      <div class="product-name">{{ producto.nombre }}</div>
                      {% if producto.marca %}
                        <div class="product-brand">{{ producto.marca }}</div>
                      {% else %}
                        <div class="product-brand" style="opacity: 0;">-</div>
                      {% endif %}
                    </div>
                    <div class="product-price-container">
                      <div class="current-price" id="display-price-{{ producto.id }}">
                        ${{ '{:.2f}'.format(producto.precio_venta) }}
                      </div>
                      <div class="price-unit">
                        {% if producto.unidad and producto.unidad != 'NONE' %}
                          / {{ producto.unidad }}
                        {% else %}
                          / pieza
                        {% endif %}
                      </div>
                    </div>
                    <div class="price-input-container">
                      <div class="price-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="text" class="price-input" id="price-input-{{ producto.id }}" value="{{ '{:.2f}'.format(producto.precio_venta) }}" 
                              data-original-price="{{ producto.precio_venta }}"
                              oninput="formatPriceInput(this)">
                      </div>
                      <button class="save-price-btn" onclick="updatePrice({{ producto.id }}, this)" style="display: block !important;">Guardar</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('{{ categoria.nombre|lower }}', 'right')">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <!-- Estado vacío -->
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-tag"></i>
        </div>
        <p class="empty-message">No hay productos en tu inventario</p>
        <a href="{{ url_for('nuevo_producto') }}" class="button-link" style="display: inline-block; padding: 10px 20px; background-color: var(--accent); color: white; text-decoration: none; border-radius: 6px; margin-top: 16px;">
          Agregar producto
        </a>
      </div>
    {% endif %}
  </div>
  
  <!-- Contenedor de notificaciones toast -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // ----------------------------------------------------
  // Funciones para el slider de productos
  // ----------------------------------------------------
  function scrollSlider(categoryId, direction) {
    const slider = document.getElementById(`slider-${categoryId}`);
    if (!slider) return;
    
    const cardWidth = slider.querySelector('.product-card').offsetWidth + 16; // 16px es el gap
    const scrollAmount = cardWidth * 3; // Scroll de 3 productos a la vez
    
    if (direction === 'left') {
      slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
      slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
  }
  
  // ----------------------------------------------------
  // Formateo de entrada de precios con comas de miles
  // ----------------------------------------------------
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  
  // Formatea el precio con comas de miles al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    // Formatea los precios visualizados
    document.querySelectorAll('.current-price').forEach(function(element) {
      const rawPrice = element.textContent.replace('$', '').trim();
      const numPrice = parseFloat(rawPrice);
      if (!isNaN(numPrice)) {
        // Mantiene los decimales originales pero añade comas para miles
        const [intPart, decPart] = rawPrice.split('.');
        element.textContent = '$' + formatNumber(intPart) + (decPart ? '.' + decPart : '.00');
      }
    });
    
    // Formatea los precios de los inputs
    document.querySelectorAll('.price-input').forEach(function(input) {
      const rawPrice = input.value.trim();
      const numPrice = parseFloat(rawPrice);
      if (!isNaN(numPrice)) {
        // Mantiene los decimales originales pero añade comas para miles
        const [intPart, decPart] = rawPrice.split('.');
        input.value = formatNumber(intPart) + (decPart ? '.' + decPart : '.00');
      }
    });
  });
  
  function formatPriceInput(input) {
    // Guardar la posición del cursor
    const startPos = input.selectionStart;
    const endPos = input.selectionEnd;
    
    // Obtener el valor actual sin formato
    let value = input.value.replace(/[^\d.]/g, '');
    
    // Asegurar que solo haya un punto decimal
    const parts = value.split('.');
    if (parts.length > 2) {
      value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    // Limitar estrictamente a dos decimales después del punto decimal
    if (parts.length > 1) {
      value = parts[0] + '.' + parts[1].slice(0, 2);
    }
    
    // Formatear con comas para miles (solo la parte entera)
    let integerPart = parts[0];
    const decimalPart = parts.length > 1 ? '.' + parts[1].slice(0, 2) : '';
    
    // Aplicar formato de miles a la parte entera
    integerPart = formatNumber(integerPart);
    
    // Combinar para obtener el valor final formateado
    const formattedValue = integerPart + decimalPart;
    
    // Actualizar el valor del input
    input.value = formattedValue;
    
    // Ajustar la posición del cursor considerando las comas añadidas
    // Esta lógica es compleja y puede necesitar ajustes según el caso
    // Por simplicidad, intentamos mantener el cursor en una posición razonable
    const lengthDiff = formattedValue.length - value.length;
    if (startPos !== null && endPos !== null) {
      input.setSelectionRange(startPos + lengthDiff, endPos + lengthDiff);
    }
  }
  
  // ----------------------------------------------------
  // Actualizar precio con AJAX
  // ----------------------------------------------------
  function updatePrice(productId, button) {
    const card = button.closest('.product-card');
    const inputContainer = button.closest('.price-input-container');
    const input = inputContainer.querySelector('.price-input');
    const currentPriceElement = document.getElementById(`display-price-${productId}`);
    
    // Obtener el valor sin comas
    const inputValue = input.value.replace(/,/g, '');
    
    // Validar que el precio sea mayor que cero
    const newPrice = parseFloat(inputValue);
    if (isNaN(newPrice) || newPrice <= 0) {
      showToast('El precio debe ser mayor que cero', 'error');
      return;
    }
    
    // Desactivar botón durante la actualización
    button.disabled = true;
    button.textContent = 'Guardando...';
    
    // Enviar actualización al servidor
    fetch(`/api/update_price/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ price: newPrice })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Error al actualizar el precio');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // Formatea el nuevo precio con comas
        const [intPart, decPart] = newPrice.toFixed(2).split('.');
        const formattedPrice = '$' + formatNumber(intPart) + '.' + decPart;
        
        // Actualizar la interfaz
        currentPriceElement.textContent = formattedPrice;
        input.dataset.originalPrice = newPrice;
        
        // Mostrar notificación de éxito
        showToast('Precio actualizado correctamente', 'success');
        
        // Efecto visual de éxito
        card.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
        card.style.boxShadow = '0 0 0 3px rgba(46, 204, 113, 0.3)';
        setTimeout(() => {
          card.style.boxShadow = '';
        }, 1500);
      } else {
        throw new Error(data.message || 'Error al actualizar el precio');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast(error.message, 'error');
    })
    .finally(() => {
      // Restaurar botón
      button.disabled = false;
      button.textContent = 'Guardar';
    });
  }
  
  // ----------------------------------------------------
  // Sistema de notificaciones toast
  // ----------------------------------------------------
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    // Crear elemento toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    // Agregar al contenedor
    toastContainer.appendChild(toast);
    
    // Remover después de la animación
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
  
  // ----------------------------------------------------
  // SOLUCIÓN RADICAL PARA EL ESCÁNER - REDISEÑADA POR COMPLETO
  // ----------------------------------------------------
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const categorySections = document.querySelectorAll('.category-section');
    
    // ==========================================
    // FUNCIÓN DE BÚSQUEDA PRINCIPAL - SIMPLIFICADA
    // ==========================================
    function performSearch(searchTermParam) {
      // Permitir proporcionar el término de búsqueda como parámetro o usar el valor del input
      const searchTerm = (searchTermParam !== undefined) 
        ? searchTermParam.toString().toLowerCase().trim() 
        : searchInput.value.toLowerCase().trim();
      
      console.log(">> EJECUTANDO BÚSQUEDA:", searchTerm);
      
      let resultsCount = 0;
      
      // Obtener estado del filtro de favoritos
      const soloFavoritos = document.getElementById('favoritosCheck').checked;
      
      // Si no hay término de búsqueda y no está activado el filtro de favoritos, mostrar todo
      if (!searchTerm && !soloFavoritos) {
        categorySections.forEach(section => {
          section.style.display = 'block';
          const products = section.querySelectorAll('.product-card');
          products.forEach(product => {
            product.style.display = 'block';
          });
        });
        
        const emptySearch = document.getElementById('emptySearchResults');
        if (emptySearch) {
          emptySearch.style.display = 'none';
        }
        return;
      }
      
      // Filtrar productos por búsqueda y/o favoritos
      categorySections.forEach(section => {
        const products = section.querySelectorAll('.product-card');
        let hasVisibleProducts = false;
        
        products.forEach(product => {
          const productName = product.dataset.productName || '';
          const productBarcode = product.dataset.productBarcode || '';
          const productBrand = product.querySelector('.product-brand')?.textContent?.toLowerCase() || '';
          const esFavorito = product.dataset.favorito === 'True';
          
          // Coincidencia exacta para códigos de barras
          const exactBarcodeMatch = productBarcode === searchTerm;
          
          // Coincidencia parcial para nombre y marca
          const partialNameMatch = productName.includes(searchTerm);
          const partialBrandMatch = productBrand.includes(searchTerm);
          
          // Verificar si cumple con el filtro de búsqueda
          const matchesSearch = !searchTerm || exactBarcodeMatch || partialNameMatch || partialBrandMatch;
          
          // Verificar si cumple con el filtro de favoritos
          const matchesFavorite = !soloFavoritos || esFavorito;
          
          // Mostrar solo si cumple con ambos filtros
          const matches = matchesSearch && matchesFavorite;
          
          product.style.display = matches ? 'block' : 'none';
          
          if (matches) {
            hasVisibleProducts = true;
            resultsCount++;
            
            if (exactBarcodeMatch) {
              // Resaltar el producto con código de barras exacto
              product.style.order = "-1"; // Mover al principio
              product.style.boxShadow = "0 0 0 2px #e52e2e";
              setTimeout(() => {
                product.style.boxShadow = "";
              }, 3000);
            }
          }
        });
        
        section.style.display = hasVisibleProducts ? 'block' : 'none';
      });
      
      // Mensaje sin resultados
      showEmptyOrResults(resultsCount, searchTerm, soloFavoritos);
      
      console.log(`>> BÚSQUEDA COMPLETADA: ${resultsCount} productos encontrados`);
      return resultsCount;
    }
    
    // Función auxiliar para mensaje vacío - MEJORADA con botón de restablecer
    function showEmptyOrResults(count, term, soloFavoritos) {
      let emptySearch = document.getElementById('emptySearchResults');
      
      if (count === 0) {
        if (!emptySearch) {
          emptySearch = document.createElement('div');
          emptySearch.id = 'emptySearchResults';
          emptySearch.className = 'empty-state';
          emptySearch.style.marginTop = '20px'; // Añadido margen superior
          
          let mensaje = '';
          if (term && soloFavoritos) {
            mensaje = `No se encontraron productos favoritos que coincidan con "<strong>${term}</strong>"`;
          } else if (term) {
            mensaje = `No se encontraron productos que coincidan con "<strong>${term}</strong>"`;
          } else if (soloFavoritos) {
            mensaje = `No tienes productos marcados como favoritos`;
          }
          
          emptySearch.innerHTML = `
            <div class="empty-icon">
              <i class="fas fa-search"></i>
            </div>
            <p class="empty-message">${mensaje}</p>
            <button class="btn-reset" onclick="resetSearch()">
              <i class="fas fa-undo-alt" style="margin-right: 8px;"></i>Restablecer
            </button>
          `;
          
          const categoriesContainer = document.getElementById('categoriesContainer');
          categoriesContainer.prepend(emptySearch);
        } else {
          const message = emptySearch.querySelector('.empty-message');
          
          let mensaje = '';
          if (term && soloFavoritos) {
            mensaje = `No se encontraron productos favoritos que coincidan con "<strong>${term}</strong>"`;
          } else if (term) {
            mensaje = `No se encontraron productos que coincidan con "<strong>${term}</strong>"`;
          } else if (soloFavoritos) {
            mensaje = `No tienes productos marcados como favoritos`;
          }
          
          message.innerHTML = mensaje;
          
          // Asegurar que el botón de restablecer esté presente
          if (!emptySearch.querySelector('.btn-reset')) {
            const resetButton = document.createElement('button');
            resetButton.className = 'btn-reset';
            resetButton.innerHTML = '<i class="fas fa-undo-alt" style="margin-right: 8px;"></i>Restablecer';
            resetButton.onclick = resetSearch;
            emptySearch.appendChild(resetButton);
          }
          
          emptySearch.style.display = 'block';
        }
      } else if (emptySearch) {
        emptySearch.style.display = 'none';
      }
    }
    
    // NUEVO: Función para restablecer la búsqueda
    window.resetSearch = function() {
      // Limpiar campo de búsqueda
      if (searchInput) {
        searchInput.value = '';
      }
      
      // Desactivar filtro de favoritos
      const favoritosCheck = document.getElementById('favoritosCheck');
      if (favoritosCheck && favoritosCheck.checked) {
        favoritosCheck.checked = false;
        
        // Actualizar visualización del botón de favoritos
        const heartIcon = document.getElementById('heartIcon');
        const favoritosContainer = document.getElementById('favoritosContainer');
        
        if (heartIcon && favoritosContainer) {
          heartIcon.innerHTML = '&#9825;'; // Corazón vacío
          heartIcon.classList.remove('active');
          favoritosContainer.classList.remove('active');
        }
      }
      
      // Ejecutar búsqueda limpia
      performSearch('');
      
      // Mostrar mensaje
      showToast('Filtros restablecidos', 'success');
    };
    
    // ==========================================
    // FUNCIONES DE ESCANEO - COMPLETAMENTE NUEVAS
    // ==========================================
    
    // HANDLER PRINCIPAL UNIFICADO PARA ESCÁNER
    window.handleScannedCode = function(code) {
      // Alertar del código escaneado
      console.log("🔍 CÓDIGO ESCANEADO:", code);
      
      // Actualizar directamente el input
      if (searchInput) {
        searchInput.value = code;
      }
      
      // Ejecutar búsqueda inmediatamente
      const found = performSearch(code);
      
      // Notificar el resultado
      if (found > 0) {
        showToast(`Encontrado ${found} producto(s) para: ${code}`, 'success');
      } else {
        showToast(`No se encontró ningún producto para el código: ${code}`, 'error');
      }
      
      // Log para fines de diagnóstico
      console.log("🔍 Búsqueda completada para el código:", code);
      return found;
    };
    
    // Reemplazar COMPLETAMENTE las funciones de escaneo existentes
    window.onScannedBarcode = function(code) {
      return window.handleScannedCode(code);
    };
    
    // Registro para eventos de input
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        performSearch();
      });
      
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    }
    
    // Escuchar cambios en el checkbox de favoritos
    const favoritosCheck = document.getElementById('favoritosCheck');
    const heartIcon = document.getElementById('heartIcon');
    const favoritosContainer = document.getElementById('favoritosContainer');
    
    if (favoritosCheck && heartIcon && favoritosContainer) {
      // Función para actualizar el estado visual del botón
      function updateFavoritosButtonState() {
        if (favoritosCheck.checked) {
          heartIcon.innerHTML = '&#9829;'; // Corazón lleno
          heartIcon.classList.add('active');
          favoritosContainer.classList.add('active');
        } else {
          heartIcon.innerHTML = '&#9825;'; // Corazón vacío
          heartIcon.classList.remove('active');
          favoritosContainer.classList.remove('active');
        }
      }
      
      // Evento de clic en el contenedor completo
      favoritosContainer.addEventListener('click', function() {
        favoritosCheck.checked = !favoritosCheck.checked;
        updateFavoritosButtonState();
        performSearch();
      });
    }
    
    // PARCHE INVASIVO PARA BARCODE SCANNER
    try {
      // No sobrescribir el initBarcodeScanner original si existe
      const originalInitBarcodeScanner = window.initBarcodeScanner;
      
      if (typeof originalInitBarcodeScanner === 'function') {
        // Creamos una versión envolvente que aplica nuestro handler
        window.initBarcodeScanner = function(scanIconSelector, inputSelector, options) {
          console.log("⚙️ Inicializando escáner mejorado");
          
          // Llamar a la implementación original
          originalInitBarcodeScanner(scanIconSelector, inputSelector, options);
          
          // IMPORTANTE: Agregar un listener directo al input
          const inputElement = document.querySelector(inputSelector);
          if (inputElement) {
            // Monitorear cambios en el valor directamente
            let lastValue = inputElement.value;
            
            // Usar MutationObserver para detectar cambios directos en el DOM
            const inputObserver = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                  const newValue = inputElement.value;
                  if (newValue !== lastValue) {
                    console.log("⚠️ Input value changed:", newValue);
                    lastValue = newValue;
                    // Ejecutar búsqueda con el nuevo valor
                    performSearch(newValue);
                  }
                }
              });
            });
            
            inputObserver.observe(inputElement, { attributes: true });
            
            // También usar setInterval como última línea de defensa
            setInterval(function() {
              const currentValue = inputElement.value;
              if (currentValue !== lastValue && currentValue.trim() !== '') {
                console.log("⚠️ Cambio detectado en intervalo:", currentValue);
                lastValue = currentValue;
                // Ejecutar búsqueda con el nuevo valor
                performSearch(currentValue);
              }
            }, 300);
          }
        };
      }
    } catch (e) {
      console.error("Error al parchear initBarcodeScanner:", e);
    }
    
    // PARCHE PARA QUAGGA.JS
    try {
      // Reemplazar completamente iniciarEscaneoQuagga si existe
      const originalIniciarEscaneoQuagga = window.iniciarEscaneoQuagga;
      
      if (typeof originalIniciarEscaneoQuagga === 'function') {
        window.iniciarEscaneoQuagga = function() {
          console.log("⚙️ Iniciando Quagga mejorado");
          
          // Llamar a la implementación original
          originalIniciarEscaneoQuagga();
          
          // Parchear Quagga.onDetected después de un breve retraso
          setTimeout(function() {
            if (window.Quagga) {
              console.log("⚙️ Quagga detectado, aplicando parche");
              
              // Guardar la implementación original
              const originalOnDetected = window.Quagga.onDetected;
              
              // Reemplazar con nuestra versión
              window.Quagga.onDetected = function(result) {
                // Primero llamar a la implementación original
                if (typeof originalOnDetected === 'function') {
                  originalOnDetected(result);
                }
                
                // Luego manejar el código con nuestra función unificada
                if (result && result.codeResult && result.codeResult.code) {
                  console.log("📷 Quagga detectó:", result.codeResult.code);
                  window.handleScannedCode(result.codeResult.code);
                }
              };
            }
          }, 500);
        };
      }
    } catch (e) {
      console.error("Error al parchear iniciarEscaneoQuagga:", e);
    }
    
    // Inicializar manualmente el escáner físico si existe
    if (typeof window.initBarcodeScanner === 'function' && document.getElementById('scanIcon')) {
      window.initBarcodeScanner('#scanIcon', '#searchInput');
      console.log("⚙️ Escáner físico inicializado manualmente");
    }
    
    // TRUCO ADICIONAL: monitor para cambios en searchInput desde cualquier fuente
    if (searchInput) {
      let lastKnownValue = searchInput.value;
      
      // Verificar cada 100ms si hay cambios en el valor
      setInterval(function() {
        const currentValue = searchInput.value;
        if (currentValue !== lastKnownValue && currentValue.trim() !== '') {
          console.log("⚠️ Se detectó cambio en searchInput:", currentValue);
          lastKnownValue = currentValue;
          performSearch(currentValue);
        }
      }, 100);
    }
  });
</script>
{% endblock %}