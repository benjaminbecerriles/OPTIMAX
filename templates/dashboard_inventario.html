{% extends 'dashboard_base.html' %}

{% block title %}Inventario - OptiMax Manage{% endblock %}

{% block inventario_active %}active{% endblock %}

{% block extra_css %}
<!-- CSS Moderno del Dashboard -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_modern.css') }}">

<!-- AOS (Animate On Scroll) -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
{% endblock %}

{% block page_header %}
<!-- Header personalizado para el diseño moderno -->
{% endblock %}

{% block content %}
<!-- Particles Background -->
<div id="particles-js"></div>

<!-- Main Dashboard Container -->
<div class="dashboard-container">
  
  <!-- Hero Section Simple -->
  <div class="hero-section" data-aos="fade-down">
    <h1 class="hero-title">
      <span class="gradient-text">Inventario</span>
    </h1>
    <p class="hero-description">
      Gestiona tus productos, stock y precios de manera eficiente.
    </p>
  </div>

  <!-- Estadísticas (IGUAL QUE EL ORIGINAL) -->
  <section class="stats-section">
    <h2 class="section-title" data-aos="fade-right">
      <span>Datos generales</span>
      <span class="title-line"></span>
    </h2>
    
    <div class="stats-grid">
      <!-- Total Productos -->
      <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
        <div class="stat-content">
          <div class="stat-number" data-value="{{ total_productos|default(0) }}">0</div>
          <div class="stat-label">Total productos</div>
        </div>
        <div class="stat-glow"></div>
      </div>
      
      <!-- Unidades en Stock -->
      <div class="stat-card purple" data-aos="fade-up" data-aos-delay="200">
        <div class="stat-content">
          <div class="stat-number" data-value="{{ total_unidades|default(0) }}">0</div>
          <div class="stat-label">Unidades en stock</div>
        </div>
        <div class="stat-glow purple"></div>
      </div>
      
      <!-- Valor del Inventario -->
      <div class="stat-card gold" data-aos="fade-up" data-aos-delay="300">
        <div class="stat-content">
          <div class="stat-number">$<span data-value="{{ valor_inventario|default(0) }}" data-format="currency">0</span></div>
          <div class="stat-label">Valor del inventario</div>
        </div>
        <div class="stat-glow gold"></div>
      </div>
      
      <!-- Productos por Agotarse -->
      <div class="stat-card red" data-aos="fade-up" data-aos-delay="400">
        <div class="stat-content">
          {% set productos_agotarse = productos|selectattr('stock', 'gt', 0)|selectattr('stock', 'le', 5)|list|length if productos else 0 %}
          <div class="stat-number" data-value="{{ productos_agotarse }}">0</div>
          <div class="stat-label">Productos por agotarse</div>
        </div>
        <div class="stat-glow red"></div>
      </div>
    </div>
  </section>

  <!-- Herramientas (IGUAL QUE EL ORIGINAL) -->
  <section class="tools-section">
    <h2 class="section-title" data-aos="fade-right">
      <span>Herramientas</span>
      <span class="title-line"></span>
    </h2>
    
    <div class="tools-grid">
      <a href="{{ url_for('nuevo_producto') }}" class="tool-card" data-aos="zoom-in" data-aos-delay="100">
        <div class="tool-icon">
          <i class="fas fa-barcode"></i>
        </div>
        <span class="tool-name">Registrar producto</span>
      </a>
      
      <a href="{{ url_for('ajuste_stock') }}" class="tool-card" data-aos="zoom-in" data-aos-delay="200">
        <div class="tool-icon purple">
          <i class="fas fa-plus-minus"></i>
        </div>
        <span class="tool-name">Ajuste de stock</span>
      </a>
      
      <a href="{{ url_for('cambiar_precios') }}" class="tool-card" data-aos="zoom-in" data-aos-delay="300">
        <div class="tool-icon green">
          <i class="fas fa-tag"></i>
        </div>
        <span class="tool-name">Cambiar precios</span>
      </a>
      
      <a href="{{ url_for('descuentos') }}" class="tool-card" data-aos="zoom-in" data-aos-delay="400">
        <div class="tool-icon orange">
          <i class="fas fa-percent"></i>
        </div>
        <span class="tool-name">Descuentos</span>
      </a>
      
      <a href="{{ url_for('ubicacion_productos') }}" class="tool-card" data-aos="zoom-in" data-aos-delay="500">
        <div class="tool-icon red">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <span class="tool-name">Ubicación</span>
      </a>
    </div>
  </section>

  <!-- Ver y gestionar productos (TABLA IGUAL QUE EL ORIGINAL) -->
  <section class="products-section">
    <div class="section-header" data-aos="fade-right">
      <h2 class="section-title">
        <span>Ver y gestionar productos</span>
        <span class="title-line"></span>
      </h2>
    </div>
    
    {% if productos and productos|length > 0 %}
      <div class="products-table-container" data-aos="fade-up">
        <table class="products-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Categoría</th>
              <th>Stock</th>
              <th>Precio</th>
              <th>Marca</th>
            </tr>
          </thead>
          <tbody>
            {% for p in productos[:2] %}
              <tr>
                <td>
                  <div class="product-cell">
                    {% if p.foto %}
                      <img src="{{ url_for('static', filename='uploads/' ~ p.foto) }}" class="product-image" alt="{{ p.nombre }}">
                    {% else %}
                      <div class="product-image placeholder">
                        <i class="fas fa-box"></i>
                      </div>
                    {% endif %}
                    <div class="product-info">
                      <div class="product-name">{{ p.nombre }}</div>
                      <div class="product-sku">
                        {% if p.codigo_barras_externo %}
                          {{ p.codigo_barras_externo }}
                        {% else %}
                          SKU-{{ '%05d' % p.id }}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </td>
                
                <td>
                  {% set cat_color = p.categoria_color|default('#6366f1') %}
                  <span class="badge-category" style="--cat-color: {{ cat_color }}">
                    {{ p.categoria|default('Sin categoría')|title }}
                  </span>
                </td>
                
                <td>
                  {% if p.stock <= 0 %}
                    <span class="badge badge-red">{{ '{:,}'.format(p.stock) }} unidades</span>
                  {% elif p.stock < 5 %}
                    <span class="badge badge-orange">{{ '{:,}'.format(p.stock) }} unidades</span>
                  {% else %}
                    <span class="badge badge-green">{{ '{:,}'.format(p.stock) }} unidades</span>
                  {% endif %}
                </td>
                
                <td>${{ '{:,.2f}'.format(p.precio_venta) }}</td>
                
                <td>{{ p.marca|default('—') }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <div class="view-all-container">
        <a href="{{ url_for('ver_productos') }}" class="view-all-btn">
          Ver todos
          <i class="fas fa-arrow-right"></i>
        </a>
      </div>
    {% else %}
      <div class="empty-state" data-aos="fade-up">
        <div class="empty-icon">
          <i class="fas fa-box-open"></i>
        </div>
        <p class="empty-message">No hay productos en tu inventario</p>
      </div>
    {% endif %}
  </section>

  <!-- Alertas (IGUAL QUE EL ORIGINAL) -->
  <section class="alerts-section">
    <div class="alerts-grid">
      <!-- Productos por agotarse -->
      <div class="alert-box" data-aos="fade-up" data-aos-delay="100">
        <div class="alert-header">
          <h3 class="alert-title">Productos por agotarse</h3>
        </div>
        
        {% set low_stock = productos|selectattr('stock', 'gt', 0)|selectattr('stock', 'le', 5)|list if productos else [] %}
        {% if low_stock|length > 0 %}
          {% for p in low_stock %}
            {% if loop.index <= 5 %}
              <div class="alert-item">
                <div class="alert-content">{{ p.nombre }}</div>
                <div class="alert-value">{{ '{:,}'.format(p.stock) }}</div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="empty-state-small">
            <div class="empty-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <p class="empty-message">No hay productos por agotarse</p>
          </div>
        {% endif %}
      </div>
      
      <!-- Notificaciones -->
      <div class="alert-box" data-aos="fade-up" data-aos-delay="200">
        <div class="alert-header">
          <h3 class="alert-title">Notificaciones</h3>
        </div>
        
        <div class="empty-state-small">
          <div class="empty-icon">
            <i class="fas fa-bell"></i>
          </div>
          <p class="empty-message">No hay notificaciones</p>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<!-- GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<!-- Particles.js -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<!-- AOS -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<!-- CountUp.js -->
<script src="https://cdn.jsdelivr.net/npm/countup.js@2.8.0/dist/countUp.min.js"></script>

<!-- Dashboard Animations Simplificado -->
<script src="{{ url_for('static', filename='js/dashboard_animations.js') }}"></script>

<!-- Datos para JavaScript -->
<script>
  // Verificar que los datos se están pasando correctamente
  window.dashboardData = {
    totalProductos: {{ total_productos|default(0)|int }},
    totalUnidades: {{ total_unidades|default(0)|int }},
    valorInventario: {{ valor_inventario|default(0)|int }},
    productosAgotarse: {{ productos_agotarse|default(0)|int }}
  };
  
  // Debug en consola
  console.log('Datos del Dashboard:', window.dashboardData);
</script>
{% endblock %}