{% extends 'base.html' %}

{% block title %}
  Registrar Entrada - {{ producto.nombre }}
{% endblock %}

{% block content %}
<style>
  /* Diseño elegante inspirado en Apple */
  :root {
    --font-system: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    --text-color: #1d1d1f;
    --text-secondary: #6b7280; /* Gris neutral sin tinte azul */
    --color-background: #f5f5f7;
    --color-card: #ffffff;
    --color-border: rgba(0, 0, 0, 0.1);
    --color-primary: #e52e2e; /* Rojo para botón guardar */
    --color-accent: #0066cc; /* Azul Apple para selecciones */
    --color-success: #34c759; /* Verde Apple */
    --color-warning: #ff9f0a; /* Naranja Apple */
    --color-danger: #ff3b30; /* Rojo Apple */
    --border-radius: 12px;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    --blue: #1a237e; /* Añadido: Azul para botón volver igual que en ajuste_stock */
    --color-green-dark: #1F4034; /* Verde oscuro para notas */
    --color-orange: #f59e0b; /* Naranja para caducidad */
    --color-blue-medium: #3b82f6; /* Azul medio para comprobante */
    --color-purple: #8b5cf6; /* Morado para costo */
    --premium-dark: #0f172a; /* Añadido para el título */
    --premium-gray-light: #6b7280; /* Gris neutral sin tinte azul */
  }
  
  body {
    font-family: var(--font-system);
    color: var(--text-color);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    background-color: var(--color-background);
    margin: 0;
    padding: 0;
  }
  
  .entry-container {
    width: 100%;
    margin: 0;
    padding: 1.5rem 0 2.25rem; /* Solo padding vertical */
    animation: fadeIn 0.6s ease-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Encabezado de página - Como en ajuste_stock.html */
  .page-header {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start; /* Cambiado de center a flex-start */
    margin-bottom: 2.5rem; /* Balance óptimo - boxes más arriba */
    text-align: left; /* Cambiado de center a left */
    position: relative;
    z-index: 1;
    max-width: 1200px; /* Mismo ancho que two-column-layout */
    margin-left: auto;
    margin-right: auto;
    padding: 0 1.5rem; /* Mismo padding que entry-container */
  }
  

  /* Efecto hover sutil al pasar por el header */
  .page-header:hover .page-title {
    transform: translateX(3px); /* Movimiento sutil hacia la derecha */
  }
  
  .page-header:hover .page-description {
    transform: translateX(3px); /* Mismo movimiento para la descripción */
    transition-delay: 0.05s; /* Pequeño retraso para efecto cascada */
  }
  
  /* TÍTULO CON ESTILO DE AJUSTE_STOCK.HTML */
  .page-title {
    font-size: 34px; /* Ligeramente reducido para mejor proporción */
    font-weight: 900; /* Aumentado para más peso visual */
    color: var(--premium-dark);
    margin: 0;
    padding: 0; /* Asegurar que no haya padding */
    letter-spacing: -0.04em;
    line-height: 1; /* Compacto pero sin que se superpongan */
    text-shadow: none;
    cursor: pointer;
    position: relative;
    display: block; /* Cambiado de inline-block a block */
    transition: transform 0.3s ease;
  }
  
  /* Gradiente animado al hover - sin desaparecer el texto */
  .page-title::after {
    content: attr(data-text);
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    opacity: 0;
    transition: opacity 0.3s ease;
    animation: gradientMove 1.5s ease infinite;
    display: block; /* Añadido para asegurar que sea block */
  }
  
  .page-title:hover::after {
    opacity: 1;
  }
  
  @keyframes gradientMove {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }
  
  /* Palabras individuales para animación de revelado */
  .page-title .word {
    display: inline-block;
    opacity: 0;
    transform: translateY(15px);
    animation: wordReveal 0.3s ease forwards;
  }
  
  .page-title .word:nth-child(1) { animation-delay: 0.03s; }
  .page-title .word:nth-child(2) { animation-delay: 0.06s; }
  
  @keyframes wordReveal {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Descripción debajo del título - NUEVO */
  .page-description {
    font-size: 1.0625rem; /* Ligeramente reducido de 1.125rem */
    color: #4b5563; /* Gris más oscuro sin tinte azul */
    margin-top: 0.5rem; /* Balance final perfecto entre proximidad y separación */
    margin-bottom: 0;
    padding: 0; /* Asegurar que no haya padding */
    line-height: 1.4; /* Más compacto */
    font-weight: 500; /* Aumentado para mejor legibilidad */
    cursor: pointer;
    position: relative;
    display: block; /* Cambiado de inline-block a block */
    transition: transform 0.3s ease;
  }

  /* Gradiente animado al hover para descripción */
  .page-description::after {
    content: attr(data-text);
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #4b5563 0%, #6b7280 50%, #4b5563 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    opacity: 0;
    transition: opacity 0.3s ease;
    animation: gradientMove 1.5s ease infinite;
    display: block; /* Añadido para asegurar que sea block */
  }

  .page-description:hover::after {
    opacity: 1;
  }

  /* Palabras individuales para la descripción */
  .page-description .word {
    display: inline-block;
    opacity: 0;
    transform: translateY(15px);
    animation: wordReveal 0.3s ease forwards;
  }

  .page-description .word:nth-child(1) { animation-delay: 0.07s; }
  .page-description .word:nth-child(2) { animation-delay: 0.09s; }
  .page-description .word:nth-child(3) { animation-delay: 0.11s; }
  .page-description .word:nth-child(4) { animation-delay: 0.13s; }
  .page-description .word:nth-child(5) { animation-delay: 0.15s; }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
  }
  
  /* Botones con estilo Apple */
  .btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: var(--transition);
    text-decoration: none;
    cursor: pointer;
    border: none;
    text-align: center;
  }
  
  .btn-icon i, 
  .btn-icon span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1;
  }
  
  .btn-outline {
    background-color: var(--color-card);
    color: var(--text-color);
    border: 1px solid var(--color-border);
  }
  
  .btn-outline:hover {
    background-color: #f2f2f2;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  /* Botón Volver estilo ajuste_stock.html */
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }
  
  /* Botón Confirmar Entrada - NUEVO DISEÑO AZUL OSCURO */
  .btn-confirm {
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
    text-decoration: none;
    width: 100%;
    justify-content: center;
  }
  
  .btn-confirm:hover {
    background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.35);
    color: white;
  }
  
  .btn-confirm:active {
    transform: translateY(0);
  }
  
  .btn-confirm i {
    font-size: 1.125rem;
  }
  
  /* Contenedor para el botón debajo del formulario */
  .form-actions {
    margin-top: 2rem;
    padding: 0 24px 24px;
  }
  
  .btn-primary {
    background-color: var(--color-primary);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #d12323;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(229, 46, 46, 0.25);
  }
  
  /* Diseño de dos columnas con misma altura */
  .two-column-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    grid-auto-rows: minmax(min-content, max-content);
    gap: 24px;
    opacity: 0;
    transform: translateY(10px);
    animation: contentFadeIn 0.5s ease-out 0.2s forwards;
    max-width: 1200px;
    margin: 0 auto 24px; /* Centrado con margin bottom */
    padding: 0 1.5rem; /* Mismo padding que el header */
  }
  
  @keyframes contentFadeIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Panel de producto */
  .product-panel {
    background-color: var(--color-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    height: auto; /* Altura automática */
    display: flex;
    flex-direction: column;
  }
  
  .product-image-container {
    width: 100%;
    height: 250px;
    overflow: hidden;
    position: relative;
    background-color: var(--color-background);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .product-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: var(--transition);
  }
  
  .product-info {
    padding: 24px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .product-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0 0 16px 0;
    line-height: 1.3;
  }
  
  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--color-border);
  }
  
  .info-row:last-child {
    border-bottom: none;
    margin-bottom: auto;
  }
  
  .info-label {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
  }
  
  .info-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-color);
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
  }
  
  .badge-success {
    background-color: rgba(52, 199, 89, 0.12);
    color: var(--color-success);
  }
  
  .badge-warning {
    background-color: rgba(255, 159, 10, 0.12);
    color: var(--color-warning);
  }
  
  .badge-danger {
    background-color: rgba(255, 59, 48, 0.12);
    color: var(--color-danger);
  }
  
  /* Formulario compacto */
  .entry-form {
    background-color: var(--color-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    height: auto;
    display: flex;
    flex-direction: column;
  }
  
  .form-body {
    padding: 24px;
    flex-grow: 1;
  }
  
  .form-section {
    margin-bottom: 24px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
  }
  
  .form-control {
    display: block;
    width: 100%;
    padding: 12px 14px;
    font-size: 15px;
    line-height: 1.5;
    color: var(--text-color);
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    transition: var(--transition);
  }
  
  .form-control:focus {
    border-color: var(--color-accent);
    outline: 0;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15);
  }
  
  /* Estilo para campos con error */
  .form-control.error {
    border-color: var(--color-danger);
    box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.15);
  }
  
  /* Select con ícono */
  .select-container {
    position: relative;
  }
  
  .select-container .form-control {
    padding-right: 40px;
    appearance: none;
  }
  
  .select-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    pointer-events: none;
    font-size: 16px;
  }
  
  /* Estilos generales para form-check (usado en otras partes) */
  .form-check {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    padding: 14px 0;
  }
  
  .form-check-input {
    width: 18px;
    height: 18px;
    margin: 0;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    transition: var(--transition);
    flex-shrink: 0;
    cursor: pointer;
  }
  
  .form-check-input:checked {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
  }
  
  .form-check-label {
    font-size: 15px;
    color: var(--text-color);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    cursor: pointer;
    user-select: none;
  }
  
  /* Input con unidad */
  .quantity-input-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .quantity-input-container .form-control {
    padding-right: 70px;
  }

  .unit-indicator {
    position: absolute;
    right: 14px;
    color: var(--text-secondary);
    pointer-events: none;
    font-size: 14px;
    font-weight: 500;
  }
  
  /* Dropdown para costo */
  #costoContainer {
    margin-top: 8px;
    padding-top: 0;
    border-top: none;
  }
  
  .aligned-cost-field {
    padding-left: 40px;
    padding-right: 16px;
  }
  
  .aligned-cost-field .form-label {
    margin-bottom: 8px;
  }
  
  .aligned-cost-field .input-group {
    max-width: 300px;
  }
  
  .input-group-text {
    display: flex;
    align-items: center;
    padding: 12px 14px;
    font-size: 15px;
    font-weight: 500;
    line-height: 1.5;
    color: var(--text-color);
    text-align: center;
    white-space: nowrap;
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-right: 0;
    border-radius: 10px 0 0 10px;
  }
  
  .input-group .form-control {
    position: relative;
    flex: 1 1 auto;
    width: 1%;
    min-width: 0;
    border-radius: 0 10px 10px 0;
  }
  
  /* Toggle estilo Apple */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e4e4e4;
    transition: .4s;
    border-radius: 34px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: var(--color-accent);
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(20px);
  }
  
  /* Selección de caducidad */
  .expiry-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 0;
    background-color: transparent;
    border-radius: 0;
    margin-top: 0;
  }
  
  .expiry-option {
    position: relative;
  }
  
  .expiry-option input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }
  
  .expiry-option label {
    display: inline-block;
    padding: 8px 12px;
    font-size: 14px;
    background-color: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    color: var(--text-color);
  }
  
  .expiry-option label:hover {
    background-color: #f2f2f2;
  }
  
  .expiry-option input:checked + label {
    background-color: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }
  
  /* Secciones colapsables estilo Apple MEJORADO */
  .collapse-section {
    margin-bottom: 16px;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    overflow: hidden;
  }
  
  .collapse-header {
    padding: 14px 16px;
    padding-left: 40px;
    background-color: var(--color-card);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-color);
    user-select: none;
    position: relative;
  }
  
  .collapse-header:hover {
    background-color: #f5f5f7;
  }
  
  .collapse-header span {
    display: flex;
    align-items: center;
  }
  
  .collapse-header i.fa-chevron-down,
  .collapse-header i.fa-chevron-up {
    color: var(--text-secondary);
    transition: transform 0.3s ease;
  }
  
  /* Variante de header con toggle integrado */
  .collapse-header-with-toggle {
    padding: 14px 16px;
    padding-left: 40px;
    background-color: var(--color-card);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-color);
    user-select: none;
    position: relative;
  }
  
  .collapse-header-with-toggle:hover {
    background-color: #f5f5f7;
  }
  
  .collapse-header-with-toggle > i {
    position: absolute;
    left: 16px;
    font-size: 16px;
    width: 16px;
    text-align: center;
  }
  
  .collapse-header-with-toggle .fa-dollar-sign {
    color: #000000; /* Negro en lugar de morado */
    font-weight: 900; /* Negritas */
  }
  
  .collapse-header-with-toggle .fa-calendar-times {
    color: var(--color-orange);
  }
  
  /* Iconos de las secciones colapsables con posición absoluta */
  .collapse-header .fa-sticky-note,
  .collapse-header .fa-file-invoice {
    position: absolute;
    left: 16px;
    font-size: 16px;
    width: 16px;
    text-align: center;
  }
  
  .collapse-header .fa-sticky-note {
    color: var(--color-green-dark);
  }
  
  .collapse-header .fa-file-invoice {
    color: var(--color-blue-medium);
  }
  
  .collapse-header.active i.fa-chevron-down {
    transform: rotate(180deg);
  }
  
  .collapse-content {
    padding: 16px;
    border-top: 1px solid var(--color-border);
    display: none;
    animation: slideDown 0.3s ease-out;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Ajuste para texto largo en headers con toggle */
  .collapse-header-with-toggle > span {
    flex: 1;
    margin-right: 10px;
  }
  
  /* Ajuste especial para el contenido de costo */
  .collapse-content .input-group {
    max-width: 300px;
  }
  
  .collapse-content .form-label {
    margin-bottom: 8px;
  }
  
  /* Notificación centrada estilo Apple */
  .notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .notification-container {
    background-color: white;
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    width: 350px;
    max-width: 90%;
    padding: 24px;
    text-align: center;
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }
  
  .notification-icon {
    color: var(--color-danger);
    font-size: 32px;
    margin-bottom: 16px;
  }
  
  .notification-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  
  .notification-message {
    font-size: 15px;
    margin-bottom: 16px;
    color: var(--text-secondary);
  }
  
  .notification-example {
    background-color: #f5f5f7;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 20px;
    font-size: 14px;
  }
  
  .notification-button {
    background-color: var(--color-accent);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .notification-button:hover {
    background-color: #0055b3;
  }
  
  .notification-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .notification-overlay.active .notification-container {
    transform: translateY(0);
  }
  
  /* Responsive design */
  @media (max-width: 992px) {
    .two-column-layout {
      grid-template-columns: 1fr;
      padding: 0 1rem; /* Padding reducido en móvil */
    }
    
    .form-row {
      grid-template-columns: 1fr;
      gap: 16px;
    }
  }
  
  @media (max-width: 768px) {
    .entry-container {
      padding: 1rem 0 1.25rem; /* Solo padding vertical en móvil */
    }
    
    .page-header {
      flex-direction: column;
      gap: 0; /* Eliminado también en móvil */
      margin-bottom: 1.5rem; /* Ajustado proporcionalmente en móvil */
      text-align: left; /* Mantener alineación izquierda en móvil */
      padding: 0 1rem; /* Ajustado padding en móvil */
    }
    
    .page-title {
      font-size: 26px; /* Más pequeño en móvil */
      line-height: 1;
    }
    
    .page-description {
      font-size: 0.9375rem; /* Más pequeño en móvil */
      margin-top: 0.5rem; /* Consistente con el diseño principal */
    }
    
    .header-actions {
      width: 100%;
      justify-content: space-between;
      padding-top: 0;
    }
    
    .product-image-container {
      height: 200px;
    }
  }
</style>

<div class="entry-container">
  <!-- Encabezado con título sin acciones -->
  <div class="page-header">
    <h1 class="page-title" data-text="Registrar Entrada">
      <span class="word">Registrar</span>
      <span class="word">Entrada</span>
    </h1>
    <p class="page-description" data-text="Añade stock a tu inventario">
      <span class="word">Añade</span>
      <span class="word">stock</span>
      <span class="word">a</span>
      <span class="word">tu</span>
      <span class="word">inventario</span>
    </p>
  </div>
  
  <!-- Diseño de dos columnas con misma altura -->
  <div class="two-column-layout">
    <!-- Panel de producto (izquierda) -->
    <div class="product-panel">
      <div class="product-image-container">
        {% if producto.foto %}
          <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" alt="{{ producto.nombre }}" class="product-image">
        {% else %}
          <img src="{{ url_for('static', filename='img/default_product.jpg') }}" alt="Imagen predeterminada" class="product-image">
        {% endif %}
      </div>
      <div class="product-info">
        <h2 class="product-title">{{ producto.nombre }}</h2>
        
        <div class="info-row">
          <span class="info-label">Stock actual</span>
          <span class="info-value">
            {% if producto.stock <= 0 %}
              <span class="badge badge-danger">Sin stock</span>
            {% elif producto.stock < 6 %}
              <span class="badge badge-warning">
                {% if producto.stock|int >= 1000 %}
                  {{ "{:,}".format(producto.stock|int).replace(',', ',') }}
                {% else %}
                  {{ producto.stock|int }}
                {% endif %}
                {% if producto.unidad and producto.unidad != 'NONE' %}
                  {{ producto.unidad }}
                {% else %}
                  {% if producto.stock == 1 %}pieza{% else %}piezas{% endif %}
                {% endif %}
              </span>
            {% else %}
              <span class="badge badge-success">
                {% if producto.stock|int >= 1000 %}
                  {{ "{:,}".format(producto.stock|int).replace(',', ',') }}
                {% else %}
                  {{ producto.stock|int }}
                {% endif %}
                {% if producto.unidad and producto.unidad != 'NONE' %}
                  {{ producto.unidad }}
                {% else %}
                  {% if producto.stock == 1 %}pieza{% else %}piezas{% endif %}
                {% endif %}
              </span>
            {% endif %}
          </span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Costo actual por 
            {% if producto.unidad and producto.unidad != 'NONE' %}
              {{ producto.unidad }}
            {% else %}
              pieza
            {% endif %}
          </span>
          <span class="info-value" id="costoActualValue">${{ producto.costo|round(2) }}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Precio de venta por 
            {% if producto.unidad and producto.unidad != 'NONE' %}
              {{ producto.unidad }}
            {% else %}
              pieza
            {% endif %}
          </span>
          <span class="info-value" id="precioVentaValue">${{ producto.precio_venta|round(2) }}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Código</span>
          <span class="info-value">{{ producto.codigo_barras_externo }}</span>
        </div>
      </div>
    </div>
    
    <!-- Formulario de entrada (derecha) -->
    <form method="POST" action="{{ url_for('ajuste_entrada', producto_id=producto.id) }}" enctype="multipart/form-data" id="entradaForm">
      <div class="entry-form">
        <div class="form-body">
          <!-- Sección principal -->
          <div class="form-section">
            <div class="form-row">
              <div class="form-group">
                <label for="cantidad" class="form-label">Cantidad a añadir</label>
                <div class="quantity-input-container">
                  <input type="text" 
                         class="form-control" 
                         id="cantidad" 
                         name="cantidad" 
                         required 
                         value="1"
                         inputmode="decimal">
                  <span class="unit-indicator" id="unidadIndicator">
                    {% if producto.unidad %}
                      {% if producto.unidad == 'pieza' %}PIEZA{% else %}{{ producto.unidad|upper }}{% endif %}
                    {% else %}
                      PIEZA
                    {% endif %}
                  </span>
                </div>
              </div>
              
              <div class="form-group">
                <label for="motivo" class="form-label">Motivo</label>
                <div class="select-container">
                  <select class="form-control" id="motivo" name="motivo" required>
                    <option value="compra">Compra a proveedor</option>
                    <option value="devolucion">Devolución de cliente</option>
                    <option value="ajuste">Ajuste de inventario</option>
                    <option value="transferencia">Transferencia entre sucursales</option>
                    <option value="otro">Otro motivo</option>
                  </select>
                  <span class="select-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sección de costo colapsable -->
          <div class="collapse-section">
            <div class="collapse-header-with-toggle">
              <i class="fas fa-dollar-sign"></i>
              <span id="mantenerCostoLabel">Mantener costo anterior ({% if ultima_entrada and ultima_entrada.costo_unitario %}${{ ultima_entrada.costo_unitario|round(2) }}{% else %}${{ producto.costo|round(2) }}{% endif %} por {% if producto.unidad and producto.unidad != 'NONE' %}{{ producto.unidad }}{% else %}pieza{% endif %})</span>
              <label class="toggle-switch">
                <input type="checkbox" id="mantener_costo_anterior" name="mantener_costo_anterior" checked onchange="toggleCostoSection()">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="collapse-content" id="costoSection" style="display:none;">
              <label for="costo_unitario" class="form-label">Nuevo costo (por 
                {% if producto.unidad and producto.unidad != 'NONE' %}
                  {{ producto.unidad }}
                {% else %}
                  pieza
                {% endif %})
              </label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="text" 
                       class="form-control" 
                       id="costo_unitario" 
                       name="costo_unitario" 
                       oninput="formatCostRealtime(this)"
                       value="{{ producto.costo|round(2) }}">
              </div>
              <input type="hidden" id="actualizar_costo" name="actualizar_costo" value="on">
              <input type="hidden" id="costo_unitario_real" name="costo_unitario_real" value="{{ producto.costo|round(2) }}">
            </div>
          </div>
          
          <!-- Sección de caducidad colapsable -->
          <div class="collapse-section">
            <div class="collapse-header-with-toggle">
              <i class="fas fa-calendar-times"></i>
              <span>Fecha de caducidad</span>
              <label class="toggle-switch">
                <input type="checkbox" id="toggle_caducidad" onchange="toggleCaducidadSection()">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="collapse-content" id="caducidadSection" style="display:none;">
              <input type="hidden" id="toggle_caducidad_estado" name="toggle_caducidad_estado" value="DESACTIVADO">
              <div class="expiry-options">
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad1dia" value="1 día">
                  <label for="cad1dia">1 día</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad3dias" value="3 días">
                  <label for="cad3dias">3 días</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad1sem" value="1 semana">
                  <label for="cad1sem">1 semana</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad2sem" value="2 semanas">
                  <label for="cad2sem">2 semanas</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad1mes" value="1 mes">
                  <label for="cad1mes">1 mes</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad3meses" value="3 meses">
                  <label for="cad3meses">3 meses</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad6meses" value="6 meses">
                  <label for="cad6meses">6 meses</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad1ano" value="1 año">
                  <label for="cad1ano">1 año</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad2anos" value="2 años">
                  <label for="cad2anos">2 años</label>
                </div>
                <div class="expiry-option">
                  <input type="radio" name="caducidad_lapso" id="cad3anos" value="3 años">
                  <label for="cad3anos">+3 años</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Opciones adicionales colapsables -->
          <div class="collapse-section">
            <div class="collapse-header" onclick="toggleCollapse('notasSection')">
              <i class="fas fa-sticky-note"></i>
              <span>Notas adicionales</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="collapse-content" id="notasSection">
              <input type="hidden" id="toggle_notas_estado" name="toggle_notas_estado" value="DESACTIVADO">
              <textarea class="form-control" id="notas" name="notas" rows="2" placeholder="Información adicional..."></textarea>
            </div>
          </div>
          
          <div class="collapse-section">
            <div class="collapse-header" onclick="toggleCollapse('comprobanteSection')">
              <i class="fas fa-file-invoice"></i>
              <span>Adjuntar comprobante</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="collapse-content" id="comprobanteSection">
              <input type="hidden" id="toggle_comprobante_estado" name="toggle_comprobante_estado" value="DESACTIVADO">
              <input type="file" class="form-control" id="comprobante" name="comprobante">
            </div>
          </div>
        </div>
        
        <!-- Botón Confirmar Entrada - Movido aquí dentro del formulario -->
        <div class="form-actions">
          <button type="submit" class="btn-icon btn-confirm">
            <i class="fas fa-check-circle"></i>
            <span>Confirmar entrada</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Notificación centrada - Añadido para formato inválido -->
<div class="notification-overlay" id="notificationOverlay">
  <div class="notification-container">
    <div class="notification-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <div class="notification-title">Formato incorrecto</div>
    <div class="notification-message">Debe incluir un dígito antes del punto decimal.</div>
    <div class="notification-example">
      <span style="font-weight: 600;">Ejemplo:</span> 0.123 <span style="color: #4CAF50;">✓</span>
      &nbsp;&nbsp;&nbsp;
      <span style="text-decoration: line-through;">.123</span> <span style="color: #FF5252;">✗</span>
    </div>
    <button id="notificationButton" class="notification-button">Entendido</button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // =========================================
    // FUNCIONES AUXILIARES PARA DECIMAL
    // =========================================
    
    // Función para normalizar y validar entrada de números
    function normalizeNumberInput(value) {
      if (!value || value.trim() === '') {
        return { valid: false, value: '', isEmpty: true };
      }
      
      let normalizedValue = value.trim();
      
      // Casos especiales que rechazamos
      if (normalizedValue.startsWith('.')) {
        return { valid: false, value: normalizedValue, startsWithDot: true };
      }
      
      // Reemplazar comas por puntos (10,5 → 10.5)
      normalizedValue = normalizedValue.replace(/,(?=\d)/g, '.');
      
      // Remover comas de miles (1,234.56 → 1234.56)
      normalizedValue = normalizedValue.replace(/,(?=\d{3})/g, '');
      
      // Normalizar punto final (10. → 10.00)
      if (normalizedValue.endsWith('.')) {
        normalizedValue += '00';
      }
      
      // Verificar que sea un número válido
      const numericValue = parseFloat(normalizedValue);
      if (isNaN(numericValue)) {
        return { valid: false, value: normalizedValue, invalidNumber: true };
      }
      
      // Verificar que sea positivo
      if (numericValue <= 0) {
        return { valid: false, value: normalizedValue, notPositive: true };
      }
      
      return { 
        valid: true, 
        value: normalizedValue,
        numericValue: numericValue,
        formattedValue: numericValue.toFixed(2)
      };
    }
    
    // =========================================
    // Notificación centrada mejorada
    // =========================================
    const notificationOverlay = document.getElementById('notificationOverlay');
    const notificationButton = document.getElementById('notificationButton');
    
    // Función para mostrar notificación centrada personalizada
    window.showCustomNotification = function(options = {}) {
      if (notificationOverlay) {
        const titleEl = notificationOverlay.querySelector('.notification-title');
        const messageEl = notificationOverlay.querySelector('.notification-message');
        const exampleEl = notificationOverlay.querySelector('.notification-example');
        const iconEl = notificationOverlay.querySelector('.notification-icon i');
        
        // Configurar contenido
        if (titleEl) titleEl.textContent = options.title || 'Error de validación';
        if (messageEl) messageEl.textContent = options.message || 'Por favor corrige los errores indicados.';
        
        // Mostrar u ocultar ejemplo
        if (exampleEl) {
          if (options.example) {
            exampleEl.innerHTML = options.example;
            exampleEl.style.display = 'block';
          } else {
            exampleEl.style.display = 'none';
          }
        }
        
        // Configurar ícono
        if (iconEl) {
          iconEl.className = options.icon || 'fas fa-exclamation-circle';
        }
        
        notificationOverlay.classList.add('active');
        
        // Auto-cerrar después de 5 segundos
        setTimeout(() => {
          hideFormatNotification();
        }, 5000);
      }
    };
    
    // Función para mostrar notificación de formato (la original)
    window.showFormatNotification = function() {
      showCustomNotification({
        title: 'Formato incorrecto',
        message: 'Debe incluir un dígito antes del punto decimal.',
        example: '<span style="font-weight: 600;">Ejemplo:</span> 0.123 <span style="color: #4CAF50;">✓</span>&nbsp;&nbsp;&nbsp;<span style="text-decoration: line-through;">.123</span> <span style="color: #FF5252;">✗</span>',
        icon: 'fas fa-exclamation-circle'
      });
    };
    
    // Función para ocultar notificación
    window.hideFormatNotification = function() {
      if (notificationOverlay) {
        notificationOverlay.classList.remove('active');
      }
    };
    
    // Cerrar al hacer clic en el botón
    if (notificationButton) {
      notificationButton.addEventListener('click', hideFormatNotification);
    }
    
    // Función simple para formatear dinero con comas
    function formatMoney(number) {
      if (typeof number === 'string') {
        number = parseFloat(number.replace(/[^\d.-]/g, ''));
      }
      
      if (isNaN(number)) {
        return '$0.00';
      }
      
      // Usar toLocaleString para formatear con comas
      return '$' + number.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    
    // 1. Formatear Costo Actual
    const costoActualEl = document.getElementById('costoActualValue');
    if (costoActualEl) {
      const valor = parseFloat(costoActualEl.textContent.replace('$', ''));
      costoActualEl.textContent = formatMoney(valor);
    }
    
    // 2. Formatear Precio de Venta
    const precioVentaEl = document.getElementById('precioVentaValue');
    if (precioVentaEl) {
      const valor = parseFloat(precioVentaEl.textContent.replace('$', ''));
      precioVentaEl.textContent = formatMoney(valor);
    }
    
    // 3. Formatear valor en Mantener costo anterior
    const mantenerCostoLabel = document.getElementById('mantenerCostoLabel');
    if (mantenerCostoLabel) {
      // Obtener todo el texto de la etiqueta
      const text = mantenerCostoLabel.textContent;
      
      // Buscar el valor entre paréntesis
      const inicio = text.indexOf('($') + 2;
      const fin = text.indexOf(' por');
      
      if (inicio > 1 && fin > inicio) {
        // Extraer el valor numérico
        const valorStr = text.substring(inicio, fin);
        const valor = parseFloat(valorStr);
        
        // Obtener la unidad
        const inicioUnidad = text.indexOf('por ') + 4;
        const finUnidad = text.indexOf(')');
        const unidad = text.substring(inicioUnidad, finUnidad);
        
        // Crear el nuevo texto con el valor formateado
        const newText = 'Mantener costo anterior (' + formatMoney(valor) + ' por ' + unidad + ')';
        
        // Actualizar la etiqueta
        mantenerCostoLabel.textContent = newText;
      }
    }
    
    // =========================================
    // MANEJO DE CANTIDADES
    // =========================================
    // Obtener el campo de cantidad y su unidad
    const cantidadInput = document.getElementById('cantidad');
    const unidadIndicator = document.getElementById('unidadIndicator');
    
    // Determinar si el producto usa unidades (no piezas)
    const esUnidadDecimal = {% if producto.unidad and producto.unidad not in ['pieza', 'piezas'] %}true{% else %}false{% endif %};
    
    // Función para actualizar la unidad basada en la cantidad
    function updateUnitText() {
      // Obtener la unidad del producto (o usar 'pieza'/'piezas' por defecto)
      {% if producto.unidad %}
        let unidad = '{{ producto.unidad }}';
        
        if (unidad === 'pieza') {
          // Si es 'pieza', cambia a plural cuando es más de 1
          const cantidad = parseFloat(cantidadInput.value.replace(/,/g, '')) || 1;
          unidadIndicator.textContent = cantidad === 1 ? 'PIEZA' : 'PIEZAS';
        } else {
          // Mantener unidad existente (KG, L, etc.)
          unidadIndicator.textContent = unidad.toUpperCase();
        }
      {% else %}
        // Para productos sin unidad específica, usar pieza/piezas
        const cantidad = parseFloat(cantidadInput.value.replace(/,/g, '')) || 1;
        unidadIndicator.textContent = cantidad === 1 ? 'PIEZA' : 'PIEZAS';
      {% endif %}
    }
    
    // Formatear número con comas para los miles - RESTAURADO AL ORIGINAL
    function formatQuantityWithCommas(input) {
      // Guardar posición del cursor
      const start = input.selectionStart || 0;
      const end = input.selectionEnd || 0;
      const oldLength = input.value.length;
      
      // Obtener valor sin comas y evitando caracteres no válidos
      let value = input.value.replace(/,/g, '');
      
      // Si es unidad decimal, permitir punto
      if (esUnidadDecimal) {
        // Truncar exceso de decimales si hay más de 2
        if (value.includes('.')) {
          const parts = value.split('.');
          if (parts[1] && parts[1].length > 2) {
            // Cortar a 2 decimales máximo
            value = parts[0] + '.' + parts[1].substring(0, 2);
          }
        }
        
        // Permitir números y un solo punto decimal con exactamente 2 decimales máximo
        const decimalPattern = /^(\d+)(\.\d{0,2})?$/;
        const match = value.match(decimalPattern);
        
        if (match && match[1]) {
          // Formatear parte entera con comas
          const formattedInt = parseInt(match[1]).toLocaleString('en-US');
          
          // Reconstruir con decimales si hay
          if (match[2]) {
            value = formattedInt + match[2];
          } else {
            value = formattedInt;
          }
        } else if (value === '') {
          // Permitir campo vacío
          input.value = '';
          return;
        } else {
          // Si no coincide con el patrón, mantener el valor anterior
          return;
        }
      } else {
        // Para unidades enteras, no permitir punto decimal
        // Eliminar cualquier punto y carácter no numérico
        value = value.replace(/[^\d]/g, '');
        
        if (value === '') {
          // Permitir campo vacío
          input.value = '';
          return;
        }
        
        // Formatear con comas
        value = parseInt(value).toLocaleString('en-US');
      }
      
      // Actualizar el valor en el campo
      input.value = value;
      
      // Ajustar la posición del cursor para mantener la posición relativa
      const newLength = input.value.length;
      const deltaLength = newLength - oldLength;
      
      if (start < oldLength) {
        const newPosition = Math.max(0, start + deltaLength);
        input.setSelectionRange(newPosition, newPosition);
      } else {
        input.setSelectionRange(newLength, newLength);
      }
      
      // Actualizar texto de unidad
      updateUnitText();
    }
    
    // Validación del formato para el campo cantidad - RESTAURADO AL ORIGINAL
    if (cantidadInput) {
      // Configurar evento input para formateo
      cantidadInput.addEventListener('input', function(e) {
        const valor = e.target.value;
        
        // Si está vacío, permitir temporalmente
        if (valor === '') {
          return;
        }
        
        // Verificar si comienza con punto decimal para unidades decimales
        if (esUnidadDecimal && valor.startsWith('.')) {
          // Cancelar el cambio y mostrar notificación
          e.preventDefault();
          // Revertir al valor anterior o vacío
          if (e.target.defaultValue) {
            e.target.value = e.target.defaultValue;
          } else {
            e.target.value = '';
          }
          // Mostrar notificación de formato
          showFormatNotification();
          return;
        }
        
        // Formatear con comas
        formatQuantityWithCommas(e.target);
        
        // Guardar como valor predeterminado para futuras comparaciones
        e.target.defaultValue = e.target.value;
      });
      
      // Inicializar con valor formateado
      formatQuantityWithCommas(cantidadInput);
    }

    // =========================================
    // FORMATEO DE COSTO - RESTAURADO AL ORIGINAL
    // =========================================
    // Función para formatear costo en tiempo real
    window.formatCostRealtime = function(input) {
      let value = input.value;
      
      // Si está vacío, permitir temporalmente
      if (value === '') {
        return;
      }
      
      // Verificar si comienza con punto decimal
      if (value.startsWith('.')) {
        // Cancelar el cambio y mostrar notificación
        input.value = input.defaultValue || '';
        // Mostrar notificación de formato
        showFormatNotification();
        return;
      }
      
      // Eliminar comas y caracteres no numéricos (excepto punto)
      value = value.replace(/,/g, "").replace(/[^\d.]/g, "");
      
      // Limitar a 2 decimales
      const patronMoneda = /^(\d*)(\.?)(\d{0,2})/;
      const match = value.match(patronMoneda);
      
      if (match) {
        let intPart = match[1] || '0'; // Parte entera (por defecto '0')
        let dot = match[2];           // Punto decimal
        let decPart = match[3];       // Parte decimal
        
        // Formatear con separador de miles
        let formattedInt = intPart ? Number(intPart).toLocaleString("en-US") : "0";
        
        // Construir el resultado final
        let result = formattedInt;
        if (dot) {
          result += ".";
        }
        result += decPart;
        
        // Actualizar el valor del input
        input.value = result;
        
        // Actualizar campo oculto con el valor numérico real (sin comas)
        const costoReal = document.getElementById('costo_unitario_real');
        if (costoReal) {
          // Convertir a valor numérico sin formato
          let numericValue = parseFloat((intPart || "0") + "." + (decPart || "0"));
          costoReal.value = numericValue.toFixed(2);
        }
        
        // Actualizar defaultValue para comparaciones futuras
        input.defaultValue = result;
        
        // Posicionar el cursor al final
        input.setSelectionRange(input.value.length, input.value.length);
      }
    }
    
    // Toggle costo - Nueva función
    window.toggleCostoSection = function() {
      const toggleCosto = document.getElementById('mantener_costo_anterior');
      const costoSection = document.getElementById('costoSection');
      const costoUnitarioInput = document.getElementById('costo_unitario');
      
      if (!toggleCosto.checked) {
        // Si se desactiva (NO mantener costo), mostrar la sección con animación
        costoSection.style.display = 'block';
        costoSection.style.animation = 'slideDown 0.3s ease-out';
        
        // Configurar eventos si no están configurados
        if (costoUnitarioInput && !costoUnitarioInput.dataset.eventsConfigured) {
          costoUnitarioInput.addEventListener('input', function(e) {
            const valor = e.target.value;
            if (valor.startsWith('.')) {
              e.target.value = e.target.dataset.lastValidValue || '';
              showFormatNotification();
            } else {
              e.target.dataset.lastValidValue = valor;
            }
          });
          
          costoUnitarioInput.addEventListener('blur', function(e) {
            formatCostOnBlur(e.target);
          });
          
          costoUnitarioInput.dataset.eventsConfigured = 'true';
          costoUnitarioInput.dataset.lastValidValue = costoUnitarioInput.value;
        }
      } else {
        // Si se activa (mantener costo), ocultar la sección
        costoSection.style.display = 'none';
      }
    }
    
    // Toggle caducidad - Nueva función
    window.toggleCaducidadSection = function() {
      const toggleCaducidad = document.getElementById('toggle_caducidad');
      const caducidadSection = document.getElementById('caducidadSection');
      const toggleCaducidadEstado = document.getElementById('toggle_caducidad_estado');
      
      if (toggleCaducidad.checked) {
        // Si se activa, mostrar la sección con animación
        caducidadSection.style.display = 'block';
        caducidadSection.style.animation = 'slideDown 0.3s ease-out';
        toggleCaducidadEstado.value = 'ACTIVADO';
      } else {
        // Si se desactiva, ocultar la sección
        caducidadSection.style.display = 'none';
        toggleCaducidadEstado.value = 'DESACTIVADO';
      }
    }
    
    // Función para manejar los colapsables - Función global
    window.toggleCollapse = function(id) {
      const content = document.getElementById(id);
      const header = content.previousElementSibling;
      const icon = header.querySelector('i.fas.fa-chevron-down, i.fas.fa-chevron-up');
      
      if (content.style.display === 'block') {
        content.style.display = 'none';
        header.classList.remove('active');
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        
        // Actualizar estado oculto
        if (id === 'notasSection') {
          document.getElementById('toggle_notas_estado').value = 'DESACTIVADO';
        } else if (id === 'comprobanteSection') {
          document.getElementById('toggle_comprobante_estado').value = 'DESACTIVADO';
        }
      } else {
        content.style.display = 'block';
        header.classList.add('active');
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        
        // Actualizar estado oculto
        if (id === 'notasSection') {
          document.getElementById('toggle_notas_estado').value = 'ACTIVADO';
        } else if (id === 'comprobanteSection') {
          document.getElementById('toggle_comprobante_estado').value = 'ACTIVADO';
        }
      }
    }
    
    // Inicializar la visualización de unidad
    updateUnitText();
    
    // Formatear el campo de costo inicial y configurar eventos - RESTAURADO AL ORIGINAL
    const costoUnitarioInput = document.getElementById('costo_unitario');
    if (costoUnitarioInput) {
      // Aplicar formato inicial si es necesario
      const costoValue = costoUnitarioInput.value.trim();
      if (costoValue && !costoValue.includes(',')) {
        formatCostRealtime(costoUnitarioInput);
      }
    }
    
    // =========================================
    // VALIDACIÓN DEL FORMULARIO MEJORADA
    // =========================================
    const form = document.getElementById('entradaForm');
    
    if (form) {
      form.addEventListener('submit', function(event) {
        let isValid = true;
        const errors = [];
        
        // 1. Validar cantidad - ADAPTADO AL FORMATO ORIGINAL
        if (cantidadInput) {
          let cantidadValor = cantidadInput.value.trim().replace(/,/g, '');
          
          if (cantidadValor === '') {
            event.preventDefault();
            cantidadInput.classList.add('error');
            showCustomNotification({
              title: 'Campo obligatorio',
              message: 'La cantidad a añadir es obligatoria.',
              icon: 'fas fa-exclamation-triangle'
            });
            cantidadInput.focus();
            return false;
          }
          
          // Verificar si es un número válido y mayor que cero
          let numeroValido = parseFloat(cantidadValor);
          
          if (isNaN(numeroValido) || numeroValido <= 0) {
            event.preventDefault();
            cantidadInput.classList.add('error');
            showCustomNotification({
              title: 'Valor inválido',
              message: 'La cantidad debe ser un número mayor que cero.',
              icon: 'fas fa-exclamation-circle'
            });
            cantidadInput.focus();
            return false;
          }
          
          cantidadInput.classList.remove('error');
          
          // Validaciones específicas según el tipo de unidad
          if (esUnidadDecimal) {
            // Para unidades decimales, verificar que no inicie con punto
            if (cantidadValor.startsWith('.')) {
              event.preventDefault();
              cantidadInput.classList.add('error');
              showFormatNotification();
              cantidadInput.focus();
              return false;
            }
            
            // Verificar que no tenga más de 2 decimales
            if (cantidadValor.includes('.')) {
              const parts = cantidadValor.split('.');
              if (parts[1] && parts[1].length > 2) {
                event.preventDefault();
                cantidadInput.classList.add('error');
                showCustomNotification({
                  title: 'Demasiados decimales',
                  message: 'La cantidad no puede tener más de 2 decimales.',
                  example: '<span style="font-weight: 600;">Máximo permitido:</span> 123.45',
                  icon: 'fas fa-exclamation-circle'
                });
                cantidadInput.focus();
                return false;
              }
            }
            
            // Asegurar que el valor final sea un número válido
            cantidadInput.value = cantidadValor;
          } else {
            // Para piezas, verificar que sea un número entero
            if (Math.floor(numeroValido) !== numeroValido) {
              event.preventDefault();
              cantidadInput.classList.add('error');
              showCustomNotification({
                title: 'Solo números enteros',
                message: 'La cantidad debe ser un número entero para este tipo de producto.',
                example: '<span style="font-weight: 600;">Válido:</span> 5, 10, 25 <span style="color: #4CAF50;">✓</span><br><span style="font-weight: 600;">Inválido:</span> 5.5, 10.2 <span style="color: #FF5252;">✗</span>',
                icon: 'fas fa-exclamation-circle'
              });
              cantidadInput.focus();
              return false;
            }
            
            // Asegurar que el valor final sea un número sin formato
            cantidadInput.value = Math.floor(numeroValido);
          }
        }
        
        // 2. Validar costo si no se mantiene el anterior - ADAPTADO AL FORMATO ORIGINAL
        const mantenerCostoToggle = document.getElementById('mantener_costo_anterior');
        const costoUnitarioInput2 = document.getElementById('costo_unitario');
        if (mantenerCostoToggle && !mantenerCostoToggle.checked && costoUnitarioInput2) {
          // Primero verificar que no comience con punto decimal
          const costoValor = costoUnitarioInput2.value.replace(/,/g, '').trim();
          
          if (costoValor === '') {
            event.preventDefault();
            costoUnitarioInput2.classList.add('error');
            showCustomNotification({
              title: 'Campo obligatorio',
              message: 'El nuevo costo es obligatorio cuando no se mantiene el costo anterior.',
              icon: 'fas fa-dollar-sign'
            });
            costoUnitarioInput2.focus();
            return false;
          }
          
          if (costoValor.startsWith('.')) {
            event.preventDefault();
            costoUnitarioInput2.classList.add('error');
            showFormatNotification();
            costoUnitarioInput2.focus();
            return false;
          }
          
          // Usar el valor del campo oculto que contiene el valor numérico real
          const costoUnitarioReal = document.getElementById('costo_unitario_real');
          if (costoUnitarioReal) {
            const costoNumerico = parseFloat(costoUnitarioReal.value);
            
            if (isNaN(costoNumerico) || costoNumerico <= 0) {
              event.preventDefault();
              costoUnitarioInput2.classList.add('error');
              showCustomNotification({
                title: 'Valor inválido',
                message: 'El costo unitario debe ser mayor que cero.',
                icon: 'fas fa-dollar-sign'
              });
              costoUnitarioInput2.focus();
              return false;
            }
          }
          
          costoUnitarioInput2.classList.remove('error');
        } else if (costoUnitarioInput2) {
          // Si se mantiene el costo anterior, remover cualquier clase de error
          costoUnitarioInput2.classList.remove('error');
        }
        
        // 3. Verificar que se seleccione un lapso de caducidad si está activado
        const toggleCaducidadEstado = document.getElementById('toggle_caducidad_estado');
        if (toggleCaducidadEstado && toggleCaducidadEstado.value === 'ACTIVADO') {
          const lapsoSeleccionado = document.querySelector('input[name="caducidad_lapso"]:checked');
          if (!lapsoSeleccionado) {
            event.preventDefault();
            showCustomNotification({
              title: 'Selección requerida',
              message: 'Selecciona un lapso de caducidad.',
              icon: 'fas fa-calendar-times'
            });
            return false;
          }
        }
        
        return isValid;
      });
    }
    
    // Remover clase de error cuando el usuario empiece a corregir
    if (cantidadInput) {
      cantidadInput.addEventListener('input', function() {
        this.classList.remove('error');
      });
    }
    
    const costoInput = document.getElementById('costo_unitario');
    if (costoInput) {
      costoInput.addEventListener('input', function() {
        this.classList.remove('error');
      });
    }
    
    // Preconfigurar el lapso de caducidad si el producto tiene uno configurado
    {% if producto.has_caducidad and producto.metodo_caducidad %}
      // Verificar si tiene configuración de caducidad
      const lapsoConfigured = "{{ producto.metodo_caducidad }}";
      const radioLapso = document.querySelector(`input[name="caducidad_lapso"][value="${lapsoConfigured}"]`);
      
      if (radioLapso) {
        // Activar toggle de caducidad y seleccionar el lapso
        const toggleCaducidad = document.getElementById('toggle_caducidad');
        toggleCaducidad.checked = true;
        
        // Mostrar la sección
        toggleCaducidadSection();
        
        radioLapso.checked = true;
      }
    {% endif %}
  });
</script>
{% endblock %}