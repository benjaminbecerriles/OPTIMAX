{% extends 'base.html' %}

{% block title %}Etiquetas de {{ producto.nombre }}{% endblock %}

{% block content %}
<style>
  /* Estilos generales */
  .etiquetas-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .page-title {
    color: #333;
    margin-bottom: 5px;
    font-size: 28px;
  }
  
  .page-subtitle {
    color: #666;
    margin-bottom: 20px;
    font-size: 16px;
  }
  
  /* Tarjeta de producto */
  .product-card {
    display: flex;
    gap: 20px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .product-image {
    width: 120px;
    height: 120px;
    object-fit: contain;
    border-radius: 8px;
    background-color: white;
    padding: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .product-details {
    flex: 1;
  }
  
  .product-name {
    font-size: 22px;
    margin-bottom: 8px;
    color: #333;
  }
  
  .product-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #555;
    gap: 5px;
  }
  
  .meta-item i {
    color: #e52e2e;
    width: 16px;
    text-align: center;
  }
  
  .product-stock {
    font-weight: bold;
    color: #28a745;
  }
  
  .category-pill {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    color: white;
    background-color: #6c757d;
  }
  
  /* Sección de configuración */
  .config-section {
    background-color: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .section-title {
    font-size: 18px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  
  .form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 16px;
    color: #333;
  }
  
  .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 16px;
    color: #333;
    background-color: white;
  }
  
  .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }
  
  .form-col {
    flex: 1;
    min-width: 200px;
  }
  
  /* Botones */
  .btn-container {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  
  .btn {
    padding: 12px 20px;
    border-radius: 5px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    border: none;
  }
  
  .btn-primary {
    background-color: #e52e2e;
    color: white;
  }
  
  .btn-secondary {
    background-color: #6c757d;
    color: white;
  }
  
  .btn-outline {
    background-color: transparent;
    border: 1px solid #ced4da;
    color: #333;
  }
  
  .btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }
  
  /* Previsualización de etiquetas */
  .preview-section {
    margin-top: 30px;
  }
  
  .preview-title {
    font-size: 18px;
    color: #333;
    margin-bottom: 15px;
  }
  
  .preview-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 20px;
    background-color: #f8f9fa;
    margin-bottom: 20px;
    min-height: 200px;
    overflow-x: auto;
  }
  
  .etiqueta-preview {
    display: inline-block;
    border: 1px dashed #ccc;
    margin: 5px;
    padding: 10px;
    background-color: white;
    position: relative;
  }
  
  .preview-sheet {
    border: 1px solid #aaa;
    background: white;
    margin: 0 auto 20px;
    position: relative;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  .etiqueta {
    position: absolute;
    border: 1px dashed #ddd;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background: white;
    font-family: Arial, sans-serif;
  }
  
  .etiqueta-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 5px;
    text-align: center;
  }
  
  .etiqueta-nombre {
    font-weight: bold;
    font-size: 10px;
    margin-bottom: 2px;
    line-height: 1.1;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    word-break: break-word;
  }
  
  .etiqueta-precio {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 2px;
  }
  
  .etiqueta-codigo {
    font-size: 8px;
    margin-bottom: 3px;
  }
  
  .etiqueta-barcode {
    max-width: 95%;
    margin-bottom: 2px;
  }
  
  /* Estilos para impresoras */
  .printer-options {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
  }
  
  .printer-option {
    flex: 1;
    min-width: 200px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .printer-option:hover {
    border-color: #e52e2e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .printer-option.selected {
    border-color: #e52e2e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background-color: #fff8f8;
  }
  
  .printer-name {
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
  }
  
  .printer-description {
    font-size: 12px;
    color: #666;
  }
  
  /* Configuración adicional */
  .toggle-container {
    margin-top: 10px;
    margin-bottom: 20px;
  }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-right: 10px;
    vertical-align: middle;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: #e52e2e;
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
  
  .toggle-label {
    display: inline-block;
    vertical-align: middle;
    font-size: 14px;
    color: #333;
  }
  
  /* Área para exportar a PDF */
  #pdf-container {
    position: fixed;
    left: -9999px;
    top: -9999px;
  }
  
  /* Mensaje de error de dependencias */
  .dependency-error {
    background-color: #fff3cd;
    color: #856404;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    border: 1px solid #ffeeba;
    display: none;
  }
  
  /* Estilos de impresión */
  @media print {
    body * {
      visibility: hidden;
    }
    
    #print-content, #print-content * {
      visibility: visible;
    }
    
    #print-content {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
    
    .no-print {
      display: none !important;
    }
  }
  
  /* Media queries */
  @media (max-width: 768px) {
    .product-card {
      flex-direction: column;
      align-items: center;
    }
    
    .form-row {
      flex-direction: column;
      gap: 10px;
    }
    
    .btn-container {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
  }
</style>

<div class="etiquetas-container">
  <h1 class="page-title">Generar etiquetas</h1>
  <p class="page-subtitle">Personaliza e imprime etiquetas para el producto</p>
  
  <!-- Mensaje de error para dependencias -->
  <div id="dependency-error" class="dependency-error">
    <strong>Error:</strong> No se han podido cargar todas las bibliotecas necesarias. Por favor, recarga la página o verifica tu conexión a Internet.
  </div>
  
  <!-- Información del producto -->
  <div class="product-card" data-producto='{"id": {{ producto.id }}, "nombre": "{{ producto.nombre|replace('"', '\\"')|replace('\n', ' ')|replace('\r', '') }}", "codigo": "{{ producto.codigo_barras_externo }}", "precio": {{ precio_final }}, "stock": {{ producto.stock }}}'>
    <img src="{{ url_for('static', filename='uploads/' + producto.foto) }}" alt="{{ producto.nombre }}" class="product-image" onerror="this.src='{{ url_for('static', filename='img/default_product.jpg') }}'">
    
    <div class="product-details">
      <h2 class="product-name">{{ producto.nombre }}</h2>
      
      <div class="product-meta">
        <div class="meta-item">
          <i class="fas fa-barcode"></i>
          <span>{{ producto.codigo_barras_externo }}</span>
        </div>
        
        <div class="meta-item">
          <i class="fas fa-tags"></i>
          <span>${{ "%.2f"|format(precio_final) }}</span>
        </div>
        
        <div class="meta-item">
          <i class="fas fa-box"></i>
          <span class="product-stock">Stock: {{ producto.stock }}</span>
        </div>
        
        {% if producto.categoria %}
        <div class="meta-item">
          <span class="category-pill" style="background-color: {{ producto.categoria_color or '#6c757d' }}">
            {{ producto.categoria }}
          </span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Sección de configuración -->
  <div class="config-section">
    <h3 class="section-title">Configuración de etiquetas</h3>
    
    <div class="form-row">
      <div class="form-col">
        <div class="form-group">
          <label class="form-label" for="cantidad">Cantidad de etiquetas</label>
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="usar_stock" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Usar stock actual ({{ producto.stock }})</span>
          </div>
          <input type="number" id="cantidad" class="form-control" min="1" value="{{ producto.stock }}" disabled>
        </div>
      </div>
      
      <div class="form-col">
        <div class="form-group">
          <label class="form-label" for="formato_etiqueta">Formato de etiqueta</label>
          <select id="formato_etiqueta" class="form-select">
            {% for formato in formatos_etiquetas %}
            <option value="{{ formato.id }}" 
                    data-width="{{ formato.ancho }}" 
                    data-height="{{ formato.alto }}" 
                    data-cols="{{ formato.columnas }}" 
                    data-rows="{{ formato.filas }}" 
                    data-per-page="{{ formato.por_pagina }}">
              {{ formato.nombre }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Impresora compatible</label>
      <div class="printer-options">
        {% for impresora in impresoras_compatibles %}
        <div class="printer-option {% if loop.first %}selected{% endif %}" data-printer="{{ impresora.id }}">
          <div class="printer-name">{{ impresora.nombre }}</div>
          <div class="printer-description">{{ impresora.descripcion }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Contenido de la etiqueta</label>
      <div class="form-row">
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_nombre" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar nombre del producto</span>
          </div>
        </div>
        
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_precio" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar precio</span>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_codigo" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar código de texto</span>
          </div>
        </div>
        
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_codigo_barras" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar código de barras</span>
          </div>
        </div>
      </div>
      
      <!-- Opciones avanzadas para códigos de barras -->
      <div id="codigo_barras_opciones" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee;">
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label class="form-label">Formato de código de barras</label>
              <select id="formato_codigo" class="form-select">
                <option value="auto">Automático (recomendado)</option>
                <option value="CODE128">CODE128 (alfanumérico - cualquier longitud)</option>
                <option value="CODE39">CODE39 (alfanumérico)</option>
                <option value="EAN13">EAN-13 (13 dígitos)</option>
                <option value="EAN8">EAN-8 (8 dígitos)</option>
                <option value="UPC">UPC-A (12 dígitos)</option>
                <option value="ITF14">ITF-14 (14 dígitos)</option>
                <option value="CODE128B">CODE128B (códigos personalizados)</option>
              </select>
            </div>
          </div>
          
          <div class="form-col">
            <div class="form-group">
              <label class="form-label">Tamaño del código</label>
              <select id="tamano_codigo" class="form-select">
                <option value="normal">Normal</option>
                <option value="grande" selected>Grande (mejor para escanear)</option>
                <option value="pequeno">Pequeño</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sección de previsualización -->
  <div class="preview-section">
    <h3 class="preview-title">Previsualización</h3>
    <div id="preview-container" class="preview-container">
      <div id="preview-content">
        <!-- La previsualización se generará con JavaScript -->
        <div style="text-align: center; padding: 50px 0;">
          <i class="fas fa-sync fa-spin" style="font-size: 30px; color: #aaa;"></i>
          <p style="margin-top: 10px; color: #666;">Cargando vista previa...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Botones de acción -->
  <div class="btn-container">
    <button id="btn-preview" class="btn btn-outline">
      <i class="fas fa-sync-alt"></i> Actualizar vista previa
    </button>
    
    <button id="btn-print" class="btn btn-secondary">
      <i class="fas fa-print"></i> Imprimir directamente
    </button>
    
    <button id="btn-pdf" class="btn btn-primary">
      <i class="fas fa-file-pdf"></i> Descargar como PDF
    </button>
  </div>
  
  <!-- Área oculta para impresión -->
  <div id="print-content" style="display: none;"></div>
  
  <!-- Contenedor oculto para PDF -->
  <div id="pdf-container" style="display: none;"></div>
</div>
{% endblock %}