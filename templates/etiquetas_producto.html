{% extends 'base.html' %}

{% block title %}Etiquetas de {{ producto.nombre }}{% endblock %}

{% block content %}
<style>
  /* Estilos generales */
  .etiquetas-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .page-title {
    color: #333;
    margin-bottom: 5px;
    font-size: 28px;
  }
  
  .page-subtitle {
    color: #666;
    margin-bottom: 20px;
    font-size: 16px;
  }
  
  /* Tarjeta de producto */
  .product-card {
    display: flex;
    gap: 20px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .product-image {
    width: 120px;
    height: 120px;
    object-fit: contain;
    border-radius: 8px;
    background-color: white;
    padding: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .product-details {
    flex: 1;
  }
  
  .product-name {
    font-size: 22px;
    margin-bottom: 8px;
    color: #333;
  }
  
  .product-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: #555;
    gap: 5px;
  }
  
  .meta-item i {
    color: #e52e2e;
    width: 16px;
    text-align: center;
  }
  
  .product-stock {
    font-weight: bold;
    color: #28a745;
  }
  
  .category-pill {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    color: white;
    background-color: #6c757d;
  }
  
  /* Sección de configuración */
  .config-section {
    background-color: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .section-title {
    font-size: 18px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  
  .form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 16px;
    color: #333;
  }
  
  .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 16px;
    color: #333;
    background-color: white;
  }
  
  .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }
  
  .form-col {
    flex: 1;
    min-width: 200px;
  }
  
  /* Botones */
  .btn-container {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  
  .btn {
    padding: 12px 20px;
    border-radius: 5px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    border: none;
  }
  
  .btn-primary {
    background-color: #e52e2e;
    color: white;
  }
  
  .btn-secondary {
    background-color: #6c757d;
    color: white;
  }
  
  .btn-outline {
    background-color: transparent;
    border: 1px solid #ced4da;
    color: #333;
  }
  
  .btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }
  
  /* Previsualización de etiquetas */
  .preview-section {
    margin-top: 30px;
  }
  
  .preview-title {
    font-size: 18px;
    color: #333;
    margin-bottom: 15px;
  }
  
  .preview-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 20px;
    background-color: #f8f9fa;
    margin-bottom: 20px;
    min-height: 200px;
    overflow-x: auto;
  }
  
  .etiqueta-preview {
    display: inline-block;
    border: 1px dashed #ccc;
    margin: 5px;
    padding: 10px;
    background-color: white;
    position: relative;
  }
  
  .preview-sheet {
    border: 1px solid #aaa;
    background: white;
    margin: 0 auto 20px;
    position: relative;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  .etiqueta {
    position: absolute;
    border: 1px dashed #ddd;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background: white;
    font-family: Arial, sans-serif;
  }
  
  .etiqueta-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 5px;
    text-align: center;
  }
  
  .etiqueta-nombre {
    font-weight: bold;
    font-size: 10px;
    margin-bottom: 2px;
    line-height: 1.1;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    word-break: break-word;
  }
  
  .etiqueta-precio {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 2px;
  }
  
  .etiqueta-codigo {
    font-size: 8px;
    margin-bottom: 3px;
  }
  
  .etiqueta-barcode {
    max-width: 95%;
    margin-bottom: 2px;
  }
  
  /* Estilos para impresoras */
  .printer-options {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
  }
  
  .printer-option {
    flex: 1;
    min-width: 200px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .printer-option:hover {
    border-color: #e52e2e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .printer-option.selected {
    border-color: #e52e2e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background-color: #fff8f8;
  }
  
  .printer-name {
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
  }
  
  .printer-description {
    font-size: 12px;
    color: #666;
  }
  
  /* Configuración adicional */
  .toggle-container {
    margin-top: 10px;
    margin-bottom: 20px;
  }
  
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-right: 10px;
    vertical-align: middle;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: #e52e2e;
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
  
  .toggle-label {
    display: inline-block;
    vertical-align: middle;
    font-size: 14px;
    color: #333;
  }
  
  /* Área para exportar a PDF */
  #pdf-container {
    position: fixed;
    left: -9999px;
    top: -9999px;
  }
  
  /* Mensaje de error de dependencias */
  .dependency-error {
    background-color: #fff3cd;
    color: #856404;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    border: 1px solid #ffeeba;
    display: none;
  }
  
  /* Estilos de impresión */
  @media print {
    body * {
      visibility: hidden;
    }
    
    #print-content, #print-content * {
      visibility: visible;
    }
    
    #print-content {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
    
    .no-print {
      display: none !important;
    }
  }
  
  /* Media queries */
  @media (max-width: 768px) {
    .product-card {
      flex-direction: column;
      align-items: center;
    }
    
    .form-row {
      flex-direction: column;
      gap: 10px;
    }
    
    .btn-container {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
  }
</style>

<div class="etiquetas-container">
  <h1 class="page-title">Generar etiquetas</h1>
  <p class="page-subtitle">Personaliza e imprime etiquetas para el producto</p>
  
  <!-- Mensaje de error para dependencias -->
  <div id="dependency-error" class="dependency-error">
    <strong>Error:</strong> No se han podido cargar todas las bibliotecas necesarias. Por favor, recarga la página o verifica tu conexión a Internet.
  </div>
  
  <!-- Información del producto -->
  <div class="product-card">
    <img src="{{ url_for('static', filename='uploads/' + producto.foto) }}" alt="{{ producto.nombre }}" class="product-image" onerror="this.src='{{ url_for('static', filename='img/default_product.jpg') }}'">
    
    <div class="product-details">
      <h2 class="product-name">{{ producto.nombre }}</h2>
      
      <div class="product-meta">
        <div class="meta-item">
          <i class="fas fa-barcode"></i>
          <span>{{ producto.codigo_barras_externo }}</span>
        </div>
        
        <div class="meta-item">
          <i class="fas fa-tags"></i>
          <span>${{ "%.2f"|format(precio_final) }}</span>
        </div>
        
        <div class="meta-item">
          <i class="fas fa-box"></i>
          <span class="product-stock">Stock: {{ producto.stock }}</span>
        </div>
        
        {% if producto.categoria %}
        <div class="meta-item">
          <span class="category-pill" style="background-color: {{ producto.categoria_color or '#6c757d' }}">
            {{ producto.categoria }}
          </span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Sección de configuración -->
  <div class="config-section">
    <h3 class="section-title">Configuración de etiquetas</h3>
    
    <div class="form-row">
      <div class="form-col">
        <div class="form-group">
          <label class="form-label" for="cantidad">Cantidad de etiquetas</label>
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="usar_stock" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Usar stock actual ({{ producto.stock }})</span>
          </div>
          <input type="number" id="cantidad" class="form-control" min="1" value="{{ producto.stock }}" disabled>
        </div>
      </div>
      
      <div class="form-col">
        <div class="form-group">
          <label class="form-label" for="formato_etiqueta">Formato de etiqueta</label>
          <select id="formato_etiqueta" class="form-select">
            {% for formato in formatos_etiquetas %}
            <option value="{{ formato.id }}" 
                    data-width="{{ formato.ancho }}" 
                    data-height="{{ formato.alto }}" 
                    data-cols="{{ formato.columnas }}" 
                    data-rows="{{ formato.filas }}" 
                    data-per-page="{{ formato.por_pagina }}">
              {{ formato.nombre }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Impresora compatible</label>
      <div class="printer-options">
        {% for impresora in impresoras_compatibles %}
        <div class="printer-option {% if loop.first %}selected{% endif %}" data-printer="{{ impresora.id }}">
          <div class="printer-name">{{ impresora.nombre }}</div>
          <div class="printer-description">{{ impresora.descripcion }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Contenido de la etiqueta</label>
      <div class="form-row">
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_nombre" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar nombre del producto</span>
          </div>
        </div>
        
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_precio" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar precio</span>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_codigo" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar código de texto</span>
          </div>
        </div>
        
        <div class="form-col">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="mostrar_codigo_barras" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Mostrar código de barras</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sección de previsualización -->
  <div class="preview-section">
    <h3 class="preview-title">Previsualización</h3>
    <div id="preview-container" class="preview-container">
      <div id="preview-content">
        <!-- La previsualización se generará con JavaScript -->
        <div style="text-align: center; padding: 50px 0;">
          <i class="fas fa-sync fa-spin" style="font-size: 30px; color: #aaa;"></i>
          <p style="margin-top: 10px; color: #666;">Cargando vista previa...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Botones de acción -->
  <div class="btn-container">
    <button id="btn-preview" class="btn btn-outline">
      <i class="fas fa-sync-alt"></i> Actualizar vista previa
    </button>
    
    <button id="btn-print" class="btn btn-secondary">
      <i class="fas fa-print"></i> Imprimir directamente
    </button>
    
    <button id="btn-pdf" class="btn btn-primary">
      <i class="fas fa-file-pdf"></i> Descargar como PDF
    </button>
  </div>
  
  <!-- Área oculta para impresión -->
  <div id="print-content" style="display: none;"></div>
  
  <!-- Contenedor oculto para PDF -->
  <div id="pdf-container" style="display: none;"></div>
</div>

<!-- Scripts JS -->
<!-- Cargar las bibliotecas desde CDN con fallback -->
<script>
  // Función para cargar script con fallback
  function loadScript(url, callback, errorCallback) {
    const script = document.createElement('script');
    script.src = url;
    script.onload = callback;
    script.onerror = errorCallback;
    document.head.appendChild(script);
  }
  
  // Intentar cargar JsBarcode
  loadScript(
    'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js',
    function() { console.log('JsBarcode cargado correctamente'); },
    function() { 
      console.error('Error al cargar JsBarcode desde CDN primario');
      // Intentar CDN alternativo
      loadScript(
        'https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js',
        function() { console.log('JsBarcode cargado desde CDN alternativo'); },
        function() { 
          console.error('Error al cargar JsBarcode desde CDN alternativo');
          document.getElementById('dependency-error').style.display = 'block';
        }
      );
    }
  );
  
  // Intentar cargar jsPDF
  loadScript(
    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
    function() { console.log('jsPDF cargado correctamente'); },
    function() { 
      console.error('Error al cargar jsPDF');
      document.getElementById('dependency-error').style.display = 'block';
    }
  );
  
  // Intentar cargar html2canvas
  loadScript(
    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
    function() { console.log('html2canvas cargado correctamente'); },
    function() { 
      console.error('Error al cargar html2canvas');
      document.getElementById('dependency-error').style.display = 'block';
    }
  );
</script>

<script>
  // Esperar a que el DOM esté completamente cargado
  document.addEventListener('DOMContentLoaded', function() {
    // Verificar periódicamente si las bibliotecas se han cargado
    const dependencyCheck = setInterval(function() {
      if (typeof JsBarcode !== 'undefined' && 
          typeof window.jspdf !== 'undefined' && 
          typeof html2canvas !== 'undefined') {
        
        // Todas las bibliotecas están cargadas, inicializar la aplicación
        clearInterval(dependencyCheck);
        initLabelApp();
        console.log('Todas las bibliotecas cargadas, iniciando aplicación');
      }
    }, 500); // Comprobar cada 500ms
    
    // Tiempo máximo de espera: 5 segundos
    setTimeout(function() {
      clearInterval(dependencyCheck);
      if (typeof JsBarcode === 'undefined' || 
          typeof window.jspdf === 'undefined' || 
          typeof html2canvas === 'undefined') {
        
        document.getElementById('dependency-error').style.display = 'block';
        console.error('No se pudieron cargar todas las bibliotecas necesarias');
      }
    }, 5000);
  });
  
  // Función principal de la aplicación
  function initLabelApp() {
    // Datos del producto (Escapar comillas en el nombre para evitar errores)
    const producto = {
      id: {{ producto.id }},
      nombre: "{{ producto.nombre|replace('"', '\\"')|replace('\n', ' ')|replace('\r', '') }}",
      codigo: "{{ producto.codigo_barras_externo }}",
      precio: {{ precio_final }},
      stock: {{ producto.stock }}
    };
    
    // Verificar que el producto tenga un código válido
    if (!producto.codigo || producto.codigo.trim() === '') {
      document.getElementById('dependency-error').style.display = 'block';
      document.getElementById('dependency-error').innerHTML = 
        '<strong>Error:</strong> Este producto no tiene un código de barras válido.';
      
      // Deshabilitar botones
      document.getElementById('btn-print').disabled = true;
      document.getElementById('btn-pdf').disabled = true;
      return;
    }
    
    // Elementos DOM
    const checkboxStock = document.getElementById('usar_stock');
    const inputCantidad = document.getElementById('cantidad');
    const selectFormato = document.getElementById('formato_etiqueta');
    const printerOptions = document.querySelectorAll('.printer-option');
    const checkboxNombre = document.getElementById('mostrar_nombre');
    const checkboxPrecio = document.getElementById('mostrar_precio');
    const checkboxCodigo = document.getElementById('mostrar_codigo');
    const checkboxCodigoBarras = document.getElementById('mostrar_codigo_barras');
    const btnPreview = document.getElementById('btn-preview');
    const btnPrint = document.getElementById('btn-print');
    const btnPDF = document.getElementById('btn-pdf');
    const previewContainer = document.getElementById('preview-container');
    const previewContent = document.getElementById('preview-content');
    const printContent = document.getElementById('print-content');
    const pdfContainer = document.getElementById('pdf-container');
    
    // Evento para habilitar/deshabilitar input de cantidad
    checkboxStock.addEventListener('change', function() {
      inputCantidad.disabled = this.checked;
      if (this.checked) {
        inputCantidad.value = producto.stock;
      }
    });
    
    // Evento para seleccionar impresora
    printerOptions.forEach(option => {
      option.addEventListener('click', function() {
        printerOptions.forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        generarVistaPrevia();
      });
    });
    
    // Eventos para actualizar vista previa
    [checkboxNombre, checkboxPrecio, checkboxCodigo, checkboxCodigoBarras, selectFormato].forEach(element => {
      element.addEventListener('change', generarVistaPrevia);
    });
    
    inputCantidad.addEventListener('input', generarVistaPrevia);
    btnPreview.addEventListener('click', generarVistaPrevia);
    
    // Eventos para impresión y PDF
    btnPrint.addEventListener('click', imprimirEtiquetas);
    btnPDF.addEventListener('click', descargarPDF);
    
    // Generar vista previa inicial
    generarVistaPrevia();
    
    // Función para obtener el formato seleccionado
    function obtenerFormatoSeleccionado() {
      const option = selectFormato.options[selectFormato.selectedIndex];
      return {
        id: option.value,
        ancho: parseFloat(option.dataset.width),
        alto: parseFloat(option.dataset.height),
        columnas: parseInt(option.dataset.cols),
        filas: parseInt(option.dataset.rows),
        porPagina: parseInt(option.dataset.perPage)
      };
    }
    
    // Función para obtener la impresora seleccionada
    function obtenerImpresoraSeleccionada() {
      const selected = document.querySelector('.printer-option.selected');
      return selected ? selected.dataset.printer : 'normal';
    }
    
    // Función para obtener la cantidad de etiquetas
    function obtenerCantidad() {
      return checkboxStock.checked ? producto.stock : parseInt(inputCantidad.value) || 1;
    }
    
    // Función para generar la vista previa
    function generarVistaPrevia() {
      try {
        const cantidad = obtenerCantidad();
        const formato = obtenerFormatoSeleccionado();
        const impresora = obtenerImpresoraSeleccionada();
        
        // Configuración según el tipo de impresora
        let configuracion = {};
        
        if (impresora === 'normal') {
          // Página A4 estándar para impresoras normales
          configuracion = {
            paginaAncho: 210, // mm
            paginaAlto: 297,  // mm
            marginX: 6.35,    // mm
            marginY: 12.7,    // mm
          };
        } else {
          // Para impresoras térmicas, ajustamos según el formato
          configuracion = {
            paginaAncho: formato.ancho + 5,
            paginaAlto: formato.alto + 5,
            marginX: 2.5,
            marginY: 2.5,
          };
        }
        
        // Limpiamos el contenedor
        previewContent.innerHTML = '';
        
        if (impresora === 'normal') {
          // Para impresoras normales, creamos hojas con múltiples etiquetas
          const etiquetasPorPagina = formato.porPagina;
          const numPaginas = Math.ceil(cantidad / etiquetasPorPagina);
          
          for (let pagina = 0; pagina < Math.min(numPaginas, 3); pagina++) { // Limitamos a 3 páginas en la vista previa
            // Crear hoja
            const hoja = document.createElement('div');
            hoja.className = 'preview-sheet';
            hoja.style.width = configuracion.paginaAncho + 'mm';
            hoja.style.height = configuracion.paginaAlto + 'mm';
            hoja.style.position = 'relative';
            
            // Añadir etiquetas a la hoja
            for (let i = 0; i < formato.filas; i++) {
              for (let j = 0; j < formato.columnas; j++) {
                const index = pagina * etiquetasPorPagina + i * formato.columnas + j;
                
                if (index < cantidad) {
                  // Calcular posición de la etiqueta
                  const posX = configuracion.marginX + j * formato.ancho;
                  const posY = configuracion.marginY + i * formato.alto;
                  
                  // Crear etiqueta
                  const etiqueta = crearEtiqueta(formato.ancho, formato.alto);
                  etiqueta.style.left = posX + 'mm';
                  etiqueta.style.top = posY + 'mm';
                  
                  hoja.appendChild(etiqueta);
                }
              }
            }
            
            previewContent.appendChild(hoja);
            
            // Separador entre páginas
            if (pagina < Math.min(numPaginas, 3) - 1) {
              const separador = document.createElement('div');
              separador.style.marginBottom = '20px';
              previewContent.appendChild(separador);
            }
          }
          
          // Si hay más páginas, mostrar mensaje
          if (numPaginas > 3) {
            const mensaje = document.createElement('p');
            mensaje.textContent = `Hay ${numPaginas} páginas en total. Solo se muestran las primeras 3 en la vista previa.`;
            mensaje.style.marginTop = '15px';
            mensaje.style.fontStyle = 'italic';
            mensaje.style.color = '#666';
            previewContent.appendChild(mensaje);
          }
        } else {
          // Para impresoras térmicas, mostramos solo algunas etiquetas individuales como ejemplo
          const numEjemplos = Math.min(cantidad, 4);
          const etiquetasContainer = document.createElement('div');
          etiquetasContainer.style.display = 'flex';
          etiquetasContainer.style.flexWrap = 'wrap';
          etiquetasContainer.style.gap = '10px';
          
          for (let i = 0; i < numEjemplos; i++) {
            const etiqueta = crearEtiqueta(formato.ancho, formato.alto);
            etiqueta.style.position = 'relative';
            etiquetasContainer.appendChild(etiqueta);
          }
          
          previewContent.appendChild(etiquetasContainer);
          
          if (cantidad > numEjemplos) {
            const mensaje = document.createElement('p');
            mensaje.textContent = `Se generarán ${cantidad} etiquetas en total.`;
            mensaje.style.marginTop = '15px';
            mensaje.style.fontStyle = 'italic';
            mensaje.style.color = '#666';
            previewContent.appendChild(mensaje);
          }
        }
        
        // Generar códigos de barras con un pequeño retraso para asegurar que los SVG estén en el DOM
        setTimeout(() => {
          generarCodigosBarras();
        }, 100);
      } catch (error) {
        console.error("Error en generarVistaPrevia:", error);
        previewContent.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #721c24; background-color: #f8d7da; border-radius: 5px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Error al generar la vista previa: ${error.message}</p>
          </div>
        `;
      }
    }
    
    // Función para crear una etiqueta individual
    function crearEtiqueta(ancho, alto) {
      try {
        const etiqueta = document.createElement('div');
        etiqueta.className = 'etiqueta';
        etiqueta.style.width = ancho + 'mm';
        etiqueta.style.height = alto + 'mm';
        
        const content = document.createElement('div');
        content.className = 'etiqueta-content';
        
        // Añadir elementos según configuración
        if (checkboxNombre.checked) {
          const nombre = document.createElement('div');
          nombre.className = 'etiqueta-nombre';
          nombre.textContent = producto.nombre;
          content.appendChild(nombre);
        }
        
        if (checkboxPrecio.checked) {
          const precio = document.createElement('div');
          precio.className = 'etiqueta-precio';
          precio.textContent = `$${producto.precio.toFixed(2)}`;
          content.appendChild(precio);
        }
        
        if (checkboxCodigoBarras.checked && producto.codigo) {
          const barcode = document.createElement('svg');
          barcode.className = 'etiqueta-barcode';
          // Asegurarse de que el código sea válido para JsBarcode
          barcode.dataset.codigo = producto.codigo;
          content.appendChild(barcode);
        }
        
        if (checkboxCodigo.checked) {
          const codigo = document.createElement('div');
          codigo.className = 'etiqueta-codigo';
          codigo.textContent = producto.codigo;
          content.appendChild(codigo);
        }
        
        etiqueta.appendChild(content);
        return etiqueta;
      } catch (error) {
        console.error("Error en crearEtiqueta:", error);
        const errorElement = document.createElement('div');
        errorElement.style.color = 'red';
        errorElement.style.padding = '10px';
        errorElement.textContent = 'Error al crear etiqueta';
        return errorElement;
      }
    }
    
    // Función para generar códigos de barras en las etiquetas
    function generarCodigosBarras() {
      if (checkboxCodigoBarras.checked && producto.codigo) {
        try {
          // Verificar si JsBarcode está disponible
          if (typeof JsBarcode === 'undefined') {
            console.error("JsBarcode no está disponible");
            return;
          }
          
          // Generar código de barras para cada etiqueta
          document.querySelectorAll('.etiqueta-barcode').forEach((svg, index) => {
            try {
              // Asegurarse de que el código sea válido
              const codigo = svg.dataset.codigo || producto.codigo;
              
              // Configurar el código de barras
              JsBarcode(svg, codigo, {
                format: "CODE128",
                width: 1.5,
                height: 30,
                displayValue: false,
                margin: 0,
                background: "#ffffff"
              });
            } catch(e) {
              console.error(`Error generando código de barras #${index}:`, e);
              
              // Mostrar mensaje de error en la etiqueta
              const errorMsg = document.createElement('div');
              errorMsg.textContent = "Error: Código inválido";
              errorMsg.style.color = "red";
              errorMsg.style.fontSize = "8px";
              
              // Reemplazar el SVG con el mensaje de error
              if (svg.parentNode) {
                svg.parentNode.replaceChild(errorMsg, svg);
              }
            }
          });
        } catch(e) {
          console.error("Error global al generar códigos de barras:", e);
        }
      }
    }
    
    // Función para imprimir etiquetas directamente
    function imprimirEtiquetas() {
      try {
        // Crear una nueva ventana para impresión
        const printWindow = window.open('', '_blank');
        
        if (!printWindow) {
          alert('Por favor, permite las ventanas emergentes para imprimir.');
          return;
        }
        
        // Obtener datos de configuración
        const formato = obtenerFormatoSeleccionado();
        const impresora = obtenerImpresoraSeleccionada();
        const cantidad = obtenerCantidad();
        
        // Crear HTML para impresión
        let printHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Etiquetas - ${producto.nombre}</title>
            <meta charset="UTF-8">
            <style>
              @page {
                size: ${impresora === 'normal' ? 'A4' : formato.ancho + 'mm ' + formato.alto + 'mm'};
                margin: 0;
              }
              body {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
              }
              .preview-sheet {
                position: relative;
                width: ${impresora === 'normal' ? '210mm' : formato.ancho + 'mm'};
                height: ${impresora === 'normal' ? '297mm' : formato.alto + 'mm'};
                page-break-after: always;
              }
              .etiqueta {
                position: absolute;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                overflow: hidden;
                background: white;
                font-family: Arial, sans-serif;
                border: 1px dashed #ddd;
              }
              .etiqueta-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                padding: 2px;
                text-align: center;
              }
              .etiqueta-nombre {
                font-weight: bold;
                font-size: 10px;
                margin-bottom: 2px;
                line-height: 1.1;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                word-break: break-word;
              }
              .etiqueta-precio {
                font-weight: bold;
                font-size: 12px;
                margin-bottom: 2px;
              }
              .etiqueta-codigo {
                font-size: 8px;
                margin-bottom: 2px;
              }
              .etiqueta-barcode {
                max-width: 95%;
                margin-bottom: 2px;
              }
            </style>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
          </head>
          <body>
        `;
        
        // Configuración según tipo de impresora
        let configuracion = {};
        
        if (impresora === 'normal') {
          // Página A4 estándar
          configuracion = {
            paginaAncho: 210, // mm
            paginaAlto: 297,  // mm
            marginX: 6.35,    // mm
            marginY: 12.7,    // mm
          };
          
          // Calcular número de páginas
          const etiquetasPorPagina = formato.porPagina;
          const numPaginas = Math.ceil(cantidad / etiquetasPorPagina);
          
          for (let pagina = 0; pagina < numPaginas; pagina++) {
            printHtml += `<div class="preview-sheet">`;
            
            // Añadir etiquetas a la hoja
            for (let i = a = 0; i < formato.filas; i++) {
              for (let j = 0; j < formato.columnas; j++) {
                const index = pagina * etiquetasPorPagina + i * formato.columnas + j;
                
                if (index < cantidad) {
                  // Calcular posición
                  const posX = configuracion.marginX + j * formato.ancho;
                  const posY = configuracion.marginY + i * formato.alto;
                  
                  // Añadir etiqueta
                  printHtml += generarEtiquetaHTML(posX, posY, formato.ancho, formato.alto);
                }
              }
            }
            
            printHtml += `</div>`;
          }
        } else {
          // Para impresoras térmicas
          for (let i = 0; i < cantidad; i++) {
            printHtml += `<div class="preview-sheet">`;
            printHtml += generarEtiquetaHTML(0, 0, formato.ancho, formato.alto);
            printHtml += `</div>`;
          }
        }
        
        printHtml += `
            <script>
              // Generar códigos de barras al cargar
              window.onload = function() {
                // Verificar que JsBarcode esté disponible
                if (typeof JsBarcode === 'undefined') {
                  alert('Error: No se pudo cargar la biblioteca de códigos de barras');
                  return;
                }
                
                // Generar códigos de barras
                document.querySelectorAll('.etiqueta-barcode').forEach(svg => {
                  try {
                    const codigo = svg.dataset.codigo;
                    if (codigo) {
                      JsBarcode(svg, codigo, {
                        format: "CODE128",
                        width: 1.5,
                        height: 30,
                        displayValue: false,
                        margin: 0,
                        background: "#ffffff"
                      });
                    }
                  } catch(e) {
                    console.error("Error generando código:", e);
                  }
                });
                
                // Esperar a que se carguen los códigos de barras y luego imprimir
                setTimeout(() => {
                  window.print();
                  setTimeout(() => window.close(), 500);
                }, 500);
              };
            </script>
          </body>
          </html>
        `;
        
        // Escribir HTML a la ventana de impresión
        printWindow.document.open();
        printWindow.document.write(printHtml);
        printWindow.document.close();
      } catch(e) {
        console.error("Error al imprimir etiquetas:", e);
        alert("Ocurrió un error al preparar la impresión: " + e.message);
      }
    }
    
    // Función para generar HTML de una etiqueta individual
    function generarEtiquetaHTML(x, y, ancho, alto) {
      let etiquetaHTML = `
        <div class="etiqueta" style="left:${x}mm;top:${y}mm;width:${ancho}mm;height:${alto}mm;">
          <div class="etiqueta-content">
      `;
      
      if (checkboxNombre.checked) {
        etiquetaHTML += `<div class="etiqueta-nombre">${producto.nombre}</div>`;
      }
      
      if (checkboxPrecio.checked) {
        etiquetaHTML += `<div class="etiqueta-precio">$${producto.precio.toFixed(2)}</div>`;
      }
      
      if (checkboxCodigoBarras.checked && producto.codigo) {
        etiquetaHTML += `<svg class="etiqueta-barcode" data-codigo="${producto.codigo}"></svg>`;
      }
      
      if (checkboxCodigo.checked) {
        etiquetaHTML += `<div class="etiqueta-codigo">${producto.codigo}</div>`;
      }
      
      etiquetaHTML += `
          </div>
        </div>
      `;
      
      return etiquetaHTML;
    }
    
    // Función para descargar PDF utilizando html2canvas y jsPDF
    function descargarPDF() {
      try {
        // Verificar que estén disponibles las bibliotecas necesarias
        if (typeof window.jspdf === 'undefined') {
          alert('Error: No se pudo cargar jsPDF. Verifica tu conexión a internet.');
          return;
        }
        
        if (typeof html2canvas === 'undefined') {
          alert('Error: No se pudo cargar html2canvas. Verifica tu conexión a internet.');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        
        // Mostrar mensaje de procesamiento
        const mensajeEspera = document.createElement('div');
        mensajeEspera.style.position = 'fixed';
        mensajeEspera.style.top = '50%';
        mensajeEspera.style.left = '50%';
        mensajeEspera.style.transform = 'translate(-50%, -50%)';
        mensajeEspera.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        mensajeEspera.style.color = 'white';
        mensajeEspera.style.padding = '20px';
        mensajeEspera.style.borderRadius = '10px';
        mensajeEspera.style.zIndex = '9999';
        mensajeEspera.textContent = 'Generando PDF, por favor espere...';
        document.body.appendChild(mensajeEspera);
        
        // Obtener configuración
        const formato = obtenerFormatoSeleccionado();
        const impresora = obtenerImpresoraSeleccionada();
        const cantidad = obtenerCantidad();
        
        // Preparar el contenedor para generar PDF
        pdfContainer.innerHTML = '';
        pdfContainer.style.position = 'absolute';
        pdfContainer.style.left = '-9999px';
        
        // Configuración según el tipo de impresora
        let configuracion = {};
        let orientacion = 'portrait';
        
        if (impresora === 'normal') {
          // Página A4 estándar
          configuracion = {
            paginaAncho: 210, // mm
            paginaAlto: 297,  // mm
            marginX: 6.35,    // mm
            marginY: 12.7,    // mm
          };
        } else {
          // Para impresoras térmicas
          configuracion = {
            paginaAncho: formato.ancho + 5,
            paginaAlto: formato.alto + 5,
            marginX: 2.5,
            marginY: 2.5,
          };
          
          // Ajustar orientación si es necesario
          if (formato.ancho > formato.alto) {
            orientacion = 'landscape';
          }
        }
        
        // Crear contenido para el PDF
        if (impresora === 'normal') {
          // Para impresoras normales, generar una página con todas las etiquetas
          const etiquetasPorPagina = formato.porPagina;
          const numPaginas = Math.ceil(cantidad / etiquetasPorPagina);
          
          // Crear una página para el PDF
          const page = document.createElement('div');
          page.style.width = configuracion.paginaAncho + 'mm';
          page.style.height = configuracion.paginaAlto + 'mm';
          page.style.position = 'relative';
          page.style.background = 'white';
          
          // Agregar etiquetas a la página
          for (let i = 0; i < formato.filas; i++) {
            for (let j = 0; j < formato.columnas; j++) {
              const index = i * formato.columnas + j;
              
              if (index < cantidad) {
                // Calcular posición de la etiqueta
                const posX = configuracion.marginX + j * formato.ancho;
                const posY = configuracion.marginY + i * formato.alto;
                
                // Crear etiqueta
                const etiqueta = crearEtiqueta(formato.ancho, formato.alto);
                etiqueta.style.left = posX + 'mm';
                etiqueta.style.top = posY + 'mm';
                
                page.appendChild(etiqueta);
              }
            }
          }
          
          pdfContainer.appendChild(page);
          
          // Generar códigos de barras
          setTimeout(() => {
            generarCodigosBarrasEnElemento(pdfContainer);
            
            // Usar html2canvas para convertir la página a imagen
            html2canvas(page, {
              scale: 2,
              backgroundColor: null,
              logging: false
            }).then(canvas => {
              // Crear PDF
              const pdf = new jsPDF({
                orientation: orientacion,
                unit: 'mm',
                format: 'a4'
              });
              
              // Añadir imagen de la página al PDF
              const imgData = canvas.toDataURL('image/png');
              pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
              
              // Añadir más páginas si es necesario
              if (numPaginas > 1) {
                for(let p = 1; p < numPaginas; p++) {
                  pdf.addPage();
                  
                  // Crear nueva página
                  page.innerHTML = '';
                  
                  // Agregar etiquetas a la página
                  for (let i = 0; i < formato.filas; i++) {
                    for (let j = 0; j < formato.columnas; j++) {
                      const index = p * etiquetasPorPagina + i * formato.columnas + j;
                      
                      if (index < cantidad) {
                        // Calcular posición de la etiqueta
                        const posX = configuracion.marginX + j * formato.ancho;
                        const posY = configuracion.marginY + i * formato.alto;
                        
                        // Crear etiqueta
                        const etiqueta = crearEtiqueta(formato.ancho, formato.alto);
                        etiqueta.style.left = posX + 'mm';
                        etiqueta.style.top = posY + 'mm';
                        
                        page.appendChild(etiqueta);
                      }
                    }
                  }
                  
                  // Generar códigos de barras
                  generarCodigosBarrasEnElemento(page);
                  
                  // Convertir la página a imagen y añadirla al PDF
                  html2canvas(page, {
                    scale: 2,
                    backgroundColor: null,
                    logging: false
                  }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                    
                    // Si es la última página, guardar PDF
                    if (p === numPaginas - 1) {
                      // Guardar PDF
                      pdf.save(`etiquetas_${producto.nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                      
                      // Eliminar mensaje de espera
                      document.body.removeChild(mensajeEspera);
                    }
                  });
                }
              } else {
                // Si solo hay una página, guardar PDF
                pdf.save(`etiquetas_${producto.nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                
                // Eliminar mensaje de espera
                document.body.removeChild(mensajeEspera);
              }
            });
          }, 100);
        } else {
          // Para impresoras térmicas, generar una etiqueta por página
          // Crear una etiqueta para el PDF
          const etiqueta = crearEtiqueta(formato.ancho, formato.alto);
          pdfContainer.appendChild(etiqueta);
          
          // Generar código de barras
          setTimeout(() => {
            generarCodigosBarrasEnElemento(pdfContainer);
            
            // Usar html2canvas para convertir la etiqueta a imagen
            html2canvas(etiqueta, {
              scale: 4,
              backgroundColor: null,
              logging: false
            }).then(canvas => {
              // Crear PDF
              const pdf = new jsPDF({
                orientation: orientacion,
                unit: 'mm',
                format: [formato.ancho, formato.alto]
              });
              
              // Añadir imagen de la etiqueta al PDF
              const imgData = canvas.toDataURL('image/png');
              pdf.addImage(imgData, 'PNG', 0, 0, formato.ancho, formato.alto);
              
              // Añadir más páginas si es necesario
              if (cantidad > 1) {
                for(let i = 1; i < cantidad; i++) {
                  pdf.addPage();
                  pdf.addImage(imgData, 'PNG', 0, 0, formato.ancho, formato.alto);
                }
              }
              
              // Guardar PDF
              pdf.save(`etiquetas_${producto.nombre.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
              
              // Eliminar mensaje de espera
              document.body.removeChild(mensajeEspera);
            });
          }, 100);
        }
      } catch(e) {
        console.error("Error al generar PDF:", e);
        alert("Ocurrió un error al generar el PDF: " + e.message);
        
        // Eliminar mensaje de espera si existe
        const mensajeEspera = document.querySelector('div[style*="position: fixed"]');
        if (mensajeEspera) {
          document.body.removeChild(mensajeEspera);
        }
      }
    }
    
    // Función para generar códigos de barras en un elemento específico
    function generarCodigosBarrasEnElemento(elemento) {
      if (checkboxCodigoBarras.checked && producto.codigo) {
        try {
          elemento.querySelectorAll('.etiqueta-barcode').forEach(svg => {
            try {
              const codigo = svg.dataset.codigo || producto.codigo;
              
              JsBarcode(svg, codigo, {
                format: "CODE128",
                width: 1.5,
                height: 30,
                displayValue: false,
                margin: 0,
                background: "#ffffff"
              });
            } catch(e) {
              console.error("Error generando código de barras:", e);
            }
          });
        } catch(e) {
          console.error("Error general al generar códigos de barras:", e);
        }
      }
    }
  }
</script>
{% endblock %}