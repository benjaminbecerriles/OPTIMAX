{% extends 'base.html' %}

{% block title %}
  Inventario de Productos
{% endblock %}

{% block summary %}
<div class="text-muted small">
  Mostrando {{ productos|length }} de {{ total_productos if total_productos is defined else 'XX' }} productos | Stock total: {{ productos|sum(attribute='stock') }} | Valor inventario: ${{ (productos|sum(attribute='precio_venta') * productos|sum(attribute='stock'))|round(2) }}
</div>
{% endblock %}

{% block content %}
  <!-- Título y botones -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="mb-0">Inventario</h1>
      <p class="text-muted">Administra aquí tus productos de forma eficiente</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('nuevo_producto') }}" class="btn btn-primary">Agregar Nuevo</a>
      <a href="{{ url_for('reabastecer_listado') }}" class="btn btn-secondary">Reabastecer</a>
      <a href="{{ url_for('pendientes_aprobacion') }}" class="btn btn-warning">Pendientes</a>
    </div>
  </div>

  <!-- Barra de herramientas -->
  <div class="row mb-3">
    <div class="col-md-4">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre, SKU o marca..." value="{{ termino_busqueda if termino_busqueda else '' }}">
      </div>
    </div>
    <div class="col-md-3">
      <select id="filtroCategoria" class="form-select">
        <option value="">Todas las categorías</option>
        <!-- Aquí irían las categorías dinámicas -->
      </select>
    </div>
    <div class="col-md-5 d-flex justify-content-end gap-2">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownColumnas" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-columns"></i> Columnas
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownColumnas">
          <li><a class="dropdown-item" href="#"><input type="checkbox" checked> SKU</a></li>
          <li><a class="dropdown-item" href="#"><input type="checkbox" checked> Categoría</a></li>
          <li><a class="dropdown-item" href="#"><input type="checkbox" checked> Stock</a></li>
          <li><a class="dropdown-item" href="#"><input type="checkbox" checked> Precio</a></li>
        </ul>
      </div>
      <button class="btn btn-outline-secondary">
        <i class="bi bi-download"></i> Exportar Excel
      </button>
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownAcciones" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-gear"></i> Acciones masivas
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownAcciones">
          <li><a class="dropdown-item" href="#">Cambiar categoría</a></li>
          <li><a class="dropdown-item" href="#">Modificar precios</a></li>
          <li><a class="dropdown-item" href="#">Cambiar visibilidad</a></li>
          <li><a class="dropdown-item" href="#">Marcar como favoritos</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Estilos para la tabla y componentes -->
  <style>
    /* Estilos para la miniatura del producto */
    .product-thumb {
      width: 90px;
      height: 90px;
      object-fit: contain;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-bottom: 0;
    }
    
    /* Estilo para la información del producto */
    .product-info {
      line-height: 1.5;
      text-align: left;
      font-size: 0.9rem;
    }
    
    .product-info div {
      margin-bottom: 3px;
    }
    
    /* Estilos para tooltip de categoría */
    .category-tooltip {
      position: relative;
      display: inline-block;
    }
    
    .category-tooltip .category-tooltip-text {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
      font-weight: 500;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .category-tooltip .category-tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    
    .category-tooltip:hover .category-tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* Estilos para expandir detalle */
    .row-detail {
      display: none;
      background-color: #f8f9fa;
      padding: 15px;
      border-top: 1px solid #dee2e6;
    }
    
    /* Menú de acciones */
    .actions-menu {
      position: relative;
      display: inline-block;
    }
    
    .actions-dot {
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
    
    .actions-dropdown {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 180px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1;
    }
    
    .actions-dropdown a {
      color: black;
      padding: 8px 12px;
      text-decoration: none;
      display: block;
      font-size: 14px;
    }
    
    .actions-dropdown a:hover {
      background-color: #f1f1f1;
    }
    
    /* Iconos para favorito y visibilidad */
    .icon-fav, .icon-vis {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    /* Filas zebra estrictas */
    .row-white {
      background-color: #ffffff !important;
    }
    
    .row-gray {
      background-color: #f8f9fa !important;
    }
    
    /* Separación entre columnas */
    .table-column-separated th,
    .table-column-separated td {
      border-right: 1px solid #dee2e6;
      padding-left: 12px;
      padding-right: 12px;
    }
    
    .table-column-separated th:last-child,
    .table-column-separated td:last-child {
      border-right: none;
    }
    
    /* Bordes completos para la tabla */
    .table-column-separated {
      border: 1px solid #dee2e6;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .table-column-separated thead th {
      border-bottom: 2px solid #dee2e6;
    }
    
    .table-column-separated tbody tr {
      border-bottom: 1px solid #dee2e6;
    }
    
    .table-column-separated tbody tr:last-child {
      border-bottom: none;
    }
    
    /* Detalle siempre con fondo claro */
    .detail-row {
      background-color: #f8f9fa !important;
    }
  </style>

  <!-- Tabla de productos -->
  <div class="table-responsive">
    <table class="table align-middle border-top table-column-separated" id="productsTable">
      <thead class="table-light">
        <tr>
          <th style="width: 120px;" class="text-center">FOTO</th>
          <th style="width: 280px;" class="text-center">DEL PRODUCTO</th>
          <th style="width: 50px;" class="text-center">CATEGORÍA</th>
          <th style="width: 90px;" class="text-center">STOCK</th>
          <th style="width: 100px;" class="text-center">CADUCIDAD</th>
          <th style="width: 90px;" class="text-center">PRECIO</th>
          <th style="width: 90px;" class="text-center">COSTO</th>
          <th style="width: 30px;" class="text-center">FAV</th>
          <th style="width: 30px;" class="text-center">VIS</th>
          <th style="width: 40px;" class="text-center">MENÚ</th>
        </tr>
      </thead>
      <tbody>
        {% for p in productos %}
        <tr class="{% if loop.index0 % 2 == 0 %}row-white{% else %}row-gray{% endif %}" data-id="{{ p.id }}">
          <!-- Foto -->
          <td class="text-center">
            {% if p.foto %}
              <img src="{{ url_for('static', filename='uploads/' ~ p.foto) }}" alt="Foto" class="product-thumb">
            {% else %}
              <div class="bg-light rounded product-thumb" style="display: inline-block;"></div>
            {% endif %}
          </td>
          
          <!-- Del Producto -->
          <td style="text-align: left; padding-left: 15px;">
            <div class="product-info">
              <div><strong>Nombre:</strong> {{ p.nombre }}</div>
              <div><strong>Marca:</strong> {{ p.marca|default('No definida') }}</div>
              <div><strong>SKU:</strong> 
                {% if p.codigo_barras_externo %}
                  {{ p.codigo_barras_externo }}
                {% else %}
                  SKU-{{ '%05d' % p.id }}
                {% endif %}
              </div>
            </div>
          </td>
          
          <!-- Categoría -->
          <td class="text-center">
            {% set cat_color = p.categoria_color|default('#CCCCCC') %}
            {% if p.categoria == 'abarrotes secos' %}
              {% set cat_color = '#FFA500' %}
            {% elif p.categoria == 'enlatados y conservas' %}
              {% set cat_color = '#DAA520' %}
            {% elif p.categoria == 'botanas, dulces y snacks' %}
              {% set cat_color = '#FF69B4' %}
            {% elif p.categoria == 'bebidas no alcohólicas' %}
              {% set cat_color = '#1E90FF' %}
            {% elif p.categoria == 'bebidas alcohólicas' %}
              {% set cat_color = '#800080' %}
            {% endif %}

            <div class="category-tooltip">
              <span class="d-inline-block rounded-circle" 
                    style="width:12px; height:12px; background-color:{{ cat_color }}; border: 1px solid rgba(0,0,0,0.1);">
              </span>
              <span class="category-tooltip-text">{{ p.categoria|default('Sin categoría')|title }}</span>
            </div>
          </td>
          
          <!-- Stock -->
          <td class="text-center fw-medium">
            {% if p.stock < p.alerta_stock|default(5) and p.stock > 0 %}
              <span class="text-warning">{{ p.stock }} piezas</span>
            {% elif p.stock <= 0 %}
              <span class="text-danger">{{ p.stock }} piezas</span>
            {% else %}
              {{ p.stock }} piezas
            {% endif %}
          </td>
          
          <!-- Caducidad -->
          <td class="text-center">
            {% if p.has_caducidad %}
              {{ p.metodo_caducidad|default('N/A') }}
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          
          <!-- Precio -->
          <td class="text-center fw-medium">$ {{ p.precio_venta|default(0)|round(2) }}</td>
          
          <!-- Costo -->
          <td class="text-center fw-medium">$ {{ p.costo|default(0)|round(2) }}</td>
          
          <!-- Favorito -->
          <td class="text-center">
            <span class="fav-toggle" data-id="{{ p.id }}" data-status="{{ p.es_favorito|default(false) }}">
              {% if p.es_favorito %}
                <span class="heart-icon active" style="font-size: 20px; color: red; cursor: pointer;">&#9829;</span>
              {% else %}
                <span class="heart-icon" style="font-size: 20px; color: gray; cursor: pointer;">&#9825;</span>
              {% endif %}
            </span>
          </td>
          
          <!-- Visibilidad -->
          <td class="text-center">
            <span class="vis-toggle" data-id="{{ p.id }}" data-status="{{ p.esta_a_la_venta|default(true) }}">
              {% if p.esta_a_la_venta %}
                <img src="{{ url_for('static', filename='img/1.png') }}" class="venta-icon" style="width:24px; cursor:pointer;">
              {% else %}
                <img src="{{ url_for('static', filename='img/2.png') }}" class="venta-icon" style="width:24px; cursor:pointer;">
              {% endif %}
            </span>
          </td>
          
          <!-- Menú -->
          <td class="text-center">
            <div class="actions-menu">
              <span class="actions-dot" onclick="toggleActionsMenu(event, this)">⋯</span>
              <div class="actions-dropdown">
                <a href="#" onclick="addStock({{ p.id }})">Añadir existencias</a>
                <a href="#" onclick="changePrice({{ p.id }})">Cambiar precio</a>
                <a href="#" onclick="changeCost({{ p.id }})">Cambiar costo</a>
                <a href="{{ url_for('editar_producto', prod_id=p.id) }}">Editar producto</a>
                <a href="#" onclick="toggleVisibility({{ p.id }})">{% if p.esta_a_la_venta %}Ocultar producto{% else %}Mostrar producto{% endif %}</a>
                <a href="#" onclick="toggleFavorite({{ p.id }})">{% if p.es_favorito %}Quitar de favoritos{% else %}Marcar como favorito{% endif %}</a>
                <a href="#" onclick="setLocation({{ p.id }})">Definir ubicación</a>
                <a href="#" onclick="printLabels({{ p.id }})">Imprimir etiquetas</a>
                <a href="#" onclick="confirmDelete({{ p.id }}, '{{ p.nombre }}')">Eliminar producto</a>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Mensaje si no hay productos -->
  {% if productos|length == 0 %}
  <div class="alert alert-info">
    No hay productos que coincidan con los criterios seleccionados.
  </div>
  {% endif %}

  <!-- Modal de confirmación para eliminar -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar el producto "<span id="deleteProductName"></span>"?</p>
          <p class="text-danger">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <a href="#" id="confirmDelete" class="btn btn-danger">Eliminar</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Inicializar los tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Aplicar rayado zebra explícitamente
    const rows = document.querySelectorAll('.product-row');
    rows.forEach((row, index) => {
      if (index % 2 === 0) {
        row.classList.add('row-white');
        row.classList.remove('row-gray');
      } else {
        row.classList.add('row-gray');
        row.classList.remove('row-white');
      }
    });
    
    // Toggle para Favoritos
    document.querySelectorAll('.fav-toggle').forEach(function(toggle) {
      toggle.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const heartIcon = this.querySelector('.heart-icon');
        const currentStatus = heartIcon.classList.contains('active');
        
        // Toggle visual
        if (currentStatus) {
          heartIcon.classList.remove('active');
          heartIcon.style.color = 'gray';
          heartIcon.innerHTML = '&#9825;';
        } else {
          heartIcon.classList.add('active');
          heartIcon.style.color = 'red';
          heartIcon.innerHTML = '&#9829;';
        }
        
        // AJAX para actualizar en la base de datos
        fetch('/api/toggle-favorito/' + id, {
          method: 'POST'
        }).catch(error => {
          console.error('Error:', error);
          // Revertir cambio visual si hay error
          if (currentStatus) {
            heartIcon.classList.add('active');
            heartIcon.style.color = 'red';
            heartIcon.innerHTML = '&#9829;';
          } else {
            heartIcon.classList.remove('active');
            heartIcon.style.color = 'gray';
            heartIcon.innerHTML = '&#9825;';
          }
        });
      });
    });
    
    // Toggle para Visibilidad
    document.querySelectorAll('.vis-toggle').forEach(function(toggle) {
      toggle.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const ventaIcon = this.querySelector('.venta-icon');
        const currentStatus = this.getAttribute('data-status') === 'true';
        
        // Toggle visual
        if (currentStatus) {
          ventaIcon.src = "{{ url_for('static', filename='img/2.png') }}";
          this.setAttribute('data-status', 'false');
        } else {
          ventaIcon.src = "{{ url_for('static', filename='img/1.png') }}";
          this.setAttribute('data-status', 'true');
        }
        
        // AJAX para actualizar en la base de datos
        fetch('/api/toggle-visibilidad/' + id, {
          method: 'POST'
        }).catch(error => {
          console.error('Error:', error);
          // Revertir cambio visual si hay error
          if (currentStatus) {
            ventaIcon.src = "{{ url_for('static', filename='img/1.png') }}";
            this.setAttribute('data-status', 'true');
          } else {
            ventaIcon.src = "{{ url_for('static', filename='img/2.png') }}";
            this.setAttribute('data-status', 'false');
          }
        });
      });
    });
    
    // Cerrar todos los menús al hacer clic en cualquier lugar
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.actions-dot') && !e.target.closest('.actions-dropdown')) {
        document.querySelectorAll('.actions-dropdown').forEach(function(menu) {
          menu.style.display = 'none';
        });
      }
    });
    
    // Modal de confirmación
    window.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  });
  
  // Función para mostrar/ocultar el menú de acciones
  function toggleActionsMenu(event, dot) {
    event.stopPropagation(); // Prevenir propagación
    
    const dropdown = dot.nextElementSibling;
    const isVisible = dropdown.style.display === 'block';
    
    // Cerrar todos los menús abiertos primero
    document.querySelectorAll('.actions-dropdown').forEach(menu => {
      menu.style.display = 'none';
    });
    
    // Abrir/cerrar el menú actual
    dropdown.style.display = isVisible ? 'none' : 'block';
  }
  
  // Funciones para acciones del menú
  function confirmDelete(id, name) {
    document.getElementById('deleteProductName').textContent = name;
    document.getElementById('confirmDelete').href = "/eliminar-producto/" + id;
    window.deleteModal.show();
  }
  
  function toggleFavorite(id) {
    const toggle = document.querySelector(`.fav-toggle[data-id="${id}"]`);
    toggle.click();
  }
  
  function toggleVisibility(id) {
    const toggle = document.querySelector(`.vis-toggle[data-id="${id}"]`);
    toggle.click();
  }
  
  // Estas funciones necesitarán implementación adicional en producción
  function addStock(id) {
    alert("Función pendiente: Añadir existencias al producto " + id);
  }
  
  function changePrice(id) {
    alert("Función pendiente: Cambiar precio del producto " + id);
  }
  
  function changeCost(id) {
    alert("Función pendiente: Cambiar costo del producto " + id);
  }
  
  function setLocation(id) {
    alert("Función pendiente: Definir ubicación del producto " + id);
  }
  
  function printLabels(id) {
    alert("Función pendiente: Imprimir etiquetas para el producto " + id);
  }
</script>
{% endblock %}