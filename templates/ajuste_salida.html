{% extends 'base.html' %}

{% block title %}
  Registrar Salida - {{ producto.nombre }}
{% endblock %}

{% block content %}
<style>
  /* Diseño elegante inspirado en Apple */
  :root {
    --font-system: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    --text-color: #1d1d1f;
    --text-secondary: #86868b;
    --color-background: #f5f5f7;
    --color-card: #ffffff;
    --color-border: rgba(0, 0, 0, 0.1);
    --color-primary: #e52e2e; /* Rojo para botón guardar */
    --color-accent: #0066cc; /* Azul Apple para selecciones */
    --color-success: #34c759; /* Verde Apple */
    --color-warning: #ff9f0a; /* Naranja Apple */
    --color-danger: #ff3b30; /* Rojo Apple */
    --border-radius: 12px;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
  }
  
  body {
    font-family: var(--font-system);
    color: var(--text-color);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    background-color: var(--color-background);
    margin: 0;
    padding: 0;
  }
  
  .entry-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Encabezado de página - Como en ajuste_stock.html */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 3rem; /* Aumentado el espacio entre título y paneles */
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    color: var(--text-color);
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
  }
  
  /* Botones con estilo Apple */
  .btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: var(--transition);
    text-decoration: none;
    cursor: pointer;
    border: none;
    text-align: center;
  }
  
  .btn-icon i, 
  .btn-icon span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1;
  }
  
  .btn-outline {
    background-color: var(--color-card);
    color: var(--text-color);
    border: 1px solid var(--color-border);
  }
  
  .btn-outline:hover {
    background-color: #f2f2f2;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  .btn-primary {
    background-color: var(--color-primary);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #d12323;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(229, 46, 46, 0.25);
  }
  
  /* Diseño de dos columnas con misma altura */
  .two-column-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    grid-auto-rows: minmax(min-content, max-content);
    gap: 24px;
    margin-bottom: 24px;
  }
  
  /* Panel de producto */
  .product-panel {
    background-color: var(--color-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    height: auto; /* Altura automática */
    display: flex;
    flex-direction: column;
  }
  
  .product-image-container {
    width: 100%;
    height: 250px;
    overflow: hidden;
    position: relative;
    background-color: var(--color-background);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .product-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: var(--transition);
  }
  
  .product-info {
    padding: 24px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .product-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0 0 16px 0;
    line-height: 1.3;
  }
  
  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--color-border);
  }
  
  .info-row:last-child {
    border-bottom: none;
    margin-bottom: auto;
  }
  
  .info-label {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
  }
  
  .info-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-color);
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
  }
  
  .badge-success {
    background-color: rgba(52, 199, 89, 0.12);
    color: var(--color-success);
  }
  
  .badge-warning {
    background-color: rgba(255, 159, 10, 0.12);
    color: var(--color-warning);
  }
  
  .badge-danger {
    background-color: rgba(255, 59, 48, 0.12);
    color: var(--color-danger);
  }
  
  /* Formulario compacto */
  .entry-form {
    background-color: var(--color-card);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    height: auto;
    display: flex;
    flex-direction: column;
  }
  
  .form-body {
    padding: 24px;
    flex-grow: 1;
  }
  
  .form-section {
    margin-bottom: 24px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
  }
  
  .form-control {
    display: block;
    width: 100%;
    padding: 12px 14px;
    font-size: 15px;
    line-height: 1.5;
    color: var(--text-color);
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    transition: var(--transition);
  }
  
  .form-control:focus {
    border-color: var(--color-accent);
    outline: 0;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15);
  }
  
  /* Select con ícono */
  .select-container {
    position: relative;
  }
  
  .select-container .form-control {
    padding-right: 40px;
    appearance: none;
  }
  
  .select-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    pointer-events: none;
    font-size: 16px;
  }
  
  .form-check {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  
  .form-check-input {
    width: 18px;
    height: 18px;
    margin: 0;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    transition: var(--transition);
  }
  
  .form-check-input:checked {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
  }
  
  .form-check-label {
    font-size: 15px;
    color: var(--text-color);
  }
  
  /* Input con unidad */
  .quantity-input-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .quantity-input-container .form-control {
    padding-right: 70px;
  }

  .unit-indicator {
    position: absolute;
    right: 14px;
    color: var(--text-secondary);
    pointer-events: none;
    font-size: 14px;
    font-weight: 500;
  }
  
  /* Radio buttons para impacto financiero */
  .radio-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  
  .radio-option {
    position: relative;
  }
  
  .radio-option input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }
  
  .radio-option label {
    display: inline-block;
    padding: 8px 12px;
    font-size: 14px;
    background-color: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    color: var(--text-color);
  }
  
  .radio-option label:hover {
    background-color: #f2f2f2;
  }
  
  .radio-option input:checked + label {
    background-color: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }
  
  /* Secciones colapsables estilo Apple */
  .collapse-section {
    margin-bottom: 16px;
    border: 1px solid var(--color-border);
    border-radius: 10px;
    overflow: hidden;
  }
  
  .collapse-header {
    padding: 14px 16px;
    background-color: var(--color-card);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-color);
    user-select: none;
  }
  
  .collapse-header:hover {
    background-color: #f5f5f7;
  }
  
  .collapse-header i {
    color: var(--text-secondary);
    transition: transform 0.3s ease;
  }
  
  .collapse-header.active i {
    transform: rotate(180deg);
  }
  
  .collapse-content {
    padding: 16px;
    border-top: 1px solid var(--color-border);
    display: none;
  }
  
  /* Responsive design */
  @media (max-width: 992px) {
    .two-column-layout {
      grid-template-columns: 1fr;
    }
    
    .form-row {
      grid-template-columns: 1fr;
      gap: 16px;
    }
  }
  
  @media (max-width: 768px) {
    .entry-container {
      padding: 20px 16px;
    }
    
    .page-header {
      flex-direction: column;
      gap: 16px;
      margin-bottom: 2rem;
    }
    
    .header-actions {
      width: 100%;
      justify-content: space-between;
      padding-top: 0;
    }
    
    .product-image-container {
      height: 200px;
    }
  }
</style>

<div class="entry-container">
  <!-- Encabezado con título y acciones -->
  <div class="page-header">
    <h1 class="page-title">Registrar Salida</h1>
    <div class="header-actions">
      <a href="{{ url_for('ajuste_stock') }}" class="btn-icon btn-outline">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
      <button type="submit" form="salidaForm" class="btn-icon btn-primary">
        <span>Confirmar salida</span>
      </button>
    </div>
  </div>
  
  <!-- Diseño de dos columnas con misma altura -->
  <div class="two-column-layout">
    <!-- Panel de producto (izquierda) -->
    <div class="product-panel">
      <div class="product-image-container">
        {% if producto.foto %}
          <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" alt="{{ producto.nombre }}" class="product-image">
        {% else %}
          <img src="{{ url_for('static', filename='img/default_product.jpg') }}" alt="Imagen predeterminada" class="product-image">
        {% endif %}
      </div>
      <div class="product-info">
        <h2 class="product-title">{{ producto.nombre }}</h2>
        
        <div class="info-row">
          <span class="info-label">Stock actual</span>
          <span class="info-value">
            {% if producto.stock <= 0 %}
              <span class="badge badge-danger">Sin stock</span>
            {% elif producto.stock < 6 %}
              <span class="badge badge-warning">{{ producto.stock }}</span>
            {% else %}
              <span class="badge badge-success">{{ producto.stock }}</span>
            {% endif %}
          </span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Costo actual</span>
          <span class="info-value" id="costoActualValue">${{ producto.costo|round(2) }}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Precio de venta</span>
          <span class="info-value" id="precioVentaValue">${{ producto.precio_venta|round(2) }}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Código</span>
          <span class="info-value">{{ producto.codigo_barras_externo }}</span>
        </div>
      </div>
    </div>
    
    <!-- Formulario de salida (derecha) -->
    <form method="POST" action="{{ url_for('ajuste_salida', producto_id=producto.id) }}" enctype="multipart/form-data" id="salidaForm">
      <div class="entry-form">
        <div class="form-body">
          <!-- Sección principal -->
          <div class="form-section">
            <div class="form-row">
              <div class="form-group">
                <label for="cantidad" class="form-label">Cantidad a reducir</label>
                <div class="quantity-input-container">
                  <input type="text" 
                         class="form-control" 
                         id="cantidad" 
                         name="cantidad" 
                         required 
                         value="1"
                         inputmode="decimal"
                         max="{{ producto.stock }}">
                  <span class="unit-indicator" id="unidadIndicator">
                    {% if producto.unidad %}
                      {% if producto.unidad == 'pieza' %}PIEZA{% else %}{{ producto.unidad|upper }}{% endif %}
                    {% else %}
                      PIEZA
                    {% endif %}
                  </span>
                </div>
              </div>
              
              <div class="form-group">
                <label for="motivo" class="form-label">Motivo</label>
                <div class="select-container">
                  <select class="form-control" id="motivo" name="motivo" required>
                    <option value="merma">Merma por daño</option>
                    <option value="caducidad">Caducidad</option>
                    <option value="robo">Robo o pérdida</option>
                    <option value="venta_manual">Venta manual</option>
                    <option value="ajuste">Ajuste de inventario</option>
                    <option value="transferencia">Transferencia entre sucursales</option>
                    <option value="devolucion">Devolución a proveedor</option>
                    <option value="otro">Otro motivo</option>
                  </select>
                  <span class="select-icon"><i class="fas fa-chevron-down"></i></span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Impacto financiero -->
          <div class="form-section">
            <div class="form-group">
              <label class="form-label">Impacto financiero</label>
              <div class="radio-options">
                <div class="radio-option">
                  <input type="radio" id="impactoSi" name="impacto_financiero" value="1" checked>
                  <label for="impactoSi">Registrar como pérdida</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="impactoNo" name="impacto_financiero" value="0">
                  <label for="impactoNo">Sin impacto financiero</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Input oculto para método de descuento -->
          <input type="hidden" name="metodo_descuento" value="auto">
          
          <!-- Notas adicionales como sección colapsable -->
          <div class="collapse-section">
            <div class="collapse-header" onclick="toggleCollapse('notasSection')">
              <span><i class="fas fa-sticky-note" style="margin-right:8px;"></i> Notas adicionales</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="collapse-content" id="notasSection">
              <input type="hidden" id="toggle_notas_estado" name="toggle_notas_estado" value="DESACTIVADO">
              <textarea class="form-control" id="notas" name="notas" rows="2" placeholder="Información adicional..."></textarea>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Función simple para formatear dinero con comas
    function formatMoney(number) {
      if (typeof number === 'string') {
        number = parseFloat(number.replace(/[^\d.-]/g, ''));
      }
      
      if (isNaN(number)) {
        return '$0.00';
      }
      
      // Usar toLocaleString para formatear con comas
      return '$' + number.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    
    // Formatear valores monetarios en el panel de información
    const costoActualEl = document.getElementById('costoActualValue');
    if (costoActualEl) {
      const valor = parseFloat(costoActualEl.textContent.replace('$', ''));
      costoActualEl.textContent = formatMoney(valor);
    }
    
    const precioVentaEl = document.getElementById('precioVentaValue');
    if (precioVentaEl) {
      const valor = parseFloat(precioVentaEl.textContent.replace('$', ''));
      precioVentaEl.textContent = formatMoney(valor);
    }
    
    // Obtener el campo de cantidad y su unidad
    const cantidadInput = document.getElementById('cantidad');
    const unidadIndicator = document.getElementById('unidadIndicator');
    
    // Determinar si el producto usa unidades (no piezas)
    const esUnidadDecimal = {% if producto.unidad and producto.unidad not in ['pieza', 'piezas'] %}true{% else %}false{% endif %};
    
    // Función para actualizar la unidad basada en la cantidad
    function updateUnitText() {
      // Obtener la unidad del producto (o usar 'pieza'/'piezas' por defecto)
      {% if producto.unidad %}
        let unidad = '{{ producto.unidad }}';
        
        if (unidad === 'pieza') {
          // Si es 'pieza', cambia a plural cuando es más de 1
          unidadIndicator.textContent = parseFloat(cantidadInput.value) === 1 ? 'PIEZA' : 'PIEZAS';
        } else {
          // Mantener unidad existente (KG, L, etc.)
          unidadIndicator.textContent = unidad.toUpperCase();
        }
      {% else %}
        // Para productos sin unidad específica, usar pieza/piezas
        unidadIndicator.textContent = parseFloat(cantidadInput.value) === 1 ? 'PIEZA' : 'PIEZAS';
      {% endif %}
    }
    
    // Validación del formato y limitación de decimales para el campo cantidad
    if (cantidadInput) {
      // Configurar manejo de entrada para el campo cantidad
      cantidadInput.addEventListener('input', function(e) {
        let valor = e.target.value;
        
        // Permitir campo vacío temporalmente para facilitar la edición
        if (valor === '') {
          return;
        }
        
        if (esUnidadDecimal) {
          // Para productos con unidades decimales (kg, l, etc.)
          
          // Patrón que permite números con hasta 3 decimales
          // Acepta: "0", "1", "1.2", "1.23", "1.234", "10.234", etc.
          const patronDecimal = /^(\d+)?(\.\d{0,3})?$/;
          
          if (!patronDecimal.test(valor)) {
            // Si no cumple con el patrón, revertir al valor anterior
            if (e.target.defaultValue) {
              e.target.value = e.target.defaultValue;
            } else {
              e.target.value = '0';
            }
          } else {
            // Actualizar el valor predeterminado para futuras validaciones
            e.target.defaultValue = e.target.value;
          }
        } else {
          // Para productos en piezas (solo enteros)
          const patronEntero = /^[0-9]+$/;
          if (!patronEntero.test(valor)) {
            // Si no cumple con el patrón y no está vacío, revertir
            if (e.target.defaultValue) {
              e.target.value = e.target.defaultValue;
            } else {
              e.target.value = '1';
            }
          } else {
            e.target.defaultValue = e.target.value;
          }
        }
        
        // Actualizar texto de unidad si hay un valor
        if (e.target.value) {
          updateUnitText();
        }
      });
    }
    
    // Función para manejar los colapsables - Función global
    window.toggleCollapse = function(id) {
      const content = document.getElementById(id);
      const header = content.previousElementSibling;
      const icon = header.querySelector('i.fas.fa-chevron-down, i.fas.fa-chevron-up');
      
      if (content.style.display === 'block') {
        content.style.display = 'none';
        header.classList.remove('active');
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        
        // Actualizar estado oculto
        if (id === 'notasSection') {
          document.getElementById('toggle_notas_estado').value = 'DESACTIVADO';
        }
      } else {
        content.style.display = 'block';
        header.classList.add('active');
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        
        // Actualizar estado oculto
        if (id === 'notasSection') {
          document.getElementById('toggle_notas_estado').value = 'ACTIVADO';
        }
      }
    }
    
    // Inicializar la visualización de unidad
    updateUnitText();
    
    // Validación del formulario
    const form = document.getElementById('salidaForm');
    
    if (form) {
      form.addEventListener('submit', function(event) {
        let cantidadValor = cantidadInput.value.trim();
        
        // Verificar si es un número válido y mayor que cero
        let numeroValido = parseFloat(cantidadValor);
        
        if (isNaN(numeroValido) || numeroValido <= 0) {
          event.preventDefault();
          alert('La cantidad debe ser mayor que cero.');
          cantidadInput.focus();
          return false;
        }
        
        // Verificar que no exceda el stock disponible
        const stockMaximo = {{ producto.stock }};
        if (numeroValido > stockMaximo) {
          event.preventDefault();
          alert(`La cantidad no puede ser mayor que el stock disponible (${stockMaximo}).`);
          cantidadInput.focus();
          return false;
        }
        
        // Validaciones especiales para unidades decimales
        if (esUnidadDecimal) {
          // Verificar formato decimal con punto obligatorio y un dígito antes
          if (cantidadValor.includes('.') && cantidadValor.charAt(0) === '.') {
            event.preventDefault();
            
            // Mensaje mejorado con estilo personalizado
            const mensaje = document.createElement('div');
            mensaje.style.position = 'fixed';
            mensaje.style.top = '50%';
            mensaje.style.left = '50%';
            mensaje.style.transform = 'translate(-50%, -50%)';
            mensaje.style.backgroundColor = '#ff3b30';
            mensaje.style.color = 'white';
            mensaje.style.padding = '20px';
            mensaje.style.borderRadius = '10px';
            mensaje.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
            mensaje.style.zIndex = '9999';
            mensaje.style.maxWidth = '90%';
            mensaje.style.width = '350px';
            mensaje.style.textAlign = 'center';
            
            mensaje.innerHTML = `
              <div style="font-size: 24px; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i></div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Formato incorrecto</div>
              <div style="margin-bottom: 16px; font-size: 15px;">Debe incluir un dígito antes del punto decimal.</div>
              <div style="font-size: 15px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 6px; margin-bottom: 16px;">
                <span style="font-weight: 600;">Ejemplo:</span> 0.123 <span style="color: #90ee90;">✓</span>
                &nbsp;&nbsp;&nbsp;
                <span style="text-decoration: line-through;">.123</span> <span style="color: #ff9999;">✗</span>
              </div>
              <button id="cerrarAlerta" style="background: white; color: #ff3b30; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">Entendido</button>
            `;
            
            document.body.appendChild(mensaje);
            
            // Botón para cerrar la alerta
            document.getElementById('cerrarAlerta').addEventListener('click', function() {
              document.body.removeChild(mensaje);
              cantidadInput.focus();
            });
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
              if (document.body.contains(mensaje)) {
                document.body.removeChild(mensaje);
              }
            }, 5000);
            
            cantidadInput.focus();
            return false;
          }
        } else {
          // Para piezas, verificar que sea un número entero
          if (Math.floor(numeroValido) !== numeroValido) {
            event.preventDefault();
            alert('La cantidad debe ser un número entero para este tipo de producto.');
            cantidadInput.focus();
            return false;
          }
        }
        
        return true;
      });
    }
  });
</script>
{% endblock %}