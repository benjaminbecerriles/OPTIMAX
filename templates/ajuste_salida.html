{% extends 'base.html' %}

{% block title %}
  Salida de Mercancía - {{ producto.nombre }}
{% endblock %}

{% block content %}
<style>
  /* Estilos globales */
  .container {
    max-width: 1000px;
    margin: 0 auto;
  }
  
  /* Encabezado y navegación */
  .breadcrumb {
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
  }
  
  .breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
  }
  
  .breadcrumb-item a:hover {
    color: #e52e2e;
  }
  
  .breadcrumb-item.active {
    color: #212529;
    font-weight: 600;
  }
  
  .page-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #212529;
    border-bottom: 2px solid #e52e2e;
    padding-bottom: 0.75rem;
    display: inline-block;
  }
  
  /* Tarjeta de producto */
  .product-card {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
    background-color: white;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .product-img-container {
    width: 120px;
    height: 120px;
    border-radius: 0.5rem;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    flex-shrink: 0;
  }
  
  .product-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  
  .product-details {
    flex: 1;
  }
  
  .product-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #212529;
  }
  
  .product-info {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }
  
  .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .info-icon {
    color: #6c757d;
    width: 16px;
    text-align: center;
  }
  
  .info-label {
    font-size: 0.875rem;
    color: #6c757d;
  }
  
  .info-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: #212529;
  }
  
  .badge-stock {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .badge-high {
    background-color: #d4edda;
    color: #155724;
  }
  
  .badge-medium {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .badge-low {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  /* Formulario de salida */
  .form-container {
    background-color: white;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
    padding: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 2rem;
  }
  
  .form-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: #212529;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .form-title i {
    color: #dc3545;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #495057;
  }
  
  .form-control {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  .form-control:focus {
    border-color: #e52e2e;
    box-shadow: 0 0 0 0.25rem rgba(229, 46, 46, 0.25);
  }
  
  .form-select {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    font-size: 1rem;
    background-color: white;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  .form-select:focus {
    border-color: #e52e2e;
    box-shadow: 0 0 0 0.25rem rgba(229, 46, 46, 0.25);
  }
  
  .form-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
  
  .form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .form-check-input {
    width: 1rem;
    height: 1rem;
  }
  
  .form-check-label {
    font-size: 0.9rem;
  }
  
  .input-group {
    display: flex;
    align-items: center;
  }
  
  .input-group-text {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem 0 0 0.375rem;
    background-color: #e9ecef;
    font-size: 1rem;
    border-right: none;
  }
  
  .input-group .form-control {
    border-radius: 0 0.375rem 0.375rem 0;
  }
  
  /* Sección de lotes */
  .lotes-section {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.25rem;
    border: 1px solid #dee2e6;
  }
  
  .lotes-section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #212529;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .lotes-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.75rem;
  }
  
  .lotes-table th {
    padding: 0.625rem;
    background-color: #e9ecef;
    border-bottom: 1px solid #dee2e6;
    text-align: left;
    font-weight: 600;
    font-size: 0.75rem;
    color: #495057;
  }
  
  .lotes-table td {
    padding: 0.625rem;
    border-bottom: 1px solid #dee2e6;
    font-size: 0.875rem;
    color: #212529;
  }
  
  .lotes-table tbody tr:hover {
    background-color: #fff;
  }
  
  /* Radio buttons personalizados */
  .radio-group {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }
  
  .radio-btn {
    background-color: white;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.15s;
    flex: 1;
  }
  
  .radio-btn:hover {
    background-color: #f8f9fa;
  }
  
  .radio-btn.checked {
    background-color: #e9ecef;
    border-color: #adb5bd;
    font-weight: 600;
  }
  
  .radio-btn input[type="radio"] {
    display: none;
  }
  
  /* Botones */
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
  }
  
  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .btn-primary {
    background-color: #dc3545;
    color: white;
    border: none;
  }
  
  .btn-primary:hover {
    background-color: #c82333;
  }
  
  .btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
  }
  
  .btn-secondary:hover {
    background-color: #5a6268;
  }
  
  .btn-outline {
    background-color: white;
    border: 1px solid #dee2e6;
    color: #495057;
  }
  
  .btn-outline:hover {
    background-color: #f8f9fa;
  }
  
  /* Historial */
  .history-container {
    margin-top: 2rem;
  }
  
  .history-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #212529;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .history-title i {
    color: #6c757d;
  }
  
  .history-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .history-table th {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
  }
  
  .history-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
    font-size: 0.875rem;
    color: #212529;
  }
  
  .history-table tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  .badge {
    display: inline-block;
    padding: 0.35rem 0.65rem;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
  }
  
  .badge-entrada {
    background-color: #d4edda;
    color: #155724;
  }
  
  .badge-salida {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  /* Modo oscuro y responsive */
  @media (prefers-color-scheme: dark) {
    .product-card,
    .form-container,
    .lotes-section {
      background-color: #343a40;
      border-color: #495057;
    }
    
    .product-title,
    .form-title,
    .history-title,
    .lotes-section-title {
      color: #f8f9fa;
    }
    
    .info-value {
      color: #e9ecef;
    }
    
    .form-control,
    .form-select,
    .radio-btn {
      background-color: #495057;
      border-color: #6c757d;
      color: #f8f9fa;
    }
    
    .radio-btn.checked {
      background-color: #212529;
      border-color: #dee2e6;
    }
    
    .lotes-table th {
      background-color: #212529;
      border-color: #495057;
      color: #f8f9fa;
    }
    
    .lotes-table td {
      border-color: #495057;
      color: #f8f9fa;
    }
    
    .lotes-table tbody tr:hover {
      background-color: #495057;
    }
    
    .form-label {
      color: #e9ecef;
    }
    
    .form-text {
      color: #adb5bd;
    }
    
    .input-group-text {
      background-color: #495057;
      border-color: #6c757d;
      color: #e9ecef;
    }
    
    .btn-outline {
      background-color: #343a40;
      border-color: #495057;
      color: #e9ecef;
    }
    
    .btn-outline:hover {
      background-color: #495057;
    }
    
    .history-table th {
      background-color: #343a40;
      border-bottom-color: #495057;
      color: #e9ecef;
    }
    
    .history-table td {
      border-bottom-color: #495057;
      color: #e9ecef;
    }
    
    .history-table tbody tr:hover {
      background-color: #495057;
    }
  }
  
  @media (max-width: 768px) {
    .product-card {
      flex-direction: column;
      gap: 1rem;
    }
    
    .product-img-container {
      width: 100%;
      height: 180px;
    }
    
    .product-info {
      grid-template-columns: 1fr;
    }
    
    .form-actions {
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .btn {
      width: 100%;
    }
    
    .radio-group {
      flex-direction: column;
    }
  }
</style>

<div class="container">
  <!-- Migas de pan -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard_home') }}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('ajuste_stock') }}">Ajuste de Inventario</a></li>
      <li class="breadcrumb-item active">Salida - {{ producto.nombre }}</li>
    </ol>
  </nav>
  
  <h1 class="page-title">Salida de Mercancía</h1>
  
  <!-- Información del producto -->
  <div class="product-card">
    <div class="product-img-container">
      {% if producto.foto %}
        <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" alt="{{ producto.nombre }}" class="product-img">
      {% else %}
        <img src="{{ url_for('static', filename='img/default_product.jpg') }}" alt="Imagen predeterminada" class="product-img">
      {% endif %}
    </div>
    <div class="product-details">
      <h2 class="product-title">{{ producto.nombre }}</h2>
      <div class="product-info">
        <div class="info-item">
          <i class="fas fa-barcode info-icon"></i>
          <span class="info-label">Código:</span>
          <span class="info-value">{{ producto.codigo_barras_externo }}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-layer-group info-icon"></i>
          <span class="info-label">Stock actual:</span>
          <span class="info-value">
            {% if producto.stock <= 0 %}
              <span class="badge-stock badge-low">Sin stock</span>
            {% elif producto.stock < 6 %}
              <span class="badge-stock badge-low">{{ producto.stock }} unidades</span>
            {% elif producto.stock < 21 %}
              <span class="badge-stock badge-medium">{{ producto.stock }} unidades</span>
            {% else %}
              <span class="badge-stock badge-high">{{ producto.stock }} unidades</span>
            {% endif %}
          </span>
        </div>
        <div class="info-item">
          <i class="fas fa-tag info-icon"></i>
          <span class="info-label">Precio:</span>
          <span class="info-value">${{ producto.precio_venta|round(2) }}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-dollar-sign info-icon"></i>
          <span class="info-label">Costo promedio:</span>
          <span class="info-value">${{ producto.costo|round(2) }}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-cubes info-icon"></i>
          <span class="info-label">Lotes activos:</span>
          <span class="info-value">{{ lotes_activos|length|default('0') }}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-calendar-alt info-icon"></i>
          <span class="info-label">Última salida:</span>
          <span class="info-value">{{ ultima_salida|default('Sin salidas registradas') }}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Formulario de salida -->
  <form method="POST" action="{{ url_for('ajuste_salida', producto_id=producto.id) }}">
    <div class="form-container">
      <h3 class="form-title">
        <i class="fas fa-minus-circle"></i>
        Registrar Salida de Mercancía
      </h3>
      
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="cantidad" class="form-label">Cantidad a reducir *</label>
            <input type="number" class="form-control" id="cantidad" name="cantidad" required min="1" max="{{ producto.stock }}" value="1">
            <div class="form-text">Número de unidades que se retirarán del inventario.</div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="form-group">
            <label for="motivo" class="form-label">Motivo *</label>
            <select class="form-select" id="motivo" name="motivo" required>
              <option value="merma">Merma por daño</option>
              <option value="caducidad">Caducidad</option>
              <option value="robo">Robo o pérdida</option>
              <option value="venta_manual">Venta manual</option>
              <option value="ajuste">Ajuste de inventario</option>
              <option value="transferencia">Transferencia entre sucursales</option>
              <option value="devolucion">Devolución a proveedor</option>
              <option value="otro">Otro motivo</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="form-group">
            <label for="metodo_descuento" class="form-label">Método de descuento *</label>
            <div class="radio-group">
              <label class="radio-btn checked" id="fifoLabel">
                <input type="radio" name="metodo_descuento" id="fifo" value="fifo" checked>
                FIFO (primero en caducar)
              </label>
              <label class="radio-btn" id="lifoLabel">
                <input type="radio" name="metodo_descuento" id="lifo" value="lifo">
                LIFO (último en entrar)
              </label>
            </div>
            <div class="form-text">Define cómo se seleccionarán los lotes afectados.</div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">Impacto financiero *</label>
            <div class="radio-group">
              <label class="radio-btn checked" id="impactoSiLabel">
                <input type="radio" name="impacto_financiero" id="impactoSi" value="1" checked>
                Registrar como pérdida
              </label>
              <label class="radio-btn" id="impactoNoLabel">
                <input type="radio" name="impacto_financiero" id="impactoNo" value="0">
                No afecta finanzas
              </label>
            </div>
            <div class="form-text">Determina si este ajuste afecta los informes financieros.</div>
          </div>
        </div>
      </div>
      
      {% if lotes_activos and lotes_activos|length > 0 %}
        <div class="lotes-section" id="lotesAffectedSection">
          <div class="lotes-section-title">
            <i class="fas fa-cubes"></i>
            <span>Lotes afectados</span>
            <div class="form-check" style="margin-left: auto; margin-bottom: 0;">
              <input class="form-check-input" type="checkbox" id="mostrarLotes" checked>
              <label class="form-check-label" for="mostrarLotes">
                Mostrar detalle
              </label>
            </div>
          </div>
          
          <div id="lotesTableContainer">
            <div class="table-responsive">
              <table class="lotes-table">
                <thead>
                  <tr>
                    <th style="width: 10%;">Lote</th>
                    <th style="width: 20%;">Entrada</th>
                    <th style="width: 20%;">Caducidad</th>
                    <th style="width: 15%;">Stock</th>
                    <th style="width: 15%;">Costo</th>
                    <th style="width: 20%;">Afectación</th>
                  </tr>
                </thead>
                <tbody>
                  {% for lote in lotes_activos %}
                    <tr>
                      <td>{{ lote.numero_lote }}</td>
                      <td>{{ lote.fecha_entrada.strftime('%d/%m/%Y') }}</td>
                      <td>{{ lote.fecha_caducidad.strftime('%d/%m/%Y') if lote.fecha_caducidad else 'N/A' }}</td>
                      <td>{{ lote.stock }} unidades</td>
                      <td>${{ lote.costo_unitario|round(2) }}</td>
                      <td id="afectacion-{{ lote.id }}">
                        <!-- Calculado por JavaScript -->
                        -
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}
      
      <div class="form-group mt-3">
        <label for="notas" class="form-label">Notas adicionales</label>
        <textarea class="form-control" id="notas" name="notas" rows="2"></textarea>
        <div class="form-text">Información adicional sobre esta salida.</div>
      </div>
      
      <div class="form-actions">
        <a href="{{ url_for('ajuste_stock') }}" class="btn btn-outline">
          <i class="fas fa-times"></i>
          Cancelar
        </a>
        <button type="submit" class="btn btn-primary" {% if producto.stock <= 0 %}disabled{% endif %}>
          <i class="fas fa-check"></i>
          Confirmar Salida
        </button>
      </div>
    </div>
  </form>
  
  <!-- Historial de movimientos -->
  <div class="history-container">
    <h3 class="history-title">
      <i class="fas fa-history"></i>
      Últimos Movimientos
    </h3>
    
    {% if historial and historial|length > 0 %}
      <div class="table-responsive">
        <table class="history-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Lote</th>
              <th>Cantidad</th>
              <th>Costo</th>
              <th>Motivo</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in historial %}
              <tr>
                <td>{{ mov.fecha_movimiento.strftime('%d/%m/%Y') }}</td>
                <td>
                  {% if mov.tipo_movimiento == 'ENTRADA' %}
                    <span class="badge badge-entrada">Entrada</span>
                  {% else %}
                    <span class="badge badge-salida">Salida</span>
                  {% endif %}
                </td>
                <td>{{ mov.numero_lote|default('-') }}</td>
                <td>
                  {% if mov.tipo_movimiento == 'ENTRADA' %}
                    +{{ mov.cantidad }}
                  {% else %}
                    -{{ mov.cantidad }}
                  {% endif %}
                </td>
                <td>
                  {% if mov.tipo_movimiento == 'ENTRADA' %}
                    ${{ mov.costo_unitario|round(2) }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ mov.motivo }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        No hay movimientos registrados para este producto.
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cantidadInput = document.getElementById('cantidad');
    const fifoRadio = document.getElementById('fifo');
    const lifoRadio = document.getElementById('lifo');
    const fifoLabel = document.getElementById('fifoLabel');
    const lifoLabel = document.getElementById('lifoLabel');
    const impactoSiRadio = document.getElementById('impactoSi');
    const impactoNoRadio = document.getElementById('impactoNo');
    const impactoSiLabel = document.getElementById('impactoSiLabel');
    const impactoNoLabel = document.getElementById('impactoNoLabel');
    const mostrarLotesCheck = document.getElementById('mostrarLotes');
    const lotesTableContainer = document.getElementById('lotesTableContainer');
    
    // Stock máximo para validación
    const stockMax = {{ producto.stock }};
    
    // Cambiar estilos de los radio buttons personalizados
    fifoRadio.addEventListener('change', function() {
      if (this.checked) {
        fifoLabel.classList.add('checked');
        lifoLabel.classList.remove('checked');
        actualizarAfectacionLotes('fifo');
      }
    });
    
    lifoRadio.addEventListener('change', function() {
      if (this.checked) {
        lifoLabel.classList.add('checked');
        fifoLabel.classList.remove('checked');
        actualizarAfectacionLotes('lifo');
      }
    });
    
    impactoSiRadio.addEventListener('change', function() {
      if (this.checked) {
        impactoSiLabel.classList.add('checked');
        impactoNoLabel.classList.remove('checked');
      }
    });
    
    impactoNoRadio.addEventListener('change', function() {
      if (this.checked) {
        impactoNoLabel.classList.add('checked');
        impactoSiLabel.classList.remove('checked');
      }
    });
    
    // Mostrar/ocultar tabla de lotes
    if (mostrarLotesCheck) {
      mostrarLotesCheck.addEventListener('change', function() {
        if (lotesTableContainer) {
          lotesTableContainer.style.display = this.checked ? 'block' : 'none';
        }
      });
    }
    
    // Validación de cantidad
    if (cantidadInput) {
      cantidadInput.addEventListener('change', function() {
        if (this.value <= 0) {
          this.value = 1;
        } else if (this.value > stockMax) {
          this.value = stockMax;
        }
        
        actualizarAfectacionLotes(fifoRadio.checked ? 'fifo' : 'lifo');
      });
    }
    
    // Función para actualizar la afectación de lotes
    function actualizarAfectacionLotes(metodo) {
      {% if lotes_activos %}
        const cantidad = parseInt(cantidadInput.value);
        let cantidadRestante = cantidad;
        
        // Datos de lotes ordenados según el método
        const lotes = [
          {% for lote in lotes_activos %}
            {
              id: {{ lote.id }},
              numero: "{{ lote.numero_lote }}",
              stock: {{ lote.stock }},
              fecha_entrada: new Date("{{ lote.fecha_entrada.isoformat() }}"),
              {% if lote.fecha_caducidad %}
                fecha_caducidad: new Date("{{ lote.fecha_caducidad.isoformat() }}"),
              {% else %}
                fecha_caducidad: null,
              {% endif %}
              costo: {{ lote.costo_unitario }}
            },
          {% endfor %}
        ];
        
        // Ordenar lotes según el método
        if (metodo === 'fifo') {
          // FIFO: primero ordenar por fecha de caducidad (si existe), luego por fecha de entrada
          lotes.sort((a, b) => {
            if (a.fecha_caducidad && b.fecha_caducidad) {
              return a.fecha_caducidad - b.fecha_caducidad;
            } else if (a.fecha_caducidad) {
              return -1; // a tiene caducidad, b no
            } else if (b.fecha_caducidad) {
              return 1; // b tiene caducidad, a no
            }
            return a.fecha_entrada - b.fecha_entrada;
          });
        } else {
          // LIFO: último en entrar, primero en salir
          lotes.sort((a, b) => b.fecha_entrada - a.fecha_entrada);
        }
        
        // Reiniciar todas las afectaciones
        lotes.forEach(lote => {
          const element = document.getElementById(`afectacion-${lote.id}`);
          if (element) {
            element.textContent = '-';
          }
        });
        
        // Calcular y mostrar afectaciones
        for (const lote of lotes) {
          if (cantidadRestante <= 0) break;
          
          const afectacion = Math.min(lote.stock, cantidadRestante);
          cantidadRestante -= afectacion;
          
          const element = document.getElementById(`afectacion-${lote.id}`);
          if (element) {
            element.textContent = `-${afectacion} unidades`;
            element.style.color = '#dc3545';
            element.style.fontWeight = '600';
          }
        }
      {% endif %}
    }
    
    // Inicializar afectación de lotes
    actualizarAfectacionLotes('fifo');
    
    // Validación del formulario
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
      const cantidad = parseInt(cantidadInput.value);
      
      if (cantidad <= 0) {
        event.preventDefault();
        alert('La cantidad debe ser mayor que cero.');
        cantidadInput.focus();
        return false;
      }
      
      if (cantidad > stockMax) {
        event.preventDefault();
        alert(`La cantidad no puede ser mayor que el stock disponible (${stockMax}).`);
        cantidadInput.focus();
        return false;
      }
      
      if (stockMax <= 0) {
        event.preventDefault();
        alert('No hay stock disponible para realizar una salida.');
        return false;
      }
      
      return true;
    });
  });
</script>
{% endblock %}