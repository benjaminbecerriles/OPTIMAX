{% extends 'base.html' %}

{% block title %}Descuentos - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Consistente con dashboard_inventario.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales - TEXTO OSCURECIDO */
    --text-color: #1d1d1f;
    --text-secondary: #515154;
    --text-tertiary: #86868b;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    --discount-color: #1a9951;
    --discount-hover: #147a3e;
    --blue: #1a237e;
    
    /* Colores de estado */
    --green: #2ecc71;
    --orange: #f39c12;
    --red: #e74c3c;
  }
  
  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }
  
  /* Contenedor principal */
  .apple-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Encabezado de página */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
    align-items: center;
  }
  
  /* Botones de acción */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }
  
  /* Barra de búsqueda */
  .search-container {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 100px;
    position: relative;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .search-box {
    flex: 1;
    position: relative;
    min-width: 300px;
  }
  
  .search-box i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
    z-index: 5;
    pointer-events: none;
  }
  
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px;
    border: 1px solid #dddddd;
    font-size: 1rem;
    height: 48px;
    transition: all 0.2s ease;
    font-weight: 400;
    background-color: var(--light-background);
  }
  
  .search-box input:focus {
    background-color: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  /* Controles de descuento */
  .discount-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .discount-type-toggle {
    display: flex;
    background-color: var(--light-background);
    border-radius: 8px;
    border: 1px solid #dddddd;
    overflow: hidden;
  }
  
  .discount-toggle-btn {
    padding: 0.5rem 1rem;
    font-size: 0.95rem;
    font-weight: 500;
    border: none;
    background-color: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
  }
  
  .discount-toggle-btn.active {
    background-color: var(--accent);
    color: white;
  }
  
  .discount-value-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--light-background);
    border: 1px solid #dddddd;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    min-width: 150px;
  }
  
  .discount-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: 1rem;
    width: 60px;
    text-align: center;
    color: var(--text-color);
    font-weight: 500;
  }
  
  .discount-symbol {
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  .apply-global-btn {
    background-color: var(--discount-color);
    color: white;
    border-radius: 8px;
    border: none;
    padding: 0.75rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(26, 153, 81, 0.3);
  }
  
  .apply-global-btn:hover {
    background-color: var(--discount-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(26, 153, 81, 0.4);
  }
  
  /* Categorías */
  .category-section {
    margin-bottom: 50px;
    border: 1px solid #eaeaea;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    background-color: #fafafa;
  }
  
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .category-title {
    font-size: 22px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
  }
  
  .category-color-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
  }
  
  .category-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: #eeeeee;
    color: #505050;
    font-size: 13px;
    font-weight: 600;
  }
  
  .category-discount-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .apply-category-btn {
    background-color: var(--discount-color);
    color: white;
    border-radius: 6px;
    border: none;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .apply-category-btn:hover {
    background-color: var(--discount-hover);
  }
  
  /* Slider de productos */
  .product-slider-container {
    position: relative;
    padding: 0 70px;
    margin: 0 -10px;
  }
  
  .product-slider {
    display: flex;
    gap: 16px;
    overflow-x: hidden;
    scroll-behavior: smooth;
    padding: 4px 0 12px 0;
    margin-bottom: 4px;
  }
  
  .product-card {
    flex: 0 0 220px;
    height: 460px;
    border-radius: 12px;
    overflow: hidden;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }
  
  .product-image-container {
    height: 140px;
    min-height: 140px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f8f8f8;
    padding: 5px;
  }
  
  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .product-details {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 320px;
  }
  
  .product-info-container {
    display: flex;
    flex-direction: column;
    height: 78px;
    margin-bottom: 10px;
    overflow: hidden;
    position: relative;
  }
  
  .product-name {
    font-size: 16px;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4;
    color: var(--text-color);
    height: 46px;
    margin-bottom: 0;
  }
  
  .product-brand {
    font-size: 13px;
    color: #606060;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  
  /* Precios y descuentos */
  .product-price-container {
    height: 48px;
    margin-top: 10px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
  }
  
  .price-row {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    width: 100%;
  }
  
  .current-price {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-color);
  }
  
  .discounted-price {
    font-size: 20px;
    font-weight: 700;
    color: var(--discount-color);
  }
  
  .original-price {
    font-size: 14px;
    color: var(--text-secondary);
    text-decoration: line-through;
  }
  
  .discount-badge {
    font-size: 12px;
    color: white;
    background-color: var(--red);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }
  
  /* Controles de descuento del producto */
  .discount-input-container {
    height: 120px;
    margin-top: 5px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .product-discount-controls {
    display: flex;
    align-items: center;
    gap: 4px;
    height: 36px;
  }
  
  .discount-type-select {
    flex: 1;
    border: 1px solid #d1d1d6;
    border-radius: 6px;
    height: 100%;
    background-color: white;
    font-size: 13px;
    padding: 0 8px;
    outline: none;
    color: var(--text-color);
  }
  
  .discount-value-input {
    width: 50px;
    border: 1px solid #d1d1d6;
    border-radius: 6px;
    height: 100%;
    text-align: center;
    font-size: 13px;
    outline: none;
    background-color: white;
    color: var(--text-color);
  }
  
  .discount-symbol-text {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    min-width: 15px;
    text-align: center;
  }
  
  .apply-discount-btn {
    width: 100%;
    height: 42px;
    background-color: var(--discount-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
    box-shadow: 0 2px 4px rgba(26, 153, 81, 0.2);
    margin-top: 8px;
  }
  
  .apply-discount-btn:hover {
    background-color: var(--discount-hover);
    transform: translateY(-1px);
  }
  
  .clear-discount-btn {
    width: 100%;
    height: 32px;
    background-color: transparent;
    color: var(--text-secondary);
    border: 1px solid #d1d1d6;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 4px;
  }
  
  .clear-discount-btn:hover {
    background-color: #f8f8f8;
    color: var(--red);
    border-color: var(--red);
  }
  
  /* Botones de navegación del slider */
  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--accent);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(229, 46, 46, 0.3);
    z-index: 10;
    transition: all 0.2s ease;
  }
  
  .slider-arrow:hover {
    background-color: var(--accent-hover);
    transform: translateY(-50%) scale(1.1);
  }
  
  .slider-arrow-left {
    left: 20px;
  }
  
  .slider-arrow-right {
    right: 20px;
  }
  
  .slider-arrow svg {
    width: 18px;
    height: 18px;
    fill: none;
    stroke: white;
    stroke-width: 2.5;
  }
  
  /* Toast notificaciones */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }
  
  .toast {
    background-color: #333;
    color: white;
    padding: 14px 20px;
    border-radius: 8px;
    margin-top: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
    max-width: 350px;
    font-weight: 500;
  }
  
  .toast.success {
    background-color: var(--green);
  }
  
  .toast.error {
    background-color: var(--red);
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
  
  /* Estado vacío */
  .empty-state {
    padding: 50px 0;
    text-align: center;
    background-color: var(--light-background);
    border-radius: 12px;
    margin-bottom: 36px;
  }
  
  .empty-icon {
    font-size: 32px;
    color: var(--text-secondary);
    margin-bottom: 14px;
  }
  
  .empty-message {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .search-container {
      flex-direction: column;
      margin-bottom: 60px;
    }
    
    .search-box {
      width: 100%;
      min-width: auto;
    }
    
    .discount-controls {
      width: 100%;
      justify-content: flex-start;
    }
    
    .product-slider {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 16px;
    }
    
    .product-card {
      flex: 0 0 70%;
      scroll-snap-align: start;
      height: 490px;
    }
    
    .product-slider-container {
      padding: 0;
    }
    
    .slider-arrow {
      display: none;
    }
    
    h1 {
      font-size: 26px;
    }
    
    .page-description {
      font-size: 15px;
    }
  }
  
  @media (max-width: 480px) {
    .product-card {
      flex: 0 0 85%;
    }
  }
</style>

<div class="apple-container">
  <!-- Encabezado -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Aplicar descuentos</h1>
      <p class="page-description">Aplica descuentos a tus productos de forma rápida y sencilla</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>
  
  <!-- Controles principales -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar por nombre, marca o código de barras...">
    </div>
    
    <div class="discount-controls">
      <div class="discount-type-toggle">
        <button class="discount-toggle-btn active" data-type="percentage">% Porcentaje</button>
        <button class="discount-toggle-btn" data-type="fixed">$ Cantidad fija</button>
      </div>
      
      <div class="discount-value-container">
        <input type="number" class="discount-input" id="globalDiscountValue" value="10" min="0" max="99">
        <span class="discount-symbol" id="globalDiscountSymbol">%</span>
      </div>
      
      <button class="apply-global-btn" onclick="applyGlobalDiscount()">
        <i class="fas fa-tags"></i>
        Aplicar a todos
      </button>
    </div>
  </div>
  
  <!-- Contenedor para categorías y productos -->
  <div id="categoriesContainer">
    {% if categorias and categorias|length > 0 %}
      {% set categorias_ordenadas = [] %}
      {% for categoria in categorias %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        {% if productos_categoria|length > 0 %}
          {% set _ = categorias_ordenadas.append({'nombre': categoria.nombre, 'color': categoria.color, 'count': productos_categoria|length}) %}
        {% endif %}
      {% endfor %}
      {% set categorias_ordenadas = categorias_ordenadas|sort(attribute='count', reverse=true) %}
      
      {% for categoria in categorias_ordenadas %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        <div class="category-section" data-category="{{ categoria.nombre|lower }}">
          <div class="category-header">
            <h2 class="category-title">
              <span class="category-color-dot" style="background-color: {{ categoria.color }}"></span>
              {{ categoria.nombre|title }}
              <span class="category-badge">{{ categoria.count }}</span>
            </h2>
            
            <div class="category-discount-controls">
              <div class="discount-type-select-container">
                <select class="discount-type-select category-discount-type" id="categoryDiscountType-{{ categoria.nombre|lower|replace(' ', '-') }}">
                  <option value="percentage">% Porcentaje</option>
                  <option value="fixed">$ Cantidad fija</option>
                </select>
              </div>
              
              <div class="discount-value-container">
                <input type="number" class="discount-input category-discount-value" id="categoryDiscountValue-{{ categoria.nombre|lower|replace(' ', '-') }}" value="10" min="0" max="99">
                <span class="discount-symbol" id="categoryDiscountSymbol-{{ categoria.nombre|lower|replace(' ', '-') }}">%</span>
              </div>
              
              <button class="apply-category-btn" onclick="applyCategoryDiscount('{{ categoria.nombre }}')">Aplicar a categoría</button>
            </div>
          </div>
          
          <div class="product-slider-container">
            <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('{{ categoria.nombre|lower }}', 'left')">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            
            <div class="product-slider" id="slider-{{ categoria.nombre|lower }}">
              {% for producto in productos_categoria %}
                <div class="product-card" data-product-id="{{ producto.id }}" data-product-name="{{ producto.nombre|lower }}" data-product-barcode="{{ producto.codigo_barras_externo|lower if producto.codigo_barras_externo else '' }}" data-original-price="{{ producto.precio_venta }}">
                  <div class="product-image-container">
                    {% if producto.foto %}
                      <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" class="product-image" alt="{{ producto.nombre }}">
                    {% else %}
                      <div class="product-image" style="display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-box" style="color: var(--text-secondary);"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="product-details">
                    <div class="product-info-container">
                      <div class="product-name">{{ producto.nombre }}</div>
                      {% if producto.marca %}
                        <div class="product-brand">{{ producto.marca }}</div>
                      {% else %}
                        <div class="product-brand" style="opacity: 0;">-</div>
                      {% endif %}
                    </div>
                    <div class="product-price-container">
                      <div class="price-row">
                        <div class="current-price" id="current-price-{{ producto.id }}">
                          ${{ '{:.2f}'.format(producto.precio_venta) }}
                        </div>
                      </div>
                    </div>
                    <div class="discount-input-container">
                      <div class="product-discount-controls">
                        <select class="discount-type-select product-discount-type" id="productDiscountType-{{ producto.id }}">
                          <option value="percentage">%</option>
                          <option value="fixed">$</option>
                        </select>
                        <input type="number" class="discount-value-input" id="productDiscountValue-{{ producto.id }}" value="10" min="0" max="99" oninput="previewDiscount({{ producto.id }})">
                        <span class="discount-symbol-text" id="productDiscountSymbol-{{ producto.id }}">%</span>
                      </div>
                      <button class="apply-discount-btn" onclick="applyDiscount({{ producto.id }})">Aplicar descuento</button>
                      <button class="clear-discount-btn" onclick="clearDiscount({{ producto.id }})" style="display: none;">Quitar descuento</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('{{ categoria.nombre|lower }}', 'right')">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <!-- Estado vacío -->
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-tags"></i>
        </div>
        <p class="empty-message">No hay productos en tu inventario</p>
        <a href="{{ url_for('nuevo_producto') }}" class="button-link" style="display: inline-block; padding: 10px 20px; background-color: var(--accent); color: white; text-decoration: none; border-radius: 6px; margin-top: 16px;">
          Agregar producto
        </a>
      </div>
    {% endif %}
  </div>
  
  <!-- Contenedor de notificaciones toast -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // Variables globales
  let globalDiscountType = 'percentage';
  
  // ----------------------------------------------------
  // Funciones para el slider de productos
  // ----------------------------------------------------
  function scrollSlider(categoryId, direction) {
    const slider = document.getElementById(`slider-${categoryId}`);
    if (!slider) return;
    
    const cardWidth = slider.querySelector('.product-card').offsetWidth + 16;
    const scrollAmount = cardWidth * 3;
    
    if (direction === 'left') {
      slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
      slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
  }
  
  // ----------------------------------------------------
  // Función para formatear moneda
  // ----------------------------------------------------
  function formatCurrency(number) {
    return new Intl.NumberFormat('es-MX', {
      style: 'currency',
      currency: 'MXN'
    }).format(number);
  }
  
  // ----------------------------------------------------
  // Función para previsualizar descuento
  // ----------------------------------------------------
  function previewDiscount(productId) {
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    const originalPrice = parseFloat(card.dataset.originalPrice);
    const discountValue = parseFloat(document.getElementById(`productDiscountValue-${productId}`).value);
    const discountType = document.getElementById(`productDiscountType-${productId}`).value;
    const currentPriceEl = document.getElementById(`current-price-${productId}`);
    
    if (!discountValue || discountValue <= 0) {
      currentPriceEl.innerHTML = formatCurrency(originalPrice);
      return;
    }
    
    let newPrice;
    let discountAmount;
    
    if (discountType === 'percentage') {
      discountAmount = originalPrice * (discountValue / 100);
      newPrice = originalPrice - discountAmount;
    } else {
      discountAmount = discountValue;
      newPrice = originalPrice - discountAmount;
    }
    
    if (newPrice < 0) newPrice = 0;
    
    currentPriceEl.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: flex-start;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="discounted-price">${formatCurrency(newPrice)}</span>
          <span class="discount-badge">-${discountType === 'percentage' ? discountValue + '%' : formatCurrency(discountValue)}</span>
        </div>
        <span class="original-price">${formatCurrency(originalPrice)}</span>
      </div>
    `;
  }
  
  // ----------------------------------------------------
  // Aplicar descuento individual
  // ----------------------------------------------------
  function applyDiscount(productId) {
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    const originalPrice = parseFloat(card.dataset.originalPrice);
    const discountValue = parseFloat(document.getElementById(`productDiscountValue-${productId}`).value);
    const discountType = document.getElementById(`productDiscountType-${productId}`).value;
    
    if (!discountValue || discountValue <= 0) {
      showToast('Por favor ingresa un descuento válido', 'error');
      return;
    }
    
    let newPrice;
    if (discountType === 'percentage') {
      newPrice = originalPrice * (1 - discountValue / 100);
    } else {
      newPrice = originalPrice - discountValue;
    }
    
    if (newPrice < 0) newPrice = 0;
    
    // Actualizar precio en servidor
    fetch(`/api/update_price/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ price: newPrice })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Actualizar precio original para futuros cálculos
        card.dataset.originalPrice = originalPrice;
        
        // Mostrar botón de quitar descuento
        const clearBtn = card.querySelector('.clear-discount-btn');
        clearBtn.style.display = 'block';
        
        showToast('Descuento aplicado correctamente', 'success');
      } else {
        showToast('Error al aplicar descuento', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error al aplicar descuento', 'error');
    });
  }
  
  // ----------------------------------------------------
  // Quitar descuento
  // ----------------------------------------------------
  function clearDiscount(productId) {
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    const originalPrice = parseFloat(card.dataset.originalPrice);
    
    // Restaurar precio original
    fetch(`/api/update_price/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ price: originalPrice })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Actualizar vista
        const currentPriceEl = document.getElementById(`current-price-${productId}`);
        currentPriceEl.innerHTML = formatCurrency(originalPrice);
        
        // Ocultar botón de quitar descuento
        const clearBtn = card.querySelector('.clear-discount-btn');
        clearBtn.style.display = 'none';
        
        // Resetear input
        document.getElementById(`productDiscountValue-${productId}`).value = '10';
        
        showToast('Descuento removido', 'success');
      } else {
        showToast('Error al remover descuento', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error al remover descuento', 'error');
    });
  }
  
  // ----------------------------------------------------
  // Aplicar descuento a categoría
  // ----------------------------------------------------
  function applyCategoryDiscount(categoryName) {
    const categoryId = categoryName.toLowerCase().replace(' ', '-');
    const discountType = document.getElementById(`categoryDiscountType-${categoryId}`).value;
    const discountValue = parseFloat(document.getElementById(`categoryDiscountValue-${categoryId}`).value);
    
    if (!discountValue || discountValue <= 0) {
      showToast('Por favor ingresa un descuento válido', 'error');
      return;
    }
    
    // Encontrar todos los productos de la categoría
    const categorySection = document.querySelector(`.category-section[data-category="${categoryName.toLowerCase()}"]`);
    const productCards = categorySection.querySelectorAll('.product-card');
    
    let count = 0;
    const promises = [];
    
    productCards.forEach(card => {
      const productId = card.dataset.productId;
      const originalPrice = parseFloat(card.dataset.originalPrice);
      
      let newPrice;
      if (discountType === 'percentage') {
        newPrice = originalPrice * (1 - discountValue / 100);
      } else {
        newPrice = originalPrice - discountValue;
      }
      
      if (newPrice < 0) newPrice = 0;
      
      // Actualizar en servidor
      const promise = fetch(`/api/update_price/${productId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ price: newPrice })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar vista
          document.getElementById(`productDiscountValue-${productId}`).value = discountValue.toString();
          document.getElementById(`productDiscountType-${productId}`).value = discountType;
          previewDiscount(productId);
          
          // Mostrar botón de quitar descuento
          const clearBtn = card.querySelector('.clear-discount-btn');
          clearBtn.style.display = 'block';
          
          count++;
        }
      });
      
      promises.push(promise);
    });
    
    Promise.all(promises).then(() => {
      showToast(`Descuento aplicado a ${count} productos de ${categoryName}`, 'success');
    });
  }
  
  // ----------------------------------------------------
  // Aplicar descuento global
  // ----------------------------------------------------
  function applyGlobalDiscount() {
    const discountValue = parseFloat(document.getElementById('globalDiscountValue').value);
    const discountType = globalDiscountType;
    
    if (!discountValue || discountValue <= 0) {
      showToast('Por favor ingresa un descuento válido', 'error');
      return;
    }
    
    // Encontrar todos los productos
    const productCards = document.querySelectorAll('.product-card');
    
    let count = 0;
    const promises = [];
    
    productCards.forEach(card => {
      const productId = card.dataset.productId;
      const originalPrice = parseFloat(card.dataset.originalPrice);
      
      let newPrice;
      if (discountType === 'percentage') {
        newPrice = originalPrice * (1 - discountValue / 100);
      } else {
        newPrice = originalPrice - discountValue;
      }
      
      if (newPrice < 0) newPrice = 0;
      
      // Actualizar en servidor
      const promise = fetch(`/api/update_price/${productId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ price: newPrice })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar vista
          document.getElementById(`productDiscountValue-${productId}`).value = discountValue.toString();
          document.getElementById(`productDiscountType-${productId}`).value = discountType;
          previewDiscount(productId);
          
          // Mostrar botón de quitar descuento
          const clearBtn = card.querySelector('.clear-discount-btn');
          clearBtn.style.display = 'block';
          
          count++;
        }
      });
      
      promises.push(promise);
    });
    
    Promise.all(promises).then(() => {
      showToast(`Descuento aplicado a ${count} productos`, 'success');
    });
  }
  
  // ----------------------------------------------------
  // Sistema de notificaciones toast
  // ----------------------------------------------------
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
  
  // ----------------------------------------------------
  // Event Listeners
  // ----------------------------------------------------
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle de tipo de descuento global
    const toggleBtns = document.querySelectorAll('.discount-toggle-btn');
    toggleBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        toggleBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        globalDiscountType = this.dataset.type;
        
        const symbol = document.getElementById('globalDiscountSymbol');
        symbol.textContent = globalDiscountType === 'percentage' ? '%' : '$';
      });
    });
    
    // Actualizar símbolos cuando cambia el tipo de descuento del producto
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('product-discount-type')) {
        const productId = e.target.id.split('-')[1];
        const symbol = document.getElementById(`productDiscountSymbol-${productId}`);
        symbol.textContent = e.target.value === 'percentage' ? '%' : '$';
        previewDiscount(productId);
      }
    });
    
    // Actualizar símbolos cuando cambia el tipo de descuento de categoría
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('category-discount-type')) {
        const categoryId = e.target.id.split('-')[1];
        const symbol = document.getElementById(`categoryDiscountSymbol-${categoryId}`);
        symbol.textContent = e.target.value === 'percentage' ? '%' : '$';
      }
    });
    
    // Búsqueda
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const productCards = document.querySelectorAll('.product-card');
        
        productCards.forEach(card => {
          const productName = card.dataset.productName;
          const productBarcode = card.dataset.productBarcode;
          const brand = card.querySelector('.product-brand')?.textContent?.toLowerCase() || '';
          
          const matches = productName.includes(searchTerm) || 
                         productBarcode.includes(searchTerm) || 
                         brand.includes(searchTerm);
          
          card.style.display = matches ? 'block' : 'none';
        });
        
        // Ocultar categorías vacías
        document.querySelectorAll('.category-section').forEach(section => {
          const visibleCards = Array.from(section.querySelectorAll('.product-card')).filter(card => 
            card.style.display !== 'none'
          );
          section.style.display = visibleCards.length > 0 ? 'block' : 'none';
        });
      });
    }
  });
</script>
{% endblock %}