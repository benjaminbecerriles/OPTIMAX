{% extends 'base.html' %}

{% block title %}Descuentos - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Consistente con dashboard_inventario.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales */
    --text-color: #1d1d1f;
    --text-secondary: #515154;
    --text-tertiary: #86868b;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    --discount-color: #1a9951;
    --discount-hover: #147a3e;
    --blue: #1a237e;
    
    /* Colores de estado */
    --green: #2ecc71;
    --orange: #f39c12;
    --red: #e74c3c;
  }
  
  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }
  
  /* Contenedor principal */
  .apple-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Encabezado de página */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
    align-items: center;
  }
  
  /* Botones de acción */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }
  
  /* Controles simplificados */
  .controls-container {
    background-color: var(--light-background);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 48px;
    border: 1px solid #e0e0e0;
  }
  
  .controls-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
  }
  
  .controls-content {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .discount-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: white;
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    padding: 8px 12px;
    min-width: 180px;
  }
  
  .discount-label {
    font-size: 15px;
    color: var(--text-secondary);
    min-width: 60px;
  }
  
  .discount-input {
    width: 60px;
    border: none;
    outline: none;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    text-align: center;
  }
  
  .discount-unit {
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  .toggle-buttons {
    display: flex;
    gap: 8px;
  }
  
  .toggle-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #d1d1d6;
    background-color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
  }
  
  .toggle-btn.active {
    background-color: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  .apply-btn {
    background-color: var(--discount-color);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 24px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(26, 153, 81, 0.3);
  }
  
  .apply-btn:hover {
    background-color: var(--discount-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(26, 153, 81, 0.4);
  }
  
  /* Búsqueda */
  .search-container {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 32px;
    position: relative;
    align-items: center;
  }
  
  .search-box {
    flex: 1;
    position: relative;
    min-width: 300px;
  }
  
  .search-box i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
    z-index: 5;
    pointer-events: none;
  }
  
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px;
    border: 1px solid #dddddd;
    font-size: 1rem;
    height: 48px;
    transition: all 0.2s ease;
    font-weight: 400;
    background-color: var(--light-background);
  }
  
  .search-box input:focus {
    background-color: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  /* Grid de productos */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
    width: 100%;
  }
  
  .product-card {
    background-color: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }
  
  .product-card.has-discount {
    border-color: var(--discount-color);
    background-color: rgba(26, 153, 81, 0.02);
  }
  
  .product-image-container {
    height: 200px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f8f9fa;
    overflow: hidden;
  }
  
  .product-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  
  .product-info {
    padding: 16px;
  }
  
  .product-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .product-brand {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
  }
  
  .product-price-section {
    margin-bottom: 16px;
  }
  
  .price-display {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 4px;
  }
  
  .current-price {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-color);
  }
  
  .discounted-price {
    font-size: 20px;
    font-weight: 700;
    color: var(--discount-color);
  }
  
  .original-price {
    font-size: 16px;
    color: var(--text-secondary);
    text-decoration: line-through;
  }
  
  .discount-badge {
    background-color: var(--red);
    color: white;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
  }
  
  .product-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .mini-input {
    width: 50px;
    padding: 6px 8px;
    border: 1px solid #d1d1d6;
    border-radius: 6px;
    font-size: 14px;
    text-align: center;
    outline: none;
  }
  
  .mini-btn {
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .apply-mini-btn {
    background-color: var(--discount-color);
    color: white;
  }
  
  .apply-mini-btn:hover {
    background-color: var(--discount-hover);
  }
  
  .remove-mini-btn {
    background-color: transparent;
    color: var(--red);
    border: 1px solid #d1d1d6;
  }
  
  .remove-mini-btn:hover {
    background-color: var(--red);
    color: white;
  }
  
  /* Estado vacío */
  .empty-state {
    padding: 64px 32px;
    text-align: center;
    background-color: var(--light-background);
    border-radius: 12px;
    margin: 48px 0;
  }
  
  .empty-icon {
    font-size: 48px;
    color: var(--text-secondary);
    margin-bottom: 16px;
  }
  
  .empty-message {
    font-size: 18px;
    color: var(--text-secondary);
    margin-bottom: 24px;
  }
  
  .empty-action {
    display: inline-block;
    padding: 12px 24px;
    background-color: var(--accent);
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  
  .empty-action:hover {
    background-color: var(--accent-hover);
    transform: translateY(-2px);
  }
  
  /* Toast notificaciones */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    max-width: 400px;
  }
  
  .toast {
    background-color: #333;
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    margin-top: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    opacity: 1;
    transition: all 0.3s ease;
  }
  
  .toast.success {
    background-color: var(--green);
  }
  
  .toast.error {
    background-color: var(--red);
  }
  
  .toast.fade-out {
    opacity: 0;
    transform: translateY(-20px);
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .apple-container {
      padding: 24px 16px;
    }
    
    .page-header {
      flex-direction: column;
      gap: 16px;
    }
    
    .controls-content {
      flex-direction: column;
      align-items: stretch;
    }
    
    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }
    
    .search-container {
      flex-direction: column;
    }
    
    .search-box {
      width: 100%;
      min-width: auto;
    }
  }
</style>

<div class="apple-container">
  <!-- Encabezado -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Aplicar descuentos</h1>
      <p class="page-description">Aplica descuentos de forma rápida y sencilla con un solo clic</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>
  
  <!-- Controles simplificados -->
  <div class="controls-container">
    <h3 class="controls-title">Aplicar descuento general</h3>
    <div class="controls-content">
      <div class="discount-input-group">
        <span class="discount-label">Descuento:</span>
        <input type="number" class="discount-input" id="globalDiscountValue" value="10" min="0" max="100">
        <span class="discount-unit" id="discountUnit">%</span>
      </div>
      
      <div class="toggle-buttons">
        <button class="toggle-btn active" data-type="percentage">Porcentaje</button>
        <button class="toggle-btn" data-type="fixed">Cantidad fija</button>
      </div>
      
      <button class="apply-btn" onclick="applyGlobalDiscount()">
        <i class="fas fa-tags"></i>
        Aplicar a todos los productos
      </button>
    </div>
  </div>
  
  <!-- Búsqueda -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar por nombre, marca o código...">
    </div>
  </div>
  
  <!-- Grid de productos -->
  <div class="products-grid" id="productsGrid">
    {% if productos and productos|length > 0 %}
      {% for producto in productos %}
        <div class="product-card" 
             data-product-id="{{ producto.id }}" 
             data-original-price="{{ producto.precio_venta }}"
             data-has-discount="{{ producto.tiene_descuento|lower }}"
             data-discount-type="{{ producto.tipo_descuento if producto.tiene_descuento else '' }}"
             data-discount-value="{{ producto.valor_descuento if producto.tiene_descuento else 0 }}"
             data-searchable="{{ (producto.nombre + ' ' + (producto.marca or '') + ' ' + (producto.codigo_barras_externo or ''))|lower }}">
          
          <div class="product-image-container">
            {% if producto.foto %}
              <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" class="product-image" alt="{{ producto.nombre }}">
            {% else %}
              <i class="fas fa-box" style="font-size: 48px; color: #ccc;"></i>
            {% endif %}
          </div>
          
          <div class="product-info">
            <div class="product-name">{{ producto.nombre }}</div>
            {% if producto.marca %}
              <div class="product-brand">{{ producto.marca }}</div>
            {% endif %}
            
            <div class="product-price-section">
              <div class="price-display">
                {% if producto.tiene_descuento %}
                  {% if producto.tipo_descuento == 'percentage' %}
                    {% set precio_final = producto.precio_venta * (1 - producto.valor_descuento / 100) %}
                  {% else %}
                    {% set precio_final = producto.precio_venta - producto.valor_descuento %}
                  {% endif %}
                  <span class="discounted-price">${{ '{:.2f}'.format(precio_final) }}</span>
                  <span class="original-price">${{ '{:.2f}'.format(producto.precio_venta) }}</span>
                  <span class="discount-badge">-{{ '{:.0f}'.format(producto.valor_descuento) if producto.tipo_descuento == 'fixed' else '{:.0f}'.format(producto.valor_descuento) }}{{ '$' if producto.tipo_descuento == 'fixed' else '%' }}</span>
                {% else %}
                  <span class="current-price">${{ '{:.2f}'.format(producto.precio_venta) }}</span>
                {% endif %}
              </div>
            </div>
            
            <div class="product-controls">
              <input type="number" class="mini-input" value="10" min="0" data-product-id="{{ producto.id }}">
              <span style="font-size: 13px;">%</span>
              {% if producto.tiene_descuento %}
                <button class="mini-btn remove-mini-btn" onclick="removeDiscount({{ producto.id }})">
                  Quitar
                </button>
              {% else %}
                <button class="mini-btn apply-mini-btn" onclick="applyProductDiscount({{ producto.id }})">
                  Aplicar
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-tags"></i>
        </div>
        <div class="empty-message">No hay productos en tu inventario</div>
        <a href="{{ url_for('nuevo_producto') }}" class="empty-action">
          Agregar producto
        </a>
      </div>
    {% endif %}
  </div>
  
  <!-- Contenedor de notificaciones -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // Variables globales
  let currentDiscountType = 'percentage';
  
  // Inicialización
  document.addEventListener('DOMContentLoaded', function() {
    initializeDiscounts();
    initializeSearch();
    initializeToggles();
  });
  
  // Configurar descuentos
  function initializeDiscounts() {
    // Actualizar el estado visual de las tarjetas con descuento
    document.querySelectorAll('.product-card').forEach(card => {
      if (card.dataset.hasDiscount === 'true') {
        card.classList.add('has-discount');
      }
    });
  }
  
  // Configurar búsqueda
  function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const cards = document.querySelectorAll('.product-card');
      
      cards.forEach(card => {
        const searchable = card.dataset.searchable;
        if (searchable.includes(searchTerm)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  }
  
  // Configurar toggles
  function initializeToggles() {
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    const discountUnit = document.getElementById('discountUnit');
    
    toggleBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        toggleBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentDiscountType = this.dataset.type;
        discountUnit.textContent = currentDiscountType === 'percentage' ? '%' : '$';
      });
    });
  }
  
  // Aplicar descuento global
  function applyGlobalDiscount() {
    const discountValue = parseFloat(document.getElementById('globalDiscountValue').value);
    
    if (!discountValue || discountValue <= 0) {
      showToast('Por favor ingresa un descuento válido', 'error');
      return;
    }
    
    const cards = document.querySelectorAll('.product-card');
    let successCount = 0;
    const promises = [];
    
    cards.forEach(card => {
      if (card.style.display === 'none') return; // Skip hidden products
      
      const productId = card.dataset.productId;
      const originalPrice = parseFloat(card.dataset.originalPrice);
      
      // Solo aplicar descuento sin cambiar el precio base
      const promise = fetch(`/api/apply_discount/${productId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: currentDiscountType,
          value: discountValue
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateProductCardDisplay(productId, originalPrice, discountValue, currentDiscountType);
          successCount++;
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
      
      promises.push(promise);
    });
    
    Promise.all(promises).then(() => {
      showToast(`Descuento aplicado a ${successCount} productos`, 'success');
    });
  }
  
  // Aplicar descuento individual - FUNCIÓN CORREGIDA
  function applyProductDiscount(productId) {
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    const input = card.querySelector('.mini-input');
    const discountValue = parseFloat(input.value);
    const originalPrice = parseFloat(card.dataset.originalPrice);
    
    if (!discountValue || discountValue <= 0) {
      showToast('Por favor ingresa un descuento válido', 'error');
      return;
    }
    
    // Por ahora, siempre usar porcentaje para descuentos individuales
    const discountType = 'percentage';
    
    // Solo aplicar el descuento, NO cambiar el precio base
    fetch(`/api/apply_discount/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: discountType,
        value: discountValue
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateProductCardDisplay(productId, originalPrice, discountValue, discountType);
        showToast('Descuento aplicado correctamente', 'success');
      } else {
        showToast('Error al aplicar descuento', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error al aplicar descuento', 'error');
    });
  }
  
  // Quitar descuento
  function removeDiscount(productId) {
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    const originalPrice = parseFloat(card.dataset.originalPrice);
    
    // Solo remover descuento, sin cambiar el precio base
    fetch(`/api/remove_discount/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Actualizar vista - mostrar el precio base original
        const priceDisplay = card.querySelector('.price-display');
        priceDisplay.innerHTML = `<span class="current-price">$${originalPrice.toFixed(2)}</span>`;
        
        // Cambiar botón a "Aplicar"
        const controlsDiv = card.querySelector('.product-controls');
        controlsDiv.innerHTML = `
          <input type="number" class="mini-input" value="10" min="0" data-product-id="${productId}">
          <span style="font-size: 13px;">%</span>
          <button class="mini-btn apply-mini-btn" onclick="applyProductDiscount(${productId})">
            Aplicar
          </button>
        `;
        
        // Quitar clase de descuento
        card.classList.remove('has-discount');
        card.dataset.hasDiscount = 'false';
        
        showToast('Descuento removido', 'success');
      } else {
        showToast('Error al remover descuento', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error al remover descuento', 'error');
    });
  }
  
  // Actualizar display de la tarjeta
  function updateProductCardDisplay(productId, originalPrice, discountValue, discountType) {
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    let finalPrice;
    
    if (discountType === 'percentage') {
      finalPrice = originalPrice * (1 - discountValue / 100);
    } else {
      finalPrice = originalPrice - discountValue;
    }
    
    if (finalPrice < 0) finalPrice = 0;
    
    // Actualizar precio
    const priceDisplay = card.querySelector('.price-display');
    const discountLabel = discountType === 'percentage' ? `${discountValue}%` : `$${discountValue}`;
    
    priceDisplay.innerHTML = `
      <span class="discounted-price">$${finalPrice.toFixed(2)}</span>
      <span class="original-price">$${originalPrice.toFixed(2)}</span>
      <span class="discount-badge">-${discountLabel}</span>
    `;
    
    // Actualizar controles
    const controlsDiv = card.querySelector('.product-controls');
    controlsDiv.innerHTML = `
      <input type="number" class="mini-input" value="${discountValue}" min="0" data-product-id="${productId}">
      <span style="font-size: 13px;">${discountType === 'percentage' ? '%' : '$'}</span>
      <button class="mini-btn remove-mini-btn" onclick="removeDiscount(${productId})">
        Quitar
      </button>
    `;
    
    // Actualizar atributos de la tarjeta
    card.classList.add('has-discount');
    card.dataset.hasDiscount = 'true';
    card.dataset.discountType = discountType;
    card.dataset.discountValue = discountValue;
  }
  
  // Sistema de notificaciones
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
      <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
      toast.classList.add('fade-out');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
</script>
{% endblock %}