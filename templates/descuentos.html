{% extends 'base.html' %}

{% block title %}Descuentos - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Simplificado */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales */
    --text-color: #1d1d1f;
    --text-secondary: #555555;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    
    /* Colores específicos de descuentos */
    --discount-color: #1a9951;
    --discount-hover: #147a3e;
    --discount-light: rgba(26, 153, 81, 0.1);
    --discount-apply-color: #4CAF50;
    --discount-remove-color: #F44336;
    --warning-color: #ff9800;
    
    --blue: #1a237e;
    --gray-300: #d1d1d6;
    --gray-500: #777777;
    --gray-600: #86868b;
  }

  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--background);
  }

  /* Contenedor principal - más estrecho */
  .descuentos-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }

  /* Encabezado simplificado */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-description {
    font-size: 17px;
    color: #86868b;
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
  }
  
  /* Botones de acción */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }

  /* Panel de descuentos simplificado */
  .discount-panel {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .panel-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Estado actual de descuentos */
  .discount-status {
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
  }

  .discount-status.warning {
    background-color: rgba(255, 152, 0, 0.1);
    border: 1px solid rgba(255, 152, 0, 0.2);
    color: #f57c00;
  }

  .discount-status.info {
    background-color: rgba(33, 150, 243, 0.1);
    border: 1px solid rgba(33, 150, 243, 0.2);
    color: #1976d2;
  }

  .discount-status.success {
    background-color: var(--discount-light);
    border: 1px solid rgba(26, 153, 81, 0.2);
    color: var(--discount-color);
  }

  /* Controles en UNA sola fila - TODO HORIZONTALMENTE */
  .discount-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .discount-target-selector {
    min-width: 200px;
  }

  .discount-target-selector select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 36px;
  }

  .specific-selector {
    min-width: 200px;
    display: none;
  }

  .specific-selector select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 36px;
  }

  /* Buscador de productos */
  .product-search-container {
    min-width: 250px;
    position: relative;
    display: none;
  }

  .product-search-input {
    width: 100%;
    padding: 10px 14px 10px 36px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
  }

  .product-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    margin-top: 4px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: none;
  }

  .product-search-result {
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background-color 0.15s ease;
    border-bottom: 1px solid var(--light-background);
  }

  .product-search-result:hover {
    background-color: var(--light-background);
  }

  .product-search-result:last-child {
    border-bottom: none;
  }

  .product-result-image {
    width: 36px;
    height: 36px;
    object-fit: contain;
    border-radius: 4px;
    background-color: var(--light-background);
  }

  .product-result-info {
    flex: 1;
  }

  .product-result-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--text-color);
  }

  .product-result-details {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 1px;
  }

  .discount-input-group {
    display: flex;
    align-items: center;
    gap: 6px;
    background-color: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 6px 10px;
    width: 100px;
  }

  .discount-input {
    width: 50px;
    border: none;
    outline: none;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    text-align: center;
  }

  .discount-label {
    font-size: 13px;
    color: var(--text-secondary);
    min-width: 15px;
  }

  /* Botón más pequeño */
  .discount-action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
  }

  .btn-apply-discount {
    background-color: var(--discount-apply-color);
    color: white;
  }

  .btn-apply-discount:hover:not(:disabled) {
    background-color: #43A047;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
  }

  /* Sección Mis Descuentos */
  .my-discounts-section {
    margin-top: 48px;
  }

  .section-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .discount-type-container {
    margin-bottom: 32px;
    animation: fadeIn 0.3s ease;
  }

  .discount-type-header {
    background-color: var(--light-background);
    padding: 12px 20px;
    border-radius: 8px 8px 0 0;
    border: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .discount-type-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .discount-type-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
    background-color: rgba(0, 0, 0, 0.05);
    padding: 4px 8px;
    border-radius: 12px;
  }

  .discount-type-button {
    padding: 6px 12px;
    font-size: 0.85rem;
    background-color: white;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .discount-type-button:hover {
    background-color: var(--accent);
    color: white;
  }

  .discount-type-items {
    background-color: white;
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-top: none;
    border-radius: 0 0 8px 8px;
    min-height: 60px;
    display: flex;
    flex-direction: column;
  }

  .discount-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--light-background);
    transition: background-color 0.15s ease;
  }

  .discount-item:last-child {
    border-bottom: none;
  }

  .discount-item:hover {
    background-color: var(--light-background);
  }

  .discount-item-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .discount-item-image {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 6px;
    background-color: var(--light-background);
    flex-shrink: 0;
  }

  .discount-item-details {
    flex: 1;
  }

  .discount-item-details h4 {
    font-size: 1rem;
    font-weight: 500;
    margin: 0;
    color: var(--text-color);
    line-height: 1.4;
  }

  .discount-item-details p {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: 2px 0 0 0;
    line-height: 1.3;
  }

  /* Precios mejorados */
  .price-info {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-top: 4px;
  }

  .price-original {
    text-decoration: line-through;
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .price-discounted {
    color: var(--discount-color);
    font-weight: 600;
    font-size: 1.05rem;
  }

  .discount-item-value {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .discount-value {
    font-weight: 600;
    color: var(--discount-color);
    font-size: 1rem;
    padding: 4px 8px;
    background-color: var(--discount-light);
    border-radius: 4px;
  }

  .empty-discounts {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Modal de confirmación personalizado */
  .custom-confirm {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .custom-confirm-box {
    background: white;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  .custom-confirm-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-color);
  }

  .custom-confirm-message {
    color: var(--text-secondary);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .custom-confirm-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .custom-confirm-button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .custom-confirm-cancel {
    background: var(--light-background);
    color: var(--text-color);
  }

  .custom-confirm-cancel:hover {
    background: #e0e0e0;
  }

  .custom-confirm-ok {
    background: var(--accent);
    color: white;
  }

  .custom-confirm-ok:hover {
    background: var(--accent-hover);
  }

  /* Animaciones */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    max-width: 400px;
  }

  .toast {
    background-color: #333;
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    margin-top: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    opacity: 1;
    transition: all 0.3s ease;
  }

  .toast.success {
    background-color: #2ecc71;
  }

  .toast.error {
    background-color: #e74c3c;
  }

  .toast.warning {
    background-color: #f39c12;
  }

  .toast.fade-out {
    opacity: 0;
    transform: translateY(-20px);
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .descuentos-container {
      padding: 24px 16px;
    }
    
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .discount-controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .discount-target-selector,
    .specific-selector,
    .product-search-container {
      width: 100%;
    }
  }
</style>

<div class="descuentos-container">
  <!-- Encabezado simplificado -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Aplicar Descuentos</h1>
      <p class="page-description">Gestiona los descuentos de manera rápida y eficiente.</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>

  <!-- Panel de aplicar descuentos -->
  <div class="discount-panel">
    <h3 class="panel-title">
      <i class="fas fa-tags"></i>
      Aplicar descuento
    </h3>
    
    <!-- Estado actual de descuentos -->
    <div class="discount-status" id="discountStatus"></div>
    
    <div class="discount-controls">
      <div class="discount-target-selector">
        <select id="discountTarget">
          <option value="all">Aplicar a todos los productos</option>
          <option value="category">Aplicar por categoría</option>
          <option value="brand">Aplicar por marca</option>
          <option value="product">Aplicar a un producto</option>
        </select>
      </div>
      
      <div class="specific-selector" id="categorySelector">
        <select id="specificCategory">
          <option value="">Selecciona una categoría</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.nombre }}">{{ categoria.nombre|title }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="specific-selector" id="brandSelector">
        <select id="specificBrand">
          <option value="">Selecciona una marca</option>
          {% set brands = productos|map(attribute='marca')|unique|list %}
          {% for brand in brands %}
            {% if brand %}
              <option value="{{ brand }}">{{ brand }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <div class="product-search-container" id="productSearchContainer">
        <input type="text" class="product-search-input" id="productSearchInput" placeholder="Buscar por nombre, SKU o marca...">
        <div class="product-search-results" id="productSearchResults"></div>
        <input type="hidden" id="selectedProductId">
      </div>
      
      <div class="discount-input-group">
        <input type="number" class="discount-input" id="globalDiscountValue" value="10" min="1" max="100" required>
        <span class="discount-label">%</span>
      </div>
      
      <button class="discount-action-btn btn-apply-discount" id="applyGlobalDiscountBtn" onclick="applyGlobalDiscount()">
        <i class="fas fa-percent"></i>
        Aplicar
      </button>
    </div>
  </div>

  <!-- Sección Mis Descuentos -->
  <div class="my-discounts-section" id="myDiscountsSection" style="display: none;">
    <h2 class="section-title">
      <i class="fas fa-list"></i>
      Mis Descuentos
    </h2>

    <!-- Descuentos Globales -->
    <div class="discount-type-container" id="globalDiscounts" style="display: none;">
      <div class="discount-type-header">
        <div>
          <div class="discount-type-title">
            <i class="fas fa-globe"></i>
            Descuento Global
            <span class="discount-type-count" id="globalDiscountCount">0</span>
          </div>
        </div>
        <button class="discount-type-button" onclick="removeGlobalDiscount()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-type-items" id="globalDiscountItems">
        <div class="empty-discounts">No hay descuento global</div>
      </div>
    </div>

    <!-- Descuentos por Categoría -->
    <div class="discount-type-container" id="categoryDiscounts" style="display: none;">
      <div class="discount-type-header">
        <div>
          <div class="discount-type-title">
            <i class="fas fa-tag"></i>
            Por Categoría
            <span class="discount-type-count" id="categoryDiscountCount">0</span>
          </div>
        </div>
        <button class="discount-type-button" onclick="removeAllCategoryDiscounts()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-type-items" id="categoryDiscountItems">
        <div class="empty-discounts">No hay descuentos por categoría</div>
      </div>
    </div>

    <!-- Descuentos por Producto -->
    <div class="discount-type-container" id="productDiscounts" style="display: none;">
      <div class="discount-type-header">
        <div>
          <div class="discount-type-title">
            <i class="fas fa-box"></i>
            Por Producto
            <span class="discount-type-count" id="productDiscountCount">0</span>
          </div>
        </div>
        <button class="discount-type-button" onclick="removeAllProductDiscounts()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-type-items" id="productDiscountItems">
        <div class="empty-discounts">No hay descuentos por producto</div>
      </div>
    </div>

    <!-- Descuentos por Marca -->
    <div class="discount-type-container" id="brandDiscounts" style="display: none;">
      <div class="discount-type-header">
        <div>
          <div class="discount-type-title">
            <i class="fas fa-trademark"></i>
            Por Marca
            <span class="discount-type-count" id="brandDiscountCount">0</span>
          </div>
        </div>
        <button class="discount-type-button" onclick="removeAllBrandDiscounts()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-type-items" id="brandDiscountItems">
        <div class="empty-discounts">No hay descuentos por marca</div>
      </div>
    </div>
  </div>

  <!-- Notificaciones -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // Estado global para controlar descuentos
  let activeDiscounts = {
    global: false,
    categories: new Set(),
    products: new Set(),
    brands: new Set(),
    globalDetails: null,
    categoryDetails: {},
    brandDetails: {}
  };
  
  // Cache de datos para mejorar performance
  let productosCache = null;
  
  // Inicialización
  document.addEventListener('DOMContentLoaded', function() {
    // Precargar datos
    productosCache = {{ productos|tojson }};
    
    initializeDiscountPanel();
    checkExistingDiscounts();
    initializeProductSearch();
  });
  
  // Configurar panel de descuentos
  function initializeDiscountPanel() {
    const discountTarget = document.getElementById('discountTarget');
    const categorySelector = document.getElementById('categorySelector');
    const brandSelector = document.getElementById('brandSelector');
    const productSearchContainer = document.getElementById('productSearchContainer');
    const applyButton = document.getElementById('applyGlobalDiscountBtn');
    
    discountTarget.addEventListener('change', function() {
      // Ocultar todos primero
      categorySelector.style.display = 'none';
      brandSelector.style.display = 'none';
      productSearchContainer.style.display = 'none';
      
      // Mostrar el selector correspondiente
      switch(this.value) {
        case 'category':
          categorySelector.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-tag"></i> Aplicar';
          break;
        case 'brand':
          brandSelector.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-trademark"></i> Aplicar';
          break;
        case 'product':
          productSearchContainer.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-box"></i> Aplicar';
          break;
        default:
          applyButton.innerHTML = '<i class="fas fa-percent"></i> Aplicar';
          break;
      }
      
      updateUIState();
    });
    
    // Validación de input
    const discountInput = document.getElementById('globalDiscountValue');
    discountInput.addEventListener('input', function() {
      if (this.value > 100) this.value = 100;
      if (this.value < 1) this.value = 1;
    });
  }
  
  // Inicializar búsqueda de productos
  function initializeProductSearch() {
    const searchInput = document.getElementById('productSearchInput');
    const resultsContainer = document.getElementById('productSearchResults');
    
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      // Búsqueda inmediata del cache
      const results = searchProducts(query);
      displaySearchResults(results);
    });
    
    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
        resultsContainer.style.display = 'none';
      }
    });
  }
  
  // Buscar productos en cache
  function searchProducts(query) {
    return productosCache.filter(product => {
      const searchableText = (
        (product.nombre || '') + ' ' +
        (product.marca || '') + ' ' +
        (product.codigo_barras_externo || '')
      ).toLowerCase();
      
      return searchableText.includes(query.toLowerCase());
    }).slice(0, 10);
  }
  
  // Mostrar resultados de búsqueda
  function displaySearchResults(results) {
    const resultsContainer = document.getElementById('productSearchResults');
    
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="empty-discounts">No se encontraron productos</div>';
      resultsContainer.style.display = 'block';
      return;
    }
    
    const html = results.map(product => `
      <div class="product-search-result" onclick="selectProduct(${product.id}, '${product.nombre.replace(/'/g, '\\\'')}')"
           data-has-discount="${product.tiene_descuento || false}"
           data-product-id="${product.id}">
        <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
             alt="${product.nombre}" 
             class="product-result-image">
        <div class="product-result-info">
          <div class="product-result-name">${product.nombre}
            ${(product.tiene_descuento) ? ' <span style="color: var(--discount-color); font-size: 0.8rem;">(-' + Math.round(product.valor_descuento) + '%)</span>' : ''}
          </div>
          <div class="product-result-details">${product.marca || 'Sin marca'} • SKU: ${product.codigo_barras_externo || 'N/A'}</div>
        </div>
      </div>
    `).join('');
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
  }
  
  // Seleccionar producto de búsqueda
  function selectProduct(productId, productName) {
    const searchInput = document.getElementById('productSearchInput');
    const resultsContainer = document.getElementById('productSearchResults');
    const selectedProductId = document.getElementById('selectedProductId');
    
    searchInput.value = productName;
    selectedProductId.value = productId;
    resultsContainer.style.display = 'none';
    
    // Almacenar información del producto seleccionado
    searchInput.dataset.selectedId = productId;
  }
  
  // Verificar descuentos existentes - OPTIMIZADO
  function checkExistingDiscounts() {
    activeDiscounts.categories.clear();
    activeDiscounts.products.clear();
    activeDiscounts.brands.clear();
    activeDiscounts.categoryDetails = {};
    activeDiscounts.brandDetails = {};
    
    // Categorizar descuentos existentes
    const categoryProducts = {};
    const brandProducts = {};
    
    productosCache.forEach(product => {
      if (product.tiene_descuento) {
        // Agregar a productos
        activeDiscounts.products.add(product.id);
        
        // Verificar por categoría
        if (!categoryProducts[product.categoria]) {
          categoryProducts[product.categoria] = { total: 0, withDiscount: 0 };
        }
        categoryProducts[product.categoria].total++;
        categoryProducts[product.categoria].withDiscount++;
        
        // Verificar por marca
        if (product.marca) {
          if (!brandProducts[product.marca]) {
            brandProducts[product.marca] = { total: 0, withDiscount: 0 };
          }
          brandProducts[product.marca].total++;
          brandProducts[product.marca].withDiscount++;
        }
      }
    });
    
    // Verificar si categorías completas tienen descuento
    Object.keys(categoryProducts).forEach(category => {
      const categoryTotal = productosCache.filter(p => p.categoria === category).length;
      if (categoryProducts[category].withDiscount === categoryTotal) {
        activeDiscounts.categories.add(category);
        activeDiscounts.categoryDetails[category] = productosCache.filter(p => p.categoria === category && p.tiene_descuento);
      }
    });
    
    // Verificar si marcas completas tienen descuento
    Object.keys(brandProducts).forEach(brand => {
      const brandTotal = productosCache.filter(p => p.marca === brand).length;
      if (brandProducts[brand].withDiscount === brandTotal) {
        activeDiscounts.brands.add(brand);
        activeDiscounts.brandDetails[brand] = productosCache.filter(p => p.marca === brand && p.tiene_descuento);
      }
    });
    
    // Verificar si todos los productos tienen descuento
    const totalProducts = productosCache.length;
    const discountedProducts = productosCache.filter(p => p.tiene_descuento).length;
    activeDiscounts.global = (discountedProducts === totalProducts && totalProducts > 0);
    
    if (activeDiscounts.global) {
      activeDiscounts.globalDetails = productosCache.filter(p => p.tiene_descuento);
    }
    
    // Actualizar UI inmediatamente
    requestAnimationFrame(() => {
      updateMyDiscountsSection();
      updateUIState();
    });
  }
  
  // Actualizar sección "Mis Descuentos" - OPTIMIZADO
  function updateMyDiscountsSection() {
    const section = document.getElementById('myDiscountsSection');
    const globalContainer = document.getElementById('globalDiscounts');
    const categoryContainer = document.getElementById('categoryDiscounts');
    const productContainer = document.getElementById('productDiscounts');
    const brandContainer = document.getElementById('brandDiscounts');
    
    const hasDiscounts = activeDiscounts.global || 
                        activeDiscounts.categories.size > 0 || 
                        activeDiscounts.products.size > 0 || 
                        activeDiscounts.brands.size > 0;
    
    section.style.display = hasDiscounts ? 'block' : 'none';
    
    // Actualizar inmediatamente sin esperas
    updateGlobalDiscountsList();
    updateCategoryDiscountsList();
    updateProductDiscountsList();
    updateBrandDiscountsList();
    
    // Mostrar/ocultar contenedores según haya discounts
    globalContainer.style.display = activeDiscounts.global ? 'block' : 'none';
    categoryContainer.style.display = activeDiscounts.categories.size > 0 ? 'block' : 'none';
    productContainer.style.display = activeDiscounts.products.size > 0 ? 'block' : 'none';
    brandContainer.style.display = activeDiscounts.brands.size > 0 ? 'block' : 'none';
  }
  
  // Actualizar lista de descuentos globales
  function updateGlobalDiscountsList() {
    const container = document.getElementById('globalDiscountItems');
    const countElement = document.getElementById('globalDiscountCount');
    
    if (!activeDiscounts.global || !activeDiscounts.globalDetails) {
      container.innerHTML = '<div class="empty-discounts">No hay descuento global</div>';
      countElement.textContent = '0';
      return;
    }
    
    countElement.textContent = activeDiscounts.globalDetails.length;
    
    const items = activeDiscounts.globalDetails.map(product => {
      const precioOriginal = product.precio_venta || 0;
      const valorDescuento = product.valor_descuento || 0;
      const precioFinal = precioOriginal * (1 - valorDescuento / 100);
      
      return `
        <div class="discount-item">
          <div class="discount-item-info">
            <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
                 alt="${product.nombre}" 
                 class="discount-item-image">
            <div class="discount-item-details">
              <h4>${product.nombre}</h4>
              <p>${product.marca || 'Sin marca'} • SKU: ${product.codigo_barras_externo || 'N/A'}</p>
              <div class="price-info">
                <span class="price-original">$${precioOriginal.toFixed(2)}</span>
                <span class="price-discounted">$${precioFinal.toFixed(2)}</span>
              </div>
            </div>
          </div>
          <div class="discount-item-value">
            <span class="discount-value">-${Math.round(valorDescuento)}%</span>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = items;
  }
  
  // Actualizar lista de descuentos por categoría
  function updateCategoryDiscountsList() {
    const container = document.getElementById('categoryDiscountItems');
    const countElement = document.getElementById('categoryDiscountCount');
    
    countElement.textContent = activeDiscounts.categories.size;
    
    if (activeDiscounts.categories.size === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuentos por categoría</div>';
      return;
    }
    
    const items = Array.from(activeDiscounts.categories).map(category => {
      const categoryProducts = activeDiscounts.categoryDetails[category] || [];
      const averageDiscount = categoryProducts.length > 0 ? 
        Math.round(categoryProducts.reduce((sum, p) => sum + p.valor_descuento, 0) / categoryProducts.length) : 0;
      
      // Crear la estructura del título de categoría
      let categoryHtml = `
        <div class="discount-type-container" style="margin-bottom: 16px; margin-top: 8px;">
          <div class="discount-type-header">
            <div>
              <div class="discount-type-title" style="font-size: 14px;">
                <i class="fas fa-folder"></i>
                ${category}
                <span class="discount-type-count">${categoryProducts.length}</span>
              </div>
            </div>
            <div class="discount-item-value">
              <span class="discount-value">-${averageDiscount}%</span>
              <button class="discount-type-button" onclick="removeCategoryDiscount('${category}')">
                <i class="fas fa-times"></i>
                Quitar
              </button>
            </div>
          </div>
          <div class="discount-type-items">
      `;
      
      // Agregar productos de la categoría
      categoryHtml += categoryProducts.map(product => {
        const precioOriginal = product.precio_venta || 0;
        const valorDescuento = product.valor_descuento || 0;
        const precioFinal = precioOriginal * (1 - valorDescuento / 100);
        
        return `
          <div class="discount-item">
            <div class="discount-item-info">
              <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
                   alt="${product.nombre}" 
                   class="discount-item-image">
              <div class="discount-item-details">
                <h4>${product.nombre}</h4>
                <p>${product.marca || 'Sin marca'} • SKU: ${product.codigo_barras_externo || 'N/A'}</p>
                <div class="price-info">
                  <span class="price-original">$${precioOriginal.toFixed(2)}</span>
                  <span class="price-discounted">$${precioFinal.toFixed(2)}</span>
                </div>
              </div>
            </div>
            <div class="discount-item-value">
              <span class="discount-value">-${Math.round(valorDescuento)}%</span>
            </div>
          </div>
        `;
      }).join('');
      
      categoryHtml += `
          </div>
        </div>
      `;
      
      return categoryHtml;
    }).join('');
    
    container.innerHTML = items;
  }
  
  // Actualizar lista de descuentos por producto
  function updateProductDiscountsList() {
    const container = document.getElementById('productDiscountItems');
    const countElement = document.getElementById('productDiscountCount');
    
    const individualProducts = productosCache.filter(p => 
      p.tiene_descuento && 
      !activeDiscounts.categories.has(p.categoria) && 
      !activeDiscounts.brands.has(p.marca)
    );
    
    countElement.textContent = individualProducts.length;
    
    if (individualProducts.length === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuentos individuales</div>';
      return;
    }
    
    const items = individualProducts.map(product => {
      const precioOriginal = product.precio_venta || 0;
      const valorDescuento = product.valor_descuento || 0;
      const precioFinal = precioOriginal * (1 - valorDescuento / 100);
      
      return `
        <div class="discount-item">
          <div class="discount-item-info">
            <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
                 alt="${product.nombre}" 
                 class="discount-item-image">
            <div class="discount-item-details">
              <h4>${product.nombre}</h4>
              <p>${product.marca || 'Sin marca'} • SKU: ${product.codigo_barras_externo || 'N/A'}</p>
              <div class="price-info">
                <span class="price-original">$${precioOriginal.toFixed(2)}</span>
                <span class="price-discounted">$${precioFinal.toFixed(2)}</span>
              </div>
            </div>
          </div>
          <div class="discount-item-value">
            <span class="discount-value">-${Math.round(valorDescuento)}%</span>
            <button class="discount-type-button" onclick="removeProductDiscount(${product.id})">
              <i class="fas fa-times"></i>
              Quitar
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = items;
  }
  
  // Actualizar lista de descuentos por marca - CORREGIDO
  function updateBrandDiscountsList() {
    const container = document.getElementById('brandDiscountItems');
    const countElement = document.getElementById('brandDiscountCount');
    
    countElement.textContent = activeDiscounts.brands.size;
    
    if (activeDiscounts.brands.size === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuentos por marca</div>';
      return;
    }
    
    const items = Array.from(activeDiscounts.brands).map(brand => {
      const brandProducts = activeDiscounts.brandDetails[brand] || [];
      const averageDiscount = brandProducts.length > 0 ? 
        Math.round(brandProducts.reduce((sum, p) => sum + p.valor_descuento, 0) / brandProducts.length) : 0;
      
      // Crear la estructura del título de marca
      let brandHtml = `
        <div class="discount-type-container" style="margin-bottom: 16px; margin-top: 8px;">
          <div class="discount-type-header">
            <div>
              <div class="discount-type-title" style="font-size: 14px;">
                <i class="fas fa-copyright"></i>
                ${brand}
                <span class="discount-type-count">${brandProducts.length}</span>
              </div>
            </div>
            <div class="discount-item-value">
              <span class="discount-value">-${averageDiscount}%</span>
              <button class="discount-type-button" onclick="removeBrandDiscount('${brand}')">
                <i class="fas fa-times"></i>
                Quitar
              </button>
            </div>
          </div>
          <div class="discount-type-items">
      `;
      
      // Agregar productos de la marca - SOLO PRODUCTOS DE ESA MARCA
      brandHtml += brandProducts.map(product => {
        const precioOriginal = product.precio_venta || 0;
        const valorDescuento = product.valor_descuento || 0;
        const precioFinal = precioOriginal * (1 - valorDescuento / 100);
        
        return `
          <div class="discount-item">
            <div class="discount-item-info">
              <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
                   alt="${product.nombre}" 
                   class="discount-item-image">
              <div class="discount-item-details">
                <h4>${product.nombre}</h4>
                <p>${product.marca || 'Sin marca'} • SKU: ${product.codigo_barras_externo || 'N/A'}</p>
                <div class="price-info">
                  <span class="price-original">$${precioOriginal.toFixed(2)}</span>
                  <span class="price-discounted">$${precioFinal.toFixed(2)}</span>
                </div>
              </div>
            </div>
            <div class="discount-item-value">
              <span class="discount-value">-${Math.round(valorDescuento)}%</span>
            </div>
          </div>
        `;
      }).join('');
      
      brandHtml += `
          </div>
        </div>
      `;
      
      return brandHtml;
    }).join('');
    
    container.innerHTML = items;
  }
  
  // Aplicar descuento global - CON VERIFICACIÓN DE DOBLES DESCUENTOS
  function applyGlobalDiscount() {
    const target = document.getElementById('discountTarget').value;
    const discountValue = parseFloat(document.getElementById('globalDiscountValue').value);
    
    if (!discountValue || discountValue < 1 || discountValue > 100) {
      showToast('Por favor ingresa un descuento válido (1-100%)', 'error');
      return;
    }
    
    switch(target) {
      case 'all':
        applyDiscountToAll(discountValue);
        break;
      case 'category':
        const category = document.getElementById('specificCategory').value;
        if (!category) {
          showToast('Por favor selecciona una categoría', 'error');
          return;
        }
        
        // Verificar si ya hay descuentos que afectarían a esta categoría
        const categoryProducts = productosCache.filter(p => p.categoria === category);
        let conflicts = [];
        
        if (activeDiscounts.global) {
          conflicts.push('descuento global');
        }
        
        if (activeDiscounts.categories.has(category)) {
          conflicts.push('descuento por categoría');
        }
        
        // Verificar productos individuales de esta categoría
        const individualInCategory = categoryProducts.filter(p => 
          p.tiene_descuento && 
          !activeDiscounts.categories.has(p.categoria) && 
          !activeDiscounts.brands.has(p.marca)
        );
        
        if (individualInCategory.length > 0) {
          conflicts.push(`${individualInCategory.length} productos con descuentos individuales`);
        }
        
        // Verificar marcas completas en esta categoría
        const brandsInCategory = new Set(categoryProducts.map(p => p.marca).filter(Boolean));
        const affectedBrands = Array.from(brandsInCategory).filter(brand => activeDiscounts.brands.has(brand));
        
        if (affectedBrands.length > 0) {
          conflicts.push(`marcas completas: ${affectedBrands.join(', ')}`);
        }
        
        if (conflicts.length > 0) {
          showToast(`No se puede aplicar. Esta categoría ya tiene: ${conflicts.join(', ')}`, 'error');
          return;
        }
        
        applyDiscountToCategory(category, discountValue);
        break;
        
      case 'brand':
        const brand = document.getElementById('specificBrand').value;
        if (!brand) {
          showToast('Por favor selecciona una marca', 'error');
          return;
        }
        
        // Verificar si ya hay descuentos que afectarían a esta marca
        const brandProducts = productosCache.filter(p => p.marca === brand);
        let brandConflicts = [];
        
        if (activeDiscounts.global) {
          brandConflicts.push('descuento global');
        }
        
        if (activeDiscounts.brands.has(brand)) {
          brandConflicts.push('descuento por marca');
        }
        
        // Verificar categorías completas que incluyan esta marca
        const categoriesWithBrand = new Set(brandProducts.map(p => p.categoria));
        const affectedCategories = Array.from(categoriesWithBrand).filter(cat => activeDiscounts.categories.has(cat));
        
        if (affectedCategories.length > 0) {
          brandConflicts.push(`categorías completas: ${affectedCategories.join(', ')}`);
        }
        
        // Verificar productos individuales de esta marca
        const individualInBrand = brandProducts.filter(p => 
          p.tiene_descuento && 
          !activeDiscounts.categories.has(p.categoria) && 
          !activeDiscounts.brands.has(p.marca)
        );
        
        if (individualInBrand.length > 0) {
          brandConflicts.push(`${individualInBrand.length} productos con descuentos individuales`);
        }
        
        if (brandConflicts.length > 0) {
          showToast(`No se puede aplicar. Esta marca ya tiene: ${brandConflicts.join(', ')}`, 'error');
          return;
        }
        
        applyDiscountToBrand(brand, discountValue);
        break;
        
      case 'product':
        const productId = document.getElementById('selectedProductId').value;
        if (!productId) {
          showToast('Por favor selecciona un producto', 'error');
          return;
        }
        
        // Verificar si el producto ya tiene descuento (cualquier tipo)
        const product = productosCache.find(p => p.id == productId);
        if (!product) {
          showToast('Producto no encontrado', 'error');
          return;
        }
        
        if (product.tiene_descuento) {
          let productConflicts = [];
          
          if (activeDiscounts.global) {
            productConflicts.push('descuento global');
          }
          
          if (activeDiscounts.categories.has(product.categoria)) {
            productConflicts.push('descuento por categoría');
          }
          
          if (activeDiscounts.brands.has(product.marca)) {
            productConflicts.push('descuento por marca');
          }
          
          if (productConflicts.length === 0) {
            productConflicts.push('descuento individual');
          }
          
          showToast(`No se puede aplicar. Este producto ya tiene: ${productConflicts.join(', ')}`, 'error');
          return;
        }
        
        applyDiscountToProduct(productId, discountValue);
        break;
    }
  }
  
  // Aplicar descuento a todos los productos
  function applyDiscountToAll(discountValue) {
    // Verificar si realmente podemos aplicar global
    if (activeDiscounts.categories.size > 0 || activeDiscounts.brands.size > 0 || activeDiscounts.products.size > 0) {
      showToast('No se puede aplicar descuento global. Ya existen descuentos específicos.', 'error');
      return;
    }
    
    const promises = productosCache.map(product => 
      applyDiscountToProduct(product.id, discountValue)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      if (successCount === productosCache.length) {
        showToast(`Descuento del ${discountValue}% aplicado a todos los productos`, 'success');
        activeDiscounts.global = true;
        checkExistingDiscounts();
      } else {
        showToast(`Aplicado a ${successCount} de ${productosCache.length} productos`, 'warning');
      }
    });
  }
  
  // Aplicar descuento a categoría
  function applyDiscountToCategory(category, discountValue) {
    const categoryProducts = productosCache.filter(p => p.categoria === category);
    
    const promises = categoryProducts.map(product => 
      applyDiscountToProduct(product.id, discountValue)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      if (successCount === categoryProducts.length) {
        showToast(`Descuento del ${discountValue}% aplicado a la categoría "${category}"`, 'success');
        activeDiscounts.categories.add(category);
        checkExistingDiscounts();
      } else {
        showToast(`Aplicado a ${successCount} de ${categoryProducts.length} productos`, 'warning');
      }
    });
  }
  
  // Aplicar descuento a marca
  function applyDiscountToBrand(brand, discountValue) {
    const brandProducts = productosCache.filter(p => p.marca === brand);
    
    const promises = brandProducts.map(product => 
      applyDiscountToProduct(product.id, discountValue)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      if (successCount === brandProducts.length) {
        showToast(`Descuento del ${discountValue}% aplicado a la marca "${brand}"`, 'success');
        activeDiscounts.brands.add(brand);
        checkExistingDiscounts();
      } else {
        showToast(`Aplicado a ${successCount} de ${brandProducts.length} productos`, 'warning');
      }
    });
  }
  
  // Aplicar descuento a producto individual - SIMPLE
  function applyDiscountToProduct(productId, discountValue) {
    return fetch(`/api/apply_discount/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: 'percentage',
        value: discountValue
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Solo mostrar toast para productos individuales
        const target = document.getElementById('discountTarget').value;
        if (target === 'product') {
          const product = productosCache.find(p => p.id == productId);
          showToast(`Descuento del ${discountValue}% aplicado a "${product.nombre}"`, 'success');
        }
        
        // Actualizar cache inmediatamente
        const cachedProduct = productosCache.find(p => p.id == productId);
        if (cachedProduct) {
          cachedProduct.tiene_descuento = true;
          cachedProduct.valor_descuento = discountValue;
          cachedProduct.tipo_descuento = 'percentage';
        }
        
        checkExistingDiscounts();
        return true;
      } else {
        showToast('Error al aplicar descuento', 'error');
        return false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      return false;
    });
  }
  
  // Remover descuento de producto individual
  function removeProductDiscount(productId) {
    const modal = document.createElement('div');
    modal.className = 'custom-confirm';
    modal.innerHTML = `
      <div class="custom-confirm-box">
        <div class="custom-confirm-title">Confirmar eliminación</div>
        <div class="custom-confirm-message">¿Estás seguro que deseas quitar el descuento de este producto?</div>
        <div class="custom-confirm-buttons">
          <button class="custom-confirm-button custom-confirm-cancel">Cancelar</button>
          <button class="custom-confirm-button custom-confirm-ok">Quitar descuento</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.querySelector('.custom-confirm-cancel').addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    modal.querySelector('.custom-confirm-ok').addEventListener('click', function() {
      document.body.removeChild(modal);
      
      fetch(`/api/remove_discount/${productId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Descuento removido', 'success');
          
          // Actualizar cache inmediatamente
          const cachedProduct = productosCache.find(p => p.id == productId);
          if (cachedProduct) {
            cachedProduct.tiene_descuento = false;
            cachedProduct.valor_descuento = 0;
          }
          
          activeDiscounts.products.delete(productId);
          checkExistingDiscounts();
        } else {
          showToast('Error al remover descuento', 'error');
        }
      });
    });
  }
  
  // Remover descuento global (sin confirmación)
  function removeGlobalDiscount() {
    const globalProducts = productosCache.filter(p => p.tiene_descuento);
    
    const promises = globalProducts.map(product => 
      fetch(`/api/remove_discount/${product.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar cache inmediatamente
          const cachedProduct = productosCache.find(p => p.id == product.id);
          if (cachedProduct) {
            cachedProduct.tiene_descuento = false;
            cachedProduct.valor_descuento = 0;
          }
          return true;
        }
        return false;
      })
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuento global removido de ${successCount} productos`, 'success');
      activeDiscounts.global = false;
      activeDiscounts.globalDetails = null;
      checkExistingDiscounts();
    });
  }
  
  // Remover descuento de categoría (sin confirmación)
  function removeCategoryDiscount(category) {
    const categoryProducts = productosCache.filter(p => p.categoria === category && p.tiene_descuento);
    
    const promises = categoryProducts.map(product => 
      fetch(`/api/remove_discount/${product.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar cache inmediatamente
          const cachedProduct = productosCache.find(p => p.id == product.id);
          if (cachedProduct) {
            cachedProduct.tiene_descuento = false;
            cachedProduct.valor_descuento = 0;
          }
          return true;
        }
        return false;
      })
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuentos removidos de ${successCount} productos en "${category}"`, 'success');
      activeDiscounts.categories.delete(category);
      delete activeDiscounts.categoryDetails[category];
      checkExistingDiscounts();
    });
  }
  
  // Remover descuento de marca (sin confirmación)
  function removeBrandDiscount(brand) {
    const brandProducts = productosCache.filter(p => p.marca === brand && p.tiene_descuento);
    
    const promises = brandProducts.map(product => 
      fetch(`/api/remove_discount/${product.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar cache inmediatamente
          const cachedProduct = productosCache.find(p => p.id == product.id);
          if (cachedProduct) {
            cachedProduct.tiene_descuento = false;
            cachedProduct.valor_descuento = 0;
          }
          return true;
        }
        return false;
      })
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuentos removidos de ${successCount} productos de "${brand}"`, 'success');
      activeDiscounts.brands.delete(brand);
      delete activeDiscounts.brandDetails[brand];
      checkExistingDiscounts();
    });
  }
  
  // Remover todos los descuentos (sin confirmación)
  function removeAllCategoryDiscounts() {
    Array.from(activeDiscounts.categories).forEach(category => {
      removeCategoryDiscount(category);
    });
  }
  
  function removeAllProductDiscounts() {
    const individualProducts = productosCache.filter(p => 
      p.tiene_descuento && 
      !activeDiscounts.categories.has(p.categoria) && 
      !activeDiscounts.brands.has(p.marca)
    );
    
    const promises = individualProducts.map(product => 
      fetch(`/api/remove_discount/${product.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar cache inmediatamente
          const cachedProduct = productosCache.find(p => p.id == product.id);
          if (cachedProduct) {
            cachedProduct.tiene_descuento = false;
            cachedProduct.valor_descuento = 0;
          }
          return true;
        }
        return false;
      })
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuentos removidos de ${successCount} productos individuales`, 'success');
      checkExistingDiscounts();
    });
  }
  
  function removeAllBrandDiscounts() {
    Array.from(activeDiscounts.brands).forEach(brand => {
      removeBrandDiscount(brand);
    });
  }
  
  // Actualizar estado de la UI
  function updateUIState() {
    const discountTarget = document.getElementById('discountTarget');
    const discountStatus = document.getElementById('discountStatus');
    
    // Resetear estado visual
    discountStatus.style.display = 'none';
    discountTarget.disabled = false;
    
    // Evaluar restricciones basadas en el estado actual
    if (activeDiscounts.global) {
      discountStatus.className = 'discount-status success';
      discountStatus.style.display = 'block';
      discountStatus.innerHTML = '<i class="fas fa-check-circle"></i> Todos los productos tienen descuento global aplicado. Para aplicar otros descuentos, primero quita el descuento global.';
      
      // Limitar opciones disponibles
      Array.from(discountTarget.options).forEach(option => {
        option.disabled = option.value !== 'all';
      });
      discountTarget.value = 'all';
    } else {
      // Reactivar todas las opciones
      Array.from(discountTarget.options).forEach(option => {
        option.disabled = false;
      });
    }
  }
  
  // Sistema de notificaciones
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    if (type === 'warning') icon = 'exclamation-triangle';
    
    toast.innerHTML = `
      <i class="fas fa-${icon}"></i>
      <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('fade-out');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
  
  // Validar inputs de descuento
  document.addEventListener('input', function(e) {
    if (e.target.id === 'globalDiscountValue') {
      if (e.target.value > 100) e.target.value = 100;
      if (e.target.value < 1 && e.target.value !== '') e.target.value = 1;
    }
  });
</script>
{% endblock %}