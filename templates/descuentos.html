{% extends 'base.html' %}

{% block title %}Descuentos - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Similar a cambiar_precios.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales */
    --text-color: #1d1d1f;
    --text-secondary: #555555;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    
    /* Colores específicos de descuentos */
    --discount-color: #1a9951;
    --discount-hover: #147a3e;
    --discount-light: rgba(26, 153, 81, 0.1);
    --discount-apply-color: #4CAF50;
    --discount-remove-color: #F44336;
    --warning-color: #ff9800;
    
    --blue: #1a237e;
    --gray-300: #d1d1d6;
    --gray-500: #777777;
    --gray-600: #86868b;
  }

  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }

  /* Contenedor principal */
  .descuentos-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }

  /* Encabezado igual que cambiar_precios.html */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-description {
    font-size: 17px;
    color: #86868b;
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
  }
  
  /* Botones de acción igual que cambiar_precios.html */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }

  /* Panel de aplicar descuentos */
  .discount-panel {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 50px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .panel-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Controles de descuento */
  .discount-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .discount-target-selector {
    min-width: 200px;
  }

  .discount-target-selector select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 36px;
  }

  .specific-selector {
    min-width: 200px;
    display: none;
  }

  .specific-selector select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 36px;
  }

  .product-search-container {
    min-width: 250px;
    position: relative;
    display: none;
  }

  .product-search-input {
    width: 100%;
    padding: 10px 14px 10px 36px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
  }

  .product-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    margin-top: 4px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: none;
  }

  .product-search-result {
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background-color 0.15s ease;
    border-bottom: 1px solid var(--light-background);
  }

  .product-search-result:hover {
    background-color: var(--light-background);
  }

  .product-search-result:last-child {
    border-bottom: none;
  }

  .product-result-image {
    width: 36px;
    height: 36px;
    object-fit: contain;
    border-radius: 4px;
    background-color: var(--light-background);
  }

  .product-result-info {
    flex: 1;
  }

  .product-result-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--text-color);
  }

  .product-result-details {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 1px;
  }

  .discount-input-group {
    display: flex;
    align-items: center;
    gap: 6px;
    background-color: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 6px 10px;
    width: 100px;
  }

  .discount-input {
    width: 50px;
    border: none;
    outline: none;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    text-align: center;
  }

  .discount-label {
    font-size: 13px;
    color: var(--text-secondary);
    min-width: 15px;
  }

  .discount-action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
  }

  .btn-apply-discount {
    background-color: var(--discount-apply-color);
    color: white;
  }

  .btn-apply-discount:hover:not(:disabled) {
    background-color: #43A047;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
  }
  
  /* Botón de reparación de descuentos */
  .btn-fix-discounts {
    background-color: var(--warning-color);
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    margin-bottom: 16px;
    border: none;
    box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
  }
  
  .btn-fix-discounts:hover {
    background-color: #f57c00;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 152, 0, 0.4);
  }

  /* Sección Mis Descuentos - COMPLETAMENTE NUEVA */
  .my-discounts-section {
    margin-top: 48px;
  }

  .section-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Usando el estilo de cambiar_precios.html para las categorías de descuentos */
  .discount-section {
    margin-bottom: 70px;
    border: 1px solid #eaeaea;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    background-color: #fafafa;
  }

  .discount-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
  }

  .discount-title {
    font-size: 22px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
  }

  .discount-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: #eeeeee;
    color: #505050;
    font-size: 13px;
    font-weight: 600;
  }

  .discount-value-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 6px;
    background-color: var(--discount-light);
    color: var(--discount-color);
    font-size: 14px;
    font-weight: 600;
  }

  /* Slider para items de descuento - MEJORADO */
  .discount-slider-container {
    position: relative;
    padding: 0 70px;
    margin: 0 -10px;
    overflow: hidden; /* Asegura que no haya desbordamiento */
  }

  .discount-slider {
    display: flex;
    gap: 20px; /* Aumentado de 16px a 20px */
    overflow-x: auto; /* Cambiado de hidden a auto para permitir scroll */
    scroll-behavior: smooth;
    padding: 8px 4px 16px 4px; /* Padding aumentado */
    margin-bottom: 8px;
    -webkit-overflow-scrolling: touch; /* Para scroll suave en iOS */
    scrollbar-width: thin; /* Para Firefox */
    scroll-snap-type: x mandatory; /* Para que los items queden alineados */
  }
  
  /* Ocultar scrollbar pero permitir scroll */
  .discount-slider::-webkit-scrollbar {
    height: 4px; /* Altura pequeña */
  }
  
  .discount-slider::-webkit-scrollbar-thumb {
    background: var(--accent-light);
    border-radius: 4px;
  }
  
  /* Hacer que las tarjetas se alineen al hacer scroll */
  .product-card, .category-card, .brand-card {
    scroll-snap-align: start;
  }

  /* Category y Brand Cards - Con círculo de color y mejor espaciado */
  .category-card, .brand-card {
    flex: 0 0 240px; /* Aumentado de 180px a 240px para más espacio */
    height: 120px; /* Aumentado de 100px a 120px para más espacio vertical */
    border-radius: 12px;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer; 
    text-decoration: none;
    position: relative; /* Para posicionar el círculo de color */
    margin: 0 8px; /* Añadir margen horizontal para evitar que se encimen */
  }

  .category-card:hover, .brand-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }
  
  /* Círculo de color para la categoría */
  .category-color-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-bottom: 12px;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .category-name, .brand-name {
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: var(--text-color);
  }

  .category-details, .brand-details {
    text-align: center;
    font-size: 13px;
    color: var(--text-secondary);
  }

  /* Product Cards - Igual que cambiar_precios.html */
  .product-card {
    flex: 0 0 220px;
    height: 360px;
    border-radius: 12px;
    overflow: hidden;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }

  .product-image-container {
    height: 140px;
    min-height: 140px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f8f8f8;
    padding: 5px;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .product-details {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .product-info-container {
    display: flex;
    flex-direction: column;
    height: 78px;
    margin-bottom: 10px;
    overflow: hidden;
    position: relative;
  }

  .product-name {
    font-size: 16px;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4;
    color: var(--text-color);
    height: 46px;
    margin-bottom: 0;
  }

  .product-brand {
    font-size: 13px;
    color: #606060;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }

  .product-price-container {
    height: 40px;
    margin-top: 10px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
  }

  .price-row {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .current-price {
    font-size: 18px;
    font-weight: 600;
    color: var(--discount-color);
  }

  .original-price {
    text-decoration: line-through;
    color: #666;
    font-size: 14px;
    margin-top: 2px;
  }

  .discount-label-small {
    background: #e74c3c;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin-left: 8px;
  }

  .remove-discount-btn {
    background-color: var(--discount-remove-color);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .remove-discount-btn:hover {
    background-color: #d32f2f;
  }

  /* Botones de navegación del slider - MEJORADOS */
  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 46px; /* Aumentado de 40px */
    height: 46px; /* Aumentado de 40px */
    border-radius: 50%;
    background-color: var(--accent);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(229, 46, 46, 0.4);
    z-index: 10;
    transition: all 0.2s ease;
  }

  .slider-arrow:hover {
    background-color: var(--accent-hover);
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 4px 12px rgba(229, 46, 46, 0.6);
  }

  .slider-arrow-left {
    left: 15px;
  }

  .slider-arrow-right {
    right: 15px;
  }

  .slider-arrow svg {
    width: 22px; /* Aumentado de 18px */
    height: 22px; /* Aumentado de 18px */
    fill: none;
    stroke: white;
    stroke-width: 2.5;
  }

  /* Modal de confirmación */
  .custom-confirm {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .custom-confirm-box {
    background: white;
    border-radius: 16px;
    padding: 28px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  }

  .custom-confirm-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .warning-icon {
    color: var(--warning-color);
    font-size: 24px;
  }

  .custom-confirm-message {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .custom-confirm-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .custom-confirm-button {
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.95rem;
  }

  .custom-confirm-cancel {
    background: var(--light-background);
    color: var(--text-color);
  }

  .custom-confirm-cancel:hover {
    background: #e0e0e0;
  }

  .custom-confirm-ok {
    background: var(--warning-color);
    color: white;
  }

  .custom-confirm-ok:hover {
    background: #f57c00;
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    max-width: 400px;
  }

  .toast {
    background-color: #333;
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    margin-top: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    opacity: 1;
    transition: all 0.3s ease;
  }

  .toast.success {
    background-color: #2ecc71;
  }

  .toast.error {
    background-color: #e74c3c;
  }

  .toast.warning {
    background-color: #f39c12;
  }

  /* Estado vacío */
  .empty-discounts {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-style: italic;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .descuentos-container {
      padding: 24px 16px;
    }
    
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .discount-controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .discount-target-selector,
    .specific-selector,
    .product-search-container {
      width: 100%;
    }
    
    .discount-slider {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 16px;
    }
    
    .product-card,
    .category-card,
    .brand-card {
      scroll-snap-align: start;
    }
    
    .discount-slider-container {
      padding: 0;
    }
    
    .slider-arrow {
      display: none;
    }
  }
</style>

<div class="descuentos-container">
  <!-- Encabezado -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Aplicar Descuentos</h1>
      <p class="page-description">Gestiona los descuentos de manera rápida y eficiente.</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>

  <!-- Panel de aplicar descuentos -->
  <div class="discount-panel">
    <h3 class="panel-title">
      <i class="fas fa-tags"></i>
      Aplicar descuento
    </h3>
    
    <div class="discount-controls">
      <div class="discount-target-selector">
        <select id="discountTarget">
          <option value="all">Aplicar a todos los productos</option>
          <option value="category">Aplicar por categoría</option>
          <option value="brand">Aplicar por marca</option>
          <option value="product">Aplicar a un producto</option>
        </select>
      </div>
      
      <div class="specific-selector" id="categorySelector">
        <select id="specificCategory">
          <option value="">Selecciona una categoría</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.nombre }}">{{ categoria.nombre|title }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="specific-selector" id="brandSelector">
        <select id="specificBrand">
          <option value="">Selecciona una marca</option>
          {% set brands = productos|map(attribute='marca')|unique|list %}
          {% for brand in brands %}
            {% if brand %}
              <option value="{{ brand }}">{{ brand }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <div class="product-search-container" id="productSearchContainer">
        <input type="text" class="product-search-input" id="productSearchInput" placeholder="Buscar por nombre, SKU o marca...">
        <div class="product-search-results" id="productSearchResults"></div>
        <input type="hidden" id="selectedProductId">
      </div>
      
      <div class="discount-input-group">
        <input type="number" class="discount-input" id="globalDiscountValue" value="10" min="1" max="100" required>
        <span class="discount-label">%</span>
      </div>
      
      <button class="discount-action-btn btn-apply-discount" id="applyGlobalDiscountBtn" onclick="applyGlobalDiscount()">
        <i class="fas fa-percent"></i>
        Aplicar
      </button>
    </div>
  </div>

  <!-- Sección Mis Descuentos -->
  <div class="my-discounts-section" id="myDiscountsSection" style="display: none;">
    <h2 class="section-title">
      <i class="fas fa-list"></i>
      Mis Descuentos
    </h2>

    <!-- Descuentos Globales -->
    <div class="discount-section" id="globalDiscounts" style="display: none;">
      <div class="discount-header">
        <div>
          <div class="discount-title">
            <i class="fas fa-globe"></i>
            Descuento Global
            <span class="discount-badge" id="globalDiscountCount">0</span>
            <span class="discount-value-badge" id="globalDiscountValue">-0%</span>
          </div>
        </div>
        <button class="remove-discount-btn" onclick="removeGlobalDiscount()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('global', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="discount-slider" id="slider-global">
          <!-- Productos se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('global', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Descuentos por Categoría -->
    <div class="discount-section" id="categoryDiscounts" style="display: none;">
      <div class="discount-header">
        <div>
          <div class="discount-title">
            <i class="fas fa-tag"></i>
            Por Categoría
            <span class="discount-badge" id="categoryDiscountCount">0</span>
          </div>
        </div>
        <button class="remove-discount-btn" onclick="removeAllCategoryDiscounts()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('category', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="discount-slider" id="slider-category">
          <!-- Categorías se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('category', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Descuentos por Marca -->
    <div class="discount-section" id="brandDiscounts" style="display: none;">
      <div class="discount-header">
        <div>
          <div class="discount-title">
            <i class="fas fa-trademark"></i>
            Por Marca
            <span class="discount-badge" id="brandDiscountCount">0</span>
          </div>
        </div>
        <button class="remove-discount-btn" onclick="removeAllBrandDiscounts()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('brand', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="discount-slider" id="slider-brand">
          <!-- Marcas se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('brand', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Descuentos por Producto -->
    <div class="discount-section" id="productDiscounts" style="display: none;">
      <div class="discount-header">
        <div>
          <div class="discount-title">
            <i class="fas fa-box"></i>
            Por Producto
            <span class="discount-badge" id="productDiscountCount">0</span>
          </div>
        </div>
        <button class="remove-discount-btn" onclick="removeAllProductDiscounts()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="discount-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('product', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="discount-slider" id="slider-product">
          <!-- Productos se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('product', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Notificaciones -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // Estado global para controlar descuentos
  let activeDiscounts = {
    global: false,
    categories: new Set(),
    products: new Set(),
    brands: new Set(),
    globalDetails: null,
    categoryDetails: {},
    brandDetails: {}
  };
  
  // Cache de datos
  let productosCache = null;
  
  // Inicialización
  document.addEventListener('DOMContentLoaded', function() {
    productosCache = {{ productos|tojson }};
    initializeDiscountPanel();
    
    // Reparar automáticamente los descuentos sin mostrar UI adicional
    fixDiscountsAutomatically().then(() => {
      // Después de reparar, actualizar la vista
      checkExistingDiscounts();
    });
    
    initializeProductSearch();
  });
  
  // Configurar panel de descuentos
  function initializeDiscountPanel() {
    const discountTarget = document.getElementById('discountTarget');
    const categorySelector = document.getElementById('categorySelector');
    const brandSelector = document.getElementById('brandSelector');
    const productSearchContainer = document.getElementById('productSearchContainer');
    const applyButton = document.getElementById('applyGlobalDiscountBtn');
    
    discountTarget.addEventListener('change', function() {
      // Ocultar todos primero
      categorySelector.style.display = 'none';
      brandSelector.style.display = 'none';
      productSearchContainer.style.display = 'none';
      
      // Mostrar el selector correspondiente
      switch(this.value) {
        case 'category':
          categorySelector.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-tag"></i> Aplicar';
          break;
        case 'brand':
          brandSelector.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-trademark"></i> Aplicar';
          break;
        case 'product':
          productSearchContainer.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-box"></i> Aplicar';
          break;
        default:
          applyButton.innerHTML = '<i class="fas fa-percent"></i> Aplicar';
          break;
      }
    });
    
    // Validación de input
    const discountInput = document.getElementById('globalDiscountValue');
    discountInput.addEventListener('input', function() {
      if (this.value > 100) this.value = 100;
      if (this.value < 1) this.value = 1;
    });
  }
  
  // Inicializar búsqueda de productos
  function initializeProductSearch() {
    const searchInput = document.getElementById('productSearchInput');
    const resultsContainer = document.getElementById('productSearchResults');
    
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      const results = searchProducts(query);
      displaySearchResults(results);
    });
    
    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
        resultsContainer.style.display = 'none';
      }
    });
  }
  
  // Buscar productos en cache
  function searchProducts(query) {
    return productosCache.filter(product => {
      const searchableText = (
        (product.nombre || '') + ' ' +
        (product.marca || '') + ' ' +
        (product.codigo_barras_externo || '')
      ).toLowerCase();
      
      return searchableText.includes(query.toLowerCase());
    }).slice(0, 10);
  }
  
  // Mostrar resultados de búsqueda
  function displaySearchResults(results) {
    const resultsContainer = document.getElementById('productSearchResults');
    
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="empty-discounts">No se encontraron productos</div>';
      resultsContainer.style.display = 'block';
      return;
    }
    
    const html = results.map(product => `
      <div class="product-search-result" onclick="selectProduct(${product.id}, '${product.nombre.replace(/'/g, '\\\'')}')"
           data-has-discount="${product.tiene_descuento || false}"
           data-product-id="${product.id}">
        <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
             alt="${product.nombre}" 
             class="product-result-image">
        <div class="product-result-info">
          <div class="product-result-name">${product.nombre}
            ${(product.tiene_descuento) ? ' <span style="color: var(--discount-color); font-size: 0.8rem;">(-' + Math.round(product.valor_descuento) + '%)</span>' : ''}
          </div>
          <div class="product-result-details">${product.marca || 'Sin marca'} • SKU: ${product.codigo_barras_externo || 'N/A'}</div>
        </div>
      </div>
    `).join('');
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
  }
  
  // Seleccionar producto de búsqueda
  function selectProduct(productId, productName) {
    const searchInput = document.getElementById('productSearchInput');
    const resultsContainer = document.getElementById('productSearchResults');
    const selectedProductId = document.getElementById('selectedProductId');
    
    searchInput.value = productName;
    selectedProductId.value = productId;
    resultsContainer.style.display = 'none';
    
    // Almacenar información del producto seleccionado
    searchInput.dataset.selectedId = productId;
  }
  
  // ========== FUNCIÓN PARA ARREGLAR DESCUENTOS AUTOMÁTICAMENTE ==========
  function fixDiscountsAutomatically() {
    return new Promise((resolve) => {
      // Corregir productos con descuentos directamente
      const productsWithInvalidDiscounts = productosCache.filter(p => 
        p.tiene_descuento && (!p.origen_descuento || !p.tipo_descuento)
      );
      
      // Si no hay productos que reparar, terminamos inmediatamente
      if (productsWithInvalidDiscounts.length === 0) {
        resolve();
        return;
      }

      // Llamar a la API para corregir descuentos
      fetch('/api/fix-existing-discounts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.count > 0) {
          console.log(`Reparados automáticamente ${data.count} productos con descuentos`);
          
          // Actualizar la cache local para los productos reparados
          productsWithInvalidDiscounts.forEach(p => {
            p.origen_descuento = p.origen_descuento || 'individual';
            
            // Si es un descuento de categoría pero falta grupo_id
            if (p.origen_descuento === 'categoria' && !p.descuento_grupo_id) {
              p.descuento_grupo_id = p.categoria;
            }
            
            // Si es un descuento de marca pero falta grupo_id
            if (p.origen_descuento === 'marca' && !p.descuento_grupo_id) {
              p.descuento_grupo_id = p.marca;
            }
            
            p.tipo_descuento = p.tipo_descuento || 'percentage';
          });
        }
        resolve();
      })
      .catch(error => {
        console.error('Error al reparar descuentos automáticamente:', error);
        // Continuamos aunque haya error
        resolve();
      });
    });
  }
  
  // ========== FUNCIÓN PRINCIPAL MEJORADA PARA USAR LA NUEVA API ==========
  function checkExistingDiscounts() {
    // Consultar la API para obtener información sobre descuentos activos
    fetch('/api/get_active_discounts')
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          console.error('Error al obtener descuentos activos:', data.message);
          return;
        }
        
        // Actualizar el estado global con los datos de la API
        const discounts = data.active_discounts;
        
        // Limpiar el estado actual
        activeDiscounts.categories.clear();
        activeDiscounts.products.clear();
        activeDiscounts.brands.clear();
        activeDiscounts.categoryDetails = {};
        activeDiscounts.brandDetails = {};
        
        // Configurar estado global con datos de la API
        activeDiscounts.global = discounts.global;
        
        // Obtener productos con descuento global, individual, por categoría y por marca
        const globalProducts = productosCache.filter(p => 
          p.tiene_descuento && p.origen_descuento === 'global'
        );
        
        if (globalProducts.length > 0) {
          activeDiscounts.globalDetails = globalProducts;
        }
        
        // Añadir categorías con descuento
        discounts.categorias.forEach(category => {
          activeDiscounts.categories.add(category);
          activeDiscounts.categoryDetails[category] = productosCache.filter(p => 
            p.tiene_descuento && 
            p.origen_descuento === 'categoria' && 
            p.descuento_grupo_id === category
          );
        });
        
        // Añadir marcas con descuento
        discounts.marcas.forEach(brand => {
          activeDiscounts.brands.add(brand);
          activeDiscounts.brandDetails[brand] = productosCache.filter(p => 
            p.tiene_descuento && 
            p.origen_descuento === 'marca' && 
            p.descuento_grupo_id === brand
          );
        });
        
        // Añadir productos individuales
        productosCache.forEach(product => {
          if (product.tiene_descuento && product.origen_descuento === 'individual') {
            activeDiscounts.products.add(product.id);
          }
        });
        
        // Actualizar UI inmediatamente
        updateMyDiscountsSection();
        updateUIState();
      })
      .catch(error => {
        console.error('Error al obtener estado de descuentos:', error);
        
        // Intentar fallback al método antiguo si falla la llamada API
        fetchGlobalDiscountStatus();
      });
  }

  // ========== FUNCIÓN DE FALLBACK PARA VERIFICAR DESCUENTO GLOBAL ==========
  function fetchGlobalDiscountStatus() {
    fetch('/api/get_global_discount_status')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar estado global
          activeDiscounts.global = data.is_global_active;
          
          if (data.is_global_active) {
            // Obtener productos con origen global
            const globalProducts = productosCache.filter(p => 
              p.tiene_descuento && p.origen_descuento === 'global'
            );
            
            if (globalProducts.length > 0) {
              activeDiscounts.globalDetails = globalProducts;
            }
          }
          
          // Continuar con la detección de otros tipos de descuentos
          detectOtherDiscounts();
        } else {
          console.error('Error al verificar estado de descuento global:', data.message);
          detectOtherDiscounts();
        }
      })
      .catch(error => {
        console.error('Error al verificar estado de descuento global:', error);
        detectOtherDiscounts();
      });
  }
  
  // ========== FUNCIÓN DE FALLBACK PARA OTROS TIPOS DE DESCUENTOS ==========
  function detectOtherDiscounts() {
    // Agrupar productos por origen del descuento
    productosCache.forEach(product => {
      if (product.tiene_descuento) {
        const origin = product.origen_descuento || 'individual';
        
        switch(origin) {
          case 'categoria':
            const category = product.descuento_grupo_id || product.categoria;
            if (category) {
              activeDiscounts.categories.add(category);
              if (!activeDiscounts.categoryDetails[category]) {
                activeDiscounts.categoryDetails[category] = [];
              }
              activeDiscounts.categoryDetails[category].push(product);
            }
            break;
          case 'marca':
            const brand = product.descuento_grupo_id || product.marca;
            if (brand) {
              activeDiscounts.brands.add(brand);
              if (!activeDiscounts.brandDetails[brand]) {
                activeDiscounts.brandDetails[brand] = [];
              }
              activeDiscounts.brandDetails[brand].push(product);
            }
            break;
          case 'individual':
            activeDiscounts.products.add(product.id);
            break;
        }
      }
    });
    
    // Actualizar UI
    updateMyDiscountsSection();
    updateUIState();
  }
  
  function updateProductDiscountsList() {
    const container = document.getElementById('slider-product');
    const countElement = document.getElementById('productDiscountCount');
    
    // Filtrar solo productos con descuento individual
    const individualProducts = productosCache.filter(product => {
      if (!product.tiene_descuento) return false;
      
      // Incluir productos con origen individual o sin origen
      return product.origen_descuento === 'individual' || !product.origen_descuento;
    });
    
    countElement.textContent = individualProducts.length;
    
    if (individualProducts.length === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuentos individuales</div>';
      document.getElementById('productDiscounts').style.display = 'none';
      return;
    }
    
    document.getElementById('productDiscounts').style.display = 'block';
    const items = individualProducts.map(product => createProductCard(product, true)).join('');
    container.innerHTML = items;
    
    // Añadir enlace "Ver todos" si hay muchos productos
    if (individualProducts.length > 10) {
      // Añadir enlace flotante para ver todos
      const viewAllLink = document.createElement('a');
      viewAllLink.href = '/descuentos/detalle/individual/all';
      viewAllLink.className = 'view-all-link';
      viewAllLink.innerHTML = `Ver todos (${individualProducts.length})`;
      viewAllLink.style.position = 'absolute';
      viewAllLink.style.right = '78px';
      viewAllLink.style.top = '10px';
      viewAllLink.style.backgroundColor = '#e52e2e';
      viewAllLink.style.color = 'white';
      viewAllLink.style.padding = '5px 10px';
      viewAllLink.style.borderRadius = '4px';
      viewAllLink.style.textDecoration = 'none';
      viewAllLink.style.fontSize = '14px';
      viewAllLink.style.fontWeight = '500';
      
      // Agregar al contenedor
      container.parentElement.appendChild(viewAllLink);
    }
  }
  
  // Actualizar sección "Mis Descuentos"
  function updateMyDiscountsSection() {
    const section = document.getElementById('myDiscountsSection');
    const globalContainer = document.getElementById('globalDiscounts');
    const categoryContainer = document.getElementById('categoryDiscounts');
    const productContainer = document.getElementById('productDiscounts');
    const brandContainer = document.getElementById('brandDiscounts');
    
    // Verificar si hay cualquier tipo de descuento activo
    const hasDiscounts = activeDiscounts.global || 
                         activeDiscounts.categories.size > 0 || 
                         activeDiscounts.products.size > 0 || 
                         activeDiscounts.brands.size > 0;
    
    // También contar productos con descuento pero sin origen asignado
    const productsWithDiscountNoOrigin = productosCache.filter(p => 
      p.tiene_descuento && !p.origen_descuento
    ).length;
    
    section.style.display = (hasDiscounts || productsWithDiscountNoOrigin > 0) ? 'block' : 'none';
    
    // Actualizar listas
    updateGlobalDiscountsList();
    updateCategoryDiscountsList();
    updateProductDiscountsList();
    updateBrandDiscountsList();
    
    // Mostrar/ocultar contenedores según haya descuento
    globalContainer.style.display = activeDiscounts.global ? 'block' : 'none';
    categoryContainer.style.display = activeDiscounts.categories.size > 0 ? 'block' : 'none';
    brandContainer.style.display = activeDiscounts.brands.size > 0 ? 'block' : 'none';
    
    // Mostrar la sección de productos individuales si hay productos con origen 'individual' o sin origen
    const individualProducts = productosCache.filter(p => 
      p.tiene_descuento && (p.origen_descuento === 'individual' || !p.origen_descuento)
    );
    productContainer.style.display = individualProducts.length > 0 ? 'block' : 'none';
    
    // Inicializar el estado de las flechas de navegación
    setTimeout(() => {
      initSliderArrows();
    }, 500);
  }
  
  function updateGlobalDiscountsList() {
    const container = document.getElementById('slider-global');
    const countElement = document.getElementById('globalDiscountCount');
    const valueElement = document.getElementById('globalDiscountValue');
    
    if (!activeDiscounts.global || !activeDiscounts.globalDetails || activeDiscounts.globalDetails.length === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuento global</div>';
      countElement.textContent = '0';
      valueElement.textContent = '-0%';
      return;
    }
    
    // Cuenta productos con descuento global
    const productsWithGlobalDiscount = productosCache.filter(p => 
      p.tiene_descuento && p.origen_descuento === 'global'
    );
    
    countElement.textContent = productsWithGlobalDiscount.length;
    const averageDiscount = Math.round(
      productsWithGlobalDiscount.reduce((sum, p) => sum + p.valor_descuento, 0) / 
      productsWithGlobalDiscount.length
    );
    valueElement.textContent = `-${averageDiscount}%`;
    
    // Permitir ver todos los productos, no solo los primeros 10
    const items = productsWithGlobalDiscount.map(product => createProductCard(product)).join('');
    container.innerHTML = items || '<div class="empty-discounts">No hay productos con descuento global</div>';
    
    // Añadir enlace "Ver todos" si hay muchos productos
    if (productsWithGlobalDiscount.length > 10) {
      // Añadir enlace flotante para ver todos
      const viewAllLink = document.createElement('a');
      viewAllLink.href = '/descuentos/detalle/global/all';
      viewAllLink.className = 'view-all-link';
      viewAllLink.innerHTML = `Ver todos (${productsWithGlobalDiscount.length})`;
      viewAllLink.style.position = 'absolute';
      viewAllLink.style.right = '78px';
      viewAllLink.style.top = '10px';
      viewAllLink.style.backgroundColor = '#e52e2e';
      viewAllLink.style.color = 'white';
      viewAllLink.style.padding = '5px 10px';
      viewAllLink.style.borderRadius = '4px';
      viewAllLink.style.textDecoration = 'none';
      viewAllLink.style.fontSize = '14px';
      viewAllLink.style.fontWeight = '500';
      
      // Agregar al contenedor
      container.parentElement.appendChild(viewAllLink);
    }
  }
  
  function updateBrandDiscountsList() {
    const container = document.getElementById('slider-brand');
    const countElement = document.getElementById('brandDiscountCount');
    
    countElement.textContent = activeDiscounts.brands.size;
    
    if (activeDiscounts.brands.size === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuentos por marca</div>';
      return;
    }
    
    const items = Array.from(activeDiscounts.brands).map(brand => {
      // Buscar productos por marca y origen
      const brandProducts = productosCache.filter(p => 
        p.tiene_descuento &&
        p.origen_descuento === 'marca' &&
        (p.descuento_grupo_id === brand || (!p.descuento_grupo_id && p.marca === brand))
      );
      
      const averageDiscount = brandProducts.length > 0 ? 
        Math.round(brandProducts.reduce((sum, p) => sum + p.valor_descuento, 0) / brandProducts.length) : 0;
      
      const encodedBrand = encodeURIComponent(brand);
      
      // Generar un color para la marca basado en el nombre para tener consistencia
      const brandColor = getHashColor(brand);
      
      return `
        <a href="/descuentos/detalle/marca/${encodedBrand}" class="brand-card">
          <div class="category-color-circle" style="background-color: ${brandColor};"></div>
          <div class="brand-name">${brand}</div>
          <div class="brand-details">
            ${brandProducts.length} productos<br>
            <span class="discount-value-badge">-${averageDiscount}%</span>
          </div>
          <button class="remove-discount-btn" onclick="event.preventDefault(); event.stopPropagation(); removeBrandDiscount('${brand.replace(/'/g, '\\\'')}')" style="margin-top: 10px;">
            <i class="fas fa-times"></i>
            Quitar
          </button>
        </a>
      `;
    }).join('');
    
    container.innerHTML = items;
  }
  
  // Función para generar un color basado en un texto (para marcas)
  function getHashColor(text) {
    if (!text) return "#A9A9A9";
    
    // Generar un hash simple basado en el texto
    let hash = 0;
    for (let i = 0; i < text.length; i++) {
      hash = text.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    // Convertir a color hexadecimal
    let color = '#';
    for (let i = 0; i < 3; i++) {
      // Usar un rango de colores más agradable (evitar colores muy claros o muy oscuros)
      const value = ((hash >> (i * 8)) & 0xFF);
      const adjustedValue = Math.max(Math.min(value, 220), 50); // Entre 50 y 220
      color += ('00' + adjustedValue.toString(16)).substr(-2);
    }
    
    return color;
  }
  
  function updateCategoryDiscountsList() {
    const container = document.getElementById('slider-category');
    const countElement = document.getElementById('categoryDiscountCount');
    
    countElement.textContent = activeDiscounts.categories.size;
    
    if (activeDiscounts.categories.size === 0) {
      container.innerHTML = '<div class="empty-discounts">No hay descuentos por categoría</div>';
      return;
    }
    
    const items = Array.from(activeDiscounts.categories).map(category => {
      // Buscar productos por categoría y origen
      const categoryProducts = productosCache.filter(p => 
        p.tiene_descuento &&
        p.origen_descuento === 'categoria' &&
        (p.descuento_grupo_id === category || (!p.descuento_grupo_id && p.categoria === category))
      );
      
      const averageDiscount = categoryProducts.length > 0 ? 
        Math.round(categoryProducts.reduce((sum, p) => sum + p.valor_descuento, 0) / categoryProducts.length) : 0;
      
      const encodedCategory = encodeURIComponent(category);
      
      // Obtener color de categoría desde CATEGORY_COLORS
      const categoryColor = getCategoryColor(category);
      
      return `
        <a href="/descuentos/detalle/categoria/${encodedCategory}" class="category-card">
          <div class="category-color-circle" style="background-color: ${categoryColor};"></div>
          <div class="category-name">${category}</div>
          <div class="category-details">
            ${categoryProducts.length} productos<br>
            <span class="discount-value-badge">-${averageDiscount}%</span>
          </div>
          <button class="remove-discount-btn" onclick="event.preventDefault(); event.stopPropagation(); removeCategoryDiscount('${category.replace(/'/g, '\\\'')}')" style="margin-top: 10px;">
            <i class="fas fa-times"></i>
            Quitar
          </button>
        </a>
      `;
    }).join('');
    
    container.innerHTML = items;
  }
  
  // Función para obtener el color de categoría
  function getCategoryColor(category) {
    // Colores predefinidos para categorías (misma lógica que en category_colors.py)
    const CATEGORY_COLORS = {
      "abarrotes secos": "#FFA500",
      "enlatados y conservas": "#DAA520",
      "botanas, dulces y snacks": "#FF69B4",
      "bebidas no alcohólicas": "#1E90FF",
      "bebidas alcohólicas": "#800080",
      "panadería y repostería": "#D2B48C",
      "lácteos y huevos": "#F5DEB3",
      "carnes frías y embutidos": "#B22222",
      "congelados y refrigerados": "#00CED1",
      "frutas y verduras frescas": "#32CD32",
      "productos de limpieza y hogar": "#87CEFA",
      "cuidado personal e higiene": "#FFC0CB",
      "medicamentos de mostrador (otc)": "#FF6347",
      "productos para bebés": "#FFB6C1",
      "productos para mascotas": "#8FBC8F",
      "artículos de papelería": "#9370DB",
      "ferretería básica": "#708090",
      "artesanías y manualidades": "#DDA0DD",
      "productos a granel": "#BDB76B",
      "productos orgánicos": "#6B8E23",
      "productos gourmet": "#CD853F",
      "suplementos alimenticios": "#DA70D6",
      "otros (miscelánea)": "#A9A9A9"
    };
    
    if (!category) {
      return "#A9A9A9";  // Color gris predeterminado para categorías vacías
    }
    
    const normalizedCategory = category.toLowerCase().trim();
    return CATEGORY_COLORS[normalizedCategory] || "#A9A9A9";  // Gris por defecto si no se encuentra
  }
  
  // Crear tarjeta de producto
  function createProductCard(product, withRemoveButton = false) {
    const precioOriginal = product.precio_venta || 0;
    const valorDescuento = product.valor_descuento || 0;
    const precioFinal = precioOriginal * (1 - valorDescuento / 100);
    
    const removeButton = withRemoveButton ? `
      <button class="remove-discount-btn" onclick="removeProductDiscount(${product.id})" style="width: 100%; margin-top: auto;">
        <i class="fas fa-times"></i>
        Quitar descuento
      </button>
    ` : '';
    
    return `
      <div class="product-card">
        <div class="product-image-container">
          <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
               alt="${product.nombre}" 
               class="product-image">
        </div>
        <div class="product-details">
          <div class="product-info-container">
            <div class="product-name">${product.nombre}</div>
            <div class="product-brand">${product.marca || 'Sin marca'}</div>
          </div>
          <div class="product-price-container">
            <div class="price-row">
              <div class="current-price">
                $${precioFinal.toFixed(2)}
              </div>
              <div class="discount-label-small">
                -${Math.round(valorDescuento)}%
              </div>
            </div>
            <div class="original-price">
              $${precioOriginal.toFixed(2)}
            </div>
          </div>
          ${removeButton}
        </div>
      </div>
    `;
  }
  
  // Aplicar descuento global
  function applyGlobalDiscount() {
    const target = document.getElementById('discountTarget').value;
    const discountValue = parseFloat(document.getElementById('globalDiscountValue').value);
    
    if (!discountValue || discountValue < 1 || discountValue > 100) {
      showToast('Por favor ingresa un descuento válido (1-100%)', 'error');
      return;
    }
    
    // Verificar conflictos
    checkForConflicts(target, discountValue);
  }
  
  // Verificar conflictos antes de aplicar descuento
  function checkForConflicts(target, discountValue) {
    const category = document.getElementById('specificCategory').value;
    const brand = document.getElementById('specificBrand').value;
    const productId = document.getElementById('selectedProductId').value;
    
    let conflictingProducts = [];
    let conflictMessage = '';
    
    switch(target) {
      case 'all':
        if (activeDiscounts.global) {
          conflictMessage = 'Todos los productos ya tienen un descuento global aplicado. ¿Deseas reemplazarlo?';
          conflictingProducts = productosCache.filter(p => p.tiene_descuento);
        } else if (activeDiscounts.categories.size > 0 || activeDiscounts.brands.size > 0 || activeDiscounts.products.size > 0) {
          conflictMessage = 'Algunos productos ya tienen descuentos aplicados. ¿Deseas sobreescribirlos con el descuento global?';
          conflictingProducts = productosCache.filter(p => p.tiene_descuento);
        }
        break;
        
      case 'category':
        if (!category) {
          showToast('Por favor selecciona una categoría', 'error');
          return;
        }
        
        const categoryProducts = productosCache.filter(p => p.categoria === category);
        conflictingProducts = categoryProducts.filter(p => p.tiene_descuento);
        
        if (conflictingProducts.length > 0) {
          if (activeDiscounts.global) {
            conflictMessage = `Esta categoría forma parte del descuento global. ¿Deseas aplicar el nuevo descuento a estos ${conflictingProducts.length} productos?`;
          } else if (activeDiscounts.categories.has(category)) {
            conflictMessage = `Esta categoría ya tiene un descuento aplicado. ¿Deseas reemplazarlo?`;
          } else {
            conflictMessage = `Algunos productos de esta categoría ya tienen descuentos aplicados. ¿Deseas sobreescribirlos?`;
          }
        }
        break;
        
      case 'brand':
        if (!brand) {
          showToast('Por favor selecciona una marca', 'error');
          return;
        }
        
        const brandProducts = productosCache.filter(p => p.marca === brand);
        conflictingProducts = brandProducts.filter(p => p.tiene_descuento);
        
        if (conflictingProducts.length > 0) {
          if (activeDiscounts.global) {
            conflictMessage = `Esta marca forma parte del descuento global. ¿Deseas aplicar el nuevo descuento a estos ${conflictingProducts.length} productos?`;
          } else if (activeDiscounts.brands.has(brand)) {
            conflictMessage = `Esta marca ya tiene un descuento aplicado. ¿Deseas reemplazarlo?`;
          } else {
            conflictMessage = `Algunos productos de esta marca ya tienen descuentos aplicados. ¿Deseas sobreescribirlos?`;
          }
        }
        break;
        
      case 'product':
        if (!productId) {
          showToast('Por favor selecciona un producto', 'error');
          return;
        }
        
        const product = productosCache.find(p => p.id == productId);
        if (product && product.tiene_descuento) {
          conflictingProducts = [product];
          conflictMessage = `Este producto ya tiene un descuento aplicado. ¿Deseas reemplazarlo?`;
        }
        break;
    }
    
    // Si hay conflictos, mostrar confirmación
    if (conflictingProducts.length > 0) {
      showConfirmDialog(
        'Conflicto de descuentos',
        conflictMessage,
        function() {
          // Proceder con la aplicación del descuento
          proceedWithDiscount(target, discountValue);
        }
      );
    } else {
      // No hay conflictos, aplicar directamente
      proceedWithDiscount(target, discountValue);
    }
  }
  
  // Mostrar diálogo de confirmación
  function showConfirmDialog(title, message, onConfirm) {
    const modal = document.createElement('div');
    modal.className = 'custom-confirm';
    modal.innerHTML = `
      <div class="custom-confirm-box">
        <div class="custom-confirm-title">
          <i class="fas fa-exclamation-triangle warning-icon"></i>
          ${title}
        </div>
        <div class="custom-confirm-message">${message}</div>
        <div class="custom-confirm-buttons">
          <button class="custom-confirm-button custom-confirm-cancel">Cancelar</button>
          <button class="custom-confirm-button custom-confirm-ok">Sobreescribir</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.querySelector('.custom-confirm-cancel').addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    modal.querySelector('.custom-confirm-ok').addEventListener('click', function() {
      document.body.removeChild(modal);
      onConfirm();
    });
  }
  
  // Proceder con la aplicación del descuento
  function proceedWithDiscount(target, discountValue) {
    switch(target) {
      case 'all':
        applyDiscountToAll(discountValue);
        break;
      case 'category':
        const category = document.getElementById('specificCategory').value;
        applyDiscountToCategory(category, discountValue);
        break;
      case 'brand':
        const brand = document.getElementById('specificBrand').value;
        applyDiscountToBrand(brand, discountValue);
        break;
      case 'product':
        const productId = document.getElementById('selectedProductId').value;
        applyDiscountToSingleProduct(productId, discountValue);
        break;
    }
  }
  
  // Aplicar descuento a todos los productos - ACTUALIZADO
  function applyDiscountToAll(discountValue) {
    // Verificar si hay al menos un producto para aplicar descuento global
    if (productosCache.length === 0) {
      showToast('No hay productos para aplicar descuento global', 'error');
      return;
    }
    
    // Para descuento global, solo necesitamos aplicarlo a un producto
    // El backend se encargará de propagarlo a todos los demás
    const primerProducto = productosCache[0];
    
    applyDiscountToProduct(primerProducto.id, discountValue, 'global', null)
      .then(success => {
        if (success) {
          showToast(`Descuento global del ${discountValue}% aplicado a todos los productos`, 'success');
          
          // Actualizar los datos locales para reflejar inmediatamente el cambio
          productosCache.forEach(p => {
            p.tiene_descuento = true;
            p.tipo_descuento = 'percentage';
            p.valor_descuento = discountValue;
            p.origen_descuento = 'global';
            p.fecha_aplicacion_descuento = new Date().toISOString();
          });
          
          activeDiscounts.global = true;
          activeDiscounts.globalDetails = [...productosCache];
          
          // Actualizar UI
          updateMyDiscountsSection();
        } else {
          showToast('Error al aplicar descuento global', 'error');
        }
      });
  }
  
  // Aplicar descuento a categoría - ACTUALIZADO
  function applyDiscountToCategory(category, discountValue) {
    const categoryProducts = productosCache.filter(p => p.categoria === category);
    
    if (categoryProducts.length === 0) {
      showToast(`No hay productos en la categoría "${category}"`, 'error');
      return;
    }
    
    const promises = categoryProducts.map(product => 
      applyDiscountToProduct(product.id, discountValue, 'categoria', category)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      if (successCount === categoryProducts.length) {
        showToast(`Descuento del ${discountValue}% aplicado a la categoría "${category}"`, 'success');
        
        // Actualizar datos locales
        categoryProducts.forEach(p => {
          p.tiene_descuento = true;
          p.tipo_descuento = 'percentage';
          p.valor_descuento = discountValue;
          p.origen_descuento = 'categoria';
          p.descuento_grupo_id = category;
          p.fecha_aplicacion_descuento = new Date().toISOString();
        });
        
        activeDiscounts.categories.add(category);
        activeDiscounts.categoryDetails[category] = [...categoryProducts];
        
        // Actualizar UI
        updateMyDiscountsSection();
      } else {
        showToast(`Aplicado a ${successCount} de ${categoryProducts.length} productos`, 'warning');
      }
    });
  }
  
  // Aplicar descuento a marca - ACTUALIZADO
  function applyDiscountToBrand(brand, discountValue) {
    const brandProducts = productosCache.filter(p => p.marca === brand);
    
    if (brandProducts.length === 0) {
      showToast(`No hay productos de la marca "${brand}"`, 'error');
      return;
    }
    
    const promises = brandProducts.map(product => 
      applyDiscountToProduct(product.id, discountValue, 'marca', brand)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      if (successCount === brandProducts.length) {
        showToast(`Descuento del ${discountValue}% aplicado a la marca "${brand}"`, 'success');
        
        // Actualizar datos locales
        brandProducts.forEach(p => {
          p.tiene_descuento = true;
          p.tipo_descuento = 'percentage';
          p.valor_descuento = discountValue;
          p.origen_descuento = 'marca';
          p.descuento_grupo_id = brand;
          p.fecha_aplicacion_descuento = new Date().toISOString();
        });
        
        activeDiscounts.brands.add(brand);
        activeDiscounts.brandDetails[brand] = [...brandProducts];
        
        // Actualizar UI
        updateMyDiscountsSection();
      } else {
        showToast(`Aplicado a ${successCount} de ${brandProducts.length} productos`, 'warning');
      }
    });
  }
  
  // Aplicar descuento a producto individual
  function applyDiscountToSingleProduct(productId, discountValue) {
    applyDiscountToProduct(productId, discountValue, 'individual', null).then(success => {
      if (success) {
        const product = productosCache.find(p => p.id == productId);
        
        // Actualizar datos locales
        if (product) {
          product.tiene_descuento = true;
          product.tipo_descuento = 'percentage';
          product.valor_descuento = discountValue;
          product.origen_descuento = 'individual';
          product.descuento_grupo_id = null;
          product.fecha_aplicacion_descuento = new Date().toISOString();
        
          activeDiscounts.products.add(product.id);
        }
        
        showToast(`Descuento del ${discountValue}% aplicado a "${product.nombre}"`, 'success');
        
        // Actualizar UI
        updateMyDiscountsSection();
      }
    });
  }
  
  // Aplicar descuento a producto (API call) - ACTUALIZADO
  function applyDiscountToProduct(productId, discountValue, discountSource = 'individual', groupId = null) {
    return fetch(`/api/apply_discount/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: 'percentage',
        value: discountValue,
        origin: discountSource,
        group_id: groupId,
        applied_at: new Date().toISOString()
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Actualizar cache inmediatamente con información completa
        const cachedProduct = productosCache.find(p => p.id == productId);
        if (cachedProduct) {
          cachedProduct.tiene_descuento = true;
          cachedProduct.valor_descuento = discountValue;
          cachedProduct.tipo_descuento = 'percentage';
          cachedProduct.origen_descuento = discountSource;
          cachedProduct.descuento_grupo_id = groupId;
          cachedProduct.fecha_aplicacion_descuento = new Date().toISOString();
        }
        return true;
      } else {
        return false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      return false;
    });
  }
  
  // ========== FUNCIONES PARA REMOVER DESCUENTOS MEJORADAS ==========
  
  function removeGlobalDiscount() {
    // Verificar primero si hay descuento global activo usando la API
    fetch('/api/get_global_discount_status')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.is_global_active) {
          // Obtener productos con origen global
          const globalProducts = productosCache.filter(p => 
            p.tiene_descuento && p.origen_descuento === 'global'
          );
          
          if (globalProducts.length === 0) {
            showToast('No se encontraron productos con descuento global', 'warning');
            return;
          }
          
          const promises = globalProducts.map(product => 
            removeDiscountFromProduct(product.id)
          );
          
          Promise.all(promises).then(results => {
            const successCount = results.filter(r => r).length;
            showToast(`Descuento global removido de ${successCount} productos`, 'success');
            
            // Actualizar datos locales
            globalProducts.forEach(p => {
              p.tiene_descuento = false;
              p.tipo_descuento = null;
              p.valor_descuento = 0;
              p.origen_descuento = null;
              p.descuento_grupo_id = null;
              p.fecha_aplicacion_descuento = null;
            });
            
            activeDiscounts.global = false;
            activeDiscounts.globalDetails = null;
            
            // Actualizar UI
            updateMyDiscountsSection();
          });
        } else {
          showToast('No hay descuento global activo para remover', 'warning');
        }
      })
      .catch(error => {
        console.error('Error al verificar descuento global:', error);
        showToast('Error al verificar estado del descuento global', 'error');
      });
  }
  
  function removeCategoryDiscount(category) {
    // Filtrar por origen_descuento y descuento_grupo_id correctamente
    const categoryProducts = productosCache.filter(p => 
      p.tiene_descuento &&
      p.origen_descuento === 'categoria' &&
      (p.descuento_grupo_id === category || (!p.descuento_grupo_id && p.categoria === category))
    );
    
    if (categoryProducts.length === 0) {
      showToast(`No se encontraron productos con descuento en la categoría "${category}"`, 'warning');
      return;
    }
    
    const promises = categoryProducts.map(product => 
      removeDiscountFromProduct(product.id)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuentos removidos de ${successCount} productos en "${category}"`, 'success');
      
      // Actualizar datos locales
      categoryProducts.forEach(p => {
        p.tiene_descuento = false;
        p.tipo_descuento = null;
        p.valor_descuento = 0;
        p.origen_descuento = null;
        p.descuento_grupo_id = null;
        p.fecha_aplicacion_descuento = null;
      });
      
      activeDiscounts.categories.delete(category);
      delete activeDiscounts.categoryDetails[category];
      
      // Actualizar UI
      updateMyDiscountsSection();
    });
  }
  
  function removeBrandDiscount(brand) {
    // Filtrar por origen_descuento y descuento_grupo_id correctamente
    const brandProducts = productosCache.filter(p => 
      p.tiene_descuento &&
      p.origen_descuento === 'marca' &&
      (p.descuento_grupo_id === brand || (!p.descuento_grupo_id && p.marca === brand))
    );
    
    if (brandProducts.length === 0) {
      showToast(`No se encontraron productos con descuento en la marca "${brand}"`, 'warning');
      return;
    }
    
    const promises = brandProducts.map(product => 
      removeDiscountFromProduct(product.id)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuentos removidos de ${successCount} productos de "${brand}"`, 'success');
      
      // Actualizar datos locales
      brandProducts.forEach(p => {
        p.tiene_descuento = false;
        p.tipo_descuento = null;
        p.valor_descuento = 0;
        p.origen_descuento = null;
        p.descuento_grupo_id = null;
        p.fecha_aplicacion_descuento = null;
      });
      
      activeDiscounts.brands.delete(brand);
      delete activeDiscounts.brandDetails[brand];
      
      // Actualizar UI
      updateMyDiscountsSection();
    });
  }
  
  function removeProductDiscount(productId) {
    const product = productosCache.find(p => p.id == productId);
    
    if (!product || !product.tiene_descuento) {
      showToast('El producto no tiene descuento para remover', 'warning');
      return;
    }
    
    removeDiscountFromProduct(productId).then(success => {
      if (success) {
        showToast('Descuento removido', 'success');
        
        // Actualizar datos locales
        product.tiene_descuento = false;
        product.tipo_descuento = null;
        product.valor_descuento = 0;
        product.origen_descuento = null;
        product.descuento_grupo_id = null;
        product.fecha_aplicacion_descuento = null;
        
        activeDiscounts.products.delete(productId);
        
        // Actualizar UI
        updateMyDiscountsSection();
      }
    });
  }
  
  function removeAllCategoryDiscounts() {
    if (activeDiscounts.categories.size === 0) {
      showToast('No hay descuentos por categoría para remover', 'warning');
      return;
    }
    
    const totalCategorias = activeDiscounts.categories.size;
    
    Array.from(activeDiscounts.categories).forEach(category => {
      removeCategoryDiscount(category);
    });
    
    showToast(`Descuentos por categoría removidos (${totalCategorias} categorías)`, 'success');
  }
  
  function removeAllProductDiscounts() {
    // Eliminar productos con origen individual y productos con descuento pero sin origen
    const individualProducts = productosCache.filter(p => 
      p.tiene_descuento && 
      (p.origen_descuento === 'individual' || !p.origen_descuento)
    );
    
    if (individualProducts.length === 0) {
      showToast('No hay descuentos individuales para remover', 'warning');
      return;
    }
    
    const promises = individualProducts.map(product => 
      removeDiscountFromProduct(product.id)
    );
    
    Promise.all(promises).then(results => {
      const successCount = results.filter(r => r).length;
      showToast(`Descuentos removidos de ${successCount} productos individuales`, 'success');
      
      // Actualizar datos locales
      individualProducts.forEach(p => {
        p.tiene_descuento = false;
        p.tipo_descuento = null;
        p.valor_descuento = 0;
        p.origen_descuento = null;
        p.descuento_grupo_id = null;
        p.fecha_aplicacion_descuento = null;
      });
      
      // Limpiar set de productos
      activeDiscounts.products.clear();
      
      // Actualizar UI
      updateMyDiscountsSection();
    });
  }
  
  function removeAllBrandDiscounts() {
    if (activeDiscounts.brands.size === 0) {
      showToast('No hay descuentos por marca para remover', 'warning');
      return;
    }
    
    const totalMarcas = activeDiscounts.brands.size;
    
    Array.from(activeDiscounts.brands).forEach(brand => {
      removeBrandDiscount(brand);
    });
    
    showToast(`Descuentos por marca removidos (${totalMarcas} marcas)`, 'success');
  }
  
  // Remover descuento de producto (API call) - ASEGURA LIMPIAR TODOS LOS CAMPOS
  function removeDiscountFromProduct(productId) {
    return fetch(`/api/remove_discount/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Actualizar cache - LIMPIANDO TODOS LOS CAMPOS RELACIONADOS
        const cachedProduct = productosCache.find(p => p.id == productId);
        if (cachedProduct) {
          cachedProduct.tiene_descuento = false;
          cachedProduct.valor_descuento = 0;
          cachedProduct.tipo_descuento = null;
          cachedProduct.origen_descuento = null;
          cachedProduct.descuento_grupo_id = null;
          cachedProduct.fecha_aplicacion_descuento = null;
        }
        return true;
      }
      return false;
    })
    .catch(error => {
      console.error('Error:', error);
      return false;
    });
  }
  
  // Función para navegar sliders - MEJORADA
  function scrollSlider(sliderId, direction) {
    const slider = document.getElementById(`slider-${sliderId}`);
    if (!slider) return;
    
    // Ajustar tamaño de scroll según el tipo de tarjeta
    let cardWidth = 0;
    
    if (sliderId === 'category' || sliderId === 'brand') {
      cardWidth = 260; // 240px + 20px gap
    } else if (sliderId === 'global' || sliderId === 'product') {
      cardWidth = 240; // 220px + 20px gap
    } else {
      cardWidth = 240; // Valor por defecto
    }
    
    // Scroll de 3 tarjetas a la vez (o menos si el slider es pequeño)
    const visibleWidth = slider.clientWidth;
    const scrollAmount = Math.min(cardWidth * 3, visibleWidth * 0.8);
    
    // Calcular desplazamiento actual y total
    const scrollLeft = slider.scrollLeft;
    const scrollWidth = slider.scrollWidth;
    
    if (direction === 'left') {
      // Si estamos cerca del inicio, ir al principio
      if (scrollLeft < scrollAmount) {
        slider.scrollTo({ left: 0, behavior: 'smooth' });
      } else {
        slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      }
    } else {
      // Si estamos cerca del final, ir al final
      if (scrollLeft + visibleWidth + scrollAmount > scrollWidth) {
        slider.scrollTo({ left: scrollWidth, behavior: 'smooth' });
      } else {
        slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      }
    }
    
    // Verificar si se necesitan mostrar/ocultar botones de navegación
    setTimeout(() => {
      updateSliderArrows(sliderId);
    }, 300);
  }
  
  // Función para actualizar visibilidad de flechas de navegación
  function updateSliderArrows(sliderId) {
    const slider = document.getElementById(`slider-${sliderId}`);
    if (!slider) return;
    
    const leftArrow = slider.parentElement.querySelector('.slider-arrow-left');
    const rightArrow = slider.parentElement.querySelector('.slider-arrow-right');
    
    if (!leftArrow || !rightArrow) return;
    
    // Mostrar/ocultar flecha izquierda según posición de scroll
    if (slider.scrollLeft <= 10) {
      leftArrow.style.opacity = '0.5';
    } else {
      leftArrow.style.opacity = '1';
    }
    
    // Mostrar/ocultar flecha derecha según posición de scroll
    if (slider.scrollLeft + slider.clientWidth >= slider.scrollWidth - 10) {
      rightArrow.style.opacity = '0.5';
    } else {
      rightArrow.style.opacity = '1';
    }
  }
  
  // Inicializar estado de flechas después de cargar contenido
  function initSliderArrows() {
    ['global', 'category', 'brand', 'product'].forEach(sliderId => {
      updateSliderArrows(sliderId);
      
      // Añadir listener para actualizar flechas durante scroll manual
      const slider = document.getElementById(`slider-${sliderId}`);
      if (slider) {
        slider.addEventListener('scroll', () => {
          updateSliderArrows(sliderId);
        });
      }
    });
  }
  
  // Actualizar estado de la UI
  function updateUIState() {
    // Esta función no necesita cambios
  }
  
  // Sistema de notificaciones
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    if (type === 'warning') icon = 'exclamation-triangle';
    
    toast.innerHTML = `
      <i class="fas fa-${icon}"></i>
      <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('fade-out');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
  
  // Validar inputs de descuento
  document.addEventListener('input', function(e) {
    if (e.target.id === 'globalDiscountValue') {
      if (e.target.value > 100) e.target.value = 100;
      if (e.target.value < 1 && e.target.value !== '') e.target.value = 1;
    }
  });
</script>
{% endblock %}