{% extends 'base.html' %}

{% block title %}
  Ajuste de Stock
{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Adaptado del dashboard_inventario.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales */
    --text-color: #1d1d1f;
    --text-secondary: #555555; /* Cambiado a color más oscuro para mejor legibilidad */
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    
    /* Colores de estado */
    --green: #2ecc71;
    --orange: #f39c12;
    --red: #e74c3c;
    --blue: #1a237e;
    --gray-500: #777777; /* Cambiado a color más oscuro para mejor legibilidad */
  }

  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--background);
  }

  /* Contenedor principal con estilo Apple */
  .ajuste-stock-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }

  /* Tipografía */
  h1 {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: #86868b; /* Más claro para la descripción de la página */
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400; /* Algo más ligero */
  }

  /* Encabezado de página - MODIFICADO PARA ALINEACIÓN PERFECTA */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start; /* Cambiado a flex-start */
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px; /* Espacio para la descripción */
    color: var(--text-color);
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px; /* Ajuste para alinear con la primera línea del título */
  }
  
  /* Botones con estilo Apple - MEJORADO PARA CENTRADO DE TEXTO */
  .btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    text-align: center; /* Centrar texto dentro del botón */
  }
  
  /* Fuerza centrado de texto en botones */
  .btn-icon i, 
  .btn-icon span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1;
  }
  
  .btn-outline {
    background-color: var(--light-background);
    color: var(--text-color);
    border: 1px solid var(--separator);
  }
  
  .btn-outline:hover {
    background-color: #e8e8e8;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .btn-primary {
    background-color: var(--accent);
    color: white;
  }
  
  .btn-primary:hover {
    background-color: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  /* Filtros y búsqueda con estilo Apple - MODIFICADO */
  .filters-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between; /* Distribuir equitativamente */
    gap: 1rem;
    margin-bottom: 1.5rem;
    width: 100%; /* Asegurar ancho completo */
  }
  
  .filter-item {
    flex: 1;
    min-width: 180px;
    display: flex;
    align-items: center;
  }
  
  .filter-item select {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 0.95rem;
    font-family: var(--font-apple);
    background-color: #f5f5f7;
    color: var(--text-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 12px;
    padding-right: 2.5rem;
    transition: all 0.2s ease;
  }
  
  .filter-item select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  /* Búsqueda con estilo Apple - CORREGIDO PARA QUE FUNCIONE COMO EN PRODUCTOS.HTML */
  .search-container {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    position: relative;
    align-items: center;
  }
  
  .search-box {
    flex: 1;
    position: relative;
  }
  
  .search-box i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-600);
    font-size: 1.1rem;
    z-index: 5;
    pointer-events: none;
  }
  
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 1rem;
    height: 48px;
    transition: all 0.2s ease;
    font-weight: 400;
    background-color: var(--light-background);
  }
  
  .search-input input:focus {
    background-color: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  .search-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .icon-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light-background);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
  }
  
  .icon-btn:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .icon-btn.scan-active {
    background-color: rgba(229, 46, 46, 0.1);
    border-color: var(--accent);
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
  }
  
  /* Contador de resultados */
  .products-summary {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    font-weight: 500; /* Añadido para mejor legibilidad */
  }
  
  /* Estilos para el corazón exactamente como en productos.html */
  .heart-icon {
    font-size: 24px;
    cursor: pointer;
    display: inline-block;
    transition: transform 0.2s ease, color 0.2s ease;
  }
  
  .heart-icon:hover {
    transform: scale(1.1);
  }
  
  .heart-icon.active {
    color: var(--red);
  }
  
  .heart-icon:not(.active) {
    color: var(--gray-500);
  }
  
  /* Contenedor para el checkbox de favoritos */
  .form-heart-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    height: 100%;
    padding: 0.75rem 0;
  }
  
  .form-heart-check-input {
    display: none;
  }
  
  /* Grid de productos */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .product-card {
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    background-color: white;
    position: relative;
  }
  
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
  }
  
  .product-img-container {
    height: 180px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light-background);
    position: relative;
  }
  
  .product-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.3s ease;
  }
  
  .product-card:hover .product-img {
    transform: scale(1.05);
  }
  
  .category-tag {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    padding: 0.4rem 0.75rem;
    border-radius: 980px;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: white;
    color: var(--text-color);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .product-body {
    padding: 1.25rem;
  }
  
  .product-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-color);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 2.6rem;
  }
  
  .product-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .product-info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500; /* Añadido para mejor legibilidad */
  }
  
  .product-info-icon {
    width: 16px;
    text-align: center;
    color: var(--text-secondary);
  }
  
  .stock-badge {
    display: inline;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-color);
  }
  
  .product-footer {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.25rem;
  }
  
  .product-btn {
    flex: 1;
    padding: 0.75rem 0.5rem;
    text-align: center;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    border: none;
  }
  
  .btn-entrada {
    background-color: rgba(46, 204, 113, 0.2);
    color: #1a7742; /* Más oscuro que var(--green) para mejor contraste */
    border: 1px solid rgba(46, 204, 113, 0.3);
    font-weight: 600;
  }
  
  .btn-entrada:hover {
    background-color: rgba(46, 204, 113, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(46, 204, 113, 0.25);
  }
  
  .btn-salida {
    background-color: rgba(231, 76, 60, 0.2);
    color: #c0392b; /* Más oscuro que var(--red) para mejor contraste */
    border: 1px solid rgba(231, 76, 60, 0.3);
    font-weight: 600;
  }
  
  .btn-salida:hover {
    background-color: rgba(231, 76, 60, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.25);
  }
  
  /* Paginación con estilo Apple */
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
  }
  
  .pagination {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 0.5rem;
  }
  
  .page-item {
    margin: 0;
  }
  
  .page-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    border-radius: 980px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.2s ease;
    min-width: 40px;
    height: 40px;
    font-size: 0.95rem;
  }
  
  .page-link:hover {
    background-color: var(--light-background);
    transform: translateY(-2px);
  }
  
  .page-item.active .page-link {
    background-color: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  .page-item.disabled .page-link {
    color: var(--text-secondary);
    pointer-events: none;
    opacity: 0.5;
  }
  
  .pagination-info {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.75rem;
    font-weight: 500; /* Añadido para mejor legibilidad */
  }
  
  /* No Results Message */
  #noResultsMessage {
    display: none;
    text-align: center;
    padding: 3rem 2rem;
    background-color: var(--light-background);
    border-radius: 12px;
    margin-bottom: 2rem;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  #noResultsMessage.visible {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }
  
  #noResultsMessage i {
    font-size: 3rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }
  
  #noResultsMessage h4 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-color);
  }
  
  #noResultsMessage p {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    font-weight: 500; /* Añadido para mejor legibilidad */
  }
  
  #resetFilters {
    display: inline-block;
    padding: 0.5rem 0.9rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.85rem;
    background-color: white;
    color: var(--text-color);
    border: 1px solid rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }
  
  #resetFilters:hover {
    background-color: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  /* Código adicional para manejo de escáner */
  #quaggaScanner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: none;
  }
  
  #quaggaScanner.active {
    display: block;
  }
  
  #scanner-container {
    width: 100%;
    max-width: 640px;
    height: 480px;
    margin: 50px auto;
    position: relative;
    border: 3px solid var(--accent);
    border-radius: 12px;
    overflow: hidden;
  }
  
  #closeScanner {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--text-color);
    cursor: pointer;
    z-index: 10000;
    border: none;
  }
  
  /* Responsive Media Queries */
  @media (max-width: 992px) {
    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    }
  }
  
  @media (max-width: 768px) {
    .ajuste-stock-container {
      padding: 24px 16px;
    }
    
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .filters-container {
      flex-direction: column;
    }
    
    .product-card {
      max-width: 100%;
    }
    
    .product-img-container {
      height: 160px;
    }
    
    .search-container {
      flex-direction: column;
    }
    
    .search-actions {
      width: 100%;
      justify-content: flex-end;
    }
  }
</style>

<div class="ajuste-stock-container">
  <!-- Encabezado con título y acciones -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Ajuste de Stock</h1>
      <p class="page-description">Registra entradas y salidas de mercancía.</p>
    </div>
    <div class="header-actions">
      <!-- Volver a añadir el icono de flecha -->
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-icon btn-outline">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
      <a href="{{ url_for('historial_movimientos') }}" class="btn-icon btn-primary" id="btnHistorial">
        <i class="fas fa-history"></i>
        <span>Historial</span>
      </a>
    </div>
  </div>
  
  <!-- Filtros y búsqueda - MODIFICADO PARA ELIMINAR FONDO GRIS -->
  <div class="filters-container">
    <div class="filter-item">
      <select class="form-select" id="categoriaFilter">
        <option value="">Todas las categorías</option>
        {% for categoria in categorias %}
          <option value="{{ categoria }}">{{ categoria|title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-item">
      <select class="form-select" id="stockFilter">
        <option value="">Todos los niveles de stock</option>
        <option value="low">Stock bajo (0-5)</option>
        <option value="medium">Stock medio (6-20)</option>
        <option value="high">Stock alto (20+)</option>
      </select>
    </div>
    <div class="filter-item">
      <select class="form-select" id="orderFilter">
        <option value="recientes">Más recientes</option>
        <option value="alfabetico">Alfabético (A-Z)</option>
        <option value="stock-asc">Stock (menor a mayor)</option>
        <option value="stock-desc">Stock (mayor a menor)</option>
      </select>
    </div>
    <div class="filter-item">
      <div class="form-heart-container">
        <input class="form-heart-check-input" type="checkbox" id="favoritosCheck">
        <span class="heart-icon" id="heartIcon">&#9825;</span>
        <label for="favoritosCheck" style="cursor: pointer; font-size: 0.95rem; font-weight: 500;">Solo favoritos</label>
      </div>
    </div>
  </div>
  
  <div class="search-container">
    <div class="search-box">
      <!-- Ícono de lupa con Font Awesome -->
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar por nombre, código o categoría...">
    </div>
    <div class="search-actions">
      <!-- Botón de escaneo con pistola de código de barras -->
      <button class="icon-btn" id="scanButton" title="Escanear con pistola">
        <img src="{{ url_for('static', filename='img/3.png') }}" alt="Escanear con Lector" style="width: 24px; height: 24px;">
      </button>
      <!-- Botón de escaneo con cámara - Especificamos directamente la función en el atributo onclick -->
      <button class="icon-btn" id="cameraButton" title="Escanear con cámara">
        <img src="{{ url_for('static', filename='img/4.png') }}" alt="Escanear con Cámara" style="width: 24px; height: 24px;">
      </button>
    </div>
  </div>
  
  <!-- Resumen de productos mostrados -->
  <div class="products-summary" id="productsCounter">
    Mostrando <span id="visibleCount">{{ productos|length }}</span> de <span id="totalCount">{{ productos|length }}</span> productos
  </div>
  
  <!-- Mensaje de sin resultados -->
  <div id="noResultsMessage">
    <i class="fas fa-search mb-3"></i>
    <h4>No se encontraron productos</h4>
    <p>Intenta modificar los filtros o la búsqueda</p>
    <button id="resetFilters">
      Restablecer
    </button>
  </div>
  
  <!-- Grid de productos -->
  <div class="products-grid">
    {% for producto in productos %}
      <div class="product-card" data-categoria="{{ producto.categoria }}" data-stock="{{ producto.stock }}" data-precio="{{ producto.precio_venta }}" data-favorito="{{ producto.es_favorito }}">
        <div class="product-img-container">
          {% if producto.foto %}
            <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" alt="{{ producto.nombre }}" class="product-img">
          {% else %}
            <img src="{{ url_for('static', filename='img/default_product.jpg') }}" alt="Imagen predeterminada" class="product-img">
          {% endif %}
        </div>
        <div class="category-tag">
          {{ producto.categoria|title }}
        </div>
        <div class="product-body">
          <h3 class="product-title">{{ producto.nombre }}</h3>
          <div class="product-info">
            <div class="product-info-item">
              <!-- Se quitó el icono de código de barras -->
              <span style="font-weight: 500;">{{ producto.codigo_barras_externo }}</span>
            </div>
            <div class="product-info-item">
              <!-- Se quitó el icono de capas -->
              <span style="font-weight: 500;">
                <span class="stock-badge">
                  {% if producto.stock <= 0 %}
                    Sin stock
                  {% else %}
                    {{ producto.stock }} 
                    {% if producto.unidad and producto.unidad != 'NONE' %}
                      {{ producto.unidad }}
                    {% else %}
                      {% if producto.stock == 1 %}pieza{% else %}piezas{% endif %}
                    {% endif %}
                  {% endif %}
                </span>
              </span>
            </div>
            <div class="product-info-item">
              <!-- Se quitó el icono de etiqueta -->
              <span style="font-weight: 500;">Precio actual: <span class="formatted-price" data-price="{{ producto.precio_venta }}">
                ${{ producto.precio_venta|string|replace('.0', '') }}
              </span></span>
            </div>
          </div>
          <div class="product-footer">
            <a href="{{ url_for('ajuste_entrada', producto_id=producto.id) }}" class="product-btn btn-entrada">
              <i class="fas fa-plus"></i> Entrada
            </a>
            <a href="{{ url_for('ajuste_salida', producto_id=producto.id) }}" class="product-btn btn-salida">
              <i class="fas fa-minus"></i> Salida
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  
  <!-- Paginación -->
  <div class="pagination-container">
    <ul class="pagination" id="paginationControl">
      <!-- Se llenará con JavaScript -->
    </ul>
  </div>
  <div class="pagination-info" id="paginationInfo">
    Mostrando 10 productos por página
  </div>
</div>

<!-- Contenedor para escáner Quagga -->
<div id="quaggaScanner">
  <button id="closeScanner">&times;</button>
  <div id="scanner-container"></div>
</div>

<!-- Scripts necesarios -->
<script src="{{ url_for('static', filename='js/barcode-scanner.js') }}"></script>
<!-- Incluir Quagga.js para el escáner de códigos de barras con cámara -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const PRODUCTS_PER_PAGE = 10;
    const productCards = document.querySelectorAll('.product-card');
    const totalProducts = productCards.length;
    let currentPage = 1;
    let filteredProducts = Array.from(productCards);
    
    // Referencias a elementos DOM
    const searchInput = document.getElementById('searchInput');
    const categoriaFilter = document.getElementById('categoriaFilter');
    const stockFilter = document.getElementById('stockFilter');
    const orderFilter = document.getElementById('orderFilter');
    const favoritosCheck = document.getElementById('favoritosCheck');
    const paginationControl = document.getElementById('paginationControl');
    const paginationInfo = document.getElementById('paginationInfo');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const productsCounter = document.getElementById('productsCounter');
    const visibleCountSpan = document.getElementById('visibleCount');
    const totalCountSpan = document.getElementById('totalCount');
    const scanButton = document.getElementById('scanButton');
    const cameraButton = document.getElementById('cameraButton');
    
    // Inicializar contador
    totalCountSpan.textContent = totalProducts;
    
    // Inicializar el escáner de códigos de barras con pistola
    if (window.initBarcodeScanner) {
      window.initBarcodeScanner('#scanButton', '#searchInput', {
        threshold: 150,
        timeoutDuration: 2000
      });
    }
    
    // Observador del valor de searchInput para activar búsqueda automáticamente al escanear
    let prevInputValue = '';
    const checkForScannerInput = setInterval(() => {
      if (searchInput && searchInput.value !== prevInputValue) {
        prevInputValue = searchInput.value;
        // Disparar evento de input para activar la búsqueda
        const inputEvent = new Event('input', { bubbles: true });
        searchInput.dispatchEvent(inputEvent);
      }
    }, 100);  // revisar cada 100ms
    
    // Implementación de Quagga.js para el escáner de cámara
    function iniciarEscaneoQuagga() {
      const scanner = document.getElementById('quaggaScanner');
      const closeButton = document.getElementById('closeScanner');
      
      // Mostrar el escáner
      scanner.classList.add('active');
      
      // Configurar Quagga
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.getElementById('scanner-container'),
          constraints: {
            width: 640,
            height: 480,
            facingMode: "environment" // Usar cámara trasera si está disponible
          }
        },
        locator: {
          patchSize: "medium",
          halfSample: true
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader"
          ],
          debug: {
            showCanvas: true,
            showPatches: true,
            showFoundPatches: true,
            showSkeleton: true,
            showLabels: true,
            showPatchLabels: true,
            showRemainingPatchLabels: true
          }
        },
        locate: true
      }, function(err) {
        if (err) {
          console.error("Error al iniciar Quagga:", err);
          alert("No se pudo acceder a la cámara. Verifique los permisos.");
          scanner.classList.remove('active');
          return;
        }
        
        // Iniciar Quagga
        Quagga.start();
      });
      
      // Detectar código de barras
      Quagga.onDetected(function(result) {
        if (result && result.codeResult && result.codeResult.code) {
          const code = result.codeResult.code;
          console.log("Código detectado:", code);
          
          // Detener Quagga y cerrar el escáner
          Quagga.stop();
          scanner.classList.remove('active');
          
          // Asignar el código al campo de búsqueda y disparar búsqueda
          if (searchInput) {
            searchInput.value = code;
            // Disparar evento de input para activar la búsqueda
            const inputEvent = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(inputEvent);
          }
        }
      });
      
      // Botón para cerrar el escáner manualmente
      closeButton.addEventListener('click', function() {
        Quagga.stop();
        scanner.classList.remove('active');
      });
    }
    
    // Asignar el evento de clic al botón de cámara
    if (cameraButton) {
      cameraButton.addEventListener('click', function() {
        iniciarEscaneoQuagga();
      });
    }
    
    // Al cargar la página, almacenar el orden original de los productos
    const originalProductOrder = Array.from(document.querySelectorAll('.product-card'));
    
    // Función para aplicar el ordenamiento de manera consistente
    function sortProducts() {
      const orderValue = orderFilter.value;
      const productsGridElement = document.querySelector('.products-grid');
      
      // Vaciar el contenedor primero
      while (productsGridElement.firstChild) {
        productsGridElement.removeChild(productsGridElement.firstChild);
      }
      
      // Crear una copia de los productos filtrados para ordenar
      let productsToSort = [...filteredProducts];
      
      // Ordenar según la opción seleccionada
      if (orderValue === 'recientes') {
        // Usar el orden original en que los productos venían del servidor
        productsToSort.sort((a, b) => {
          return originalProductOrder.indexOf(a) - originalProductOrder.indexOf(b);
        });
      } 
      else if (orderValue === 'alfabetico') {
        productsToSort.sort((a, b) => {
          const titleA = a.querySelector('.product-title').textContent.toLowerCase();
          const titleB = b.querySelector('.product-title').textContent.toLowerCase();
          return titleA.localeCompare(titleB);
        });
      } 
      else if (orderValue === 'stock-asc') {
        productsToSort.sort((a, b) => {
          const stockA = parseInt(a.getAttribute('data-stock') || '0');
          const stockB = parseInt(b.getAttribute('data-stock') || '0');
          return stockA - stockB;
        });
      } 
      else if (orderValue === 'stock-desc') {
        productsToSort.sort((a, b) => {
          const stockA = parseInt(a.getAttribute('data-stock') || '0');
          const stockB = parseInt(b.getAttribute('data-stock') || '0');
          return stockB - stockA;
        });
      } 
      else if (orderValue === 'precio-asc') {
        productsToSort.sort((a, b) => {
          const precioA = parseFloat(a.getAttribute('data-precio') || '0');
          const precioB = parseFloat(b.getAttribute('data-precio') || '0');
          return precioA - precioB;
        });
      } 
      else if (orderValue === 'precio-desc') {
        productsToSort.sort((a, b) => {
          const precioA = parseFloat(a.getAttribute('data-precio') || '0');
          const precioB = parseFloat(b.getAttribute('data-precio') || '0');
          return precioB - precioA;
        });
      }
      
      // Reordenar físicamente en el DOM
      productsToSort.forEach(card => {
        productsGridElement.appendChild(card);
      });
      
      return productsToSort;
    }
    
    // Función principal para aplicar filtros y paginación
    function applyFiltersAndPagination() {
      const searchTerm = searchInput.value.toLowerCase();
      const categoriaSelected = categoriaFilter.value.toLowerCase();
      const stockSelected = stockFilter.value;
      const favoritosOnly = favoritosCheck.checked;
      
      // Aplicar filtros
      filteredProducts = Array.from(productCards).filter(card => {
        const categoria = card.getAttribute('data-categoria').toLowerCase();
        const stock = parseInt(card.getAttribute('data-stock'));
        const favorito = card.getAttribute('data-favorito') === 'True';
        const title = card.querySelector('.product-title').textContent.toLowerCase();
        const code = card.querySelector('.product-info-item span').textContent.toLowerCase();
        
        // Filtro de búsqueda
        const matchesSearch = !searchTerm || 
                            title.includes(searchTerm) || 
                            code.includes(searchTerm) || 
                            categoria.includes(searchTerm);
        
        // Filtro de categoría
        const matchesCategoria = !categoriaSelected || categoriaSelected === '' || categoria === categoriaSelected;
        
        // Filtro de stock
        let matchesStock = true;
        if (stockSelected === 'low') {
          matchesStock = stock <= 5;
        } else if (stockSelected === 'medium') {
          matchesStock = stock > 5 && stock <= 20;
        } else if (stockSelected === 'high') {
          matchesStock = stock > 20;
        }
        
        // Filtro de favoritos
        const matchesFavoritos = !favoritosOnly || favorito;
        
        return matchesSearch && matchesCategoria && matchesStock && matchesFavoritos;
      });
      
      // Ordenar productos utilizando la función dedicada
      filteredProducts = sortProducts();
      
      // Actualizar contador de resultados
      visibleCountSpan.textContent = filteredProducts.length;
      
      // Mostrar mensaje de no resultados si es necesario
      if (filteredProducts.length === 0) {
        noResultsMessage.classList.add('visible');
      } else {
        noResultsMessage.classList.remove('visible');
      }
      
      // Actualizar paginación
      updatePagination();
      
      // Mostrar productos de la página actual
      showCurrentPage();
    }
    
    // Función para actualizar la paginación
    function updatePagination() {
      const totalFilteredProducts = filteredProducts.length;
      const totalPages = Math.ceil(totalFilteredProducts / PRODUCTS_PER_PAGE);
      
      // Asegurar que la página actual es válida
      if (currentPage > totalPages) {
        currentPage = totalPages > 0 ? totalPages : 1;
      }
      
      // Actualizar controles de paginación
      paginationControl.innerHTML = '';
      
      // Botón "Anterior"
      const prevLi = document.createElement('li');
      prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
      const prevLink = document.createElement('a');
      prevLink.className = 'page-link';
      prevLink.href = '#';
      prevLink.textContent = 'Anterior';
      if (currentPage > 1) {
        prevLink.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage--;
          applyFiltersAndPagination();
        });
      }
      prevLi.appendChild(prevLink);
      paginationControl.appendChild(prevLi);
      
      // Números de página
      // Mostrar hasta 5 páginas, priorizando la actual y sus vecinas
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4 && startPage > 1) {
        startPage = Math.max(1, endPage - 4);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = 'page-item' + (i === currentPage ? ' active' : '');
        const pageLink = document.createElement('a');
        pageLink.className = 'page-link';
        pageLink.href = '#';
        pageLink.textContent = i;
        pageLink.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          applyFiltersAndPagination();
        });
        pageLi.appendChild(pageLink);
        paginationControl.appendChild(pageLi);
      }
      
      // Botón "Siguiente"
      const nextLi = document.createElement('li');
      nextLi.className = 'page-item' + (currentPage === totalPages || totalPages === 0 ? ' disabled' : '');
      const nextLink = document.createElement('a');
      nextLink.className = 'page-link';
      nextLink.href = '#';
      nextLink.textContent = 'Siguiente';
      if (currentPage < totalPages) {
        nextLink.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage++;
          applyFiltersAndPagination();
        });
      }
      nextLi.appendChild(nextLink);
      paginationControl.appendChild(nextLi);
      
      // Actualizar información de paginación
      if (totalPages <= 1) {
        paginationInfo.textContent = `Mostrando ${totalFilteredProducts} productos`;
      } else {
        const productsOnThisPage = Math.min(PRODUCTS_PER_PAGE, 
          (currentPage < totalPages) ? PRODUCTS_PER_PAGE : totalFilteredProducts - ((totalPages - 1) * PRODUCTS_PER_PAGE));
        paginationInfo.textContent = `Mostrando ${productsOnThisPage} productos por página`;
      }
      
      // Ocultar paginación si no hay productos o solo hay una página
      paginationControl.style.display = totalPages <= 1 ? 'none' : 'flex';
    }
    
    // Función para mostrar los productos de la página actual
    function showCurrentPage() {
      const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
      const endIndex = Math.min(startIndex + PRODUCTS_PER_PAGE, filteredProducts.length);
      
      // Ocultar todos los productos
      productCards.forEach(card => {
        card.style.display = 'none';
      });
      
      // Mostrar solo los productos de la página actual
      for (let i = startIndex; i < endIndex; i++) {
        filteredProducts[i].style.display = 'block';
      }
    }
    
    // Actualizar el corazón cuando cambia el checkbox
    const heartIcon = document.getElementById('heartIcon');
    
    favoritosCheck.addEventListener('change', function() {
      currentPage = 1;
      
      // Actualizar el estilo del corazón
      if (this.checked) {
        heartIcon.innerHTML = '&#9829;'; // Corazón lleno
        heartIcon.classList.add('active');
      } else {
        heartIcon.innerHTML = '&#9825;'; // Corazón vacío
        heartIcon.classList.remove('active');
      }
      
      applyFiltersAndPagination();
    });
    
    // También permitir hacer clic en el corazón para activar/desactivar
    heartIcon.addEventListener('click', function() {
      favoritosCheck.checked = !favoritosCheck.checked;
      
      // Disparar el evento change para actualizar todo
      const event = new Event('change');
      favoritosCheck.dispatchEvent(event);
    });
    
    // Eventos de filtros
    searchInput.addEventListener('input', function() {
      currentPage = 1; // Resetear a la primera página
      applyFiltersAndPagination();
    });
    
    categoriaFilter.addEventListener('change', function() {
      currentPage = 1;
      applyFiltersAndPagination();
    });
    
    stockFilter.addEventListener('change', function() {
      currentPage = 1;
      applyFiltersAndPagination();
    });
    
    orderFilter.addEventListener('change', function() {
      currentPage = 1;
      applyFiltersAndPagination();
    });
    
    // Manejar el botón de reset de filtros
    resetFiltersBtn.addEventListener('click', function() {
      searchInput.value = '';
      categoriaFilter.value = '';
      stockFilter.value = '';
      orderFilter.value = 'recientes';
      favoritosCheck.checked = false;
      heartIcon.innerHTML = '&#9825;'; // Corazón vacío
      heartIcon.classList.remove('active');
      currentPage = 1;
      applyFiltersAndPagination();
    });
    
    // Formatear precios para eliminar .0 y añadir comas
    function formatPrice(price) {
      // Convertir a número
      let numPrice = parseFloat(price);
      
      // Determinar si necesitamos decimales
      let hasSignificantDecimals = false;
      let decimalPart = "";
      
      if (numPrice % 1 !== 0) {
        // Hay decimales, verificar si son significativos
        decimalPart = numPrice.toString().split('.')[1];
        
        // Si hay más de 2 decimales y al menos uno después del segundo decimal no es cero
        if (decimalPart.length > 2 && /[1-9]/.test(decimalPart.substring(2))) {
          hasSignificantDecimals = true;
        }
      }
      
      // Formatear con o sin decimales según corresponda
      if (hasSignificantDecimals) {
        // Conservar 3 decimales
        return "$" + numPrice.toLocaleString('en-US', {
          minimumFractionDigits: 3,
          maximumFractionDigits: 3
        });
      } else if (decimalPart && decimalPart !== "0" && decimalPart !== "00") {
        // Hay decimales significativos (1 o 2)
        return "$" + numPrice.toLocaleString('en-US', {
          minimumFractionDigits: decimalPart.length,
          maximumFractionDigits: decimalPart.length
        });
      } else {
        // Sin decimales
        return "$" + Math.floor(numPrice).toLocaleString('en-US');
      }
    }
    
    // Aplicar formato a todos los precios
    document.querySelectorAll('.formatted-price').forEach(priceElement => {
      const originalPrice = priceElement.getAttribute('data-price');
      priceElement.textContent = formatPrice(originalPrice);
    });
    
    // Inicializar visualización
    applyFiltersAndPagination();
    
    // Animación para tarjetas de productos
    function applyCardAnimations() {
      productCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
          card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    }
    
    // Aplicar animaciones
    applyCardAnimations();
  });
</script>
{% endblock %}