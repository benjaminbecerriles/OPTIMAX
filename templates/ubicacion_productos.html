{% extends 'base.html' %}

{% block title %}Ubicaciones de Productos - OptiMax{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Consistente con cambiar_precios.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales */
    --text-color: #1d1d1f;
    --text-secondary: #515154;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    --blue: #1a237e;
    --location-color: #007aff;
  }
  
  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }
  
  /* Contenedor principal */
  .apple-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Encabezado de página - BASADO EN cambiar_precios.html */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    width: 100%;
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
    align-items: center;
  }
  
  /* Botón volver estilo ajuste_stock.html */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-action i, 
  .btn-action span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1;
  }
  
  /* Botón Volver estilo */
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }
  
  /* Botón asignar en grupo */
  .btn-assign {
    background-color: var(--accent);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(229, 46, 46, 0.3);
  }
  
  .btn-assign:hover {
    background-color: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(229, 46, 46, 0.4);
    color: #ffffff;
  }
  
  /* Barra de búsqueda - Alineación corregida */
  .search-container {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 36px;
    position: relative;
    align-items: center;
    width: 100%;
  }
  
  .search-box {
    flex: 1;
    position: relative;
    margin-right: auto;
    margin-left: 0 !important; /* Forzar margen izquierdo 0 */
    padding-left: 0 !important; /* Asegurar alineación */
  }
  
  .search-box i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
    z-index: 5;
    pointer-events: none;
  }
  
  /* Asegurar que el input de búsqueda conserva la alineación */
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 1rem;
    height: 48px;
    transition: all 0.2s ease;
    font-weight: 400;
    background-color: var(--light-background);
    text-align: left;
  }
  
  .search-box input:focus {
    background-color: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  .search-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  /* Contenedor para el filtro de sin ubicación */
  .filter-container {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: var(--light-background);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 0 16px;
    height: 48px;
    transition: all 0.2s ease;
    cursor: pointer;
    user-select: none;
  }
  
  .filter-container:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .filter-container.active {
    background-color: rgba(0, 122, 255, 0.1);
    border-color: var(--location-color);
  }
  
  .filter-container span {
    font-size: 0.95rem;
    font-weight: 500;
  }
  
  .filter-check-input {
    display: none;
  }
  
  .icon-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light-background);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
  }
  
  .icon-btn:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .icon-btn.scan-active {
    background-color: rgba(229, 46, 46, 0.1);
    border-color: var(--accent);
    animation: blink 1s infinite;
  }
  
  /* Tabla de productos - ALINEADA PRIMERA COLUMNA IZQUIERDA */
  .table-container {
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid var(--separator);
    margin-bottom: 32px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    width: 100%;
    background-color: white;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th {
    padding: 16px;
    font-weight: 600;
    font-size: 14px;
    color: var(--text-secondary);
    background-color: var(--light-background);
    border-bottom: 1px solid var(--separator);
  }
  
  th:first-child {
    text-align: left;
  }
  
  th:not(:first-child) {
    text-align: center;
  }
  
  td {
    padding: 16px;
    border-bottom: 1px solid var(--separator);
    font-size: 15px;
  }
  
  td:first-child {
    text-align: left;
  }
  
  td:not(:first-child) {
    text-align: center;
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: var(--light-background);
  }
  
  tr {
    transition: background-color 0.2s ease;
  }
  
  .product-info {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: flex-start;
  }
  
  .product-image {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: contain;
    background-color: white;
    border: 1px solid var(--separator);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .product-details {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
    max-width: 200px;
  }
  
  .product-name {
    font-weight: 500;
    margin-bottom: 4px;
    color: var(--text-color);
    text-align: left;
  }
  
  .product-code {
    font-size: 13px;
    color: var(--text-secondary);
    text-align: left;
  }
  
  .location-cell {
    max-width: 240px;
    position: relative;
  }
  
  .location-display {
    padding: 8px 0;
    font-weight: 500;
    color: var(--location-color);
    transition: all 0.2s ease;
  }
  
  .location-display.empty {
    color: var(--text-secondary);
    font-weight: 400;
    font-style: italic;
  }
  
  .location-edit {
    display: none;
    justify-content: center;
    max-width: 240px;
    margin: 0 auto;
  }
  
  .location-edit input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--location-color);
    font-size: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
  }
  
  .location-edit input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    transform: translateY(-1px);
  }
  
  .location-suggestions {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
  }
  
  .location-suggestion {
    font-size: 12px;
    background-color: #f0f0f5;
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  
  .location-suggestion:hover {
    background-color: #e5e5ea;
    transform: translateY(-1px);
    border-color: var(--location-color);
  }
  
  .action-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  
  .btn-icon {
    width: 36px;
    height: 36px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background-color: #f5f5f7;
    border: 1px solid rgba(0, 0, 0, 0.05);
    color: var(--text-secondary);
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .btn-icon:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .btn-icon.edit {
    color: var(--location-color);
  }
  
  .btn-icon.edit:hover {
    background-color: rgba(0, 122, 255, 0.1);
    border-color: var(--location-color);
  }
  
  .btn-icon.delete {
    color: var(--accent);
  }
  
  .btn-icon.delete:hover {
    background-color: rgba(229, 46, 46, 0.1);
    border-color: var(--accent);
  }
  
  .btn-save, .btn-cancel {
    display: none;
  }
  
  /* Notificaciones */
  .notification {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 12px;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 500;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .notification.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .notification.success {
    background-color: #34c759;
  }
  
  .notification.error {
    background-color: #ff3b30;
  }
  
  /* Modal de confirmación personalizado */
  .confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .confirm-modal.show {
    opacity: 1;
    visibility: visible;
  }
  
  .confirm-dialog {
    background-color: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }
  
  .confirm-modal.show .confirm-dialog {
    transform: translateY(0);
  }
  
  .confirm-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
  }
  
  .confirm-message {
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 24px;
  }
  
  .confirm-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  
  .confirm-cancel {
    background-color: var(--light-background);
    color: var(--text-color);
    box-shadow: none;
  }
  
  .confirm-delete {
    background-color: var(--accent);
    color: white;
  }
  
  /* Modal de edición masiva - DISEÑO MEJORADO */
  .modal-content {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
    border: none;
  }
  
  .modal-header {
    border-bottom: 1px solid var(--separator);
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: var(--light-background);
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
    color: var(--text-color);
  }
  
  .btn-close {
    background-color: rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    width: 26px;
    height: 26px;
    opacity: 0.7;
    transition: all 0.2s ease;
  }
  
  .btn-close:hover {
    opacity: 1;
    background-color: rgba(0, 0, 0, 0.15);
    transform: scale(1.05);
  }
  
  .modal-body {
    padding: 28px;
  }
  
  .modal-footer {
    border-top: 1px solid var(--separator);
    padding: 18px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background-color: var(--light-background);
  }
  
  .form-group {
    margin-bottom: 24px;
  }
  
  .form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 15px;
    color: var(--text-color);
  }
  
  .form-control {
    width: 100%;
    padding: 12px 16px;
    border-radius: 10px;
    border: 1px solid #dcdce0;
    font-size: 15px;
    transition: all 0.2s ease;
    background-color: white;
  }
  
  .form-control:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
    transform: translateY(-1px);
  }
  
  /* Radio options - simplificado */
  .radio-options-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .radio-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    background-color: white;
  }
  
  .radio-option:hover {
    background-color: var(--light-background);
  }
  
  .radio-option.selected {
    background-color: #f0f0f5;
    border-color: #ccc;
  }
  
  .radio-option input {
    margin: 0;
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
  }
  
  .radio-option i {
    color: #555;
    font-size: 14px;
    width: 18px;
    text-align: center;
  }
  
  .radio-option span {
    font-size: 14px;
    font-weight: normal;
  }
  
  /* Categoría mejorada - simplificada */
  .category-selection {
    margin: 15px auto 0;
    max-width: 90%;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #e0e0e0;
  }
  
  .category-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: var(--text-color);
    font-weight: 500;
  }
  
  .category-select-container {
    position: relative;
  }
  
  .category-select-container:after {
    content: "\f078";
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    pointer-events: none;
  }
  
  .category-select {
    width: 100%;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #dcdce0;
    font-size: 15px;
    appearance: none;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .category-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
  }
  
  /* Estado vacío */
  .empty-state {
    padding: 64px 0;
    text-align: center;
    background-color: var(--light-background);
    border-radius: 16px;
    border: 1px dashed var(--separator);
    margin-bottom: 32px;
    width: 100%;
  }
  
  .empty-icon {
    font-size: 56px;
    color: var(--text-secondary);
    margin-bottom: 20px;
  }
  
  .empty-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-color);
  }
  
  .empty-description {
    color: var(--text-secondary);
    font-size: 17px;
    max-width: 420px;
    margin: 0 auto 24px auto;
    line-height: 1.5;
  }
  
  /* Paginación */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 32px;
  }
  
  .pagination-item {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background-color: var(--light-background);
    border: 1px solid var(--separator);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }
  
  .pagination-item:hover {
    background-color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .pagination-item.active {
    background-color: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  /* Toast notificaciones */
  .toast {
    background-color: #333;
    color: white;
    padding: 14px 20px;
    border-radius: 12px;
    margin-top: 8px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
    max-width: 350px;
    font-weight: 500;
  }
  
  .toast.success {
    background-color: #34c759;
  }
  
  .toast.error {
    background-color: #ff3b30;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .search-container {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search-actions {
      justify-content: space-between;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    th, td {
      padding: 12px 8px;
    }
    
    .product-image {
      width: 36px;
      height: 36px;
    }
  }
  
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
  }
  
  .animated-fade {
    animation: fadeIn 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>

<div class="apple-container animated-fade">
  <!-- Cabecera -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Ubicaciones de Productos</h1>
      <p class="page-description">Gestiona las ubicaciones físicas de tus productos de manera fácil y rápida</p>
    </div>
    <div class="header-actions">
      <button id="btnBulkAssign" class="btn-action btn-assign" data-bs-toggle="modal" data-bs-target="#bulkLocationModal">
        <i class="fas fa-tags"></i> Agregar masivamente
      </button>
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>
  
  <!-- Barra de búsqueda alineada -->
  <div class="search-container">
    <div class="search-box" id="searchBoxContainer">
      <i class="fas fa-search"></i>
      <input type="text" id="searchProducts" placeholder="Buscar por nombre o código...">
    </div>
    <div class="search-actions">
      <!-- Filtro sin ubicación -->
      <div class="filter-container" id="noLocationFilter">
        <input class="filter-check-input" type="checkbox" id="noLocationCheck">
        <i class="fas fa-map-marker-alt"></i>
        <span>Sin ubicación</span>
      </div>
      
      <!-- Botón escanear con pistola -->
      <button type="button" class="icon-btn" id="scanIcon" title="Escanear con pistola">
        <img src="{{ url_for('static', filename='img/3.png') }}" alt="Escanear con Lector" style="width: 24px; height: 24px;">
      </button>
      
      <!-- Botón escanear con cámara -->
      <button type="button" class="icon-btn" id="cameraIcon" title="Escanear con cámara" onclick="iniciarEscaneoQuagga()">
        <img src="{{ url_for('static', filename='img/4.png') }}" alt="Escanear con Cámara" style="width: 24px; height: 24px;">
      </button>
    </div>
  </div>
  
  <!-- Tabla de productos -->
  {% if productos and productos|length > 0 %}
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width: 40%; text-align: left;">Producto</th>
          <th style="width: 15%; text-align: center;">Categoría</th>
          <th style="width: 30%; text-align: center;">Ubicación</th>
          <th style="width: 15%; text-align: center;">Acciones</th>
        </tr>
      </thead>
      <tbody id="productsTableBody">
        {% for producto in productos %}
        <tr data-product-id="{{ producto.id }}" data-product-name="{{ producto.nombre|lower }}" data-product-code="{{ producto.codigo_barras_externo|lower if producto.codigo_barras_externo else '' }}" data-has-location="{{ '1' if producto.ubicacion else '0' }}">
          <td>
            <div class="product-info">
              <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) if producto.foto else url_for('static', filename='img/default_product.jpg') }}" class="product-image" alt="{{ producto.nombre }}">
              <div class="product-details">
                <div class="product-name">{{ producto.nombre }}</div>
                <div class="product-code">{{ producto.codigo_barras_externo or 'SKU-' ~ producto.id }}</div>
              </div>
            </div>
          </td>
          <td style="text-align: center;">
            {% if producto.categoria %}
              <span class="category-badge" style="display: inline-block; padding: 4px 8px; border-radius: 4px; background-color: {{ producto.categoria_color or '#6B7280' }}20; color: {{ producto.categoria_color or '#6B7280' }}; font-weight: 500; font-size: 13px;">
                {{ producto.categoria|title }}
              </span>
            {% else %}
              <span class="category-badge" style="color: #aaa; font-style: italic; font-size: 13px;">Sin categoría</span>
            {% endif %}
          </td>
          <td class="location-cell">
            <div class="location-display {% if not producto.ubicacion %}empty{% endif %}">
              {{ producto.ubicacion or 'Sin ubicación asignada' }}
            </div>
            <div class="location-edit">
              <input type="text" value="{{ producto.ubicacion or '' }}" placeholder="Ej: Estante A, Bodega 2">
              {% if ubicaciones and ubicaciones|length > 0 %}
              <div class="location-suggestions">
                {% for ubicacion in ubicaciones %}
                <div class="location-suggestion">{{ ubicacion }}</div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button type="button" class="btn-icon edit btn-edit-location" title="Editar ubicación" onclick="editLocation({{ producto.id }})">
                <i class="fas fa-pencil-alt"></i>
              </button>
              <!-- Botón eliminar - simplificado para usar bootstrap modal -->
              <button type="button" class="btn-icon delete btn-delete-location" 
                      title="Eliminar ubicación" 
                      onclick="prepareDeleteLocation({{ producto.id }})"
                      {% if not producto.ubicacion %}style="display: none;"{% endif %}>
                <i class="fas fa-trash-alt"></i>
              </button>
              <button type="button" class="btn-icon btn-save" title="Guardar" onclick="saveLocation({{ producto.id }})" style="color: #34c759; display: none;">
                <i class="fas fa-check"></i>
              </button>
              <button type="button" class="btn-icon btn-cancel" title="Cancelar" onclick="cancelEditing({{ producto.id }})" style="color: #ff3b30; display: none;">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Paginación -->
  {% if total_pages and total_pages > 1 %}
  <div class="pagination">
    {% if page > 1 %}
    <a href="{{ url_for('ubicacion_productos', page=page-1) }}" class="pagination-item">
      <i class="fas fa-chevron-left"></i>
    </a>
    {% endif %}
    
    {% for p in range(1, total_pages + 1) %}
    <a href="{{ url_for('ubicacion_productos', page=p) }}" class="pagination-item {% if p == page %}active{% endif %}">
      {{ p }}
    </a>
    {% endfor %}
    
    {% if page < total_pages %}
    <a href="{{ url_for('ubicacion_productos', page=page+1) }}" class="pagination-item">
      <i class="fas fa-chevron-right"></i>
    </a>
    {% endif %}
  </div>
  {% endif %}
  
  {% else %}
  <!-- Estado vacío -->
  <div class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-boxes"></i>
    </div>
    <h3 class="empty-title">No hay productos en tu inventario</h3>
    <p class="empty-description">Agrega productos a tu inventario para poder asignarles ubicaciones físicas</p>
    <a href="{{ url_for('agregar_producto') }}" class="btn-action btn-assign">
      <i class="fas fa-plus"></i> Agregar producto
    </a>
  </div>
  {% endif %}
  
  <!-- Modal de confirmación usando Bootstrap -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Eliminar ubicación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar esta ubicación? Esta acción no se puede deshacer.</p>
          <input type="hidden" id="delete-product-id" value="">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-action" style="background-color: #f5f5f7; color: #1d1d1f;" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn-action btn-assign" id="confirmDeleteBtn" onclick="deleteLocation()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal para asignación masiva -->
  <div class="modal fade" id="bulkLocationModal" tabindex="-1" aria-labelledby="bulkLocationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bulkLocationModalLabel">
            Agregar ubicación masivamente
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ubicacionMasiva" class="form-label">
              Ubicación a asignar
            </label>
            <input type="text" id="ubicacionMasiva" class="form-control" placeholder="Ej: Estante A, Bodega 2">
            
            {% if ubicaciones and ubicaciones|length > 0 %}
            <div class="location-suggestions" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; justify-content: flex-start;">
              {% for ubicacion in ubicaciones %}
              <div class="location-suggestion" onclick="document.getElementById('ubicacionMasiva').value = this.textContent.trim()">
                {{ ubicacion }}
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label class="form-label">
              Aplicar a
            </label>
            
            <div class="radio-options-container">
              <label class="radio-option selected" id="radioCategory">
                <input type="radio" name="selectionType" value="category" checked>
                <span>Por categoría</span>
              </label>
              
              <label class="radio-option" id="radioManual">
                <input type="radio" name="selectionType" value="manual">
                <span>Selección manual</span>
              </label>
            </div>
            
            <div id="categorySelection" class="category-selection">
              <div class="category-label">
                <span>Selecciona categoría:</span>
              </div>
              <div class="category-select-container">
                <select id="categoriaSelector" class="category-select">
                  {% for categoria in categorias %}
                  <option value="{{ categoria.nombre }}">
                    {{ categoria.nombre|title }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div id="manualSelection" class="category-selection" style="display: none;">
              <div class="category-label">
                <span>Buscar productos:</span>
              </div>
              <div class="search-area">
                <input type="text" id="searchProductsModal" class="form-control" placeholder="Buscar productos...">
                <ul id="selectedProductsList" class="selected-products-list"></ul>
                <div class="selected-count mt-2">
                  Productos seleccionados: <span id="selectedCount">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-action" style="background-color: #f5f5f7; color: #1d1d1f;" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn-action btn-assign" id="saveUbicacionMasiva">
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Objeto global para almacenar valores originales por ID de producto
  var originalValues = {};
  
  // Función para editar ubicación
  function editLocation(productId) {
    console.log("Editando ubicación para producto ID:", productId);
    
    // Obtener elementos relevantes
    var row = document.querySelector('tr[data-product-id="' + productId + '"]');
    if (!row) {
      console.error("No se encontró la fila para el producto ID:", productId);
      return;
    }
    
    var locationDisplay = row.querySelector('.location-display');
    var locationEdit = row.querySelector('.location-edit');
    var locationInput = locationEdit.querySelector('input');
    var btnEdit = row.querySelector('.btn-edit-location');
    var btnDelete = row.querySelector('.btn-delete-location');
    var btnSave = row.querySelector('.btn-save');
    var btnCancel = row.querySelector('.btn-cancel');
    
    // Cerrar cualquier otra edición en curso
    document.querySelectorAll('.location-edit').forEach(function(edit) {
      if (edit !== locationEdit && edit.style.display === 'block') {
        var otherRow = edit.closest('tr');
        var otherDisplay = otherRow.querySelector('.location-display');
        var otherBtnEdit = otherRow.querySelector('.btn-edit-location');
        var otherBtnDelete = otherRow.querySelector('.btn-delete-location');
        var otherBtnSave = otherRow.querySelector('.btn-save');
        var otherBtnCancel = otherRow.querySelector('.btn-cancel');
        
        edit.style.display = 'none';
        otherDisplay.style.display = 'block';
        otherBtnEdit.style.display = 'flex';
        if (otherDisplay.textContent.trim() !== 'Sin ubicación asignada') {
          otherBtnDelete.style.display = 'flex';
        } else {
          otherBtnDelete.style.display = 'none';
        }
        otherBtnSave.style.display = 'none';
        otherBtnCancel.style.display = 'none';
      }
    });
    
    // Guardar valor original
    originalValues[productId] = locationInput.value;
    
    // Activar modo edición
    locationDisplay.style.display = 'none';
    locationEdit.style.display = 'flex';
    btnEdit.style.display = 'none';
    btnDelete.style.display = 'none';
    btnSave.style.display = 'flex';
    btnCancel.style.display = 'flex';
    locationInput.focus();
  }
  
  // Función para guardar ubicación
  function saveLocation(productId) {
    console.log("Guardando ubicación para producto ID:", productId);
    
    // Obtener elementos relevantes
    var row = document.querySelector('tr[data-product-id="' + productId + '"]');
    if (!row) {
      console.error("No se encontró la fila para el producto ID:", productId);
      return;
    }
    
    var locationDisplay = row.querySelector('.location-display');
    var locationEdit = row.querySelector('.location-edit');
    var locationInput = locationEdit.querySelector('input');
    var btnEdit = row.querySelector('.btn-edit-location');
    var btnDelete = row.querySelector('.btn-delete-location');
    var btnSave = row.querySelector('.btn-save');
    var btnCancel = row.querySelector('.btn-cancel');
    
    var newLocation = locationInput.value.trim();
    
    // Mostrar cargando
    btnSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btnSave.disabled = true;
    
    // Llamar a la API
    fetch('/api/actualizar-ubicacion/' + productId, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ubicacion: newLocation })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        // Actualizar UI
        if (newLocation) {
          locationDisplay.textContent = newLocation;
          locationDisplay.classList.remove('empty');
          row.setAttribute('data-has-location', '1');
          btnDelete.style.display = 'flex';
        } else {
          locationDisplay.textContent = 'Sin ubicación asignada';
          locationDisplay.classList.add('empty');
          row.setAttribute('data-has-location', '0');
          btnDelete.style.display = 'none';
        }
        
        // Actualizar valor original
        originalValues[productId] = newLocation;
        
        // Efecto visual de éxito
        row.style.transition = "background-color 0.3s ease";
        row.style.backgroundColor = "rgba(52, 199, 89, 0.1)";
        setTimeout(function() {
          row.style.backgroundColor = "";
        }, 1000);
        
        // Mostrar notificación
        showNotification('Ubicación actualizada correctamente', 'success');
      } else {
        throw new Error(data.message || 'Error al actualizar ubicación');
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
      showNotification('Error: ' + error.message, 'error');
    })
    .finally(function() {
      // Restaurar botón
      btnSave.innerHTML = '<i class="fas fa-check"></i>';
      btnSave.disabled = false;
      
      // Volver a modo visualización
      locationDisplay.style.display = 'block';
      locationEdit.style.display = 'none';
      btnEdit.style.display = 'flex';
      btnSave.style.display = 'none';
      btnCancel.style.display = 'none';
    });
  }
  
  // Función para cancelar edición
  function cancelEditing(productId) {
    console.log("Cancelando edición para producto ID:", productId);
    
    // Obtener elementos relevantes
    var row = document.querySelector('tr[data-product-id="' + productId + '"]');
    if (!row) {
      console.error("No se encontró la fila para el producto ID:", productId);
      return;
    }
    
    var locationDisplay = row.querySelector('.location-display');
    var locationEdit = row.querySelector('.location-edit');
    var locationInput = locationEdit.querySelector('input');
    var btnEdit = row.querySelector('.btn-edit-location');
    var btnDelete = row.querySelector('.btn-delete-location');
    var btnSave = row.querySelector('.btn-save');
    var btnCancel = row.querySelector('.btn-cancel');
    
    // Restaurar valor original
    locationInput.value = originalValues[productId] || '';
    
    // Volver a modo visualización
    locationDisplay.style.display = 'block';
    locationEdit.style.display = 'none';
    btnEdit.style.display = 'flex';
    btnDelete.style.display = originalValues[productId] ? 'flex' : 'none';
    btnSave.style.display = 'none';
    btnCancel.style.display = 'none';
  }
  
  // Función para preparar la eliminación
  function prepareDeleteLocation(productId) {
    console.log("Preparando eliminación para producto ID:", productId);
    
    // Guardar el ID del producto para la eliminación
    document.getElementById('delete-product-id').value = productId;
    
    // Mostrar el modal usando Bootstrap
    var myModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    myModal.show();
  }
  
  // Función para eliminar la ubicación
  function deleteLocation() {
    // Obtener el ID del producto
    var productId = document.getElementById('delete-product-id').value;
    
    if (!productId) {
      showNotification('Error: No se pudo identificar el producto', 'error');
      return;
    }
    
    console.log("Eliminando ubicación para producto ID:", productId);
    
    // Mostrar cargando en el botón
    var confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
    confirmBtn.disabled = true;
    
    // Llamar a la API
    fetch('/api/actualizar-ubicacion/' + productId, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ubicacion: '' })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        // Buscar la fila correspondiente
        var row = document.querySelector('tr[data-product-id="' + productId + '"]');
        
        if (row) {
          // Actualizar UI
          var locationDisplay = row.querySelector('.location-display');
          var btnDelete = row.querySelector('.btn-delete-location');
          
          locationDisplay.textContent = 'Sin ubicación asignada';
          locationDisplay.classList.add('empty');
          row.setAttribute('data-has-location', '0');
          btnDelete.style.display = 'none';
          
          // Actualizar valor original
          originalValues[productId] = '';
        }
        
        // Cerrar el modal
        var modalInstance = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modalInstance.hide();
        
        // Mostrar notificación
        showNotification('Ubicación eliminada correctamente', 'success');
        
        // Refrescar los filtros
        if (typeof applyFilters === 'function') {
          applyFilters();
        }
      } else {
        throw new Error(data.message || 'Error al eliminar ubicación');
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
      showNotification('Error: ' + error.message, 'error');
    })
    .finally(function() {
      // Restaurar el botón
      confirmBtn.innerHTML = 'Eliminar';
      confirmBtn.disabled = false;
    });
  }
  
  // Función para mostrar notificaciones
  function showNotification(message, type) {
    type = type || 'success';
    
    // Variable para controlar el timeout
    var notificationTimeout;
    
    // Limpiar timeout previo
    if (window.notificationTimeout) {
      clearTimeout(window.notificationTimeout);
    }
    
    // Quitar notificación existente
    var existingNotification = document.querySelector('.notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Crear nueva notificación
    var notification = document.createElement('div');
    notification.className = 'notification ' + type;
    notification.innerHTML = 
      '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + '"></i>' +
      '<span>' + message + '</span>';
    
    // Añadir al DOM
    document.body.appendChild(notification);
    
    // Mostrar
    setTimeout(function() { 
      notification.classList.add('show'); 
    }, 10);
    
    // Ocultar después de un tiempo
    window.notificationTimeout = setTimeout(function() {
      notification.classList.remove('show');
      setTimeout(function() { 
        notification.remove(); 
      }, 300);
    }, 3000);
  }
  
  // Función para aplicar filtros
  function applyFilters() {
    var searchValue = document.getElementById('searchProducts').value.toLowerCase().trim();
    var showOnlyNoLocation = document.getElementById('noLocationCheck').checked;
    
    var visibleCount = 0;
    
    document.querySelectorAll('#productsTableBody tr').forEach(function(row) {
      var productName = row.getAttribute('data-product-name') || '';
      var productCode = row.getAttribute('data-product-code') || '';
      var hasLocation = row.getAttribute('data-has-location') === '1';
      
      // Verificar filtros
      var matchesSearch = !searchValue || 
                          productName.includes(searchValue) || 
                          productCode.includes(searchValue);
      var matchesLocationFilter = !showOnlyNoLocation || !hasLocation;
      
      // Aplicar
      if (matchesSearch && matchesLocationFilter) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    
    // Mostrar mensaje sin resultados
    var noResultsRow = document.getElementById('noResultsRow');
    
    if (visibleCount === 0) {
      if (!noResultsRow) {
        var tbody = document.getElementById('productsTableBody');
        noResultsRow = document.createElement('tr');
        noResultsRow.id = 'noResultsRow';
        noResultsRow.innerHTML = 
          '<td colspan="4" style="text-align: center; padding: 32px;">' +
            '<i class="fas fa-search" style="font-size: 28px; color: #666; margin-bottom: 16px;"></i>' +
            '<p style="margin: 0; font-size: 17px; color: #666; margin-bottom: 16px;">No se encontraron productos con los filtros seleccionados</p>' +
            '<button class="btn-action btn-assign" style="margin-top: 16px; display: inline-flex;" onclick="resetFilters()">' +
              '<i class="fas fa-undo"></i> Limpiar filtros' +
            '</button>' +
          '</td>';
        tbody.appendChild(noResultsRow);
      } else {
        noResultsRow.style.display = '';
      }
    } else if (noResultsRow) {
      noResultsRow.style.display = 'none';
    }
  }
  
  // Función para resetear filtros
  function resetFilters() {
    document.getElementById('searchProducts').value = '';
    document.getElementById('noLocationCheck').checked = false;
    document.getElementById('noLocationFilter').classList.remove('active');
    applyFilters();
  }
  
  // Inicializar cuando el DOM está listo
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar eventos para el filtro de ubicación
    var noLocationFilter = document.getElementById('noLocationFilter');
    var noLocationCheck = document.getElementById('noLocationCheck');
    
    if (noLocationFilter && noLocationCheck) {
      noLocationFilter.addEventListener('click', function() {
        noLocationCheck.checked = !noLocationCheck.checked;
        this.classList.toggle('active', noLocationCheck.checked);
        applyFilters();
      });
    }
    
    // Configurar eventos para la búsqueda
    var searchInput = document.getElementById('searchProducts');
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }
    
    // Configurar sugerencias de ubicación
    document.querySelectorAll('.location-suggestion').forEach(function(suggestion) {
      suggestion.addEventListener('click', function() {
        var locationInput = this.closest('.location-edit').querySelector('input');
        if (locationInput) {
          locationInput.value = this.textContent.trim();
          locationInput.focus();
        }
      });
    });
    
    // Configurar eventos de teclado para los inputs de ubicación
    document.querySelectorAll('.location-edit input').forEach(function(input) {
      input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          
          // Obtener ID del producto
          var row = this.closest('tr');
          if (row) {
            var productId = row.getAttribute('data-product-id');
            if (productId) {
              saveLocation(productId);
            }
          }
        } else if (event.key === 'Escape') {
          event.preventDefault();
          
          // Obtener ID del producto
          var row = this.closest('tr');
          if (row) {
            var productId = row.getAttribute('data-product-id');
            if (productId) {
              cancelEditing(productId);
            }
          }
        }
      });
    });
    
    // Configurar modal de asignación masiva
    const selectionTypeRadios = document.querySelectorAll('input[name="selectionType"]');
    const categorySelection = document.getElementById('categorySelection');
    const manualSelection = document.getElementById('manualSelection');
    const radioCategory = document.getElementById('radioCategory');
    const radioManual = document.getElementById('radioManual');
  
    // Conjunto para almacenar IDs de productos seleccionados manualmente
    const selectedProducts = new Set();
    
    if (radioCategory && radioManual) {
      radioCategory.addEventListener('click', function() {
        document.querySelector('input[name="selectionType"][value="category"]').checked = true;
        radioCategory.classList.add('selected');
        radioManual.classList.remove('selected');
        categorySelection.style.display = 'block';
        manualSelection.style.display = 'none';
      });
      
      radioManual.addEventListener('click', function() {
        document.querySelector('input[name="selectionType"][value="manual"]').checked = true;
        radioManual.classList.add('selected');
        radioCategory.classList.remove('selected');
        categorySelection.style.display = 'none';
        manualSelection.style.display = 'block';
      });
    }
    
    // Guardar asignación masiva
    const saveUbicacionMasivaBtn = document.getElementById('saveUbicacionMasiva');
    if (saveUbicacionMasivaBtn) {
      saveUbicacionMasivaBtn.addEventListener('click', function() {
        const ubicacion = document.getElementById('ubicacionMasiva').value.trim();
        
        if (!ubicacion) {
          showNotification('Por favor ingresa una ubicación', 'error');
          return;
        }
        
        const selectionType = document.querySelector('input[name="selectionType"]:checked').value;
        let data = {
          ubicacion: ubicacion
        };
        
        if (selectionType === 'category') {
          data.categoria = document.getElementById('categoriaSelector').value;
        } else if (selectionType === 'manual') {
          // Para selección manual
          if (selectedProducts.size === 0) {
            showNotification('No hay productos seleccionados', 'error');
            return;
          }
          
          data.producto_ids = Array.from(selectedProducts);
        }
        
        // Mostrar cargando
        saveUbicacionMasivaBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        saveUbicacionMasivaBtn.disabled = true;
        
        // Llamar a la API
        fetch('/api/actualizar-ubicacion-masiva', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkLocationModal'));
            modal.hide();
            
            // Mostrar notificación
            showNotification(`Se actualizaron ${data.count} productos`, 'success');
            
            // Recargar página después de un breve retraso
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            throw new Error(data.message || 'Error al guardar las ubicaciones');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('Error: ' + error.message, 'error');
        })
        .finally(() => {
          // Restaurar botón
          saveUbicacionMasivaBtn.innerHTML = 'Guardar';
          saveUbicacionMasivaBtn.disabled = false;
        });
      });
    }
    
    // Buscar productos en el modal
    const searchProductsModal = document.getElementById('searchProductsModal');
    const selectedProductsList = document.getElementById('selectedProductsList');
    const selectedCount = document.getElementById('selectedCount');
    
    if (searchProductsModal && selectedProductsList) {
      searchProductsModal.addEventListener('input', function() {
        const searchText = searchProductsModal.value.toLowerCase();
        
        // Actualizar lista de productos encontrados
        updateProductSearchResults(searchText);
      });
      
      function updateProductSearchResults(searchText) {
        // Limpiar resultados anteriores
        selectedProductsList.innerHTML = '';
        
        // Si no hay texto de búsqueda, mostrar solo los seleccionados
        if (!searchText) {
          displaySelectedProducts();
          return;
        }
        
        // Buscar entre los productos visibles
        const matchingProducts = [];
        document.querySelectorAll('#productsTableBody tr').forEach(row => {
          const productId = row.dataset.productId;
          const productName = row.querySelector('.product-name').textContent.toLowerCase();
          const productCode = row.querySelector('.product-code').textContent.toLowerCase();
          
          if (productName.includes(searchText) || productCode.includes(searchText)) {
            matchingProducts.push({
              id: productId,
              name: row.querySelector('.product-name').textContent,
              selected: selectedProducts.has(productId)
            });
          }
        });
        
        // Mostrar resultados
        matchingProducts.forEach(product => {
          const li = document.createElement('li');
          li.innerHTML = `
            <label>
              <input type="checkbox" data-product-id="${product.id}" 
                     ${product.selected ? 'checked' : ''}>
              ${product.name}
            </label>
          `;
          
          // Manejar selección/deselección
          const checkbox = li.querySelector('input[type="checkbox"]');
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              selectedProducts.add(product.id);
            } else {
              selectedProducts.delete(product.id);
            }
            updateSelectedCount();
          });
          
          selectedProductsList.appendChild(li);
        });
        
        // Si no hay resultados
        if (matchingProducts.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No se encontraron productos';
          li.style.fontStyle = 'italic';
          li.style.color = '#666';
          selectedProductsList.appendChild(li);
        }
      }
      
      function displaySelectedProducts() {
        // Mostrar solo los productos seleccionados
        selectedProductsList.innerHTML = '';
        
        if (selectedProducts.size === 0) {
          const li = document.createElement('li');
          li.textContent = 'No hay productos seleccionados';
          li.style.fontStyle = 'italic';
          li.style.color = '#666';
          selectedProductsList.appendChild(li);
          return;
        }
        
        // Crear un elemento para cada producto seleccionado
        selectedProducts.forEach(productId => {
          const row = document.querySelector(`tr[data-product-id="${productId}"]`);
          if (row) {
            const productName = row.querySelector('.product-name').textContent;
            
            const li = document.createElement('li');
            li.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${productName}</span>
                <button type="button" class="btn-remove-product" data-product-id="${productId}">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
            
            // Agregar evento para quitar producto
            li.querySelector('.btn-remove-product').addEventListener('click', () => {
              selectedProducts.delete(productId);
              updateSelectedCount();
              displaySelectedProducts();
            });
            
            selectedProductsList.appendChild(li);
          }
        });
      }
      
      function updateSelectedCount() {
        if (selectedCount) {
          selectedCount.textContent = selectedProducts.size;
        }
      }
    }
    
    // Soporte para escaneo con pistola/cámara
    if (window.initBarcodeScanner) {
      window.initBarcodeScanner('#scanIcon', '#searchProducts');
    }
    
    // Manejo de código escaneado (para cualquier método de escaneo)
    window.onScannedBarcode = function(code) {
      if (searchInput) {
        searchInput.value = code;
        applyFilters();
      }
      
      // Buscar producto con código escaneado
      let found = false;
      document.querySelectorAll('#productsTableBody tr').forEach(row => {
        if (row.getAttribute('data-product-code') === code.toLowerCase()) {
          // Resaltar la fila
          row.style.transition = 'background-color 0.3s';
          row.style.backgroundColor = 'rgba(0, 122, 255, 0.2)';
          found = true;
          
          // Hacer scroll para que sea visible
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Quitar resaltado después de un tiempo
          setTimeout(() => {
            row.style.backgroundColor = '';
          }, 3000);
        }
      });
      
      if (found) {
        showNotification('Producto encontrado', 'success');
      } else {
        showNotification('No se encontró el producto con ese código', 'error');
      }
    };
    
    // Aplicar filtros iniciales
    applyFilters();
  });
</script>
{% endblock %}