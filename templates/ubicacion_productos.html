{% extends 'base.html' %}

{% block title %}Ubicaciones de Productos - OptiMax Manage{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Similar a descuentos.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales */
    --text-color: #1d1d1f;
    --text-secondary: #555555;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    
    /* Colores específicos de ubicaciones */
    --location-color: #4b6cb7;
    --location-hover: #3b5998;
    --location-light: rgba(75, 108, 183, 0.1);
    --location-apply-color: #4b6cb7;
    --location-remove-color: #F44336;
    --warning-color: #ff9800;
    
    --blue: #1a237e;
    --gray-300: #d1d1d6;
    --gray-500: #777777;
    --gray-600: #86868b;
    
    /* Colores de resaltado para búsqueda */
    --highlight-color: #FF0080;
    --highlight-background: rgba(255, 0, 128, 0.1);
  }

  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }

  /* Contenedor principal */
  .ubicaciones-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }

  /* Encabezado igual que descuentos.html */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-description {
    font-size: 17px;
    color: #86868b;
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
  }
  
  /* Botones de acción igual que descuentos.html */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }

  /* Panel de aplicar ubicaciones */
  .location-panel {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 50px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .panel-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Controles de ubicación */
  .location-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .location-target-selector {
    min-width: 200px;
  }

  .location-target-selector select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 36px;
  }

  .specific-selector {
    min-width: 200px;
    display: none;
  }

  .specific-selector select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 12px;
    padding-right: 36px;
  }

  .product-search-container {
    min-width: 250px;
    position: relative;
    display: none;
  }

  .product-search-input {
    width: 100%;
    padding: 10px 14px 10px 36px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px;
  }

  /* Estilo de resultados de búsqueda similar a descuentos.html */
  .product-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    margin-top: 4px;
    max-height: 350px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    display: none;
    padding: 0;
  }

  .product-search-result {
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: background-color 0.15s ease;
    border-bottom: 1px solid var(--light-background);
  }

  .product-search-result:hover {
    background-color: var(--light-background);
  }

  .product-search-result:active {
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  .product-search-result.active {
    background-color: var(--light-background);
    border-left: 3px solid var(--accent);
  }

  .product-search-result:last-child {
    border-bottom: none;
  }

  .product-result-image {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 6px;
    background-color: #f0f0f0;
    border: 1px solid #e5e5e5;
    padding: 2px;
  }

  .product-result-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .product-result-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--text-color);
    line-height: 1.3;
  }

  .product-result-details {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 1px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  
  /* Estilo para los detalles del producto */
  .product-result-sku {
    color: #777;
    font-size: 0.75rem;
    font-family: monospace;
    background-color: #f5f5f5;
    padding: 1px 4px;
    border-radius: 3px;
    display: inline-block;
  }
  
  /* Estilo para resaltar coincidencias en búsqueda */
  .search-highlight {
    color: var(--highlight-color);
    font-weight: bold;
    background-color: var(--highlight-background);
    padding: 0 2px;
    border-radius: 2px;
  }
  
  /* Estilo para el producto seleccionado */
  .selected-product-box {
    display: flex;
    align-items: center;
    background-color: #f0f7ff;
    border: 1px solid #c2e0ff;
    border-radius: 8px;
    padding: 10px 12px;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .selected-product-box img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    border-radius: 4px;
    margin-right: 10px;
  }
  
  .selected-product-info {
    flex: 1;
  }
  
  .selected-product-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-color);
  }
  
  .selected-product-code {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }
  
  .selected-product-remove {
    background: none;
    border: none;
    color: #d32f2f;
    font-size: 1.2rem;
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  
  .selected-product-remove:hover {
    background-color: rgba(211, 47, 47, 0.1);
  }

  .location-input-group {
    flex: 1;
    min-width: 200px;
    position: relative;
  }

  .location-input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    font-size: 0.9rem;
    font-family: var(--font-apple);
    background-color: white;
    color: var(--text-color);
  }

  .location-action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
  }

  .btn-apply-location {
    background-color: var(--location-apply-color);
    color: white;
  }

  .btn-apply-location:hover:not(:disabled) {
    background-color: var(--location-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(75, 108, 183, 0.3);
  }
  
  /* Estilo para botón disabled */
  .btn-apply-location:disabled,
  .btn-apply-location.disabled {
    background-color: #9E9E9E;
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  /* Botón de reparación de ubicaciones */
  .btn-fix-locations {
    background-color: var(--warning-color);
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    margin-bottom: 16px;
    border: none;
    box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
  }
  
  .btn-fix-locations:hover {
    background-color: #f57c00;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 152, 0, 0.4);
  }

  /* Sección Mis Ubicaciones */
  .my-locations-section {
    margin-top: 48px;
  }

  .section-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 24px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Usando el estilo de descuentos.html para las categorías de ubicaciones */
  .location-section {
    margin-bottom: 70px;
    border: 1px solid #eaeaea;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    background-color: #fafafa;
  }

  .location-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
    position: relative;
  }

  .location-title {
    font-size: 22px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
  }
  
  /* Fijamos posición para el botón de remover */
  .location-header .remove-location-btn {
    position: absolute;
    right: 0;
    top: 0;
  }

  .location-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: #eeeeee;
    color: #505050;
    font-size: 13px;
    font-weight: 600;
  }

  .location-value-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 6px;
    background-color: var(--location-light);
    color: var(--location-color);
    font-size: 14px;
    font-weight: 600;
  }
  
  /* Ver Todos Link en el encabezado */
  .view-all-header-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px;
    background-color: var(--accent);
    color: white;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    margin-left: 12px;
    box-shadow: 0 2px 4px rgba(229, 46, 46, 0.3);
    transition: all 0.2s ease;
  }
  
  /* Estilo especial para link de ubicación global */
  .view-all-header-link.global {
    background-color: #6c757d;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
  }
  
  .view-all-header-link:hover {
    background-color: var(--accent-hover);
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(229, 46, 46, 0.4);
  }
  
  .view-all-header-link.global:hover {
    background-color: #5a6268;
    box-shadow: 0 3px 6px rgba(90, 98, 104, 0.4);
  }
  
  .header-content {
    display: flex;
    align-items: center;
  }
  
  /* Slider para items de ubicación */
  .location-slider-container {
    position: relative;
    padding: 0 70px;
    margin: 0 -10px;
    overflow: hidden;
  }

  .location-slider {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 8px 4px 24px 4px;
    margin-bottom: 8px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scroll-snap-type: x mandatory;
  }
  
  /* Ocultar scrollbar pero permitir scroll */
  .location-slider::-webkit-scrollbar {
    height: 4px;
  }
  
  .location-slider::-webkit-scrollbar-thumb {
    background: var(--accent-light);
    border-radius: 4px;
  }
  
  /* Hacer que las tarjetas se alineen al hacer scroll */
  .product-card, .category-card, .brand-card {
    scroll-snap-align: start;
  }

  /* Category y Brand Cards */
  .category-card, .brand-card {
    flex: 0 0 220px;
    height: 360px;
    border-radius: 12px;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer; 
    text-decoration: none;
    position: relative;
    margin: 0 8px;
  }
  
  /* Estructura con espaciado fijo interno */
  .category-card-top, .brand-card-top {
    flex: 0 0 150px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  
  /* Estilo específico para el círculo de marca (siempre gris) */
  .brand-circle {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    margin-bottom: 15px;
    border: 2px solid white;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #888888 !important;
  }
  
  /* Ícono dentro de brand-circle - Color blanco */
  .brand-icon {
    font-size: 32px;
    color: white !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  /* Ícono dentro del círculo de color */
  .category-icon {
    font-size: 32px;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  .category-card-middle, .brand-card-middle {
    flex: 0 0 110px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
  }
  
  .category-card-bottom, .brand-card-bottom {
    margin-top: auto;
    width: 100%;
  }

  .category-card:hover, .brand-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }
  
  /* Círculo de color para la categoría */
  .category-color-circle {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    margin-bottom: 15px;
    border: 2px solid white;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .category-name, .brand-name {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 10px;
    color: var(--text-color);
    line-height: 1.3;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .category-details, .brand-details {
    text-align: center;
    font-size: 14px;
    color: var(--text-secondary);
    height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  
  /* Tarjeta de ubicación global */
  .global-location-card {
    flex: 0 0 95% !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    height: 300px !important;
    margin: 0 auto !important;
    padding: 25px !important;
    position: relative !important;
    text-align: center !important;
    text-decoration: none !important;
  }
  
  .global-location-card .global-icon-container {
    margin-bottom: 25px;
  }
  
  .global-location-card .global-circle {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background-color: var(--location-color);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }
  
  .global-location-card .global-icon {
    font-size: 30px;
    color: white;
  }
  
  .global-location-card .global-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--text-color);
  }
  
  .global-location-card .global-details {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    gap: 8px;
    margin-bottom: 30px;
    color: var(--text-secondary);
  }
  
  .global-location-card .global-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 6px;
    background-color: var(--location-light);
    color: var(--location-color);
    font-size: 14px;
    font-weight: 600;
  }
  
  .global-location-card .global-action {
    margin-top: 10px;
    width: 100%;
    max-width: 300px;
    display: flex;
    justify-content: center;
  }
  
  .global-location-card .remove-location-btn {
    background-color: var(--location-remove-color);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
  }
  
  .global-location-card .remove-location-btn:hover {
    background-color: #d32f2f;
    transform: translateY(-2px);
  }

  /* Product Cards */
  .product-card {
    flex: 0 0 220px;
    height: 360px;
    border-radius: 12px;
    overflow: hidden;
    background-color: white;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }

  .product-image-container {
    height: 140px;
    min-height: 140px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f8f8f8;
    padding: 5px;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .product-details {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .product-info-container {
    display: flex;
    flex-direction: column;
    height: 78px;
    margin-bottom: 10px;
    overflow: hidden;
    position: relative;
  }

  .product-name {
    font-size: 16px;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4;
    color: var(--text-color);
    height: 46px;
    margin-bottom: 0;
  }

  .product-brand {
    font-size: 13px;
    color: #606060;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }

  .product-location-container {
    height: 40px;
    margin-top: 10px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
  }

  .location-row {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .current-location {
    font-size: 16px;
    font-weight: 600;
    color: var(--location-color);
  }

  .location-label-small {
    background: var(--location-color);
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin-left: 8px;
  }

  .remove-location-btn {
    background-color: var(--location-remove-color);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: auto;
  }

  .remove-location-btn:hover {
    background-color: #d32f2f;
  }

  /* Botones de navegación del slider */
  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background-color: var(--accent);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(229, 46, 46, 0.4);
    z-index: 10;
    transition: all 0.2s ease;
  }

  .slider-arrow:hover {
    background-color: var(--accent-hover);
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 4px 12px rgba(229, 46, 46, 0.6);
  }

  .slider-arrow-left {
    left: 15px;
  }

  .slider-arrow-right {
    right: 15px;
  }

  .slider-arrow svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: white;
    stroke-width: 2.5;
  }

  /* Modal de confirmación */
  .custom-confirm {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .custom-confirm-box {
    background: white;
    border-radius: 16px;
    padding: 28px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  }

  .custom-confirm-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .warning-icon {
    color: var(--warning-color);
    font-size: 24px;
  }

  .custom-confirm-message {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .custom-confirm-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .custom-confirm-button {
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.95rem;
  }

  .custom-confirm-cancel {
    background: var(--light-background);
    color: var(--text-color);
  }

  .custom-confirm-cancel:hover {
    background: #e0e0e0;
  }

  .custom-confirm-ok {
    background: var(--warning-color);
    color: white;
  }

  .custom-confirm-ok:hover {
    background: #f57c00;
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    max-width: 400px;
  }

  .toast {
    background-color: #333;
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    margin-top: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
    opacity: 1;
    transition: all 0.3s ease;
  }

  .toast.success {
    background-color: #2ecc71;
  }

  .toast.error {
    background-color: #e74c3c;
  }

  .toast.warning {
    background-color: #f39c12;
  }

  /* Estado vacío */
  .empty-locations {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-style: italic;
  }
  
  /* Estilo para los mensajes de no se encontraron resultados */
  .no-results-message {
    padding: 14px;
    text-align: center;
    color: var(--text-secondary);
    font-style: italic;
    border-radius: 4px;
    background-color: #f9f9f9;
    margin: 10px 0;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .ubicaciones-container {
      padding: 24px 16px;
    }
    
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .location-controls {
      flex-direction: column;
      align-items: stretch;
    }
    
    .location-target-selector,
    .specific-selector,
    .product-search-container {
      width: 100%;
    }
    
    .location-slider {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 16px;
    }
    
    .product-card,
    .category-card,
    .brand-card {
      scroll-snap-align: start;
    }
    
    .location-slider-container {
      padding: 0;
    }
    
    .slider-arrow {
      display: none;
    }
  }
</style>

<div class="ubicaciones-container">
  <!-- Encabezado -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Ubicaciones de Productos</h1>
      <p class="page-description">Gestiona las ubicaciones físicas de tus productos de manera rápida y eficiente.</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>

  <!-- Panel de aplicar ubicaciones -->
  <div class="location-panel">
    <h3 class="panel-title">
      <i class="fas fa-map-marker-alt"></i>
      Aplicar ubicación
    </h3>
    
    <!-- Botón de reseteo de ubicaciones -->
    <div class="reset-locations-container" style="margin-top: 10px; margin-bottom: 20px;">
      <button id="resetAllLocationsBtn" class="btn-fix-locations">
        <i class="fas fa-exclamation-triangle"></i>
        Resetear todas las ubicaciones
      </button>
      <div class="info-text" style="margin-top: 8px; font-size: 12px; color: #666;">
        Utiliza este botón si experimentas problemas con ubicaciones duplicadas o inconsistentes.
      </div>
    </div>
    
    <div class="location-controls">
      <div class="location-target-selector">
        <select id="locationTarget">
          <option value="all">Aplicar a todos los productos</option>
          <option value="category">Aplicar por categoría</option>
          <option value="brand">Aplicar por marca</option>
          <option value="product">Aplicar a un producto</option>
        </select>
      </div>
      
      <div class="specific-selector" id="categorySelector">
        <select id="specificCategory">
          <option value="">Selecciona una categoría</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.nombre }}">{{ categoria.nombre|title }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="specific-selector" id="brandSelector">
        <select id="specificBrand">
          <option value="">Selecciona una marca</option>
          {% set brands = productos|map(attribute='marca')|unique|list %}
          {% for brand in brands %}
            {% if brand %}
              <option value="{{ brand }}">{{ brand }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <div class="product-search-container" id="productSearchContainer">
        <input type="text" class="product-search-input" id="productSearchInput" placeholder="Buscar por nombre o SKU...">
        <!-- Contenedor para producto seleccionado -->
        <div class="selected-product-box" id="selectedProductBox" style="display: none;">
          <img id="selectedProductImage" src="/static/img/default_product.jpg" alt="Producto seleccionado">
          <div class="selected-product-info">
            <div class="selected-product-name" id="selectedProductName">Nombre del producto</div>
            <div class="selected-product-code" id="selectedProductCode">SKU: ######</div>
          </div>
          <button type="button" class="selected-product-remove" id="selectedProductRemove">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="product-search-results" id="productSearchResults"></div>
        <input type="hidden" id="selectedProductId">
      </div>
      
      <div class="location-input-group">
        <input type="text" class="location-input" id="globalLocationValue" placeholder="Ej: Estante A, Bodega 2" required>
      </div>
      
      <button class="location-action-btn btn-apply-location" id="applyGlobalLocationBtn" onclick="applyGlobalLocation()">
        <i class="fas fa-check"></i>
        Aplicar
      </button>
    </div>
  </div>

  <!-- Sección Mis Ubicaciones -->
  <div class="my-locations-section" id="myLocationsSection" style="display: none;">
    <h2 class="section-title">
      <i class="fas fa-list"></i>
      Mis Ubicaciones
    </h2>

    <!-- Ubicación Global -->
    <div class="location-section" id="globalLocations" style="display: none;">
      <div class="location-header">
        <div class="header-content">
          <div class="location-title">
            Ubicación Global
            <span class="location-badge" id="globalLocationCount">0</span>
            <span class="location-value-badge" id="globalLocationValue">Estante A</span>
          </div>
          <span id="view-all-global-container"></span>
        </div>
      </div>
      <div class="location-slider-container">
        <div class="location-slider" id="slider-global">
          <!-- Productos se cargarán aquí -->
        </div>
      </div>
    </div>

    <!-- Ubicaciones por Categoría -->
    <div class="location-section" id="categoryLocations" style="display: none;">
      <div class="location-header">
        <div class="header-content">
          <div class="location-title">
            Por Categoría
            <span class="location-badge" id="categoryLocationCount">0</span>
          </div>
          <span id="view-all-category-container"></span>
        </div>
        <button class="remove-location-btn" onclick="removeAllCategoryLocations()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="location-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('category', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="location-slider" id="slider-category">
          <!-- Categorías se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('category', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Ubicaciones por Marca -->
    <div class="location-section" id="brandLocations" style="display: none;">
      <div class="location-header">
        <div class="header-content">
          <div class="location-title">
            Por Marca
            <span class="location-badge" id="brandLocationCount">0</span>
          </div>
          <span id="view-all-brand-container"></span>
        </div>
        <button class="remove-location-btn" onclick="removeAllBrandLocations()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="location-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('brand', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="location-slider" id="slider-brand">
          <!-- Marcas se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('brand', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Ubicaciones por Producto -->
    <div class="location-section" id="productLocations" style="display: none;">
      <div class="location-header">
        <div class="header-content">
          <div class="location-title">
            Por Producto
            <span class="location-badge" id="productLocationCount">0</span>
          </div>
          <span id="view-all-product-container"></span>
        </div>
        <button class="remove-location-btn" onclick="removeAllProductLocations()">
          <i class="fas fa-times"></i>
          Quitar todos
        </button>
      </div>
      <div class="location-slider-container">
        <div class="slider-arrow slider-arrow-left" onclick="scrollSlider('product', 'left')">
          <svg viewBox="0 0 24 24">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="location-slider" id="slider-product">
          <!-- Productos se cargarán aquí -->
        </div>
        <div class="slider-arrow slider-arrow-right" onclick="scrollSlider('product', 'right')">
          <svg viewBox="0 0 24 24">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Notificaciones -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  // Estado global para controlar ubicaciones
  let activeLocations = {
    global: false,
    categories: new Set(),
    brands: new Set(),
    products: new Set(),
    globalDetails: null,
    categoryDetails: {},
    brandDetails: {},
    locationValues: {}  // Para guardar valores de ubicación
  };
  
  // Cache de datos
  let productosCache = null;
  
  // Inicialización
  
document.addEventListener('DOMContentLoaded', function() {
    productosCache = {{ productos|tojson }};
    
    // Asegurar que todos los productos tengan los nuevos campos incluso si faltan
    productosCache.forEach(producto => {
      // Si no existen los campos, inicializarlos
      if (producto.ubicacion_tipo === undefined) {
        producto.ubicacion_tipo = null;
      }
      if (producto.ubicacion_grupo === undefined) {
        producto.ubicacion_grupo = null;
      }
    });
    
    initializeLocationPanel();
    
    // Verificar ubicaciones existentes
    checkExistingLocations();
    
    initializeProductSearch();
    
    // Mostrar alerta si se detectan productos sin ubicacion_tipo
    const productosSinTipo = productosCache.filter(p => 
      p.ubicacion && !p.ubicacion_tipo
    );
    
    if (productosSinTipo.length > 0) {
      showToast(`Se detectaron ${productosSinTipo.length} productos con ubicación pero sin tipo asignado. Usa el botón "Resetear todas las ubicaciones" para corregir.`, 'warning');
    }
  });
  
  // Configurar panel de ubicaciones
  function initializeLocationPanel() {
    const locationTarget = document.getElementById('locationTarget');
    const categorySelector = document.getElementById('categorySelector');
    const brandSelector = document.getElementById('brandSelector');
    const productSearchContainer = document.getElementById('productSearchContainer');
    const applyButton = document.getElementById('applyGlobalLocationBtn');
    const selectedProductBox = document.getElementById('selectedProductBox');
    const searchInput = document.getElementById('productSearchInput');
    
    locationTarget.addEventListener('change', function() {
      // Ocultar todos primero
      categorySelector.style.display = 'none';
      brandSelector.style.display = 'none';
      productSearchContainer.style.display = 'none';
      
      // Si hay un producto seleccionado, limpiar la selección al cambiar el target
      if (selectedProductBox && selectedProductBox.style.display === 'flex') {
        clearProductSelection();
      }
      
      // Mostrar el selector correspondiente
      switch(this.value) {
        case 'category':
          categorySelector.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-tag"></i> Aplicar';
          break;
        case 'brand':
          brandSelector.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-trademark"></i> Aplicar';
          break;
        case 'product':
          productSearchContainer.style.display = 'block';
          applyButton.innerHTML = '<i class="fas fa-box"></i> Aplicar';
          
          // Asegurarse de que el input de búsqueda sea visible (no el cuadro de selección)
          if (searchInput && selectedProductBox) {
            searchInput.style.display = 'block';
            selectedProductBox.style.display = 'none';
          }
          break;
        default:
          applyButton.innerHTML = '<i class="fas fa-check"></i> Aplicar';
          break;
      }
      
      // Actualizar estado del botón
      updateApplyButtonState();
    });
  }
  
  // Función para resaltar coincidencias en búsqueda
  function highlightMatch(text, query) {
    if (!text || !query || query.trim() === '') return text;
    
    // Normalizar texto y query para una búsqueda insensible a acentos/mayúsculas
    const normalizeString = (str) => {
      return str.normalize("NFD")
               .replace(/[\u0300-\u036f]/g, "")
               .toLowerCase();
    };
    
    const normalizedText = normalizeString(text);
    const normalizedQuery = normalizeString(query);
    
    // Encontrar dónde ocurre la coincidencia en el texto normalizado
    const index = normalizedText.indexOf(normalizedQuery);
    if (index === -1) return text;
    
    // Extraer la parte del texto original que coincide (mantiene acentos/mayúsculas)
    const before = text.substring(0, index);
    const match = text.substring(index, index + query.length);
    const after = text.substring(index + query.length);
    
    // Retornar con el texto resaltado usando una clase CSS
    return before + '<span class="search-highlight">' + match + '</span>' + after;
  }
  
  // Inicializar búsqueda de productos
  function initializeProductSearch() {
    const searchInput = document.getElementById('productSearchInput');
    const resultsContainer = document.getElementById('productSearchResults');
    const selectedBox = document.getElementById('selectedProductBox');
    const applyButton = document.getElementById('applyGlobalLocationBtn');
    
    // Listener para el botón de quitar producto seleccionado
    const removeBtn = document.getElementById('selectedProductRemove');
    if (removeBtn) {
      removeBtn.addEventListener('click', clearProductSelection);
    }
    
    // Cache para optimizar búsquedas repetidas
    const searchCache = new Map();
    
    // Debounce para evitar muchas llamadas al escribir rápido
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      // Usar caché si existe para esta consulta
      if (searchCache.has(query)) {
        displaySearchResults(searchCache.get(query), query);
        return;
      }
      
      // Debounce de 150ms para no afectar rendimiento
      searchTimeout = setTimeout(() => {
        const results = searchProducts(query);
        // Guardar en caché para futuras búsquedas
        searchCache.set(query, results);
        displaySearchResults(results, query);
      }, 150);
    });
    
    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
        resultsContainer.style.display = 'none';
      }
    });
    
    // Manejar eventos de teclado para navegación
    searchInput.addEventListener('keydown', function(e) {
      if (!resultsContainer.style.display || resultsContainer.style.display === 'none') {
        return;
      }
      
      const items = resultsContainer.querySelectorAll('.product-search-result');
      if (!items.length) return;
      
      // Encontrar el elemento actualmente activo
      let currentIndex = -1;
      for (let i = 0; i < items.length; i++) {
        if (items[i].classList.contains('active')) {
          currentIndex = i;
          break;
        }
      }
      
      // Manejar teclas de flecha y Enter
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          if (currentIndex < 0) {
            items[0].classList.add('active');
          } else {
            items[currentIndex].classList.remove('active');
            items[(currentIndex + 1) % items.length].classList.add('active');
          }
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          if (currentIndex < 0) {
            items[items.length - 1].classList.add('active');
          } else {
            items[currentIndex].classList.remove('active');
            items[(currentIndex - 1 + items.length) % items.length].classList.add('active');
          }
          break;
          
        case 'Enter':
          if (currentIndex >= 0) {
            e.preventDefault();
            items[currentIndex].click();
          }
          break;
          
        case 'Escape':
          e.preventDefault();
          resultsContainer.style.display = 'none';
          break;
      }
    });
    
    // Verificar estado del botón Aplicar cuando se cambia el target
    const locationTarget = document.getElementById('locationTarget');
    if (locationTarget) {
      locationTarget.addEventListener('change', updateApplyButtonState);
    }
    
    // Inicializar estado del botón
    updateApplyButtonState();
  }
  
  // Actualizar estado del botón Aplicar
  function updateApplyButtonState() {
    const locationTarget = document.getElementById('locationTarget');
    const applyButton = document.getElementById('applyGlobalLocationBtn');
    const selectedProductId = document.getElementById('selectedProductId');
    
    if (!locationTarget || !applyButton) return;
    
    // Si el target es 'product', verificar si hay un producto seleccionado
    if (locationTarget.value === 'product') {
      const hasSelection = selectedProductId && selectedProductId.value;
      applyButton.disabled = !hasSelection;
      
      // Añadir/quitar clase visual
      if (hasSelection) {
        applyButton.classList.remove('disabled');
      } else {
        applyButton.classList.add('disabled');
      }
    } else {
      // Para otros targets, habilitar siempre
      applyButton.disabled = false;
      applyButton.classList.remove('disabled');
    }
  }
  
  // Buscar productos en cache
  function searchProducts(query) {
    if (!query || query.trim().length < 2) return [];
    
    const queryLower = query.toLowerCase().trim();
    
    // Función para normalizar texto (quitar acentos para mejores coincidencias)
    const normalizeText = (text) => {
      if (!text) return '';
      return text.normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
    };
    
    // Buscar coincidencias en nombre y SKU (no en marca)
    return productosCache.filter(product => {
      if (!product) return false;
      
      const normalizedName = normalizeText(product.nombre || '');
      const normalizedSku = normalizeText(product.codigo_barras_externo || '');
      
      // Buscar coincidencias por SKU o nombre (peso diferente)
      const skuMatch = normalizedSku.includes(normalizeText(queryLower));
      const nameMatch = normalizedName.includes(normalizeText(queryLower));
      
      // Si coincide con cualquiera, incluir en resultados
      return skuMatch || nameMatch;
    })
    // Ordenar primero los que coinciden con SKU, luego por nombre
    .sort((a, b) => {
      const aSkuMatch = (a.codigo_barras_externo || '').toLowerCase().includes(queryLower);
      const bSkuMatch = (b.codigo_barras_externo || '').toLowerCase().includes(queryLower);
      
      // Primero, ordenar por coincidencia de SKU (más relevante)
      if (aSkuMatch && !bSkuMatch) return -1;
      if (!aSkuMatch && bSkuMatch) return 1;
      
      // Luego, por coincidencia exacta en el nombre
      const aExactMatch = (a.nombre || '').toLowerCase() === queryLower;
      const bExactMatch = (b.nombre || '').toLowerCase() === queryLower;
      if (aExactMatch && !bExactMatch) return -1;
      if (!aExactMatch && bExactMatch) return 1;
      
      // Por último, ordenar alfabéticamente
      return (a.nombre || '').localeCompare(b.nombre || '');
    })
    // Limitar resultados para mejor rendimiento
    .slice(0, 8);
  }
  
  // Mostrar resultados de búsqueda
  function displaySearchResults(results, query) {
    const resultsContainer = document.getElementById('productSearchResults');
    
    if (!resultsContainer) return;
    
    if (results.length === 0) {
      resultsContainer.innerHTML = `
        <div class="no-results-message">
          No se encontraron productos que coincidan con "${query}"
        </div>`;
      resultsContainer.style.display = 'block';
      return;
    }
    
    const html = results.map(product => {
      // Resaltar coincidencias en nombre y SKU
      const highlightedName = highlightMatch(product.nombre || '', query);
      const highlightedSku = highlightMatch(product.codigo_barras_externo || '', query);
      
      // Mostrar información de ubicación si existe
      const locationInfo = product.ubicacion 
        ? `<span style="color: var(--location-color); font-size: 0.8rem; margin-left: 5px;">
            (${product.ubicacion})
           </span>` 
        : '';
      
      return `
        <div class="product-search-result" 
             onclick="selectProduct(${product.id}, '${(product.nombre || '').replace(/'/g, '\\\'')}')">
          <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
               alt="${product.nombre}" 
               class="product-result-image"
               onerror="this.src='/static/img/default_product.jpg'">
          <div class="product-result-info">
            <div class="product-result-name">
              ${highlightedName} ${locationInfo}
            </div>
            <div class="product-result-details">
              <span class="product-result-sku">SKU: ${highlightedSku}</span>
              ${product.categoria ? `<span>${product.categoria}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
  }
  
  // Seleccionar producto de búsqueda
  function selectProduct(productId, productName) {
    const searchInput = document.getElementById('productSearchInput');
    const resultsContainer = document.getElementById('productSearchResults');
    const selectedProductId = document.getElementById('selectedProductId');
    const selectedBox = document.getElementById('selectedProductBox');
    const selectedNameEl = document.getElementById('selectedProductName');
    const selectedCodeEl = document.getElementById('selectedProductCode');
    const selectedImageEl = document.getElementById('selectedProductImage');
    
    // Obtener datos completos del producto
    const product = productosCache.find(p => p.id == productId);
    if (!product) return;
    
    // Actualizar elementos ocultos
    selectedProductId.value = productId;
    
    // Actualizar interfaz
    if (selectedBox && selectedNameEl && selectedCodeEl) {
      // Mostrar el cuadro de selección
      selectedNameEl.textContent = product.nombre || productName;
      selectedCodeEl.textContent = `SKU: ${product.codigo_barras_externo || 'N/A'}`;
      
      // Actualizar imagen si existe
      if (selectedImageEl) {
        selectedImageEl.src = product.foto ? 
          `/static/uploads/${product.foto}` : 
          '/static/img/default_product.jpg';
      }
      
      // Ocultar input y mostrar cuadro de selección
      searchInput.style.display = 'none';
      selectedBox.style.display = 'flex';
    }
    
    // Ocultar resultados
    resultsContainer.style.display = 'none';
    
    // Actualizar estado del botón Aplicar
    updateApplyButtonState();
  }
  
  // Función para limpiar la selección de producto
  function clearProductSelection() {
    const searchInput = document.getElementById('productSearchInput');
    const selectedBox = document.getElementById('selectedProductBox');
    const selectedProductId = document.getElementById('selectedProductId');
    
    // Limpiar ID seleccionado
    if (selectedProductId) {
      selectedProductId.value = '';
    }
    
    // Ocultar cuadro de selección y mostrar input
    if (selectedBox && searchInput) {
      selectedBox.style.display = 'none';
      searchInput.style.display = 'block';
      searchInput.value = '';
      searchInput.focus();
    }
    
    // Actualizar estado del botón Aplicar
    updateApplyButtonState();
  }
  
  // FUNCIÓN PARA OBTENER ESTADO DE UBICACIONES ACTIVAS DESDE LA API
  function checkExistingLocations() {
    console.log("Consultando API para obtener ubicaciones activas...");
    fetch('/api/get_active_locations')
      .then(response => {
        // Verificar si la respuesta es válida
        if (!response.ok) {
          throw new Error(`Error de red: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("Respuesta de API:", data);
        if (data.success) {
          // Limpiar el estado actual
          activeLocations = {
            global: false,
            categories: new Set(),
            brands: new Set(),
            products: new Set(),
            globalDetails: null,
            categoryDetails: {},
            brandDetails: {},
            locationValues: {}
          };
          
          const locations = data.active_locations;
          
          // Actualizar el estado global con los datos de la API
          activeLocations.global = locations.global;
          activeLocations.locationValues = locations.location_values || {};
          
          // Añadir categorías con ubicación
          locations.categorias.forEach(category => {
            activeLocations.categories.add(category);
          });
          
          // Añadir marcas con ubicación
          locations.marcas.forEach(brand => {
            activeLocations.brands.add(brand);
          });
          
          // Identificar productos individuales basados en ubicacion_tipo
          if (locations.individuales > 0) {
            // Buscar productos con ubicación individual
            productosCache.forEach(product => {
              if (product.ubicacion && product.ubicacion_tipo === 'individual') {
                activeLocations.products.add(product.id);
              }
            });
          }
          
          // Guardar conteos de productos si están disponibles
          if (locations.conteos) {
            activeLocations.conteos = locations.conteos;
          }
          
          console.log("Estado de ubicaciones actualizado:", activeLocations);
          
          // Actualizar UI
          updateMyLocationsSection();
        } else {
          console.error('Error al obtener ubicaciones activas:', data.message);
          // Fallback: si hay error, intentar detectar por cuenta propia
          detectLocationsByProducts();
        }
      })
      .catch(error => {
        console.error('Error al obtener estado de ubicaciones:', error);
        // Si falla la API, intentamos detectar por nuestros propios medios
        detectLocationsByProducts();
      });
  }
  
  // FALLBACK: Detectar ubicaciones manualmente en caso de que la API falle
  function detectLocationsByProducts() {
    console.log("Ejecutando detección manual de ubicaciones...");
    // Limpiamos el estado actual
    activeLocations = {
      global: false,
      categories: new Set(),
      brands: new Set(),
      products: new Set(),
      globalDetails: null,
      categoryDetails: {},
      brandDetails: {},
      locationValues: {}
    };
    
    // Ahora usamos los campos ubicacion_tipo y ubicacion_grupo
    productosCache.forEach(producto => {
      if (!producto.ubicacion) return;
      
      // Si el producto tiene los campos, usarlos directamente
      if (producto.ubicacion_tipo) {
        switch (producto.ubicacion_tipo) {
          case 'global':
            activeLocations.global = true;
            if (!activeLocations.locationValues['global']) {
              activeLocations.locationValues['global'] = producto.ubicacion;
            }
            break;
            
          case 'categoria':
            if (producto.ubicacion_grupo) {
              activeLocations.categories.add(producto.ubicacion_grupo);
              if (!activeLocations.locationValues[producto.ubicacion_grupo]) {
                activeLocations.locationValues[producto.ubicacion_grupo] = producto.ubicacion;
              }
            }
            break;
            
          case 'marca':
            if (producto.ubicacion_grupo) {
              activeLocations.brands.add(producto.ubicacion_grupo);
              if (!activeLocations.locationValues[producto.ubicacion_grupo]) {
                activeLocations.locationValues[producto.ubicacion_grupo] = producto.ubicacion;
              }
            }
            break;
            
          case 'individual':
            activeLocations.products.add(producto.id);
            break;
        }
      } else {
        // Si no tiene los campos, fallback a la lógica anterior
        console.log('Fallback a lógica antigua: Producto sin ubicacion_tipo', producto.id);
        activeLocations.products.add(producto.id);
      }
    });
    
    console.log("Detección manual completada:", activeLocations);
    
    // Actualizar UI
    updateMyLocationsSection();
  }
  
  // Actualizar sección "Mis Ubicaciones"
  function updateMyLocationsSection() {
    const section = document.getElementById('myLocationsSection');
    const globalContainer = document.getElementById('globalLocations');
    const categoryContainer = document.getElementById('categoryLocations');
    const productContainer = document.getElementById('productLocations');
    const brandContainer = document.getElementById('brandLocations');
    
    // Verificar si hay cualquier tipo de ubicación activa
    const hasLocations = activeLocations.global || 
                        activeLocations.categories.size > 0 || 
                        activeLocations.products.size > 0 || 
                        activeLocations.brands.size > 0;
    
    section.style.display = hasLocations ? 'block' : 'none';
    
    // Actualizar listas
    updateGlobalLocationsList();
    updateCategoryLocationsList();
    updateProductLocationsList();
    updateBrandLocationsList();
    
    // Mostrar/ocultar contenedores según haya ubicación
    globalContainer.style.display = activeLocations.global ? 'block' : 'none';
    categoryContainer.style.display = activeLocations.categories.size > 0 ? 'block' : 'none';
    brandContainer.style.display = activeLocations.brands.size > 0 ? 'block' : 'none';
    productContainer.style.display = activeLocations.products.size > 0 ? 'block' : 'none';
    
    // Inicializar el estado de las flechas de navegación
    setTimeout(() => {
      initSliderArrows();
    }, 500);
  }
  
  function updateGlobalLocationsList() {
    const container = document.getElementById('slider-global');
    const countElement = document.getElementById('globalLocationCount');
    const valueElement = document.getElementById('globalLocationValue');
    const viewAllContainer = document.getElementById('view-all-global-container');
    
    // Limpiar el contenedor "Ver todos"
    if (viewAllContainer) {
      viewAllContainer.innerHTML = '';
    }
    
    if (!activeLocations.global) {
      container.innerHTML = '<div class="empty-locations">No hay ubicación global</div>';
      countElement.textContent = '0';
      valueElement.textContent = 'N/A';
      return;
    }
    
    // Usar el conteo proporcionado por la API si está disponible
    let productCount = 0;
    
    if (activeLocations.conteos && activeLocations.conteos.global !== undefined) {
      productCount = activeLocations.conteos.global;
    } else {
      // Fallback: contar productos con ubicación global
      let globalProducts = [];
      productosCache.forEach(p => {
        if (p.ubicacion_tipo === 'global') {
          globalProducts.push(p);
        }
      });
      productCount = globalProducts.length;
    }
    
    const globalLocationValue = activeLocations.locationValues['global'] || '';
    
    countElement.textContent = productCount;
    valueElement.textContent = globalLocationValue;
    
    // Estructura HTML para la tarjeta global
    const url = '/ubicacion-detalle/global/all';
    container.innerHTML = `
      <a href="${url}" class="global-location-card">
        <div class="global-icon-container">
          <div class="global-circle">
            <i class="fas fa-map-marker-alt global-icon"></i>
          </div>
        </div>
        <div class="global-title">Ubicación Global</div>
        <div class="global-details">
          ${productCount} productos en
          <span class="global-badge">${globalLocationValue}</span>
        </div>
        <div class="global-action">
          <button class="remove-location-btn" onclick="event.preventDefault(); event.stopPropagation(); removeGlobalLocation()">
            <i class="fas fa-times"></i>
            Quitar
          </button>
        </div>
      </a>
    `;
    
    // Añadir enlace "Ver todos" si hay muchos productos
    if (productCount > 10 && viewAllContainer) {
      const viewAllLink = document.createElement('a');
      viewAllLink.href = url;
      viewAllLink.className = 'view-all-header-link global';
      viewAllLink.innerHTML = `Ver todos (${productCount})`;
      viewAllContainer.appendChild(viewAllLink);
    }
  }
  
  function updateCategoryLocationsList() {
    const container = document.getElementById('slider-category');
    const countElement = document.getElementById('categoryLocationCount');
    const viewAllContainer = document.getElementById('view-all-category-container');
    
    // Limpiar el contenedor "Ver todos"
    if (viewAllContainer) {
      viewAllContainer.innerHTML = '';
    }
    
    countElement.textContent = activeLocations.categories.size;
    
    if (activeLocations.categories.size === 0) {
      container.innerHTML = '<div class="empty-locations">No hay ubicaciones por categoría</div>';
      return;
    }
    
    const items = Array.from(activeLocations.categories).map(category => {
      // Obtener conteo de productos de la API si está disponible
      let productCount = 0;
      
      if (activeLocations.conteos && 
          activeLocations.conteos.categorias && 
          activeLocations.conteos.categorias[category] !== undefined) {
        productCount = activeLocations.conteos.categorias[category];
      } else {
        // Fallback: contar productos con ubicación por categoría
        const categoryProducts = productosCache.filter(p => 
          p.categoria === category && p.ubicacion_tipo === 'categoria'
        );
        productCount = categoryProducts.length;
      }
      
      const locationValue = activeLocations.locationValues[category] || "";
      
      const encodedCategory = encodeURIComponent(category);
      
      // Obtener color de categoría
      let categoryColor = "#6B7280";
      
      // Buscar producto con esta categoría para obtener su color
      const categoryProduct = productosCache.find(p => p.categoria === category && p.categoria_color);
      if (categoryProduct && categoryProduct.categoria_color) {
        categoryColor = categoryProduct.categoria_color;
      }
      
      // Asignar un icono específico según la categoría
      let categoryIcon = 'box';
      
      if (category.includes('abarrotes')) categoryIcon = 'shopping-basket';
      else if (category.includes('enlatados') || category.includes('conservas')) categoryIcon = 'archive';
      else if (category.includes('snacks') || category.includes('botanas') || category.includes('dulces')) categoryIcon = 'cookie-bite';
      else if (category.includes('bebidas') && category.includes('alcohólicas')) categoryIcon = 'wine-glass-alt';
      else if (category.includes('bebidas')) categoryIcon = 'coffee';
      else if (category.includes('panadería') || category.includes('repostería')) categoryIcon = 'bread-slice';
      else if (category.includes('lácteos') || category.includes('huevos')) categoryIcon = 'egg';
      else if (category.includes('carnes')) categoryIcon = 'drumstick-bite';
      else if (category.includes('congelados') || category.includes('refrigerados')) categoryIcon = 'snowflake';
      else if (category.includes('frutas') || category.includes('verduras')) categoryIcon = 'apple-alt';
      else if (category.includes('limpieza')) categoryIcon = 'broom';
      else if (category.includes('cuidado') || category.includes('higiene')) categoryIcon = 'shower';
      else if (category.includes('medicamentos')) categoryIcon = 'pills';
      else if (category.includes('bebés')) categoryIcon = 'baby';
      else if (category.includes('mascotas')) categoryIcon = 'paw';
      else if (category.includes('papelería')) categoryIcon = 'pencil-alt';
      else if (category.includes('ferretería')) categoryIcon = 'tools';
      else if (category.includes('artesanías') || category.includes('manualidades')) categoryIcon = 'palette';
      else if (category.includes('granel')) categoryIcon = 'weight-hanging';
      else if (category.includes('orgánicos')) categoryIcon = 'leaf';
      else if (category.includes('gourmet')) categoryIcon = 'utensils';
      else if (category.includes('suplementos')) categoryIcon = 'capsules';
      
      return `
        <a href="/ubicacion-detalle/categoria/${encodedCategory}" class="category-card">
          <div class="category-card-top">
            <div class="category-color-circle" style="background-color: ${categoryColor};">
              <i class="fas fa-${categoryIcon} category-icon"></i>
            </div>
          </div>
          <div class="category-card-middle">
            <div class="category-name">${category}</div>
            <div class="category-details">
              ${productCount} productos<br>
              <span class="location-value-badge">${locationValue}</span>
            </div>
          </div>
          <div class="category-card-bottom">
            <button class="remove-location-btn" onclick="event.preventDefault(); event.stopPropagation(); removeCategoryLocation('${category.replace(/'/g, '\\\'')}')" style="width: 100%;">
              <i class="fas fa-times"></i>
              Quitar
            </button>
          </div>
        </a>
      `;
    }).join('');
    
    container.innerHTML = items;
    
    // Añadir enlace "Ver todos" si hay muchas categorías
    if (activeLocations.categories.size > 10 && viewAllContainer) {
      const viewAllLink = document.createElement('a');
      viewAllLink.href = '/ubicacion-detalle/categoria/all';
      viewAllLink.className = 'view-all-header-link';
      viewAllLink.innerHTML = `Ver todas (${activeLocations.categories.size})`;
      viewAllContainer.appendChild(viewAllLink);
    }
  }
  
  function updateBrandLocationsList() {
    const container = document.getElementById('slider-brand');
    const countElement = document.getElementById('brandLocationCount');
    const viewAllContainer = document.getElementById('view-all-brand-container');
    
    // Limpiar el contenedor "Ver todos"
    if (viewAllContainer) {
      viewAllContainer.innerHTML = '';
    }
    
    countElement.textContent = activeLocations.brands.size;
    
    if (activeLocations.brands.size === 0) {
      container.innerHTML = '<div class="empty-locations">No hay ubicaciones por marca</div>';
      return;
    }
    
    const items = Array.from(activeLocations.brands).map(brand => {
      // Obtener conteo de productos de la API si está disponible
      let productCount = 0;
      
      if (activeLocations.conteos && 
          activeLocations.conteos.marcas && 
          activeLocations.conteos.marcas[brand] !== undefined) {
        productCount = activeLocations.conteos.marcas[brand];
      } else {
        // Fallback: contar productos con ubicación por marca
        const brandProducts = productosCache.filter(p => 
          p.marca === brand && p.ubicacion_tipo === 'marca'
        );
        productCount = brandProducts.length;
      }
      
      const locationValue = activeLocations.locationValues[brand] || "";
      
      const encodedBrand = encodeURIComponent(brand);
      
      return `
        <a href="/ubicacion-detalle/marca/${encodedBrand}" class="brand-card">
          <div class="category-card-top">
            <div class="brand-circle">
              <i class="far fa-bookmark brand-icon"></i>
            </div>
          </div>
          <div class="category-card-middle">
            <div class="brand-name">${brand}</div>
            <div class="brand-details">
              ${productCount} productos<br>
              <span class="location-value-badge">${locationValue}</span>
            </div>
          </div>
          <div class="category-card-bottom">
            <button class="remove-location-btn" onclick="event.preventDefault(); event.stopPropagation(); removeBrandLocation('${brand.replace(/'/g, '\\\'')}')" style="width: 100%;">
              <i class="fas fa-times"></i>
              Quitar
            </button>
          </div>
        </a>
      `;
    }).join('');
    
    container.innerHTML = items;
    
    // Añadir enlace "Ver todos" si hay muchas marcas
    if (activeLocations.brands.size > 10 && viewAllContainer) {
      const viewAllLink = document.createElement('a');
      viewAllLink.href = '/ubicacion-detalle/marca/all';
      viewAllLink.className = 'view-all-header-link';
      viewAllLink.innerHTML = `Ver todas (${activeLocations.brands.size})`;
      viewAllContainer.appendChild(viewAllLink);
    }
  }
  
  function updateProductLocationsList() {
    const container = document.getElementById('slider-product');
    const countElement = document.getElementById('productLocationCount');
    const viewAllContainer = document.getElementById('view-all-product-container');
    
    // Limpiar el contenedor "Ver todos"
    if (viewAllContainer) {
      viewAllContainer.innerHTML = '';
    }
    
    // Filtrar solo productos con ubicación individual
    let individualProducts = [];
    
    // Usamos ubicacion_tipo para identificar productos individuales
    productosCache.forEach(product => {
      if (product.ubicacion && product.ubicacion_tipo === 'individual') {
        individualProducts.push(product);
      }
    });
    
    countElement.textContent = individualProducts.length;
    
    if (individualProducts.length === 0) {
      container.innerHTML = '<div class="empty-locations">No hay ubicaciones individuales</div>';
      document.getElementById('productLocations').style.display = 'none';
      return;
    }
    
    document.getElementById('productLocations').style.display = 'block';
    const items = individualProducts.map(product => createProductCard(product, true)).join('');
    container.innerHTML = items;
    
    // Añadir enlace "Ver todos" si hay muchos productos
    if (individualProducts.length > 10 && viewAllContainer) {
      const viewAllLink = document.createElement('a');
      viewAllLink.href = '/ubicacion-detalle/individual/all';
      viewAllLink.className = 'view-all-header-link';
      viewAllLink.innerHTML = `Ver todos (${individualProducts.length})`;
      viewAllContainer.appendChild(viewAllLink);
    }
  }
  
  // Crear tarjeta de producto
  function createProductCard(product, withRemoveButton = false) {
    const removeButton = withRemoveButton ? `
      <button class="remove-location-btn" onclick="removeProductLocation(${product.id})" style="width: 100%; margin-top: auto;">
        <i class="fas fa-times"></i>
        Quitar ubicación
      </button>
    ` : '';
    
    return `
      <div class="product-card">
        <div class="product-image-container">
          <img src="${product.foto ? '/static/uploads/' + product.foto : '/static/img/default_product.jpg'}" 
               alt="${product.nombre}" 
               class="product-image">
        </div>
        <div class="product-details">
          <div class="product-info-container">
            <div class="product-name">${product.nombre}</div>
            <div class="product-brand">${product.marca || 'Sin marca'}</div>
          </div>
          <div class="product-location-container">
            <div class="location-row">
              <div class="current-location">
                ${product.ubicacion || 'Sin ubicación'}
              </div>
              <div class="location-label-small">
                <i class="fas fa-map-marker-alt"></i>
              </div>
            </div>
          </div>
          ${removeButton}
        </div>
      </div>
    `;
  }
  
  // Aplicar ubicación global
  function applyGlobalLocation() {
    const target = document.getElementById('locationTarget').value;
    const locationValue = document.getElementById('globalLocationValue').value.trim();
    
    if (!locationValue) {
      showToast('Por favor ingresa una ubicación válida', 'error');
      return;
    }
    
    console.log("Aplicando ubicación:", { target, locationValue });
    
    // Verificar conflictos
    checkForLocationConflicts(target, locationValue);
  }
  
  // Verificar conflictos antes de aplicar ubicación
  function checkForLocationConflicts(target, locationValue) {
    const category = document.getElementById('specificCategory').value;
    const brand = document.getElementById('specificBrand').value;
    const productId = document.getElementById('selectedProductId').value;
    
    let conflictingProducts = [];
    let conflictMessage = '';
    
    switch(target) {
      case 'all':
        if (activeLocations.global) {
          conflictMessage = 'Todos los productos ya tienen una ubicación global aplicada. ¿Deseas reemplazarla?';
          conflictingProducts = productosCache.filter(p => p.ubicacion);
        } else if (activeLocations.categories.size > 0 || activeLocations.brands.size > 0 || activeLocations.products.size > 0) {
          conflictMessage = 'Algunos productos ya tienen ubicaciones aplicadas. ¿Deseas sobreescribirlas con la ubicación global?';
          conflictingProducts = productosCache.filter(p => p.ubicacion);
        }
        break;
        
      case 'category':
        if (!category) {
          showToast('Por favor selecciona una categoría', 'error');
          return;
        }
        
        const categoryProducts = productosCache.filter(p => p.categoria === category);
        conflictingProducts = categoryProducts.filter(p => p.ubicacion);
        
        if (conflictingProducts.length > 0) {
          if (activeLocations.global) {
            conflictMessage = `Esta categoría forma parte de la ubicación global. ¿Deseas aplicar la nueva ubicación a estos ${conflictingProducts.length} productos?`;
          } else if (activeLocations.categories.has(category)) {
            conflictMessage = `Esta categoría ya tiene una ubicación aplicada. ¿Deseas reemplazarla?`;
          } else {
            conflictMessage = `Algunos productos de esta categoría ya tienen ubicaciones aplicadas. ¿Deseas sobreescribirlas?`;
          }
        }
        break;
        
      case 'brand':
        if (!brand) {
          showToast('Por favor selecciona una marca', 'error');
          return;
        }
        
        const brandProducts = productosCache.filter(p => p.marca === brand);
        conflictingProducts = brandProducts.filter(p => p.ubicacion);
        
        if (conflictingProducts.length > 0) {
          if (activeLocations.global) {
            conflictMessage = `Esta marca forma parte de la ubicación global. ¿Deseas aplicar la nueva ubicación a estos ${conflictingProducts.length} productos?`;
          } else if (activeLocations.brands.has(brand)) {
            conflictMessage = `Esta marca ya tiene una ubicación aplicada. ¿Deseas reemplazarla?`;
          } else {
            conflictMessage = `Algunos productos de esta marca ya tienen ubicaciones aplicadas. ¿Deseas sobreescribirlas?`;
          }
        }
        break;
        
      case 'product':
        if (!productId) {
          showToast('Por favor selecciona un producto', 'error');
          return;
        }
        
        const product = productosCache.find(p => p.id == productId);
        if (product && product.ubicacion) {
          conflictingProducts = [product];
          conflictMessage = `Este producto ya tiene una ubicación aplicada. ¿Deseas reemplazarla?`;
        }
        break;
    }
    
    // Si hay conflictos, mostrar confirmación
    if (conflictingProducts.length > 0) {
      showConfirmDialog(
        'Conflicto de ubicaciones',
        conflictMessage,
        function() {
          // Proceder con la aplicación de la ubicación
          proceedWithLocation(target, locationValue);
        }
      );
    } else {
      // No hay conflictos, aplicar directamente
      proceedWithLocation(target, locationValue);
    }
  }
  
  // Mostrar diálogo de confirmación
  function showConfirmDialog(title, message, onConfirm) {
    // Crear el modal dinámicamente
    const modal = document.createElement('div');
    modal.className = 'custom-confirm';
    modal.innerHTML = `
      <div class="custom-confirm-box">
        <div class="custom-confirm-title">
          <i class="fas fa-exclamation-triangle warning-icon"></i>
          ${title}
        </div>
        <div class="custom-confirm-message">${message}</div>
        <div class="custom-confirm-buttons">
          <button class="custom-confirm-button custom-confirm-cancel">Cancelar</button>
          <button class="custom-confirm-button custom-confirm-ok">Sobreescribir</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Agregar eventos
    modal.querySelector('.custom-confirm-cancel').addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    modal.querySelector('.custom-confirm-ok').addEventListener('click', function() {
      document.body.removeChild(modal);
      onConfirm();
    });
  }
  
  // Proceder con la aplicación de la ubicación
  function proceedWithLocation(target, locationValue) {
    // Mostrar indicador de carga
    showToast(`Aplicando ubicación "${locationValue}"...`, 'warning');
    
    switch(target) {
      case 'all':
        applyLocationToAll(locationValue);
        break;
      case 'category':
        const category = document.getElementById('specificCategory').value;
        applyLocationToCategory(category, locationValue);
        break;
      case 'brand':
        const brand = document.getElementById('specificBrand').value;
        applyLocationToBrand(brand, locationValue);
        break;
      case 'product':
        const productId = document.getElementById('selectedProductId').value;
        applyLocationToSingleProduct(productId, locationValue);
        break;
    }
  }
  
  // Aplicar ubicación a todos los productos
  function applyLocationToAll(locationValue) {
    // Verificar si hay al menos un producto para aplicar ubicación global
    if (productosCache.length === 0) {
      showToast('No hay productos para aplicar ubicación global', 'error');
      return;
    }
    
    // Mostrar indicador de carga
    showToast('Aplicando ubicación global...', 'warning');
    
    console.log("Enviando petición para aplicar ubicación global:", locationValue);
    
    // Llamar a la API para aplicar ubicación masiva a todos los productos
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: locationValue,
        global: true
      })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local - TODOS los productos
        productosCache.forEach(p => {
          p.ubicacion = locationValue;
          p.ubicacion_tipo = 'global';
          p.ubicacion_grupo = null;
        });
        
        // Limpiar el estado actual y establecer solo global
        activeLocations = {
          global: true,
          categories: new Set(),
          brands: new Set(),
          products: new Set(),
          globalDetails: productosCache.slice(), // Todos los productos
          categoryDetails: {},
          brandDetails: {},
          locationValues: {
            'global': locationValue
          }
        };
        
        // Actualizar UI
        updateMyLocationsSection();
        
        showToast(`Ubicación global "${locationValue}" aplicada a ${data.count} productos`, 'success');
      } else {
        throw new Error(data.message || 'Error al aplicar ubicación global');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Aplicar ubicación a categoría
  function applyLocationToCategory(category, locationValue) {
    if (!category) {
      showToast('Por favor selecciona una categoría', 'error');
      return;
    }
    
    const categoryProducts = productosCache.filter(p => p.categoria === category);
    
    if (categoryProducts.length === 0) {
      showToast(`No hay productos en la categoría "${category}"`, 'error');
      return;
    }
    
    // Mostrar indicador de carga
    showToast(`Aplicando ubicación a categoría "${category}"...`, 'warning');
    
    console.log("Enviando petición para aplicar ubicación a categoría:", { category, locationValue });
    
    // Llamar a la API para aplicar ubicación masiva a la categoría
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: locationValue,
        categoria: category
      })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local de los productos
        categoryProducts.forEach(p => {
          p.ubicacion = locationValue;
          p.ubicacion_tipo = 'categoria';
          p.ubicacion_grupo = category;
        });
        
        // Actualizar esta categoría como última asignación
        activeLocations.categories.add(category);
        activeLocations.locationValues[category] = locationValue;
        activeLocations.categoryDetails[category] = categoryProducts.slice();
        
        // Actualizar UI
        checkExistingLocations(); // Refrescar completamente las ubicaciones desde la API
        
        showToast(`Ubicación "${locationValue}" aplicada a ${data.count} productos de la categoría "${category}"`, 'success');
      } else {
        throw new Error(data.message || 'Error al aplicar ubicación a la categoría');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Aplicar ubicación a marca
  function applyLocationToBrand(brand, locationValue) {
    if (!brand) {
      showToast('Por favor selecciona una marca', 'error');
      return;
    }
    
    const brandProducts = productosCache.filter(p => p.marca === brand);
    
    if (brandProducts.length === 0) {
      showToast(`No hay productos de la marca "${brand}"`, 'error');
      return;
    }
    
    // Mostrar indicador de carga
    showToast(`Aplicando ubicación a marca "${brand}"...`, 'warning');
    
    console.log("Enviando petición para aplicar ubicación a marca:", { brand, locationValue });
    
    // Llamar a la API para aplicar ubicación masiva a la marca
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: locationValue,
        marca: brand
      })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local
        brandProducts.forEach(p => {
          p.ubicacion = locationValue;
          p.ubicacion_tipo = 'marca';
          p.ubicacion_grupo = brand;
        });
        
        // Actualizar esta marca como última asignación
        activeLocations.brands.add(brand);
        activeLocations.locationValues[brand] = locationValue;
        activeLocations.brandDetails[brand] = brandProducts.slice();
        
        // Actualizar UI
        checkExistingLocations(); // Refrescar completamente las ubicaciones desde la API
        
        showToast(`Ubicación "${locationValue}" aplicada a ${data.count} productos de la marca "${brand}"`, 'success');
      } else {
        throw new Error(data.message || 'Error al aplicar ubicación a la marca');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Aplicar ubicación a producto individual
  function applyLocationToSingleProduct(productId, locationValue) {
    if (!productId) {
      showToast('Por favor selecciona un producto', 'error');
      return;
    }
    
    const product = productosCache.find(p => p.id == productId);
    
    if (!product) {
      showToast('No se encontró el producto seleccionado', 'error');
      return;
    }
    
    // Mostrar indicador de carga
    showToast(`Aplicando ubicación a producto "${product.nombre}"...`, 'warning');
    
    console.log("Enviando petición para actualizar ubicación de producto:", { productId, locationValue });
    
    // Llamar a la API para actualizar la ubicación del producto
    fetch(`/api/actualizar-ubicacion/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ubicacion: locationValue })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local
        product.ubicacion = locationValue;
        product.ubicacion_tipo = 'individual';
        product.ubicacion_grupo = null;
        
        // Actualizar estado como producto individual
        activeLocations.products.add(parseInt(productId));
        
        // Actualizar UI
        checkExistingLocations(); // Refrescar completamente las ubicaciones desde la API
        
        // Limpiar selección de producto
        clearProductSelection();
        
        showToast(`Ubicación "${locationValue}" aplicada al producto "${product.nombre}"`, 'success');
      } else {
        throw new Error(data.message || 'Error al aplicar ubicación al producto');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Remover ubicación global
  function removeGlobalLocation() {
    if (!activeLocations.global) {
      showToast('No hay ubicación global para remover', 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast('Removiendo ubicación global...', 'warning');
    
    console.log("Enviando petición para remover ubicación global");
    
    // Llamar a la API para remover ubicación global (estableciendo ubicación vacía)
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: '',
        global: true,
        remove: true
      })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local
        productosCache.forEach(p => {
          if (p.ubicacion_tipo === 'global') {
            p.ubicacion = '';
            p.ubicacion_tipo = null;
            p.ubicacion_grupo = null;
          }
        });
        
        // Actualizar estado global
        activeLocations.global = false;
        activeLocations.globalDetails = null;
        delete activeLocations.locationValues['global'];
        
        // Actualizar UI
        updateMyLocationsSection();
        
        showToast(`Ubicación global removida de ${data.count} productos`, 'success');
      } else {
        throw new Error(data.message || 'Error al remover ubicación global');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Remover ubicación de categoría
  function removeCategoryLocation(category) {
    if (!activeLocations.categories.has(category)) {
      showToast(`No hay ubicación para la categoría "${category}"`, 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast(`Removiendo ubicación de categoría "${category}"...`, 'warning');
    
    console.log("Enviando petición para remover ubicación de categoría:", category);
    
    // Llamar a la API para remover ubicación de la categoría
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: '',
        categoria: category,
        remove: true
      })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local
        productosCache.forEach(p => {
          if (p.categoria === category && p.ubicacion_tipo === 'categoria') {
            p.ubicacion = '';
            p.ubicacion_tipo = null;
            p.ubicacion_grupo = null;
          }
        });
        
        // Actualizar estado global
        activeLocations.categories.delete(category);
        delete activeLocations.locationValues[category];
        delete activeLocations.categoryDetails[category];
        
        // Actualizar UI
        updateMyLocationsSection();
        
        showToast(`Ubicación removida de ${data.count} productos de la categoría "${category}"`, 'success');
      } else {
        throw new Error(data.message || 'Error al remover ubicación de la categoría');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Remover ubicación de marca
  function removeBrandLocation(brand) {
    if (!activeLocations.brands.has(brand)) {
      showToast(`No hay ubicación para la marca "${brand}"`, 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast(`Removiendo ubicación de marca "${brand}"...`, 'warning');
    
    console.log("Enviando petición para remover ubicación de marca:", brand);
    
    // Llamar a la API para remover ubicación de la marca
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: '',
        marca: brand,
        remove: true
      })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local
        productosCache.forEach(p => {
          if (p.marca === brand && p.ubicacion_tipo === 'marca') {
            p.ubicacion = '';
            p.ubicacion_tipo = null;
            p.ubicacion_grupo = null;
          }
        });
        
        // Actualizar estado global
        activeLocations.brands.delete(brand);
        delete activeLocations.locationValues[brand];
        delete activeLocations.brandDetails[brand];
        
        // Actualizar UI
        updateMyLocationsSection();
        
        showToast(`Ubicación removida de ${data.count} productos de la marca "${brand}"`, 'success');
      } else {
        throw new Error(data.message || 'Error al remover ubicación de la marca');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Remover ubicación de producto
  function removeProductLocation(productId) {
    const product = productosCache.find(p => p.id == productId);
    
    if (!product || !product.ubicacion) {
      showToast('El producto no tiene ubicación para remover', 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast(`Removiendo ubicación de producto "${product.nombre}"...`, 'warning');
    
    console.log("Enviando petición para remover ubicación de producto:", productId);
    
    // Llamar a la API para remover ubicación del producto
    fetch(`/api/actualizar-ubicacion/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ubicacion: '' })
    })
    .then(response => {
      console.log("Respuesta recibida:", response.status);
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);
      if (data.success) {
        // Actualizar estado local
        product.ubicacion = '';
        product.ubicacion_tipo = null;
        product.ubicacion_grupo = null;
        
        // Actualizar estado global
        activeLocations.products.delete(parseInt(productId));
        
        // Actualizar UI
        updateMyLocationsSection();
        
        showToast(`Ubicación removida del producto "${product.nombre}"`, 'success');
      } else {
        throw new Error(data.message || 'Error al remover ubicación del producto');
      }
    })
    .catch(error => {
      console.error("Error completo:", error);
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Remover todas las ubicaciones de categoría
  function removeAllCategoryLocations() {
    if (activeLocations.categories.size === 0) {
      showToast('No hay ubicaciones por categoría para remover', 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast('Removiendo todas las ubicaciones por categoría...', 'warning');
    
    // Obtener todas las categorías con ubicación
    const categoriasConUbicacion = Array.from(activeLocations.categories);
    let categoriasCompletadas = 0;
    let totalProductosActualizados = 0;
    
    // Función para procesar categorías una por una
    function procesarSiguienteCategoria(index) {
      if (index >= categoriasConUbicacion.length) {
        // Terminamos de procesar todas las categorías
        showToast(`Se removieron ubicaciones de ${totalProductosActualizados} productos en todas las categorías`, 'success');
        return;
      }
      
      const categoria = categoriasConUbicacion[index];
      
      // Llamar a la API para remover ubicación de esta categoría
      fetch('/api/actualizar-ubicacion-masiva', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ubicacion: '',
          categoria: categoria,
          remove: true
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar estado local
          productosCache.forEach(p => {
            if (p.categoria === categoria && p.ubicacion_tipo === 'categoria') {
              p.ubicacion = '';
              p.ubicacion_tipo = null;
              p.ubicacion_grupo = null;
            }
          });
          
          // Actualizar estado global
          activeLocations.categories.delete(categoria);
          delete activeLocations.locationValues[categoria];
          delete activeLocations.categoryDetails[categoria];
          
          // Sumar al total
          totalProductosActualizados += data.count;
          categoriasCompletadas++;
          
          // Procesar la siguiente categoría
          procesarSiguienteCategoria(index + 1);
        } else {
          throw new Error(data.message || 'Error al remover ubicación de la categoría');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message, 'error');
        // Intentar continuar con la siguiente categoría a pesar del error
        procesarSiguienteCategoria(index + 1);
      });
    }
    
    // Iniciar el proceso con la primera categoría
    procesarSiguienteCategoria(0);
    
    // Actualizar UI después de que termine el proceso
    setTimeout(() => {
      updateMyLocationsSection();
    }, 500);
  }
  
  // Remover todas las ubicaciones de marca
  function removeAllBrandLocations() {
    if (activeLocations.brands.size === 0) {
      showToast('No hay ubicaciones por marca para remover', 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast('Removiendo todas las ubicaciones por marca...', 'warning');
    
    // Obtener todas las marcas con ubicación
    const marcasConUbicacion = Array.from(activeLocations.brands);
    let marcasCompletadas = 0;
    let totalProductosActualizados = 0;
    
    // Función para procesar marcas una por una
    function procesarSiguienteMarca(index) {
      if (index >= marcasConUbicacion.length) {
        // Terminamos de procesar todas las marcas
        showToast(`Se removieron ubicaciones de ${totalProductosActualizados} productos en todas las marcas`, 'success');
        return;
      }
      
      const marca = marcasConUbicacion[index];
      
      // Llamar a la API para remover ubicación de esta marca
      fetch('/api/actualizar-ubicacion-masiva', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ubicacion: '',
          marca: marca,
          remove: true
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar estado local
          productosCache.forEach(p => {
            if (p.marca === marca && p.ubicacion_tipo === 'marca') {
              p.ubicacion = '';
              p.ubicacion_tipo = null;
              p.ubicacion_grupo = null;
            }
          });
          
          // Actualizar estado global
          activeLocations.brands.delete(marca);
          delete activeLocations.locationValues[marca];
          delete activeLocations.brandDetails[marca];
          
          // Sumar al total
          totalProductosActualizados += data.count;
          marcasCompletadas++;
          
          // Procesar la siguiente marca
          procesarSiguienteMarca(index + 1);
        } else {
          throw new Error(data.message || 'Error al remover ubicación de la marca');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message, 'error');
        // Intentar continuar con la siguiente marca a pesar del error
        procesarSiguienteMarca(index + 1);
      });
    }
    
    // Iniciar el proceso con la primera marca
    procesarSiguienteMarca(0);
    
    // Actualizar UI después de que termine el proceso
    setTimeout(() => {
      updateMyLocationsSection();
    }, 500);
  }
  
  // Remover todas las ubicaciones individuales
  function removeAllProductLocations() {
    if (activeLocations.products.size === 0) {
      showToast('No hay ubicaciones individuales para remover', 'warning');
      return;
    }
    
    // Mostrar indicador de carga
    showToast('Removiendo todas las ubicaciones individuales...', 'warning');
    
    // Obtener todos los IDs de productos con ubicación individual
    const productosIndividuales = Array.from(activeLocations.products);
    
    // Llamar a la API para remover ubicación de estos productos
    fetch('/api/actualizar-ubicacion-masiva', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ubicacion: '',
        producto_ids: productosIndividuales,
        remove: true
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Actualizar estado local
        productosIndividuales.forEach(productId => {
          const product = productosCache.find(p => p.id == productId);
          if (product) {
            product.ubicacion = '';
            product.ubicacion_tipo = null;
            product.ubicacion_grupo = null;
          }
        });
        
        // Limpiar estado global
        activeLocations.products.clear();
        
        // Actualizar UI
        updateMyLocationsSection();
        
        showToast(`Ubicaciones removidas de ${data.count} productos individuales`, 'success');
      } else {
        throw new Error(data.message || 'Error al remover ubicaciones individuales');
      }
    })
    .catch(error => {
      showToast('Error: ' + error.message, 'error');
    });
  }
  
  // Función para navegar sliders
  function scrollSlider(sliderId, direction) {
    const slider = document.getElementById(`slider-${sliderId}`);
    if (!slider) return;
    
    // Ajustar tamaño de scroll según el tipo de tarjeta
    let cardWidth = 0;
    
    if (sliderId === 'category' || sliderId === 'brand') {
      cardWidth = 240; // 220px + 20px gap
    } else if (sliderId === 'global' || sliderId === 'product') {
      cardWidth = 240; // 220px + 20px gap
    } else {
      cardWidth = 240; // Valor por defecto
    }
    
    // Scroll de 3 tarjetas a la vez (o menos si el slider es pequeño)
    const visibleWidth = slider.clientWidth;
    const scrollAmount = Math.min(cardWidth * 3, visibleWidth * 0.8);
    
    // Calcular desplazamiento actual y total
    const scrollLeft = slider.scrollLeft;
    const scrollWidth = slider.scrollWidth;
    
    if (direction === 'left') {
      // Si estamos cerca del inicio, ir al principio
      if (scrollLeft < scrollAmount) {
        slider.scrollTo({ left: 0, behavior: 'smooth' });
      } else {
        slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      }
    } else {
      // Si estamos cerca del final, ir al final
      if (scrollLeft + visibleWidth + scrollAmount > scrollWidth) {
        slider.scrollTo({ left: scrollWidth, behavior: 'smooth' });
      } else {
        slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      }
    }
    
    // Verificar si se necesitan mostrar/ocultar botones de navegación
    setTimeout(() => {
      updateSliderArrows(sliderId);
    }, 300);
  }
  
  // Función para actualizar visibilidad de flechas de navegación
  function updateSliderArrows(sliderId) {
    const slider = document.getElementById(`slider-${sliderId}`);
    if (!slider) return;
    
    const leftArrow = slider.parentElement.querySelector('.slider-arrow-left');
    const rightArrow = slider.parentElement.querySelector('.slider-arrow-right');
    
    if (!leftArrow || !rightArrow) return;
    
    // Mostrar/ocultar flecha izquierda según posición de scroll
    if (slider.scrollLeft <= 10) {
      leftArrow.style.opacity = '0.5';
    } else {
      leftArrow.style.opacity = '1';
    }
    
    // Mostrar/ocultar flecha derecha según posición de scroll
    if (slider.scrollLeft + slider.clientWidth >= slider.scrollWidth - 10) {
      rightArrow.style.opacity = '0.5';
    } else {
      rightArrow.style.opacity = '1';
    }
  }
  
  // Inicializar estado de flechas después de cargar contenido
  function initSliderArrows() {
    ['global', 'category', 'brand', 'product'].forEach(sliderId => {
      updateSliderArrows(sliderId);
      
      // Añadir listener para actualizar flechas durante scroll manual
      const slider = document.getElementById(`slider-${sliderId}`);
      if (slider) {
        slider.addEventListener('scroll', () => {
          updateSliderArrows(sliderId);
        });
      }
    });
  }
  
  // Sistema de notificaciones
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    if (type === 'warning') icon = 'exclamation-triangle';
    
    toast.innerHTML = `
      <i class="fas fa-${icon}"></i>
      <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('fade-out');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
  
  // Inicializar botón de reseteo
  document.getElementById('resetAllLocationsBtn').addEventListener('click', function() {
    if (confirm('¿Estás seguro de que deseas eliminar TODAS las ubicaciones? Esta acción no se puede deshacer.')) {
      // Mostrar indicador de carga
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reseteando...';
      this.disabled = true;
      
      // Llamar a la API para resetear todas las ubicaciones
      fetch('/api/reset-product-locations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Se han reseteado ${data.count} ubicaciones correctamente`, 'success');
          // Recargar la página después de 1 segundo
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          throw new Error(data.message || 'Error al resetear ubicaciones');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message, 'error');
        // Restaurar botón
        this.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Resetear todas las ubicaciones';
        this.disabled = false;
      });
    }
  });
</script>
{% endblock %}