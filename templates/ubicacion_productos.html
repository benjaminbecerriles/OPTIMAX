{% extends 'base.html' %}

{% block title %}Ubicación de Productos - OptiMax{% endblock %}

{% block content %}
<style>
  /* Sistema de Diseño Apple - Consistente con cambiar_precios.html */
  :root {
    --font-apple: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', Helvetica, Arial, sans-serif;
    
    /* Colores esenciales - TEXTO OSCURECIDO */
    --text-color: #1d1d1f;
    --text-secondary: #515154;
    --background: #ffffff;
    --light-background: #f5f5f7;
    --separator: rgba(0, 0, 0, 0.1);
    --accent: #e52e2e;
    --accent-hover: #c51818;
    --accent-light: rgba(229, 46, 46, 0.1);
    --save-btn-color: #ff6b6b;
    --save-btn-hover: #ff5252;
    --blue: #1a237e;
    --location-color: #3498db;
    
    /* Colores de estado */
    --green: #2ecc71;
    --orange: #f39c12;
    --red: #e74c3c;
  }
  
  body {
    font-family: var(--font-apple);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    color: var(--text-color);
    background-color: var(--background);
  }
  
  /* Contenedor principal */
  .apple-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 36px 24px;
  }
  
  /* Encabezado de página - Igual a cambiar_precios.html */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
  }
  
  .header-title-container {
    display: flex;
    flex-direction: column;
  }
  
  .page-title {
    font-size: 32px;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin: 0;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .page-description {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: 28px;
    max-width: 600px;
    font-weight: 400;
  }
  
  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 8px;
    align-items: center;
  }
  
  /* Botón volver estilo ajuste_stock.html */
  .btn-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    border-radius: 980px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
    border: none;
    height: 44px;
    white-space: nowrap;
  }
  
  .btn-action i, 
  .btn-action span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    line-height: 1;
  }
  
  /* Botón Volver estilo */
  .btn-volver {
    background-color: var(--blue);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(26, 35, 126, 0.3);
  }
  
  .btn-volver:hover {
    background-color: #151c64;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(26, 35, 126, 0.4);
    color: #ffffff;
  }
  
  /* Botón asignar masivamente */
  .btn-assign {
    background-color: var(--accent);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(229, 46, 46, 0.3);
  }
  
  .btn-assign:hover {
    background-color: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(229, 46, 46, 0.4);
    color: #ffffff;
  }
  
  /* Barra de búsqueda - Igual a cambiar_precios.html */
  .search-container {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 60px;
    position: relative;
    align-items: center;
  }
  
  .search-box {
    flex: 1;
    position: relative;
  }
  
  .search-box i {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1.1rem;
    z-index: 5;
    pointer-events: none;
  }
  
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 1rem;
    height: 48px;
    transition: all 0.2s ease;
    font-weight: 400;
    background-color: var(--light-background);
  }
  
  .search-box input:focus {
    background-color: white;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(229, 46, 46, 0.15);
    outline: none;
  }
  
  .search-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .filter-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--light-background);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 0 16px;
    height: 48px;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .filter-container:hover {
    background-color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .filter-container.active {
    background-color: rgba(52, 152, 219, 0.1);
    border-color: var(--location-color);
  }
  
  .filter-container span {
    font-size: 0.95rem;
    font-weight: 500;
  }
  
  .filter-check-input {
    display: none;
  }
  
  /* Categorías - Estilo de cambiar_precios.html */
  .category-section {
    margin-bottom: 70px;
    border: 1px solid #eaeaea;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    background-color: #fafafa;
  }
  
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .category-title {
    font-size: 22px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
  }
  
  .category-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: #eeeeee;
    color: #505050;
    font-size: 13px;
    font-weight: 600;
  }
  
  .category-color-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
  }
  
  /* Productos - Diseño mejorado */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
    gap: 18px;
    margin-top: 20px;
  }
  
  .product-card {
    background-color: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    display: flex;
    flex-direction: column;
    height: 300px;
    position: relative;
  }
  
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.08);
  }
  
  .product-image-container {
    height: 120px;
    min-height: 120px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f8f8f8;
    padding: 5px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .product-details {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .product-info-container {
    height: 64px;
    margin-bottom: 10px;
    overflow: hidden;
    position: relative;
  }
  
  .product-name {
    font-size: 15px;
    font-weight: 600;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4;
    color: var(--text-color);
    height: 42px;
    margin-bottom: 0;
  }
  
  .product-code {
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 4px;
  }
  
  /* Ubicación y controles */
  .location-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 5px;
  }
  
  .location-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
  }
  
  .location-display {
    font-size: 15px;
    font-weight: 500;
    padding: 6px 0;
    color: var(--location-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .location-display.empty {
    color: var(--text-secondary);
    font-style: italic;
    opacity: 0.7;
  }
  
  .location-input-container {
    display: none;
    flex-direction: column;
    gap: 8px;
  }
  
  .location-input-group {
    position: relative;
    display: flex;
    flex-direction: column;
  }
  
  .location-input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid var(--location-color);
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
  }
  
  .location-input:focus {
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  .suggestions-container {
    margin-top: 2px;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .location-input:focus + .suggestions-container {
    max-height: 60px;
  }
  
  .location-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    padding-top: 5px;
  }
  
  .suggestion-chip {
    font-size: 11px;
    padding: 3px 8px;
    background-color: #eef5fb;
    border: 1px solid #d6e9f8;
    border-radius: 12px;
    cursor: pointer;
    white-space: nowrap;
  }
  
  .suggestion-chip:hover {
    background-color: #d6e9f8;
  }
  
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: flex-end;
    padding-top: 5px;
  }
  
  .btn-edit, .btn-save, .btn-cancel {
    width: 34px;
    height: 34px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-edit {
    background-color: #eef5fb;
    color: var(--location-color);
  }
  
  .btn-save {
    background-color: rgba(46, 204, 113, 0.15);
    color: var(--green);
    display: none;
  }
  
  .btn-cancel {
    background-color: rgba(231, 76, 60, 0.15);
    color: var(--red);
    display: none;
  }
  
  .btn-edit:hover, .btn-save:hover, .btn-cancel:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  /* Toast notificaciones */
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }
  
  .toast {
    background-color: #333;
    color: white;
    padding: 14px 20px;
    border-radius: 8px;
    margin-top: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
    max-width: 350px;
    font-weight: 500;
  }
  
  .toast.success {
    background-color: var(--green);
  }
  
  .toast.error {
    background-color: var(--red);
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }
  
  /* Estado vacío */
  .empty-state {
    padding: 50px 0;
    text-align: center;
    background-color: var(--light-background);
    border-radius: 12px;
    margin-bottom: 36px;
  }
  
  .empty-icon {
    font-size: 32px;
    color: var(--text-secondary);
    margin-bottom: 14px;
  }
  
  .empty-message {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .btn-reset {
    display: inline-block;
    background-color: white;
    color: var(--text-color);
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    padding: 12px 28px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    text-decoration: none;
    margin-top: 5px;
  }
  
  .btn-reset:hover {
    background-color: #f5f5f7;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transform: translateY(-1px);
  }
  
  /* Animaciones */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .animated-fade {
    animation: fadeIn 0.3s ease-out;
  }
  
  /* Modal para asignación masiva */
  .modal-content {
    border-radius: 12px;
    overflow: hidden;
    border: none;
  }
  
  .modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid var(--separator);
    padding: 16px 20px;
  }
  
  .modal-title {
    font-weight: 600;
    font-size: 18px;
    color: var(--text-color);
  }
  
  .modal-body {
    padding: 20px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    font-weight: 500;
    margin-bottom: 8px;
    color: var(--text-color);
  }
  
  .form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.2s ease;
  }
  
  .form-control:focus {
    border-color: var(--location-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    outline: none;
  }
  
  .selection-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 10px;
  }
  
  .option-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  
  .text-muted {
    color: var(--text-secondary);
    font-size: 13px;
    margin-top: 5px;
  }
  
  .product-items-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 10px;
  }
  
  .product-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .product-item:last-child {
    border-bottom: none;
  }
  
  .category-select, .location-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    font-size: 15px;
    background-color: white;
  }
  
  .modal-footer {
    border-top: 1px solid var(--separator);
    padding: 16px 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .btn-secondary {
    padding: 8px 16px;
    border-radius: 6px;
    background-color: #f5f5f7;
    border: 1px solid #d1d1d6;
    color: var(--text-color);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-primary {
    padding: 8px 16px;
    border-radius: 6px;
    background-color: var(--accent);
    border: none;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-primary:hover {
    background-color: var(--accent-hover);
    transform: translateY(-1px);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
    }
    
    .product-grid {
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
    
    .search-container {
      flex-direction: column;
      align-items: stretch;
    }
  }
  
  @media (max-width: 480px) {
    .product-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="apple-container animated-fade">
  <!-- ESTRUCTURA DE ENCABEZADO IGUAL A CAMBIAR_PRECIOS.HTML -->
  <div class="page-header">
    <div class="header-title-container">
      <h1 class="page-title">Ubicación de Productos</h1>
      <p class="page-description">Define dónde se encuentran físicamente tus productos para facilitar su localización</p>
    </div>
    <div class="header-actions">
      <!-- Botón para asignación masiva -->
      <button type="button" class="btn-action btn-assign" data-bs-toggle="modal" data-bs-target="#ubicacionMasivaModal">
        <i class="fas fa-tags"></i>
        <span>Asignación masiva</span>
      </button>
      
      <!-- Botón Volver -->
      <a href="{{ url_for('dashboard_inventario') }}" class="btn-action btn-volver">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </a>
    </div>
  </div>
  
  <!-- Barra de búsqueda adaptada al estilo de cambiar_precios.html -->
  <div class="search-container">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar por nombre o código de barras...">
    </div>
    <div class="search-actions">
      <!-- Filtro solo sin ubicación -->
      <div class="filter-container" id="emptyLocationContainer">
        <input class="filter-check-input" type="checkbox" id="emptyLocationCheck">
        <i class="fas fa-map-marker-alt" style="color: var(--location-color);"></i>
        <span style="font-size: 0.95rem; font-weight: 500;">Sin ubicación</span>
      </div>
    </div>
  </div>
  
  <!-- Contenedor para categorías y productos -->
  <div id="categoriesContainer">
    {% if categorias and categorias|length > 0 %}
      {# Ordenar categorías por cantidad de productos (mayor a menor) #}
      {% set categorias_ordenadas = [] %}
      {% for categoria in categorias %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        {% if productos_categoria|length > 0 %}
          {% set _ = categorias_ordenadas.append({'nombre': categoria.nombre, 'color': categoria.color, 'count': productos_categoria|length}) %}
        {% endif %}
      {% endfor %}
      {% set categorias_ordenadas = categorias_ordenadas|sort(attribute='count', reverse=true) %}
      
      {% for categoria in categorias_ordenadas %}
        {% set productos_categoria = productos|selectattr('categoria', 'equalto', categoria.nombre)|list %}
        <div class="category-section" data-category="{{ categoria.nombre|lower }}">
          <div class="category-header">
            <h2 class="category-title">
              <span class="category-color-dot" style="background-color: {{ categoria.color }}"></span>
              {{ categoria.nombre|title }}
              <span class="category-badge">{{ productos_categoria|length }}</span>
            </h2>
          </div>
          
          <div class="product-grid">
            {% for producto in productos_categoria %}
              <div class="product-card" 
                   data-product-id="{{ producto.id }}" 
                   data-product-name="{{ producto.nombre|lower }}" 
                   data-product-barcode="{{ producto.codigo_barras_externo|lower if producto.codigo_barras_externo else '' }}"
                   data-has-location="{{ '1' if producto.ubicacion else '0' }}">
                <div class="product-image-container">
                  {% if producto.foto %}
                    <img src="{{ url_for('static', filename='uploads/' ~ producto.foto) }}" class="product-image" alt="{{ producto.nombre }}">
                  {% else %}
                    <div class="product-image" style="display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-box" style="color: var(--text-secondary);"></i>
                    </div>
                  {% endif %}
                </div>
                <div class="product-details">
                  <div class="product-info-container">
                    <div class="product-name">{{ producto.nombre }}</div>
                    <div class="product-code">{{ producto.codigo_barras_externo or 'SKU-' ~ '%05d'|format(producto.id) }}</div>
                  </div>
                  
                  <div class="location-container">
                    <div class="location-label">Ubicación:</div>
                    <div class="location-display {% if not producto.ubicacion %}empty{% endif %}">
                      {{ producto.ubicacion or 'Sin asignar' }}
                    </div>
                    
                    <div class="location-input-container">
                      <div class="location-input-group">
                        <input type="text" class="location-input" value="{{ producto.ubicacion or '' }}" placeholder="Ej: Estante A, Bodega 2">
                        <div class="suggestions-container">
                          <div class="location-suggestions">
                            {% for ubicacion in ubicaciones %}
                              <div class="suggestion-chip">{{ ubicacion }}</div>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="action-buttons">
                      <button type="button" class="btn-edit" title="Editar ubicación">
                        <i class="fas fa-pencil-alt"></i>
                      </button>
                      <button type="button" class="btn-save" title="Guardar">
                        <i class="fas fa-check"></i>
                      </button>
                      <button type="button" class="btn-cancel" title="Cancelar">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <!-- Estado vacío -->
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <p class="empty-message">No hay productos en tu inventario</p>
        <a href="{{ url_for('nuevo_producto') }}" class="button-link" style="display: inline-block; padding: 10px 20px; background-color: var(--accent); color: white; text-decoration: none; border-radius: 6px; margin-top: 16px;">
          Agregar producto
        </a>
      </div>
    {% endif %}
  </div>
  
  <!-- Paginación -->
  {% if total_pages and total_pages > 1 %}
    <div class="pagination-container">
      <div class="pagination">
        {% if page > 1 %}
          <a href="{{ url_for('ubicacion_productos', page=page-1) }}" class="pagination-item">
            <i class="fas fa-chevron-left"></i>
          </a>
        {% endif %}
        
        {% for p in range(1, total_pages + 1) %}
          <a href="{{ url_for('ubicacion_productos', page=p) }}" class="pagination-item {% if p == page %}active{% endif %}">
            {{ p }}
          </a>
        {% endfor %}
        
        {% if page < total_pages %}
          <a href="{{ url_for('ubicacion_productos', page=page+1) }}" class="pagination-item">
            <i class="fas fa-chevron-right"></i>
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
  
  <!-- Modal para asignación masiva -->
  <div class="modal fade" id="ubicacionMasivaModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Asignar ubicación a múltiples productos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="ubicacionMasiva" class="form-label">Ubicación a asignar:</label>
            <input type="text" id="ubicacionMasiva" class="form-control" placeholder="Ej: Estante A, Bodega 2">
            
            {% if ubicaciones|length > 0 %}
              <div class="location-suggestions" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                {% for ubicacion in ubicaciones %}
                  <div class="suggestion-chip" onclick="document.getElementById('ubicacionMasiva').value = this.textContent.trim()">
                    {{ ubicacion }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          
          <div class="form-group">
            <label class="form-label">Asignar a:</label>
            <div class="selection-options">
              <div class="option-container">
                <label class="radio-label">
                  <input type="radio" name="selectionType" value="category" checked>
                  <span>Por categoría</span>
                </label>
              </div>
              <div class="option-container">
                <label class="radio-label">
                  <input type="radio" name="selectionType" value="manual">
                  <span>Selección manual</span>
                </label>
              </div>
            </div>
          </div>
          
          <div id="categorySelection" class="form-group">
            <label for="categoriaSelector" class="form-label">Categoría:</label>
            <select id="categoriaSelector" class="category-select">
              {% for categoria in categorias %}
                <option value="{{ categoria.nombre }}">{{ categoria.nombre|title }}</option>
              {% endfor %}
            </select>
            <p class="text-muted">Se asignará la ubicación a todos los productos de esta categoría.</p>
          </div>
          
          <div id="manualSelection" class="form-group" style="display: none;">
            <label class="form-label">Buscar y seleccionar productos:</label>
            <input type="text" id="searchProductsModal" class="form-control" placeholder="Escribe para buscar...">
            
            <div class="product-items-list" id="selectedProductsList">
              <div class="text-muted" style="text-align: center; padding: 20px;">
                Busca productos por nombre o código
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn-primary" id="saveUbicacionMasiva">Guardar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Contenedor de notificaciones toast -->
  <div class="toast-container" id="toastContainer"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Referencias a elementos DOM
    const searchInput = document.getElementById('searchInput');
    const emptyLocationCheck = document.getElementById('emptyLocationCheck');
    const emptyLocationContainer = document.getElementById('emptyLocationContainer');
    const categorySections = document.querySelectorAll('.category-section');
    const productCards = document.querySelectorAll('.product-card');
    const searchProductsModal = document.getElementById('searchProductsModal');
    const selectedProductsList = document.getElementById('selectedProductsList');
    const saveUbicacionMasivaBtn = document.getElementById('saveUbicacionMasiva');
    
    // Set para almacenar productos seleccionados
    const selectedProducts = new Set();
    
    // Inicializar edición de ubicación para cada producto
    productCards.forEach(card => {
      setupLocationEditing(card);
    });
    
    function setupLocationEditing(card) {
      const productId = card.dataset.productId;
      const locationDisplay = card.querySelector('.location-display');
      const locationInput = card.querySelector('.location-input');
      const locationInputContainer = card.querySelector('.location-input-container');
      const btnEdit = card.querySelector('.btn-edit');
      const btnSave = card.querySelector('.btn-save');
      const btnCancel = card.querySelector('.btn-cancel');
      
      // Guardar valor original
      let originalValue = locationInput.value;
      
      // Configurar sugerencias
      const suggestionChips = card.querySelectorAll('.suggestion-chip');
      suggestionChips.forEach(chip => {
        chip.addEventListener('click', () => {
          locationInput.value = chip.textContent.trim();
        });
      });
      
      // Botón editar
      btnEdit.addEventListener('click', () => {
        // Ocultar pantalla de visualización
        locationDisplay.style.display = 'none';
        locationInputContainer.style.display = 'flex';
        
        // Mostrar botones de guardar/cancelar
        btnEdit.style.display = 'none';
        btnSave.style.display = 'flex';
        btnCancel.style.display = 'flex';
        
        // Enfocar input
        locationInput.focus();
      });
      
      // Botón guardar
      btnSave.addEventListener('click', () => {
        const newLocation = locationInput.value.trim();
        
        // Cambiar botón a estado de carga
        btnSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btnSave.disabled = true;
        
        // Enviar al servidor
        saveLocation(productId, newLocation)
          .then(success => {
            if (success) {
              // Actualizar visualización
              if (newLocation) {
                locationDisplay.textContent = newLocation;
                locationDisplay.classList.remove('empty');
                card.dataset.hasLocation = '1';
              } else {
                locationDisplay.textContent = 'Sin asignar';
                locationDisplay.classList.add('empty');
                card.dataset.hasLocation = '0';
              }
              
              // Guardar valor original
              originalValue = newLocation;
              
              // Mostrar mensaje
              showToast('Ubicación actualizada correctamente', 'success');
            } else {
              showToast('Error al guardar la ubicación', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error al guardar la ubicación', 'error');
          })
          .finally(() => {
            // Restaurar estado
            btnSave.innerHTML = '<i class="fas fa-check"></i>';
            btnSave.disabled = false;
            
            // Volver a mostrar pantalla de visualización
            locationDisplay.style.display = 'block';
            locationInputContainer.style.display = 'none';
            
            // Restaurar botones
            btnEdit.style.display = 'flex';
            btnSave.style.display = 'none';
            btnCancel.style.display = 'none';
          });
      });
      
      // Botón cancelar
      btnCancel.addEventListener('click', () => {
        // Restaurar valor original
        locationInput.value = originalValue;
        
        // Volver a mostrar pantalla de visualización
        locationDisplay.style.display = 'block';
        locationInputContainer.style.display = 'none';
        
        // Restaurar botones
        btnEdit.style.display = 'flex';
        btnSave.style.display = 'none';
        btnCancel.style.display = 'none';
      });
      
      // Manejar tecla Enter para guardar
      locationInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          btnSave.click();
        }
      });
    }
    
    // Función para guardar ubicación
    function saveLocation(productId, location) {
      return fetch(`/api/actualizar-ubicacion/${productId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ubicacion: location })
      })
      .then(response => response.json())
      .then(data => {
        return data.success;
      })
      .catch(error => {
        console.error('Error:', error);
        return false;
      });
    }
    
    // Búsqueda y filtrado
    function applyFilters() {
      const searchValue = searchInput.value.toLowerCase().trim();
      const showOnlyEmpty = emptyLocationCheck.checked;
      
      let resultsCount = 0;
      let visibleCategories = new Set();
      
      // Primero ocultar todas las categorías
      categorySections.forEach(section => {
        section.style.display = 'none';
      });
      
      // Filtrar productos
      productCards.forEach(card => {
        const productName = card.dataset.productName || '';
        const productBarcode = card.dataset.productBarcode || '';
        const hasLocation = card.dataset.hasLocation === '1';
        const category = card.closest('.category-section').dataset.category;
        
        // Verificar si cumple con el filtro de búsqueda
        const matchesSearch = !searchValue || 
                             productName.includes(searchValue) || 
                             productBarcode.includes(searchValue);
        
        // Verificar si cumple con el filtro de ubicación
        const matchesLocation = !showOnlyEmpty || !hasLocation;
        
        // Mostrar solo si cumple con ambos filtros
        const matches = matchesSearch && matchesLocation;
        
        card.style.display = matches ? 'flex' : 'none';
        
        if (matches) {
          resultsCount++;
          visibleCategories.add(category);
        }
      });
      
      // Mostrar categorías con resultados
      visibleCategories.forEach(category => {
        const section = document.querySelector(`.category-section[data-category="${category}"]`);
        if (section) {
          section.style.display = 'block';
        }
      });
      
      // Mostrar mensaje si no hay resultados
      showEmptyResults(resultsCount);
      
      return resultsCount;
    }
    
    // Mostrar mensaje si no hay resultados
    function showEmptyResults(count) {
      let emptyMessage = document.getElementById('emptySearchResults');
      
      if (count === 0) {
        if (!emptyMessage) {
          emptyMessage = document.createElement('div');
          emptyMessage.id = 'emptySearchResults';
          emptyMessage.className = 'empty-state';
          
          const filterActive = emptyLocationCheck.checked;
          const searchValue = searchInput.value.trim();
          
          let messageText = 'No se encontraron productos';
          if (filterActive && searchValue) {
            messageText = `No se encontraron productos sin ubicación que coincidan con "${searchValue}"`;
          } else if (filterActive) {
            messageText = 'No hay productos sin ubicación asignada';
          } else if (searchValue) {
            messageText = `No se encontraron productos que coincidan con "${searchValue}"`;
          }
          
          emptyMessage.innerHTML = `
            <div class="empty-icon">
              <i class="fas fa-search"></i>
            </div>
            <p class="empty-message">${messageText}</p>
            <button class="btn-reset" onclick="resetFilters()">
              <i class="fas fa-undo-alt" style="margin-right: 8px;"></i>Limpiar filtros
            </button>
          `;
          
          document.getElementById('categoriesContainer').prepend(emptyMessage);
        } else {
          emptyMessage.style.display = 'block';
          
          const messageElement = emptyMessage.querySelector('.empty-message');
          const filterActive = emptyLocationCheck.checked;
          const searchValue = searchInput.value.trim();
          
          let messageText = 'No se encontraron productos';
          if (filterActive && searchValue) {
            messageText = `No se encontraron productos sin ubicación que coincidan con "${searchValue}"`;
          } else if (filterActive) {
            messageText = 'No hay productos sin ubicación asignada';
          } else if (searchValue) {
            messageText = `No se encontraron productos que coincidan con "${searchValue}"`;
          }
          
          messageElement.textContent = messageText;
        }
      } else if (emptyMessage) {
        emptyMessage.style.display = 'none';
      }
    }
    
    // Función global para resetear filtros
    window.resetFilters = function() {
      searchInput.value = '';
      emptyLocationCheck.checked = false;
      emptyLocationContainer.classList.remove('active');
      applyFilters();
    };
    
    // Eventos para filtros
    searchInput.addEventListener('input', applyFilters);
    
    // Filtro de ubicación vacía
    emptyLocationContainer.addEventListener('click', function() {
      emptyLocationCheck.checked = !emptyLocationCheck.checked;
      emptyLocationContainer.classList.toggle('active', emptyLocationCheck.checked);
      applyFilters();
    });
    
    // Selección de tipo en modal
    const selectionTypeRadios = document.querySelectorAll('input[name="selectionType"]');
    const categorySelection = document.getElementById('categorySelection');
    const manualSelection = document.getElementById('manualSelection');
    
    selectionTypeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'category') {
          categorySelection.style.display = 'block';
          manualSelection.style.display = 'none';
        } else {
          categorySelection.style.display = 'none';
          manualSelection.style.display = 'block';
        }
      });
    });
    
    // Búsqueda en modal
    searchProductsModal.addEventListener('input', function() {
      const searchValue = this.value.toLowerCase().trim();
      
      if (searchValue.length < 2) {
        // Mostrar solo productos seleccionados
        showSelectedProducts();
        return;
      }
      
      // Buscar productos
      const matchingProducts = [];
      
      productCards.forEach(card => {
        const productId = card.dataset.productId;
        const productName = card.dataset.productName || '';
        const productBarcode = card.dataset.productBarcode || '';
        
        if (productName.includes(searchValue) || productBarcode.includes(searchValue)) {
          const nameElement = card.querySelector('.product-name');
          matchingProducts.push({
            id: productId,
            name: nameElement ? nameElement.textContent : 'Producto',
            selected: selectedProducts.has(productId)
          });
        }
      });
      
      // Mostrar resultados
      renderSearchResults(matchingProducts);
    });
    
    // Renderizar resultados de búsqueda en modal
    function renderSearchResults(products) {
      selectedProductsList.innerHTML = '';
      
      if (products.length === 0) {
        selectedProductsList.innerHTML = `
          <div class="text-muted" style="text-align: center; padding: 20px;">
            No se encontraron productos
          </div>
        `;
        return;
      }
      
      products.forEach(product => {
        const item = document.createElement('div');
        item.className = 'product-item';
        item.innerHTML = `
          <span>${product.name}</span>
          <label class="checkbox-container">
            <input type="checkbox" ${product.selected ? 'checked' : ''} data-product-id="${product.id}">
          </label>
        `;
        
        // Evento para checkbox
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedProducts.add(product.id);
          } else {
            selectedProducts.delete(product.id);
          }
        });
        
        selectedProductsList.appendChild(item);
      });
    }
    
    // Mostrar productos seleccionados
    function showSelectedProducts() {
      if (selectedProducts.size === 0) {
        selectedProductsList.innerHTML = `
          <div class="text-muted" style="text-align: center; padding: 20px;">
            No hay productos seleccionados
          </div>
        `;
        return;
      }
      
      selectedProductsList.innerHTML = '';
      
      selectedProducts.forEach(productId => {
        const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
        if (card) {
          const nameElement = card.querySelector('.product-name');
          const name = nameElement ? nameElement.textContent : 'Producto';
          
          const item = document.createElement('div');
          item.className = 'product-item';
          item.innerHTML = `
            <span>${name}</span>
            <button type="button" class="btn-remove-item" data-product-id="${productId}">
              <i class="fas fa-times"></i>
            </button>
          `;
          
          // Evento para quitar
          const removeBtn = item.querySelector('.btn-remove-item');
          removeBtn.addEventListener('click', function() {
            selectedProducts.delete(productId);
            showSelectedProducts();
          });
          
          selectedProductsList.appendChild(item);
        }
      });
    }
    
    // Guardar asignación masiva
    saveUbicacionMasivaBtn.addEventListener('click', function() {
      const ubicacion = document.getElementById('ubicacionMasiva').value.trim();
      
      if (!ubicacion) {
        showToast('Por favor ingresa una ubicación', 'error');
        return;
      }
      
      // Obtener tipo de selección
      const selectionType = document.querySelector('input[name="selectionType"]:checked').value;
      
      // Preparar datos para enviar
      let data = {
        ubicacion: ubicacion
      };
      
      if (selectionType === 'category') {
        // Selección por categoría
        const categoria = document.getElementById('categoriaSelector').value;
        data.categoria = categoria;
      } else {
        // Selección manual
        if (selectedProducts.size === 0) {
          showToast('No hay productos seleccionados', 'error');
          return;
        }
        
        data.producto_ids = Array.from(selectedProducts);
      }
      
      // Mostrar cargando
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
      this.disabled = true;
      
      // Enviar al servidor
      fetch('/api/actualizar-ubicacion-masiva', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Cerrar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('ubicacionMasivaModal'));
          modal.hide();
          
          // Mostrar mensaje
          showToast(`Se actualizaron ${data.count} productos`, 'success');
          
          // Recargar página
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          throw new Error(data.message || 'Error al guardar las ubicaciones');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast(`Error: ${error.message}`, 'error');
      })
      .finally(() => {
        // Restaurar botón
        this.innerHTML = 'Guardar';
        this.disabled = false;
      });
    });
    
    // Sistema de notificaciones
    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer');
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Inicializar tooltips de Bootstrap si está disponible
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }
  });
</script>
{% endblock %}